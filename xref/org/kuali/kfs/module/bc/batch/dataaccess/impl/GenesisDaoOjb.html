<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<title>GenesisDaoOjb xref</title>
<link type="text/css" rel="stylesheet" href="../../../../../../../../stylesheet.css" />
</head>
<body>
<div id="overview"><a href="../../../../../../../../../apidocs/org/kuali/kfs/module/bc/batch/dataaccess/impl/GenesisDaoOjb.html">View Javadoc</a></div><pre>

<a class="jxr_linenumber" name="1" href="#1">1</a>   <em class="jxr_comment">/*</em>
<a class="jxr_linenumber" name="2" href="#2">2</a>   <em class="jxr_comment"> * Copyright 2011 The Kuali Foundation.</em>
<a class="jxr_linenumber" name="3" href="#3">3</a>   <em class="jxr_comment"> * </em>
<a class="jxr_linenumber" name="4" href="#4">4</a>   <em class="jxr_comment"> * Licensed under the Educational Community License, Version 2.0 (the "License");</em>
<a class="jxr_linenumber" name="5" href="#5">5</a>   <em class="jxr_comment"> * you may not use this file except in compliance with the License.</em>
<a class="jxr_linenumber" name="6" href="#6">6</a>   <em class="jxr_comment"> * You may obtain a copy of the License at</em>
<a class="jxr_linenumber" name="7" href="#7">7</a>   <em class="jxr_comment"> * </em>
<a class="jxr_linenumber" name="8" href="#8">8</a>   <em class="jxr_comment"> * <a href="http://www.opensource.org/licenses/ecl2.php" target="alexandria_uri">http://www.opensource.org/licenses/ecl2.php</a></em>
<a class="jxr_linenumber" name="9" href="#9">9</a>   <em class="jxr_comment"> * </em>
<a class="jxr_linenumber" name="10" href="#10">10</a>  <em class="jxr_comment"> * Unless required by applicable law or agreed to in writing, software</em>
<a class="jxr_linenumber" name="11" href="#11">11</a>  <em class="jxr_comment"> * distributed under the License is distributed on an "AS IS" BASIS,</em>
<a class="jxr_linenumber" name="12" href="#12">12</a>  <em class="jxr_comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</em>
<a class="jxr_linenumber" name="13" href="#13">13</a>  <em class="jxr_comment"> * See the License for the specific language governing permissions and</em>
<a class="jxr_linenumber" name="14" href="#14">14</a>  <em class="jxr_comment"> * limitations under the License.</em>
<a class="jxr_linenumber" name="15" href="#15">15</a>  <em class="jxr_comment"> */</em>
<a class="jxr_linenumber" name="16" href="#16">16</a>  <strong class="jxr_keyword">package</strong> org.kuali.kfs.module.bc.batch.dataaccess.impl;
<a class="jxr_linenumber" name="17" href="#17">17</a>  
<a class="jxr_linenumber" name="18" href="#18">18</a>  <strong class="jxr_keyword">import</strong> java.math.BigDecimal;
<a class="jxr_linenumber" name="19" href="#19">19</a>  <strong class="jxr_keyword">import</strong> java.math.MathContext;
<a class="jxr_linenumber" name="20" href="#20">20</a>  <strong class="jxr_keyword">import</strong> java.math.RoundingMode;
<a class="jxr_linenumber" name="21" href="#21">21</a>  <strong class="jxr_keyword">import</strong> java.sql.Date;
<a class="jxr_linenumber" name="22" href="#22">22</a>  <strong class="jxr_keyword">import</strong> java.util.ArrayList;
<a class="jxr_linenumber" name="23" href="#23">23</a>  <strong class="jxr_keyword">import</strong> java.util.HashMap;
<a class="jxr_linenumber" name="24" href="#24">24</a>  <strong class="jxr_keyword">import</strong> java.util.HashSet;
<a class="jxr_linenumber" name="25" href="#25">25</a>  <strong class="jxr_keyword">import</strong> java.util.Iterator;
<a class="jxr_linenumber" name="26" href="#26">26</a>  <strong class="jxr_keyword">import</strong> java.util.List;
<a class="jxr_linenumber" name="27" href="#27">27</a>  <strong class="jxr_keyword">import</strong> java.util.Map;
<a class="jxr_linenumber" name="28" href="#28">28</a>  
<a class="jxr_linenumber" name="29" href="#29">29</a>  <strong class="jxr_keyword">import</strong> org.apache.log4j.Level;
<a class="jxr_linenumber" name="30" href="#30">30</a>  <strong class="jxr_keyword">import</strong> org.apache.log4j.Logger;
<a class="jxr_linenumber" name="31" href="#31">31</a>  <strong class="jxr_keyword">import</strong> org.apache.ojb.broker.query.Criteria;
<a class="jxr_linenumber" name="32" href="#32">32</a>  <strong class="jxr_keyword">import</strong> org.apache.ojb.broker.query.QueryByCriteria;
<a class="jxr_linenumber" name="33" href="#33">33</a>  <strong class="jxr_keyword">import</strong> org.apache.ojb.broker.query.ReportQueryByCriteria;
<a class="jxr_linenumber" name="34" href="#34">34</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.coa.businessobject.Account;
<a class="jxr_linenumber" name="35" href="#35">35</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.coa.businessobject.ObjectCode;
<a class="jxr_linenumber" name="36" href="#36">36</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.coa.businessobject.Organization;
<a class="jxr_linenumber" name="37" href="#37">37</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.coa.service.OrganizationService;
<a class="jxr_linenumber" name="38" href="#38">38</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.fp.businessobject.FiscalYearFunctionControl;
<a class="jxr_linenumber" name="39" href="#39">39</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.fp.businessobject.FunctionControlCode;
<a class="jxr_linenumber" name="40" href="#40">40</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.gl.GeneralLedgerConstants.ColumnNames;
<a class="jxr_linenumber" name="41" href="#41">41</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.gl.businessobject.Balance;
<a class="jxr_linenumber" name="42" href="#42">42</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.integration.ld.LaborLedgerObject;
<a class="jxr_linenumber" name="43" href="#43">43</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.module.bc.BCConstants;
<a class="jxr_linenumber" name="44" href="#44">44</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.module.bc.BCPropertyConstants;
<a class="jxr_linenumber" name="45" href="#45">45</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.module.bc.batch.dataaccess.BudgetConstructionHumanResourcesPayrollInterfaceDao;
<a class="jxr_linenumber" name="46" href="#46">46</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.module.bc.batch.dataaccess.GenesisDao;
<a class="jxr_linenumber" name="47" href="#47">47</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.module.bc.businessobject.BudgetConstructionAccountOrganizationHierarchy;
<a class="jxr_linenumber" name="48" href="#48">48</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.module.bc.businessobject.BudgetConstructionAccountReports;
<a class="jxr_linenumber" name="49" href="#49">49</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.module.bc.businessobject.BudgetConstructionAdministrativePost;
<a class="jxr_linenumber" name="50" href="#50">50</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.module.bc.businessobject.BudgetConstructionAppointmentFundingReason;
<a class="jxr_linenumber" name="51" href="#51">51</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.module.bc.businessobject.BudgetConstructionCalculatedSalaryFoundationTracker;
<a class="jxr_linenumber" name="52" href="#52">52</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.module.bc.businessobject.BudgetConstructionFundingLock;
<a class="jxr_linenumber" name="53" href="#53">53</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.module.bc.businessobject.BudgetConstructionHeader;
<a class="jxr_linenumber" name="54" href="#54">54</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.module.bc.businessobject.BudgetConstructionIntendedIncumbent;
<a class="jxr_linenumber" name="55" href="#55">55</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.module.bc.businessobject.BudgetConstructionMonthly;
<a class="jxr_linenumber" name="56" href="#56">56</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.module.bc.businessobject.BudgetConstructionOrganizationReports;
<a class="jxr_linenumber" name="57" href="#57">57</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.module.bc.businessobject.BudgetConstructionPosition;
<a class="jxr_linenumber" name="58" href="#58">58</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.module.bc.businessobject.CalculatedSalaryFoundationTracker;
<a class="jxr_linenumber" name="59" href="#59">59</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.module.bc.businessobject.CalculatedSalaryFoundationTrackerOverride;
<a class="jxr_linenumber" name="60" href="#60">60</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.module.bc.businessobject.PendingBudgetConstructionAppointmentFunding;
<a class="jxr_linenumber" name="61" href="#61">61</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.module.bc.businessobject.PendingBudgetConstructionGeneralLedger;
<a class="jxr_linenumber" name="62" href="#62">62</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.module.bc.document.BudgetConstructionDocument;
<a class="jxr_linenumber" name="63" href="#63">63</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.sys.KFSConstants;
<a class="jxr_linenumber" name="64" href="#64">64</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.sys.KFSPropertyConstants;
<a class="jxr_linenumber" name="65" href="#65">65</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.sys.KFSConstants.BudgetConstructionConstants;
<a class="jxr_linenumber" name="66" href="#66">66</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.sys.KFSConstants.ParameterValues;
<a class="jxr_linenumber" name="67" href="#67">67</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.sys.businessobject.FinancialSystemDocumentHeader;
<a class="jxr_linenumber" name="68" href="#68">68</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.sys.businessobject.UniversityDate;
<a class="jxr_linenumber" name="69" href="#69">69</a>  <strong class="jxr_keyword">import</strong> org.kuali.kfs.sys.context.SpringContext;
<a class="jxr_linenumber" name="70" href="#70">70</a>  <strong class="jxr_keyword">import</strong> org.kuali.rice.kew.exception.WorkflowException;
<a class="jxr_linenumber" name="71" href="#71">71</a>  <strong class="jxr_keyword">import</strong> org.kuali.rice.kns.dao.DocumentDao;
<a class="jxr_linenumber" name="72" href="#72">72</a>  <strong class="jxr_keyword">import</strong> org.kuali.rice.kns.service.DateTimeService;
<a class="jxr_linenumber" name="73" href="#73">73</a>  <strong class="jxr_keyword">import</strong> org.kuali.rice.kns.service.DocumentService;
<a class="jxr_linenumber" name="74" href="#74">74</a>  <strong class="jxr_keyword">import</strong> org.kuali.rice.kns.service.KualiModuleService;
<a class="jxr_linenumber" name="75" href="#75">75</a>  <strong class="jxr_keyword">import</strong> org.kuali.rice.kns.util.KualiDecimal;
<a class="jxr_linenumber" name="76" href="#76">76</a>  <strong class="jxr_keyword">import</strong> org.kuali.rice.kns.util.KualiInteger;
<a class="jxr_linenumber" name="77" href="#77">77</a>  <strong class="jxr_keyword">import</strong> org.kuali.rice.kns.util.TransactionalServiceUtils;
<a class="jxr_linenumber" name="78" href="#78">78</a>  <strong class="jxr_keyword">import</strong> org.kuali.rice.kns.workflow.service.WorkflowDocumentService;
<a class="jxr_linenumber" name="79" href="#79">79</a>  
<a class="jxr_linenumber" name="80" href="#80">80</a>  
<a class="jxr_linenumber" name="81" href="#81">81</a>  <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">class</strong> <a href="../../../../../../../../org/kuali/kfs/module/bc/batch/dataaccess/impl/GenesisDaoOjb.html">GenesisDaoOjb</a> <strong class="jxr_keyword">extends</strong> <a href="../../../../../../../../org/kuali/kfs/module/bc/batch/dataaccess/impl/BudgetConstructionBatchHelperDaoOjb.html">BudgetConstructionBatchHelperDaoOjb</a> <strong class="jxr_keyword">implements</strong> <a href="../../../../../../../../org/kuali/kfs/module/bc/batch/dataaccess/GenesisDao.html">GenesisDao</a> {
<a class="jxr_linenumber" name="82" href="#82">82</a>      <em class="jxr_comment">/*</em>
<a class="jxr_linenumber" name="83" href="#83">83</a>  <em class="jxr_comment">     *   December, 2006:</em>
<a class="jxr_linenumber" name="84" href="#84">84</a>  <em class="jxr_comment">     *   These routines are written to try to mitigate the performance hit that</em>
<a class="jxr_linenumber" name="85" href="#85">85</a>  <em class="jxr_comment">     *   comes from using OJB as opposed to JDBC (pass-through SQL).  Pass-through</em>
<a class="jxr_linenumber" name="86" href="#86">86</a>  <em class="jxr_comment">     *   SQL in Kuali could lead to database-dependencies in the code, and tie Kuali</em>
<a class="jxr_linenumber" name="87" href="#87">87</a>  <em class="jxr_comment">     *   to a specific RDBMS.</em>
<a class="jxr_linenumber" name="88" href="#88">88</a>  <em class="jxr_comment">     *   OJB is not really suited for batch, where rows are fetched, inserted, and</em>
<a class="jxr_linenumber" name="89" href="#89">89</a>  <em class="jxr_comment">     *   updated in big bunches as opposed to a few at a time.</em>
<a class="jxr_linenumber" name="90" href="#90">90</a>  <em class="jxr_comment">     *   (1)  OJB in "lazy evaluation mode" (the Kuali standard for performance </em>
<a class="jxr_linenumber" name="91" href="#91">91</a>  <em class="jxr_comment">     *        reasons) will only return the row from the main table regardless of </em>
<a class="jxr_linenumber" name="92" href="#92">92</a>  <em class="jxr_comment">     *        how many "reference descriptor" joins and/or "collection descriptor"</em>
<a class="jxr_linenumber" name="93" href="#93">93</a>  <em class="jxr_comment">     *        joins there may be in the OJB repository file.  So, if I query table A and</em>
<a class="jxr_linenumber" name="94" href="#94">94</a>  <em class="jxr_comment">     *        reference table B, my query (in batch) might return 10,000 A rows in</em>
<a class="jxr_linenumber" name="95" href="#95">95</a>  <em class="jxr_comment">     *        a single call.  None of the matching B fields will be filled in in the</em>
<a class="jxr_linenumber" name="96" href="#96">96</a>  <em class="jxr_comment">     *        DAO.  If I then try to access a B field in a given instance of the DAO,</em>
<a class="jxr_linenumber" name="97" href="#97">97</a>  <em class="jxr_comment">     *        Spring will do a query to fetch the relevant B row.  In essence, in batch</em>
<a class="jxr_linenumber" name="98" href="#98">98</a>  <em class="jxr_comment">     *        I would do a single DB call to get the 10,000 rows of A, and 10,000 DB</em>
<a class="jxr_linenumber" name="99" href="#99">99</a>  <em class="jxr_comment">     *        calls to fill in the fields from B, one for each row of A.</em>
<a class="jxr_linenumber" name="100" href="#100">100</a> <em class="jxr_comment">     *   (2)  This routine tries to do joins in java, in memory, by using what Oracle</em>
<a class="jxr_linenumber" name="101" href="#101">101</a> <em class="jxr_comment">     *        calls a "hash join".  If we want to join A and B on a key, we will get</em>
<a class="jxr_linenumber" name="102" href="#102">102</a> <em class="jxr_comment">     *        the relevant fields from A and B on separate DB calls (one for A and one</em>
<a class="jxr_linenumber" name="103" href="#103">103</a> <em class="jxr_comment">     *        for B), and create a hash map on the join key from the results.  We can</em>
<a class="jxr_linenumber" name="104" href="#104">104</a> <em class="jxr_comment">     *        then iterate through either A or B and get the relevant fields from the</em>
<a class="jxr_linenumber" name="105" href="#105">105</a> <em class="jxr_comment">     *        other table by employing the hash key.  This should be fast, since hash</em>
<a class="jxr_linenumber" name="106" href="#106">106</a> <em class="jxr_comment">     *        tables are designed for fast access.</em>
<a class="jxr_linenumber" name="107" href="#107">107</a> <em class="jxr_comment">     *   (3)  We will only store when absolutely necessary to minimize data base access.</em>
<a class="jxr_linenumber" name="108" href="#108">108</a> <em class="jxr_comment">     *        So where in Oracle we would do an UPDATE A.. WHERE (EXISTS (SELECT 1 FROM B</em>
<a class="jxr_linenumber" name="109" href="#109">109</a> <em class="jxr_comment">     *        WHERE A matches B) or an INSERT A (SELECT ... FROM A, B WHERE A = B), we will </em>
<a class="jxr_linenumber" name="110" href="#110">110</a> <em class="jxr_comment">     *        get all the candidate rows from both A and B, and store individually to do</em>
<a class="jxr_linenumber" name="111" href="#111">111</a> <em class="jxr_comment">     *        INSERT or UPDATE.  (There seems to be no way in OJB to store more than</em>
<a class="jxr_linenumber" name="112" href="#112">112</a> <em class="jxr_comment">     *        one row at a time.)  This may lead to a lot of database calls that operate</em>
<a class="jxr_linenumber" name="113" href="#113">113</a> <em class="jxr_comment">     *        on a single row.  We can only try to minimize this problem.  We can't</em>
<a class="jxr_linenumber" name="114" href="#114">114</a> <em class="jxr_comment">     *        get around it.  </em>
<a class="jxr_linenumber" name="115" href="#115">115</a> <em class="jxr_comment">     *   This is the impression of the coder.  If anyone has other suggestions, please</em>
<a class="jxr_linenumber" name="116" href="#116">116</a> <em class="jxr_comment">     *   let us know.</em>
<a class="jxr_linenumber" name="117" href="#117">117</a> <em class="jxr_comment">     *   (One alternative might be to have many different class-desriptor tags in the</em>
<a class="jxr_linenumber" name="118" href="#118">118</a> <em class="jxr_comment">     *    OJB repository file representing table A, one for each join to table B.  If</em>
<a class="jxr_linenumber" name="119" href="#119">119</a> <em class="jxr_comment">     *    we could override lazy evaluation at the class-descriptor level, we could </em>
<a class="jxr_linenumber" name="120" href="#120">120</a> <em class="jxr_comment">     *    code some batch-specific joins that would get everything we need in one call.</em>
<a class="jxr_linenumber" name="121" href="#121">121</a> <em class="jxr_comment">     *    The problem with this is that the A/B descriptions would then be in multiple</em>
<a class="jxr_linenumber" name="122" href="#122">122</a> <em class="jxr_comment">     *    tags, and changing them would be labor-intensive and error-prone.  But OJB</em>
<a class="jxr_linenumber" name="123" href="#123">123</a> <em class="jxr_comment">     *    repositories allow headers, so we could get around this by using an entity to </em>
<a class="jxr_linenumber" name="124" href="#124">124</a> <em class="jxr_comment">     *    describe the A fields.  The entity would be in one place, so changes to the A</em>
<a class="jxr_linenumber" name="125" href="#125">125</a> <em class="jxr_comment">     *    fields could also be made in one place.  The foreignkey field-ref tag B fields</em>
<a class="jxr_linenumber" name="126" href="#126">126</a> <em class="jxr_comment">     *    are repeated in every description anyway, so things aren't always in one place</em>
<a class="jxr_linenumber" name="127" href="#127">127</a> <em class="jxr_comment">     *    to begin with.)</em>
<a class="jxr_linenumber" name="128" href="#128">128</a> <em class="jxr_comment">     *    November, 2008:</em>
<a class="jxr_linenumber" name="129" href="#129">129</a> <em class="jxr_comment">     *    JOINs (especially those using one-to-many relationships) are problematic in OJB, as the admit in their docmentation.</em>
<a class="jxr_linenumber" name="130" href="#130">130</a> <em class="jxr_comment">     *    But, it is possible, using ReportQuery and qualifiers, to tell OJB how to build efficient JOIN SQL correctly.  The code</em>
<a class="jxr_linenumber" name="131" href="#131">131</a> <em class="jxr_comment">     *    below, however, seems to be efficient as well.  The only disadvantage it has is that it requires additional memory.  Based</em>
<a class="jxr_linenumber" name="132" href="#132">132</a> <em class="jxr_comment">     *    on tests against realistic data sets (over 400,000 rows written), the OJB cache is a far greater memory hog--and itself uses</em>
<a class="jxr_linenumber" name="133" href="#133">133</a> <em class="jxr_comment">     *    hashmaps--than these hashmaps.  If you are running batch in your own container with no other threads active, it is easy to</em>
<a class="jxr_linenumber" name="134" href="#134">134</a> <em class="jxr_comment">     *    turn off the OJB cache dynamically.  This code doesn't really make use of the OJB cache.  It attempts to avoid reading the</em>
<a class="jxr_linenumber" name="135" href="#135">135</a> <em class="jxr_comment">     *    same row repeatedly.  It also uses report queries extensively, and those do not cache results.</em>
<a class="jxr_linenumber" name="136" href="#136">136</a> <em class="jxr_comment">     *    </em>
<a class="jxr_linenumber" name="137" href="#137">137</a> <em class="jxr_comment">     */</em>
<a class="jxr_linenumber" name="138" href="#138">138</a> 
<a class="jxr_linenumber" name="139" href="#139">139</a>     <strong class="jxr_keyword">private</strong> <a href="../../../../../../../../org/kuali/kfs/fp/businessobject/FiscalYearFunctionControl.html">FiscalYearFunctionControl</a> fiscalYearFunctionControl;
<a class="jxr_linenumber" name="140" href="#140">140</a>     <strong class="jxr_keyword">private</strong> <a href="../../../../../../../../org/kuali/kfs/fp/businessobject/FunctionControlCode.html">FunctionControlCode</a> functionControlCode;
<a class="jxr_linenumber" name="141" href="#141">141</a> 
<a class="jxr_linenumber" name="142" href="#142">142</a>     <em class="jxr_comment">/*<em class="jxr_comment">  turn on the logger for the persistence broker */</em></em>
<a class="jxr_linenumber" name="143" href="#143">143</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> Logger LOG = org.apache.log4j.Logger.getLogger(GenesisDaoOjb.<strong class="jxr_keyword">class</strong>);
<a class="jxr_linenumber" name="144" href="#144">144</a> 
<a class="jxr_linenumber" name="145" href="#145">145</a>     <em class="jxr_comment">/*</em>
<a class="jxr_linenumber" name="146" href="#146">146</a> <em class="jxr_comment">     *   version number for new rows</em>
<a class="jxr_linenumber" name="147" href="#147">147</a> <em class="jxr_comment">     */</em>
<a class="jxr_linenumber" name="148" href="#148">148</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">static</strong> Long DEFAULT_VERSION_NUMBER = <strong class="jxr_keyword">new</strong> Long(1);
<a class="jxr_linenumber" name="149" href="#149">149</a>     <em class="jxr_comment">/*</em>
<a class="jxr_linenumber" name="150" href="#150">150</a> <em class="jxr_comment">     *   code a high value for the limit of the organization reporting chain.  we limit this to avoid</em>
<a class="jxr_linenumber" name="151" href="#151">151</a> <em class="jxr_comment">     *   infinite loops when for some reason there is a circular reporting chain in the DB</em>
<a class="jxr_linenumber" name="152" href="#152">152</a> <em class="jxr_comment">     */</em>
<a class="jxr_linenumber" name="153" href="#153">153</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">static</strong> Integer MAXIMUM_ORGANIZATION_TREE_DEPTH = <strong class="jxr_keyword">new</strong> Integer(1000);
<a class="jxr_linenumber" name="154" href="#154">154</a> 
<a class="jxr_linenumber" name="155" href="#155">155</a>     <strong class="jxr_keyword">private</strong> DocumentService documentService;
<a class="jxr_linenumber" name="156" href="#156">156</a>     <strong class="jxr_keyword">private</strong> WorkflowDocumentService workflowDocumentService;
<a class="jxr_linenumber" name="157" href="#157">157</a>     <strong class="jxr_keyword">private</strong> DateTimeService dateTimeService;
<a class="jxr_linenumber" name="158" href="#158">158</a>     <strong class="jxr_keyword">private</strong> DocumentDao documentDao;
<a class="jxr_linenumber" name="159" href="#159">159</a>     <strong class="jxr_keyword">private</strong> KualiModuleService kualiModuleService;
<a class="jxr_linenumber" name="160" href="#160">160</a>     <strong class="jxr_keyword">private</strong> <a href="../../../../../../../../org/kuali/kfs/module/bc/batch/dataaccess/BudgetConstructionHumanResourcesPayrollInterfaceDao.html">BudgetConstructionHumanResourcesPayrollInterfaceDao</a> budgetConstructionHumanResourcesPayrollInterfaceDao;
<a class="jxr_linenumber" name="161" href="#161">161</a> 
<a class="jxr_linenumber" name="162" href="#162">162</a> 
<a class="jxr_linenumber" name="163" href="#163">163</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">final</strong> Map&lt;String, String&gt; getBudgetConstructionControlFlags(Integer universityFiscalYear) {
<a class="jxr_linenumber" name="164" href="#164">164</a>         <em class="jxr_comment">/*<em class="jxr_comment">  return the flag names and the values for all the BC flags for the fiscal year */</em></em>
<a class="jxr_linenumber" name="165" href="#165">165</a> 
<a class="jxr_linenumber" name="166" href="#166">166</a>         <em class="jxr_comment">/*<em class="jxr_comment">  the key to the map returned will be the name of the flag</em></em>
<a class="jxr_linenumber" name="167" href="#167">167</a> <em class="jxr_comment">         *  the entry will be the flag's value </em>
<a class="jxr_linenumber" name="168" href="#168">168</a> <em class="jxr_comment">         */</em>
<a class="jxr_linenumber" name="169" href="#169">169</a>         Map&lt;String, String&gt; controlFlags = <strong class="jxr_keyword">new</strong> HashMap();
<a class="jxr_linenumber" name="170" href="#170">170</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="171" href="#171">171</a>         criteriaID.addEqualTo(KFSConstants.UNIVERSITY_FISCAL_YEAR_PROPERTY_NAME, universityFiscalYear);
<a class="jxr_linenumber" name="172" href="#172">172</a>         String[] queryAttr = { KFSPropertyConstants.FINANCIAL_SYSTEM_FUNCTION_CONTROL_CODE, KFSPropertyConstants.FINANCIAL_SYSTEM_FUNCTION_ACTIVE_INDICATOR };
<a class="jxr_linenumber" name="173" href="#173">173</a>         ReportQueryByCriteria queryID = <strong class="jxr_keyword">new</strong> ReportQueryByCriteria(FiscalYearFunctionControl.<strong class="jxr_keyword">class</strong>, queryAttr, criteriaID);
<a class="jxr_linenumber" name="174" href="#174">174</a>         Iterator Results = getPersistenceBrokerTemplate().getReportQueryIteratorByQuery(queryID);
<a class="jxr_linenumber" name="175" href="#175">175</a>         <em class="jxr_comment">/*<em class="jxr_comment"> fill in the map */</em></em>
<a class="jxr_linenumber" name="176" href="#176">176</a>         <strong class="jxr_keyword">while</strong> (Results.hasNext()) {
<a class="jxr_linenumber" name="177" href="#177">177</a>             String[] mapValues = (String[]) ((Object[]) Results.next());
<a class="jxr_linenumber" name="178" href="#178">178</a>             controlFlags.put(mapValues[0], mapValues[1]);
<a class="jxr_linenumber" name="179" href="#179">179</a>         }
<a class="jxr_linenumber" name="180" href="#180">180</a>         ;
<a class="jxr_linenumber" name="181" href="#181">181</a>         <strong class="jxr_keyword">return</strong> controlFlags;
<a class="jxr_linenumber" name="182" href="#182">182</a>     }
<a class="jxr_linenumber" name="183" href="#183">183</a> 
<a class="jxr_linenumber" name="184" href="#184">184</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> getBudgetConstructionControlFlag(Integer universityFiscalYear, String FlagID) {
<a class="jxr_linenumber" name="185" href="#185">185</a>         <em class="jxr_comment">/*<em class="jxr_comment">  return true if a flag is on, false if it is not */</em></em>
<a class="jxr_linenumber" name="186" href="#186">186</a>         Boolean result;
<a class="jxr_linenumber" name="187" href="#187">187</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="188" href="#188">188</a>         criteriaID.addEqualTo(KFSConstants.UNIVERSITY_FISCAL_YEAR_PROPERTY_NAME, universityFiscalYear);
<a class="jxr_linenumber" name="189" href="#189">189</a>         criteriaID.addEqualTo(KFSPropertyConstants.FINANCIAL_SYSTEM_FUNCTION_CONTROL_CODE, FlagID);
<a class="jxr_linenumber" name="190" href="#190">190</a>         String[] queryAttr = { KFSPropertyConstants.FINANCIAL_SYSTEM_FUNCTION_ACTIVE_INDICATOR };
<a class="jxr_linenumber" name="191" href="#191">191</a>         ReportQueryByCriteria queryID = <strong class="jxr_keyword">new</strong> ReportQueryByCriteria(FiscalYearFunctionControl.<strong class="jxr_keyword">class</strong>, queryAttr, criteriaID, <strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="192" href="#192">192</a>         Iterator Results = getPersistenceBrokerTemplate().getReportQueryIteratorByQuery(queryID);
<a class="jxr_linenumber" name="193" href="#193">193</a>         result = (Boolean) ((Object[]) Results.next())[0];
<a class="jxr_linenumber" name="194" href="#194">194</a>         <strong class="jxr_keyword">return</strong> result;
<a class="jxr_linenumber" name="195" href="#195">195</a>     }
<a class="jxr_linenumber" name="196" href="#196">196</a> 
<a class="jxr_linenumber" name="197" href="#197">197</a> 
<a class="jxr_linenumber" name="198" href="#198">198</a>     <em class="jxr_comment">/*</em>
<a class="jxr_linenumber" name="199" href="#199">199</a> <em class="jxr_comment">     * ********************************************************************************</em>
<a class="jxr_linenumber" name="200" href="#200">200</a> <em class="jxr_comment">     *   This routine returns the fiscal year as of the run date.</em>
<a class="jxr_linenumber" name="201" href="#201">201</a> <em class="jxr_comment">     *   Normally, genesis runs in the current fiscal year to build budget construction</em>
<a class="jxr_linenumber" name="202" href="#202">202</a> <em class="jxr_comment">     *   for the coming fiscal year.</em>
<a class="jxr_linenumber" name="203" href="#203">203</a> <em class="jxr_comment">     */</em>
<a class="jxr_linenumber" name="204" href="#204">204</a>     <strong class="jxr_keyword">public</strong> Integer fiscalYearFromToday() {
<a class="jxr_linenumber" name="205" href="#205">205</a>         <em class="jxr_comment">//  we look up the fiscal year for today's date, and return it</em>
<a class="jxr_linenumber" name="206" href="#206">206</a>         <em class="jxr_comment">//  we return 0 if nothing is found</em>
<a class="jxr_linenumber" name="207" href="#207">207</a>         Integer currentFiscalYear = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="208" href="#208">208</a>         Date lookUpDate = dateTimeService.getCurrentSqlDateMidnight();
<a class="jxr_linenumber" name="209" href="#209">209</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="210" href="#210">210</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_DATE, lookUpDate);
<a class="jxr_linenumber" name="211" href="#211">211</a>         String[] attrb = { KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR };
<a class="jxr_linenumber" name="212" href="#212">212</a>         ReportQueryByCriteria queryID = <strong class="jxr_keyword">new</strong> ReportQueryByCriteria(UniversityDate.<strong class="jxr_keyword">class</strong>, attrb, criteriaID);
<a class="jxr_linenumber" name="213" href="#213">213</a>         Iterator resultRow = getPersistenceBrokerTemplate().getReportQueryIteratorByQuery(queryID);
<a class="jxr_linenumber" name="214" href="#214">214</a>         <em class="jxr_comment">// there will only be one row.</em>
<a class="jxr_linenumber" name="215" href="#215">215</a>         <em class="jxr_comment">// Oracle will not close the cursor, however, until the iterator has been exhausted</em>
<a class="jxr_linenumber" name="216" href="#216">216</a>         <strong class="jxr_keyword">if</strong> (resultRow.hasNext()) {
<a class="jxr_linenumber" name="217" href="#217">217</a>             currentFiscalYear = (Integer) ((Number) ((Object[]) TransactionalServiceUtils.retrieveFirstAndExhaustIterator(resultRow))[0]).intValue();
<a class="jxr_linenumber" name="218" href="#218">218</a>         }
<a class="jxr_linenumber" name="219" href="#219">219</a>         LOG.debug(String.format(<span class="jxr_string">"\nreturned from fiscalYearFromToday: %d"</span>, currentFiscalYear));
<a class="jxr_linenumber" name="220" href="#220">220</a>         <strong class="jxr_keyword">return</strong> currentFiscalYear;
<a class="jxr_linenumber" name="221" href="#221">221</a>     }
<a class="jxr_linenumber" name="222" href="#222">222</a> 
<a class="jxr_linenumber" name="223" href="#223">223</a> 
<a class="jxr_linenumber" name="224" href="#224">224</a>     <em class="jxr_comment">/*</em>
<a class="jxr_linenumber" name="225" href="#225">225</a> <em class="jxr_comment">     * ******************************************************************************  </em>
<a class="jxr_linenumber" name="226" href="#226">226</a> <em class="jxr_comment">     *   (1) these routines are used to create and set the control flags for budget *</em>
<a class="jxr_linenumber" name="227" href="#227">227</a> <em class="jxr_comment">     *   construction.  Genesis sets flags for both the current fiscal year and the *</em>
<a class="jxr_linenumber" name="228" href="#228">228</a> <em class="jxr_comment">     *   fiscal year to be budgeted to a fixed set of initial values.  The flags    *</em>
<a class="jxr_linenumber" name="229" href="#229">229</a> <em class="jxr_comment">     *   are changed after that using maintenance screens.                          *</em>
<a class="jxr_linenumber" name="230" href="#230">230</a> <em class="jxr_comment">     * ******************************************************************************  </em>
<a class="jxr_linenumber" name="231" href="#231">231</a> <em class="jxr_comment">     */</em>
<a class="jxr_linenumber" name="232" href="#232">232</a> 
<a class="jxr_linenumber" name="233" href="#233">233</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setControlFlagsAtTheStartOfGenesis(Integer BaseYear) {
<a class="jxr_linenumber" name="234" href="#234">234</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="235" href="#235">235</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="236" href="#236">236</a>         <em class="jxr_comment">// first we have to eliminate anything for the new year that's there now</em>
<a class="jxr_linenumber" name="237" href="#237">237</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="238" href="#238">238</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="239" href="#239">239</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, RequestYear);
<a class="jxr_linenumber" name="240" href="#240">240</a>         QueryByCriteria queryID = <strong class="jxr_keyword">new</strong> QueryByCriteria(FiscalYearFunctionControl.<strong class="jxr_keyword">class</strong>, criteriaID);
<a class="jxr_linenumber" name="241" href="#241">241</a>         getPersistenceBrokerTemplate().deleteByQuery(queryID);
<a class="jxr_linenumber" name="242" href="#242">242</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="243" href="#243">243</a>         <em class="jxr_comment">// </em>
<a class="jxr_linenumber" name="244" href="#244">244</a>         <em class="jxr_comment">//  the default values (except for the BUDGET_CONSTRUCTION_GENESIS_RUNNING flag)</em>
<a class="jxr_linenumber" name="245" href="#245">245</a>         <em class="jxr_comment">//  come from the function control code table</em>
<a class="jxr_linenumber" name="246" href="#246">246</a>         <a href="../../../../../../../../org/kuali/kfs/fp/businessobject/FiscalYearFunctionControl.html">FiscalYearFunctionControl</a> SLF;
<a class="jxr_linenumber" name="247" href="#247">247</a>         criteriaID = QueryByCriteria.CRITERIA_SELECT_ALL;
<a class="jxr_linenumber" name="248" href="#248">248</a>         String[] attrQ = { KFSPropertyConstants.FINANCIAL_SYSTEM_FUNCTION_CONTROL_CODE, KFSPropertyConstants.FINANCIAL_SYSTEM_FUNCTION_DEFAULT_INDICATOR };
<a class="jxr_linenumber" name="249" href="#249">249</a>         ReportQueryByCriteria rptQueryID = <strong class="jxr_keyword">new</strong> ReportQueryByCriteria(FunctionControlCode.<strong class="jxr_keyword">class</strong>, attrQ, criteriaID);
<a class="jxr_linenumber" name="250" href="#250">250</a>         Integer sqlFunctionControlCode = 0;
<a class="jxr_linenumber" name="251" href="#251">251</a>         Integer sqlFunctionActiveIndicator = 1;
<a class="jxr_linenumber" name="252" href="#252">252</a>         <em class="jxr_comment">// run the query</em>
<a class="jxr_linenumber" name="253" href="#253">253</a>         Iterator Results = getPersistenceBrokerTemplate().getReportQueryIteratorByQuery(rptQueryID);
<a class="jxr_linenumber" name="254" href="#254">254</a>         <strong class="jxr_keyword">while</strong> (Results.hasNext()) {
<a class="jxr_linenumber" name="255" href="#255">255</a>             SLF = <strong class="jxr_keyword">new</strong> <a href="../../../../../../../../org/kuali/kfs/fp/businessobject/FiscalYearFunctionControl.html">FiscalYearFunctionControl</a>();
<a class="jxr_linenumber" name="256" href="#256">256</a>             Object[] resultFields = (Object[]) Results.next();
<a class="jxr_linenumber" name="257" href="#257">257</a>             String flagTag = (String) resultFields[sqlFunctionControlCode];
<a class="jxr_linenumber" name="258" href="#258">258</a>             <em class="jxr_comment">//          String flagDefault = (String) resultFields[sqlFunctionActiveIndicator];</em>
<a class="jxr_linenumber" name="259" href="#259">259</a>             <em class="jxr_comment">//  apparently OJB is smart enough to bring this in as a boolean</em>
<a class="jxr_linenumber" name="260" href="#260">260</a>             <strong class="jxr_keyword">boolean</strong> flagDefault = (Boolean) resultFields[sqlFunctionActiveIndicator];
<a class="jxr_linenumber" name="261" href="#261">261</a>             SLF.setUniversityFiscalYear(RequestYear);
<a class="jxr_linenumber" name="262" href="#262">262</a>             LOG.debug(<span class="jxr_string">"\nfiscal year has been set"</span>);
<a class="jxr_linenumber" name="263" href="#263">263</a>             SLF.setFinancialSystemFunctionControlCode(flagTag);
<a class="jxr_linenumber" name="264" href="#264">264</a>             LOG.debug(<span class="jxr_string">"\nfunction code has been set"</span>);
<a class="jxr_linenumber" name="265" href="#265">265</a>             SLF.setVersionNumber(DEFAULT_VERSION_NUMBER);
<a class="jxr_linenumber" name="266" href="#266">266</a>             LOG.debug(String.format(<span class="jxr_string">"\nversion number set to %d"</span>, SLF.getVersionNumber()));
<a class="jxr_linenumber" name="267" href="#267">267</a>             <strong class="jxr_keyword">if</strong> (flagTag.equals(BudgetConstructionConstants.BUDGET_CONSTRUCTION_GENESIS_RUNNING)) {
<a class="jxr_linenumber" name="268" href="#268">268</a>                 SLF.setFinancialSystemFunctionActiveIndicator(<strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="269" href="#269">269</a>             }
<a class="jxr_linenumber" name="270" href="#270">270</a>             <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="271" href="#271">271</a>                 <em class="jxr_comment">//               SLF.setFinancialSystemFunctionActiveIndicator(</em>
<a class="jxr_linenumber" name="272" href="#272">272</a>                 <em class="jxr_comment">//                       ((flagDefault == KFSConstants.ParameterValues.YES)? true : false));</em>
<a class="jxr_linenumber" name="273" href="#273">273</a>                 SLF.setFinancialSystemFunctionActiveIndicator(flagDefault);
<a class="jxr_linenumber" name="274" href="#274">274</a>             }
<a class="jxr_linenumber" name="275" href="#275">275</a>             LOG.debug(<span class="jxr_string">"\nabout to store the result"</span>);
<a class="jxr_linenumber" name="276" href="#276">276</a>             getPersistenceBrokerTemplate().store(SLF);
<a class="jxr_linenumber" name="277" href="#277">277</a>         }
<a class="jxr_linenumber" name="278" href="#278">278</a>     }
<a class="jxr_linenumber" name="279" href="#279">279</a> 
<a class="jxr_linenumber" name="280" href="#280">280</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setControlFlagsAtTheEndOfGenesis(Integer BaseYear) {
<a class="jxr_linenumber" name="281" href="#281">281</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="282" href="#282">282</a>         resetExistingFlags(BaseYear, BCConstants.CURRENT_FSCL_YR_CTRL_FLAGS);
<a class="jxr_linenumber" name="283" href="#283">283</a>         resetExistingFlags(RequestYear, BCConstants.NEXT_FSCL_YR_CTRL_FLAGS_AFTER_GENESIS);
<a class="jxr_linenumber" name="284" href="#284">284</a>     }
<a class="jxr_linenumber" name="285" href="#285">285</a> 
<a class="jxr_linenumber" name="286" href="#286">286</a>     <em class="jxr_comment">//  this method just reads the existing flags and changes their values</em>
<a class="jxr_linenumber" name="287" href="#287">287</a>     <em class="jxr_comment">//  based on the configuration constants</em>
<a class="jxr_linenumber" name="288" href="#288">288</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> resetExistingFlags(Integer Year, HashMap&lt;String, String&gt; configValues) {
<a class="jxr_linenumber" name="289" href="#289">289</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="290" href="#290">290</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, Year);
<a class="jxr_linenumber" name="291" href="#291">291</a>         QueryByCriteria queryID = <strong class="jxr_keyword">new</strong> QueryByCriteria(FiscalYearFunctionControl.<strong class="jxr_keyword">class</strong>, criteriaID);
<a class="jxr_linenumber" name="292" href="#292">292</a>         Iterator Results = getPersistenceBrokerTemplate().getIteratorByQuery(queryID);
<a class="jxr_linenumber" name="293" href="#293">293</a>         <strong class="jxr_keyword">while</strong> (Results.hasNext()) {
<a class="jxr_linenumber" name="294" href="#294">294</a>             LOG.debug(<span class="jxr_string">"\nbefore call to next() and cast"</span>);
<a class="jxr_linenumber" name="295" href="#295">295</a>             <a href="../../../../../../../../org/kuali/kfs/fp/businessobject/FiscalYearFunctionControl.html">FiscalYearFunctionControl</a> SLF = (FiscalYearFunctionControl) Results.next();
<a class="jxr_linenumber" name="296" href="#296">296</a>             LOG.debug(<span class="jxr_string">"\nafter call to next()"</span>);
<a class="jxr_linenumber" name="297" href="#297">297</a>             String mapKey = SLF.getFinancialSystemFunctionControlCode();
<a class="jxr_linenumber" name="298" href="#298">298</a>             String newValue = configValues.get(mapKey);
<a class="jxr_linenumber" name="299" href="#299">299</a>             SLF.setFinancialSystemFunctionActiveIndicator(((newValue.equals(ParameterValues.YES)) ? <strong class="jxr_keyword">true</strong> : false));
<a class="jxr_linenumber" name="300" href="#300">300</a>             LOG.debug(<span class="jxr_string">"\nabout to store the result"</span>);
<a class="jxr_linenumber" name="301" href="#301">301</a>             getPersistenceBrokerTemplate().store(SLF);
<a class="jxr_linenumber" name="302" href="#302">302</a>             LOG.debug(<span class="jxr_string">"\nafter store"</span>);
<a class="jxr_linenumber" name="303" href="#303">303</a>         }
<a class="jxr_linenumber" name="304" href="#304">304</a>     }
<a class="jxr_linenumber" name="305" href="#305">305</a> 
<a class="jxr_linenumber" name="306" href="#306">306</a>     <em class="jxr_comment">/*</em>
<a class="jxr_linenumber" name="307" href="#307">307</a> <em class="jxr_comment">     *  ****************************************************************  </em>
<a class="jxr_linenumber" name="308" href="#308">308</a> <em class="jxr_comment">     *  (2) intialization for genesis                                  *</em>
<a class="jxr_linenumber" name="309" href="#309">309</a> <em class="jxr_comment">     *  these methods clean out the PBGL and document tables.          *</em>
<a class="jxr_linenumber" name="310" href="#310">310</a> <em class="jxr_comment">     *  BC only allows one fiscal year at a time                       *</em>
<a class="jxr_linenumber" name="311" href="#311">311</a> <em class="jxr_comment">     *  (this could be modified to clear things out by fiscal year)    *</em>
<a class="jxr_linenumber" name="312" href="#312">312</a> <em class="jxr_comment">     *  it should be modified to add more tables                       * </em>
<a class="jxr_linenumber" name="313" href="#313">313</a> <em class="jxr_comment">     *                                                                 *</em>
<a class="jxr_linenumber" name="314" href="#314">314</a> <em class="jxr_comment">     *  NOTE (IMPORTANT):                                              *</em>
<a class="jxr_linenumber" name="315" href="#315">315</a> <em class="jxr_comment">     *  In order to do a bulk delete, we MUST use deleteByQuery.  The  *</em>
<a class="jxr_linenumber" name="316" href="#316">316</a> <em class="jxr_comment">     *  only alternative is to fetch each existing row and delete it,  *</em>
<a class="jxr_linenumber" name="317" href="#317">317</a> <em class="jxr_comment">     *  one at a time.  This is unrealistic in a batch process dealing *</em>
<a class="jxr_linenumber" name="318" href="#318">318</a> <em class="jxr_comment">     *  with many rows. deleteByQuery does NOT "synchronize" the cache:*</em>
<a class="jxr_linenumber" name="319" href="#319">319</a> <em class="jxr_comment">     *  the deleted rows remain in the cache and will be fetched on a  *</em>
<a class="jxr_linenumber" name="320" href="#320">320</a> <em class="jxr_comment">     *  subsequent database call if they fit the criteria.  The OJB    *</em>
<a class="jxr_linenumber" name="321" href="#321">321</a> <em class="jxr_comment">     *  documentation explicitly states this.  So, after a             *</em>
<a class="jxr_linenumber" name="322" href="#322">322</a> <em class="jxr_comment">     *  deleteByQuery we need to call clearCache.  This will not remove*</em>
<a class="jxr_linenumber" name="323" href="#323">323</a> <em class="jxr_comment">     *  instantiated objects but will remove the database rows that    *</em>
<a class="jxr_linenumber" name="324" href="#324">324</a> <em class="jxr_comment">     *  were used to build them.  One consequence is that every store  *</em>
<a class="jxr_linenumber" name="325" href="#325">325</a> <em class="jxr_comment">     *  of an object that was instantiated before the cache was cleared*</em>
<a class="jxr_linenumber" name="326" href="#326">326</a> <em class="jxr_comment">     *  will generate a select on the first key field (to test whether *</em>
<a class="jxr_linenumber" name="327" href="#327">327</a> <em class="jxr_comment">     *  the object exists) and then an INSERT if it does not or an     *</em>
<a class="jxr_linenumber" name="328" href="#328">328</a> <em class="jxr_comment">     *  UPDATE if it does.  This same process happens if on changes the*</em>
<a class="jxr_linenumber" name="329" href="#329">329</a> <em class="jxr_comment">     *  key (for example, the Fiscal Year) of an instantiated object.  *  </em>
<a class="jxr_linenumber" name="330" href="#330">330</a> <em class="jxr_comment">     *  ****************************************************************</em>
<a class="jxr_linenumber" name="331" href="#331">331</a> <em class="jxr_comment">     */</em>
<a class="jxr_linenumber" name="332" href="#332">332</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> clearDBForGenesis(Integer BaseYear) {
<a class="jxr_linenumber" name="333" href="#333">333</a>         clearBudgetConstructionAdministrativePost();
<a class="jxr_linenumber" name="334" href="#334">334</a>         clearBudgetConstructionIntendedIncumbent();
<a class="jxr_linenumber" name="335" href="#335">335</a>         <em class="jxr_comment">//  the order is important because of referential integrity in the database</em>
<a class="jxr_linenumber" name="336" href="#336">336</a>         clearBothYearsBCSF(BaseYear);
<a class="jxr_linenumber" name="337" href="#337">337</a>         clearBothYearsBudgetConstructionAppointmentFundingReason(BaseYear);
<a class="jxr_linenumber" name="338" href="#338">338</a>         clearBothYearsPendingApptFunding(BaseYear);
<a class="jxr_linenumber" name="339" href="#339">339</a>         clearBothYearsBCPosition(BaseYear);
<a class="jxr_linenumber" name="340" href="#340">340</a>         <em class="jxr_comment">//  the calling order is important because of referential integrity in the </em>
<a class="jxr_linenumber" name="341" href="#341">341</a>         <em class="jxr_comment">//  database</em>
<a class="jxr_linenumber" name="342" href="#342">342</a>         clearBothYearsPBGL(BaseYear);
<a class="jxr_linenumber" name="343" href="#343">343</a>         clearBothYearsHeaders(BaseYear);
<a class="jxr_linenumber" name="344" href="#344">344</a>     }
<a class="jxr_linenumber" name="345" href="#345">345</a> 
<a class="jxr_linenumber" name="346" href="#346">346</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearBudgetConstructionAdministrativePost() {
<a class="jxr_linenumber" name="347" href="#347">347</a>         QueryByCriteria queryId = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionAdministrativePost.<strong class="jxr_keyword">class</strong>, QueryByCriteria.CRITERIA_SELECT_ALL);
<a class="jxr_linenumber" name="348" href="#348">348</a>         getPersistenceBrokerTemplate().deleteByQuery(queryId);
<a class="jxr_linenumber" name="349" href="#349">349</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="350" href="#350">350</a>     }
<a class="jxr_linenumber" name="351" href="#351">351</a> 
<a class="jxr_linenumber" name="352" href="#352">352</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearBaseYearBudgetConstructionAppointmentFundingReason(Integer BaseYear) {
<a class="jxr_linenumber" name="353" href="#353">353</a>         Criteria criteriaId = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="354" href="#354">354</a>         criteriaId.addColumnEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear);
<a class="jxr_linenumber" name="355" href="#355">355</a>         QueryByCriteria queryId = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionAppointmentFundingReason.<strong class="jxr_keyword">class</strong>, criteriaId);
<a class="jxr_linenumber" name="356" href="#356">356</a>         getPersistenceBrokerTemplate().deleteByQuery(queryId);
<a class="jxr_linenumber" name="357" href="#357">357</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="358" href="#358">358</a>     }
<a class="jxr_linenumber" name="359" href="#359">359</a> 
<a class="jxr_linenumber" name="360" href="#360">360</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearBothYearsBudgetConstructionAppointmentFundingReason(Integer BaseYear) {
<a class="jxr_linenumber" name="361" href="#361">361</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="362" href="#362">362</a>         Criteria criteriaId = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="363" href="#363">363</a>         criteriaId.addBetween(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear, RequestYear);
<a class="jxr_linenumber" name="364" href="#364">364</a>         QueryByCriteria queryId = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionAppointmentFundingReason.<strong class="jxr_keyword">class</strong>, criteriaId);
<a class="jxr_linenumber" name="365" href="#365">365</a>         getPersistenceBrokerTemplate().deleteByQuery(queryId);
<a class="jxr_linenumber" name="366" href="#366">366</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="367" href="#367">367</a>     }
<a class="jxr_linenumber" name="368" href="#368">368</a> 
<a class="jxr_linenumber" name="369" href="#369">369</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearBudgetConstructionAppointmentFundingReason() {
<a class="jxr_linenumber" name="370" href="#370">370</a>         QueryByCriteria queryId = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionAppointmentFundingReason.<strong class="jxr_keyword">class</strong>, QueryByCriteria.CRITERIA_SELECT_ALL);
<a class="jxr_linenumber" name="371" href="#371">371</a>         getPersistenceBrokerTemplate().deleteByQuery(queryId);
<a class="jxr_linenumber" name="372" href="#372">372</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="373" href="#373">373</a>     }
<a class="jxr_linenumber" name="374" href="#374">374</a> 
<a class="jxr_linenumber" name="375" href="#375">375</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearRequestYearBudgetConstructionAppointmentFundingReason(Integer BaseYear) {
<a class="jxr_linenumber" name="376" href="#376">376</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="377" href="#377">377</a>         Criteria criteriaId = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="378" href="#378">378</a>         criteriaId.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, RequestYear);
<a class="jxr_linenumber" name="379" href="#379">379</a>         QueryByCriteria queryId = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionAppointmentFundingReason.<strong class="jxr_keyword">class</strong>, criteriaId);
<a class="jxr_linenumber" name="380" href="#380">380</a>         getPersistenceBrokerTemplate().deleteByQuery(queryId);
<a class="jxr_linenumber" name="381" href="#381">381</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="382" href="#382">382</a>     }
<a class="jxr_linenumber" name="383" href="#383">383</a> 
<a class="jxr_linenumber" name="384" href="#384">384</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearBaseYearBCSF(Integer BaseYear) {
<a class="jxr_linenumber" name="385" href="#385">385</a>         Criteria criteriaId = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="386" href="#386">386</a>         criteriaId.addColumnEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear);
<a class="jxr_linenumber" name="387" href="#387">387</a>         QueryByCriteria queryId = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionCalculatedSalaryFoundationTracker.<strong class="jxr_keyword">class</strong>, criteriaId);
<a class="jxr_linenumber" name="388" href="#388">388</a>         getPersistenceBrokerTemplate().deleteByQuery(queryId);
<a class="jxr_linenumber" name="389" href="#389">389</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="390" href="#390">390</a>     }
<a class="jxr_linenumber" name="391" href="#391">391</a> 
<a class="jxr_linenumber" name="392" href="#392">392</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearBothYearsBCSF(Integer BaseYear) {
<a class="jxr_linenumber" name="393" href="#393">393</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="394" href="#394">394</a>         Criteria criteriaId = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="395" href="#395">395</a>         criteriaId.addBetween(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear, RequestYear);
<a class="jxr_linenumber" name="396" href="#396">396</a>         QueryByCriteria queryId = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionCalculatedSalaryFoundationTracker.<strong class="jxr_keyword">class</strong>, criteriaId);
<a class="jxr_linenumber" name="397" href="#397">397</a>         getPersistenceBrokerTemplate().deleteByQuery(queryId);
<a class="jxr_linenumber" name="398" href="#398">398</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="399" href="#399">399</a>     }
<a class="jxr_linenumber" name="400" href="#400">400</a> 
<a class="jxr_linenumber" name="401" href="#401">401</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearBCSF() {
<a class="jxr_linenumber" name="402" href="#402">402</a>         QueryByCriteria queryId = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionCalculatedSalaryFoundationTracker.<strong class="jxr_keyword">class</strong>, QueryByCriteria.CRITERIA_SELECT_ALL);
<a class="jxr_linenumber" name="403" href="#403">403</a>         getPersistenceBrokerTemplate().deleteByQuery(queryId);
<a class="jxr_linenumber" name="404" href="#404">404</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="405" href="#405">405</a>     }
<a class="jxr_linenumber" name="406" href="#406">406</a> 
<a class="jxr_linenumber" name="407" href="#407">407</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearBudgetConstructionIntendedIncumbent() {
<a class="jxr_linenumber" name="408" href="#408">408</a>         QueryByCriteria queryId = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionIntendedIncumbent.<strong class="jxr_keyword">class</strong>, QueryByCriteria.CRITERIA_SELECT_ALL);
<a class="jxr_linenumber" name="409" href="#409">409</a>         getPersistenceBrokerTemplate().deleteByQuery(queryId);
<a class="jxr_linenumber" name="410" href="#410">410</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="411" href="#411">411</a>     }
<a class="jxr_linenumber" name="412" href="#412">412</a> 
<a class="jxr_linenumber" name="413" href="#413">413</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearBaseYearBCPosition(Integer BaseYear) {
<a class="jxr_linenumber" name="414" href="#414">414</a>         Criteria criteriaId = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="415" href="#415">415</a>         criteriaId.addColumnEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear);
<a class="jxr_linenumber" name="416" href="#416">416</a>         QueryByCriteria queryId = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionPosition.<strong class="jxr_keyword">class</strong>, criteriaId);
<a class="jxr_linenumber" name="417" href="#417">417</a>         getPersistenceBrokerTemplate().deleteByQuery(queryId);
<a class="jxr_linenumber" name="418" href="#418">418</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="419" href="#419">419</a>     }
<a class="jxr_linenumber" name="420" href="#420">420</a> 
<a class="jxr_linenumber" name="421" href="#421">421</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearBothYearsBCPosition(Integer BaseYear) {
<a class="jxr_linenumber" name="422" href="#422">422</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="423" href="#423">423</a>         Criteria criteriaId = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="424" href="#424">424</a>         criteriaId.addBetween(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear, RequestYear);
<a class="jxr_linenumber" name="425" href="#425">425</a>         QueryByCriteria queryId = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionPosition.<strong class="jxr_keyword">class</strong>, criteriaId);
<a class="jxr_linenumber" name="426" href="#426">426</a>         getPersistenceBrokerTemplate().deleteByQuery(queryId);
<a class="jxr_linenumber" name="427" href="#427">427</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="428" href="#428">428</a>     }
<a class="jxr_linenumber" name="429" href="#429">429</a> 
<a class="jxr_linenumber" name="430" href="#430">430</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearBCPosition() {
<a class="jxr_linenumber" name="431" href="#431">431</a>         QueryByCriteria queryId = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionPosition.<strong class="jxr_keyword">class</strong>, QueryByCriteria.CRITERIA_SELECT_ALL);
<a class="jxr_linenumber" name="432" href="#432">432</a>         getPersistenceBrokerTemplate().deleteByQuery(queryId);
<a class="jxr_linenumber" name="433" href="#433">433</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="434" href="#434">434</a>     }
<a class="jxr_linenumber" name="435" href="#435">435</a> 
<a class="jxr_linenumber" name="436" href="#436">436</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearRequestYearBCPosition(Integer BaseYear) {
<a class="jxr_linenumber" name="437" href="#437">437</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="438" href="#438">438</a>         Criteria criteriaId = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="439" href="#439">439</a>         criteriaId.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, RequestYear);
<a class="jxr_linenumber" name="440" href="#440">440</a>         QueryByCriteria queryId = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionPosition.<strong class="jxr_keyword">class</strong>, criteriaId);
<a class="jxr_linenumber" name="441" href="#441">441</a>         getPersistenceBrokerTemplate().deleteByQuery(queryId);
<a class="jxr_linenumber" name="442" href="#442">442</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="443" href="#443">443</a>     }
<a class="jxr_linenumber" name="444" href="#444">444</a> 
<a class="jxr_linenumber" name="445" href="#445">445</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearRequestYearBCSF(Integer BaseYear) {
<a class="jxr_linenumber" name="446" href="#446">446</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="447" href="#447">447</a>         Criteria criteriaId = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="448" href="#448">448</a>         criteriaId.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, RequestYear);
<a class="jxr_linenumber" name="449" href="#449">449</a>         QueryByCriteria queryId = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionCalculatedSalaryFoundationTracker.<strong class="jxr_keyword">class</strong>, criteriaId);
<a class="jxr_linenumber" name="450" href="#450">450</a>         getPersistenceBrokerTemplate().deleteByQuery(queryId);
<a class="jxr_linenumber" name="451" href="#451">451</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="452" href="#452">452</a>     }
<a class="jxr_linenumber" name="453" href="#453">453</a> 
<a class="jxr_linenumber" name="454" href="#454">454</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearBaseYearHeaders(Integer BaseYear) {
<a class="jxr_linenumber" name="455" href="#455">455</a>         Criteria criteriaId = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="456" href="#456">456</a>         criteriaId.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear);
<a class="jxr_linenumber" name="457" href="#457">457</a>         QueryByCriteria queryId = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionHeader.<strong class="jxr_keyword">class</strong>, criteriaId);
<a class="jxr_linenumber" name="458" href="#458">458</a>         getPersistenceBrokerTemplate().deleteByQuery(queryId);
<a class="jxr_linenumber" name="459" href="#459">459</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="460" href="#460">460</a>     }
<a class="jxr_linenumber" name="461" href="#461">461</a> 
<a class="jxr_linenumber" name="462" href="#462">462</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearBothYearsHeaders(Integer BaseYear) {
<a class="jxr_linenumber" name="463" href="#463">463</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="464" href="#464">464</a>         Criteria criteriaId = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="465" href="#465">465</a>         criteriaId.addBetween(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear, RequestYear);
<a class="jxr_linenumber" name="466" href="#466">466</a>         QueryByCriteria queryId = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionHeader.<strong class="jxr_keyword">class</strong>, criteriaId);
<a class="jxr_linenumber" name="467" href="#467">467</a>         getPersistenceBrokerTemplate().deleteByQuery(queryId);
<a class="jxr_linenumber" name="468" href="#468">468</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="469" href="#469">469</a>     }
<a class="jxr_linenumber" name="470" href="#470">470</a> 
<a class="jxr_linenumber" name="471" href="#471">471</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearHeaders() {
<a class="jxr_linenumber" name="472" href="#472">472</a>         QueryByCriteria queryId = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionHeader.<strong class="jxr_keyword">class</strong>, QueryByCriteria.CRITERIA_SELECT_ALL);
<a class="jxr_linenumber" name="473" href="#473">473</a>         getPersistenceBrokerTemplate().deleteByQuery(queryId);
<a class="jxr_linenumber" name="474" href="#474">474</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="475" href="#475">475</a>     }
<a class="jxr_linenumber" name="476" href="#476">476</a> 
<a class="jxr_linenumber" name="477" href="#477">477</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearBaseYearPBGL(Integer BaseYear) {
<a class="jxr_linenumber" name="478" href="#478">478</a>         <em class="jxr_comment">// the order here is mandated by referential integrity</em>
<a class="jxr_linenumber" name="479" href="#479">479</a>         <em class="jxr_comment">// remove rows from the base year from budget construction months</em>
<a class="jxr_linenumber" name="480" href="#480">480</a>         Criteria mnCriteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="481" href="#481">481</a>         mnCriteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear);
<a class="jxr_linenumber" name="482" href="#482">482</a>         QueryByCriteria mnQueryID = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionMonthly.<strong class="jxr_keyword">class</strong>, mnCriteriaID);
<a class="jxr_linenumber" name="483" href="#483">483</a>         getPersistenceBrokerTemplate().deleteByQuery(mnQueryID);
<a class="jxr_linenumber" name="484" href="#484">484</a>         <em class="jxr_comment">// remove rows from the basse year from budget construction general ledger</em>
<a class="jxr_linenumber" name="485" href="#485">485</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="486" href="#486">486</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear);
<a class="jxr_linenumber" name="487" href="#487">487</a>         QueryByCriteria queryID = <strong class="jxr_keyword">new</strong> QueryByCriteria(PendingBudgetConstructionGeneralLedger.<strong class="jxr_keyword">class</strong>, criteriaID);
<a class="jxr_linenumber" name="488" href="#488">488</a>         LOG.debug(String.format(<span class="jxr_string">"delete PBGL started at %tT for %d"</span>, dateTimeService.getCurrentDate(), BaseYear));
<a class="jxr_linenumber" name="489" href="#489">489</a>         getPersistenceBrokerTemplate().deleteByQuery(queryID);
<a class="jxr_linenumber" name="490" href="#490">490</a>         LOG.debug(String.format(<span class="jxr_string">"delete PBGL ended at %tT"</span>, dateTimeService.getCurrentDate()));
<a class="jxr_linenumber" name="491" href="#491">491</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="492" href="#492">492</a>     }
<a class="jxr_linenumber" name="493" href="#493">493</a> 
<a class="jxr_linenumber" name="494" href="#494">494</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearBothYearsPBGL(Integer BaseYear) {
<a class="jxr_linenumber" name="495" href="#495">495</a>         clearBaseYearPBGL(BaseYear);
<a class="jxr_linenumber" name="496" href="#496">496</a>         clearRequestYearPBGL(BaseYear);
<a class="jxr_linenumber" name="497" href="#497">497</a>     }
<a class="jxr_linenumber" name="498" href="#498">498</a> 
<a class="jxr_linenumber" name="499" href="#499">499</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearPBGL() {
<a class="jxr_linenumber" name="500" href="#500">500</a>         <em class="jxr_comment">// the order here is mandated by referential integrity</em>
<a class="jxr_linenumber" name="501" href="#501">501</a>         QueryByCriteria mnQueryId = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionMonthly.<strong class="jxr_keyword">class</strong>, QueryByCriteria.CRITERIA_SELECT_ALL);
<a class="jxr_linenumber" name="502" href="#502">502</a>         getPersistenceBrokerTemplate().deleteByQuery(mnQueryId);
<a class="jxr_linenumber" name="503" href="#503">503</a>         QueryByCriteria queryId = <strong class="jxr_keyword">new</strong> QueryByCriteria(PendingBudgetConstructionGeneralLedger.<strong class="jxr_keyword">class</strong>, QueryByCriteria.CRITERIA_SELECT_ALL);
<a class="jxr_linenumber" name="504" href="#504">504</a>         getPersistenceBrokerTemplate().deleteByQuery(queryId);
<a class="jxr_linenumber" name="505" href="#505">505</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="506" href="#506">506</a>     }
<a class="jxr_linenumber" name="507" href="#507">507</a> 
<a class="jxr_linenumber" name="508" href="#508">508</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearRequestYearPBGL(Integer BaseYear) {
<a class="jxr_linenumber" name="509" href="#509">509</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="510" href="#510">510</a>         <em class="jxr_comment">// the order here is mandated by referential integrity</em>
<a class="jxr_linenumber" name="511" href="#511">511</a>         <em class="jxr_comment">// remove rows from the request year from budget construction months</em>
<a class="jxr_linenumber" name="512" href="#512">512</a>         Criteria mnCriteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="513" href="#513">513</a>         mnCriteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, RequestYear);
<a class="jxr_linenumber" name="514" href="#514">514</a>         QueryByCriteria mnQueryID = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionMonthly.<strong class="jxr_keyword">class</strong>, mnCriteriaID);
<a class="jxr_linenumber" name="515" href="#515">515</a>         getPersistenceBrokerTemplate().deleteByQuery(mnQueryID);
<a class="jxr_linenumber" name="516" href="#516">516</a>         <em class="jxr_comment">// remove rows from the request year</em>
<a class="jxr_linenumber" name="517" href="#517">517</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="518" href="#518">518</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, RequestYear);
<a class="jxr_linenumber" name="519" href="#519">519</a>         QueryByCriteria queryID = <strong class="jxr_keyword">new</strong> QueryByCriteria(PendingBudgetConstructionGeneralLedger.<strong class="jxr_keyword">class</strong>, criteriaID);
<a class="jxr_linenumber" name="520" href="#520">520</a>         LOG.debug(String.format(<span class="jxr_string">"\ndelete PBGL started at %tT for %d"</span>, dateTimeService.getCurrentDate(), RequestYear));
<a class="jxr_linenumber" name="521" href="#521">521</a>         getPersistenceBrokerTemplate().deleteByQuery(queryID);
<a class="jxr_linenumber" name="522" href="#522">522</a>         LOG.debug(String.format(<span class="jxr_string">"\ndelete PBGL ended at %tT"</span>, dateTimeService.getCurrentDate()));
<a class="jxr_linenumber" name="523" href="#523">523</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="524" href="#524">524</a>     }
<a class="jxr_linenumber" name="525" href="#525">525</a> 
<a class="jxr_linenumber" name="526" href="#526">526</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearBaseYearPendingApptFunding(Integer BaseYear) {
<a class="jxr_linenumber" name="527" href="#527">527</a>         Criteria criteriaId = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="528" href="#528">528</a>         criteriaId.addColumnEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear);
<a class="jxr_linenumber" name="529" href="#529">529</a>         QueryByCriteria queryId = <strong class="jxr_keyword">new</strong> QueryByCriteria(PendingBudgetConstructionAppointmentFunding.<strong class="jxr_keyword">class</strong>, criteriaId);
<a class="jxr_linenumber" name="530" href="#530">530</a>         getPersistenceBrokerTemplate().deleteByQuery(queryId);
<a class="jxr_linenumber" name="531" href="#531">531</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="532" href="#532">532</a>     }
<a class="jxr_linenumber" name="533" href="#533">533</a> 
<a class="jxr_linenumber" name="534" href="#534">534</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearBothYearsPendingApptFunding(Integer BaseYear) {
<a class="jxr_linenumber" name="535" href="#535">535</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="536" href="#536">536</a>         Criteria criteriaId = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="537" href="#537">537</a>         criteriaId.addBetween(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear, RequestYear);
<a class="jxr_linenumber" name="538" href="#538">538</a>         QueryByCriteria queryId = <strong class="jxr_keyword">new</strong> QueryByCriteria(PendingBudgetConstructionAppointmentFunding.<strong class="jxr_keyword">class</strong>, criteriaId);
<a class="jxr_linenumber" name="539" href="#539">539</a>         getPersistenceBrokerTemplate().deleteByQuery(queryId);
<a class="jxr_linenumber" name="540" href="#540">540</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="541" href="#541">541</a>     }
<a class="jxr_linenumber" name="542" href="#542">542</a> 
<a class="jxr_linenumber" name="543" href="#543">543</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearPendingApptFunding() {
<a class="jxr_linenumber" name="544" href="#544">544</a>         QueryByCriteria queryId = <strong class="jxr_keyword">new</strong> QueryByCriteria(PendingBudgetConstructionAppointmentFunding.<strong class="jxr_keyword">class</strong>, QueryByCriteria.CRITERIA_SELECT_ALL);
<a class="jxr_linenumber" name="545" href="#545">545</a>         getPersistenceBrokerTemplate().deleteByQuery(queryId);
<a class="jxr_linenumber" name="546" href="#546">546</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="547" href="#547">547</a>     }
<a class="jxr_linenumber" name="548" href="#548">548</a> 
<a class="jxr_linenumber" name="549" href="#549">549</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearRequestYearPendingApptFunding(Integer BaseYear) {
<a class="jxr_linenumber" name="550" href="#550">550</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="551" href="#551">551</a>         Criteria criteriaId = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="552" href="#552">552</a>         criteriaId.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, RequestYear);
<a class="jxr_linenumber" name="553" href="#553">553</a>         QueryByCriteria queryId = <strong class="jxr_keyword">new</strong> QueryByCriteria(PendingBudgetConstructionAppointmentFunding.<strong class="jxr_keyword">class</strong>, criteriaId);
<a class="jxr_linenumber" name="554" href="#554">554</a>         getPersistenceBrokerTemplate().deleteByQuery(queryId);
<a class="jxr_linenumber" name="555" href="#555">555</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="556" href="#556">556</a>     }
<a class="jxr_linenumber" name="557" href="#557">557</a> 
<a class="jxr_linenumber" name="558" href="#558">558</a>     <em class="jxr_comment">/*<em class="jxr_comment"> </em></em>
<a class="jxr_linenumber" name="559" href="#559">559</a> <em class="jxr_comment">     *  ****************************************************************************</em>
<a class="jxr_linenumber" name="560" href="#560">560</a> <em class="jxr_comment">     *  (3) BC Document Creation                                                   *</em>
<a class="jxr_linenumber" name="561" href="#561">561</a> <em class="jxr_comment">     *  ****************************************************************************</em>
<a class="jxr_linenumber" name="562" href="#562">562</a> <em class="jxr_comment">     */</em>
<a class="jxr_linenumber" name="563" href="#563">563</a>     <em class="jxr_comment">/*</em>
<a class="jxr_linenumber" name="564" href="#564">564</a> <em class="jxr_comment">     *  A document number is created for each account/sub-account involved in budgdet construction.  </em>
<a class="jxr_linenumber" name="565" href="#565">565</a> <em class="jxr_comment">     *  These "documents" are not routed.  They are created and finalized in workflow in a single step. </em>
<a class="jxr_linenumber" name="566" href="#566">566</a> <em class="jxr_comment">     *  They serve two purposes.  First, the budget construction tool can use the workflow action tables to </em>
<a class="jxr_linenumber" name="567" href="#567">567</a> <em class="jxr_comment">     *  track the people who have edited each account/sub-account, and use the workflow notes tables to allow </em>
<a class="jxr_linenumber" name="568" href="#568">568</a> <em class="jxr_comment">     *  these editors to leave whatever comments they may wish to make.  Second, the general ledger entry </em>
<a class="jxr_linenumber" name="569" href="#569">569</a> <em class="jxr_comment">     *  table requires that every entry have a document number attached.  Assigning a document number to </em>
<a class="jxr_linenumber" name="570" href="#570">570</a> <em class="jxr_comment">     *  each account/sub-account in the budget allows us to load the budget to the general ledger with </em>
<a class="jxr_linenumber" name="571" href="#571">571</a> <em class="jxr_comment">     *  a document number that can be tracked in workflow as outlined above.</em>
<a class="jxr_linenumber" name="572" href="#572">572</a> <em class="jxr_comment">     *  </em>
<a class="jxr_linenumber" name="573" href="#573">573</a> <em class="jxr_comment">     *  An account/subaccount can get into budget construction in three ways.</em>
<a class="jxr_linenumber" name="574" href="#574">574</a> <em class="jxr_comment">     *  (1)  Someone can create a budget for it using the budget construction on-line tool.  Neither genesis nor </em>
<a class="jxr_linenumber" name="575" href="#575">575</a> <em class="jxr_comment">     *  the batch update process cares about this case, so it is irrelevant here.</em>
<a class="jxr_linenumber" name="576" href="#576">576</a> <em class="jxr_comment">     *  (2)  There is an existing base budget in the current fiscal year for the account/subaccount.  In this case,</em>
<a class="jxr_linenumber" name="577" href="#577">577</a> <em class="jxr_comment">     *  genesis and the batch update process will create a document for it in budget construction if one does not already </em>
<a class="jxr_linenumber" name="578" href="#578">578</a> <em class="jxr_comment">     *  exist (much of the code below involves looking at the GL and checking for existing documents for account/subaccounts with </em>
<a class="jxr_linenumber" name="579" href="#579">579</a> <em class="jxr_comment">     *  base budget in the GL.</em>
<a class="jxr_linenumber" name="580" href="#580">580</a> <em class="jxr_comment">     *  (3) There is no base budget in the GL, but for some reason there is a person in a budgeted position drawing pay in </em>
<a class="jxr_linenumber" name="581" href="#581">581</a> <em class="jxr_comment">     *  payroll.  In this case, if no document number exists, we will create one.  It will point to budget construction CSF tracker </em>
<a class="jxr_linenumber" name="582" href="#582">582</a> <em class="jxr_comment">     *  (i.e., payroll) base, but it will not have any base budget amounts in the budget construction general ledger.</em>
<a class="jxr_linenumber" name="583" href="#583">583</a> <em class="jxr_comment">     *</em>
<a class="jxr_linenumber" name="584" href="#584">584</a> <em class="jxr_comment">     *  NOTE: Kuali workflow went through a lot of iterations since this code was written.  I have tried to remove any comments </em>
<a class="jxr_linenumber" name="585" href="#585">585</a> <em class="jxr_comment">     *  that pertain to iterations other than the stable release 3 configuration, but I may have missed something.  Earlier iterations</em>
<a class="jxr_linenumber" name="586" href="#586">586</a> <em class="jxr_comment">     *  (a) used a lot of memory and (b) were at one point in a separate transaction.</em>
<a class="jxr_linenumber" name="587" href="#587">587</a> <em class="jxr_comment">     *  Because this code will have to deal with a remote workflow server in real life, it will be the slowest part of genesis.  We did </em>
<a class="jxr_linenumber" name="588" href="#588">588</a> <em class="jxr_comment">     *  not have a good test bed for thoroughly researching this issue, but based on extrapolation I believe the solution we came up with </em>
<a class="jxr_linenumber" name="589" href="#589">589</a> <em class="jxr_comment">     *  (going to "complete" status immediately in order to by-pass routing, then using workflow routines to read the actual workflow</em>
<a class="jxr_linenumber" name="590" href="#590">590</a> <em class="jxr_comment">     *  document tables and set all the dates to final and save the initial "action taken") will give acceptable performance.  </em>
<a class="jxr_linenumber" name="591" href="#591">591</a> <em class="jxr_comment">     */</em>
<a class="jxr_linenumber" name="592" href="#592">592</a> 
<a class="jxr_linenumber" name="593" href="#593">593</a>     <strong class="jxr_keyword">private</strong> HashSet&lt;String&gt; currentBCHeaderKeys = <strong class="jxr_keyword">new</strong> HashSet&lt;String&gt;(1);
<a class="jxr_linenumber" name="594" href="#594">594</a>     <em class="jxr_comment">// these routines are used to merge CSF and CSF Override</em>
<a class="jxr_linenumber" name="595" href="#595">595</a>     <strong class="jxr_keyword">private</strong> HashMap&lt;String, String[]&gt; CSFTrackerKeys = <strong class="jxr_keyword">new</strong> HashMap&lt;String, String[]&gt;(1);
<a class="jxr_linenumber" name="596" href="#596">596</a> 
<a class="jxr_linenumber" name="597" href="#597">597</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> createNewDocumentsCleanUp() {
<a class="jxr_linenumber" name="598" href="#598">598</a>         currentBCHeaderKeys.clear();
<a class="jxr_linenumber" name="599" href="#599">599</a>         CSFTrackerKeys.clear();
<a class="jxr_linenumber" name="600" href="#600">600</a>     }
<a class="jxr_linenumber" name="601" href="#601">601</a> 
<a class="jxr_linenumber" name="602" href="#602">602</a>     <em class="jxr_comment">// counters</em>
<a class="jxr_linenumber" name="603" href="#603">603</a>     Long documentsToCreateinNTS = <strong class="jxr_keyword">new</strong> Long(0);
<a class="jxr_linenumber" name="604" href="#604">604</a>     Long documentsSkippedinNTS = <strong class="jxr_keyword">new</strong> Long(0);
<a class="jxr_linenumber" name="605" href="#605">605</a>     Long documentsCreatedinNTS = <strong class="jxr_keyword">new</strong> Long(0);
<a class="jxr_linenumber" name="606" href="#606">606</a>     Long documentsCSFCreatedinNTS = <strong class="jxr_keyword">new</strong> Long(0);
<a class="jxr_linenumber" name="607" href="#607">607</a>     Long documentsGLCreatedinNTS = <strong class="jxr_keyword">new</strong> Long(0);
<a class="jxr_linenumber" name="608" href="#608">608</a> 
<a class="jxr_linenumber" name="609" href="#609">609</a>     Long proxyCandidatesReadinTS = <strong class="jxr_keyword">new</strong> Long(0);
<a class="jxr_linenumber" name="610" href="#610">610</a>     Long proxyBCHeadersCreatedinTS = <strong class="jxr_keyword">new</strong> Long(0);
<a class="jxr_linenumber" name="611" href="#611">611</a> 
<a class="jxr_linenumber" name="612" href="#612">612</a>     <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="613" href="#613">613</a>     <em class="jxr_comment">// this is the new document creation mechanism that works with embedded workflow</em>
<a class="jxr_linenumber" name="614" href="#614">614</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> createNewBCDocumentsFromGLCSF(Integer BaseYear, <strong class="jxr_keyword">boolean</strong> GLUpdatesAllowed, <strong class="jxr_keyword">boolean</strong> CSFUpdatesAllowed) {
<a class="jxr_linenumber" name="615" href="#615">615</a>         <strong class="jxr_keyword">if</strong> ((!GLUpdatesAllowed) &amp;&amp; (!CSFUpdatesAllowed)) {
<a class="jxr_linenumber" name="616" href="#616">616</a>             <em class="jxr_comment">// no new documents need to be created</em>
<a class="jxr_linenumber" name="617" href="#617">617</a>             <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="618" href="#618">618</a>         }
<a class="jxr_linenumber" name="619" href="#619">619</a>         <em class="jxr_comment">// take the count of header keys from the GL</em>
<a class="jxr_linenumber" name="620" href="#620">620</a>         setUpCurrentBCHeaderKeys(BaseYear);
<a class="jxr_linenumber" name="621" href="#621">621</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="622" href="#622">622</a>         <em class="jxr_comment">// fetch the keys currently in budget construction header</em>
<a class="jxr_linenumber" name="623" href="#623">623</a>         getCurrentBCHeaderKeys(BaseYear);
<a class="jxr_linenumber" name="624" href="#624">624</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="625" href="#625">625</a>         <em class="jxr_comment">//  we have to read the GL BALANCE (which is not proxy=true) to create</em>
<a class="jxr_linenumber" name="626" href="#626">626</a>         <em class="jxr_comment">//  new BC header objects.  we use a report query to avoid triggering</em>
<a class="jxr_linenumber" name="627" href="#627">627</a>         <em class="jxr_comment">//  nine separate reads for each row, and to avoid returning the entire</em>
<a class="jxr_linenumber" name="628" href="#628">628</a>         <em class="jxr_comment">//  field list when we only need a few fields.</em>
<a class="jxr_linenumber" name="629" href="#629">629</a>         <strong class="jxr_keyword">if</strong> (GLUpdatesAllowed) {
<a class="jxr_linenumber" name="630" href="#630">630</a>             getAndStoreCurrentGLBCHeaderCandidates(BaseYear);
<a class="jxr_linenumber" name="631" href="#631">631</a>         }
<a class="jxr_linenumber" name="632" href="#632">632</a>         <em class="jxr_comment">//  we also have to read CSF for any accounts with no base budget in GL BALANCE</em>
<a class="jxr_linenumber" name="633" href="#633">633</a>         <em class="jxr_comment">//  but which pay people in budgeted positions</em>
<a class="jxr_linenumber" name="634" href="#634">634</a>         <strong class="jxr_keyword">if</strong> (CSFUpdatesAllowed) {
<a class="jxr_linenumber" name="635" href="#635">635</a>             setUpCSFHashStructures(BaseYear);
<a class="jxr_linenumber" name="636" href="#636">636</a>             getCSFCandidateDocumentKeys(BaseYear);
<a class="jxr_linenumber" name="637" href="#637">637</a>             getCSFOverrideDeletedKeys(BaseYear);
<a class="jxr_linenumber" name="638" href="#638">638</a>             getCSFOverrideCandidateDocumentKeys(BaseYear);
<a class="jxr_linenumber" name="639" href="#639">639</a>             getAndStoreCurrentCSFBCHeaderCandidates(BaseYear);
<a class="jxr_linenumber" name="640" href="#640">640</a>         }
<a class="jxr_linenumber" name="641" href="#641">641</a>         createNewDocumentsCleanUp();
<a class="jxr_linenumber" name="642" href="#642">642</a>     }
<a class="jxr_linenumber" name="643" href="#643">643</a> 
<a class="jxr_linenumber" name="644" href="#644">644</a>     <em class="jxr_comment">//  here are the private methods that go with it      </em>
<a class="jxr_linenumber" name="645" href="#645">645</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> getAndStoreCurrentCSFBCHeaderCandidates(Integer BaseYear) {
<a class="jxr_linenumber" name="646" href="#646">646</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="647" href="#647">647</a>         <strong class="jxr_keyword">for</strong> (Map.Entry&lt;String, String[]&gt; newCSFDocs : CSFTrackerKeys.entrySet()) {
<a class="jxr_linenumber" name="648" href="#648">648</a>             <em class="jxr_comment">// all the CSF keys in the map require new documents</em>
<a class="jxr_linenumber" name="649" href="#649">649</a>             proxyCandidatesReadinTS = proxyCandidatesReadinTS + 1;
<a class="jxr_linenumber" name="650" href="#650">650</a>             String[] Results = newCSFDocs.getValue();
<a class="jxr_linenumber" name="651" href="#651">651</a>             <em class="jxr_comment">// set up the Budget Construction Header</em>
<a class="jxr_linenumber" name="652" href="#652">652</a>             <a href="../../../../../../../../org/kuali/kfs/module/bc/document/BudgetConstructionDocument.html">BudgetConstructionDocument</a> newBCHdr;
<a class="jxr_linenumber" name="653" href="#653">653</a>             <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="654" href="#654">654</a>                 newBCHdr = (BudgetConstructionDocument) documentService.getNewDocument(BCConstants.BUDGET_CONSTRUCTION_DOCUMENT_NAME);
<a class="jxr_linenumber" name="655" href="#655">655</a>             }
<a class="jxr_linenumber" name="656" href="#656">656</a>             <strong class="jxr_keyword">catch</strong> (WorkflowException wex) {
<a class="jxr_linenumber" name="657" href="#657">657</a>                 LOG.warn(String.format(<span class="jxr_string">"\nskipping creation of document for CSF key: %s %s %s \n(%s)\n"</span>, Results[0], Results[1], Results[2], wex.getMessage()));
<a class="jxr_linenumber" name="658" href="#658">658</a>                 wex.printStackTrace();
<a class="jxr_linenumber" name="659" href="#659">659</a>                 documentsSkippedinNTS = documentsSkippedinNTS + 1;
<a class="jxr_linenumber" name="660" href="#660">660</a>                 <strong class="jxr_keyword">continue</strong>;
<a class="jxr_linenumber" name="661" href="#661">661</a>             }
<a class="jxr_linenumber" name="662" href="#662">662</a>             newBCHdr.setUniversityFiscalYear(RequestYear);
<a class="jxr_linenumber" name="663" href="#663">663</a>             newBCHdr.setChartOfAccountsCode(Results[0]);
<a class="jxr_linenumber" name="664" href="#664">664</a>             newBCHdr.setAccountNumber(Results[1]);
<a class="jxr_linenumber" name="665" href="#665">665</a>             newBCHdr.setSubAccountNumber(Results[2]);
<a class="jxr_linenumber" name="666" href="#666">666</a>             <em class="jxr_comment">//  store the document</em>
<a class="jxr_linenumber" name="667" href="#667">667</a>             <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="668" href="#668">668</a>                 storeANewBCDocument(newBCHdr);
<a class="jxr_linenumber" name="669" href="#669">669</a>             }
<a class="jxr_linenumber" name="670" href="#670">670</a>             <strong class="jxr_keyword">catch</strong> (WorkflowException wex) {
<a class="jxr_linenumber" name="671" href="#671">671</a>                 LOG.warn(String.format(<span class="jxr_string">"\nskipping creation of document for CSF key: %s %s %s \n(%s)\n"</span>, newBCHdr.getChartOfAccounts(), newBCHdr.getAccountNumber(), newBCHdr.getSubAccountNumber(), wex.getMessage()));
<a class="jxr_linenumber" name="672" href="#672">672</a>                 wex.printStackTrace();
<a class="jxr_linenumber" name="673" href="#673">673</a>                 documentsSkippedinNTS = documentsSkippedinNTS + 1;
<a class="jxr_linenumber" name="674" href="#674">674</a>                 <strong class="jxr_keyword">continue</strong>;
<a class="jxr_linenumber" name="675" href="#675">675</a> 
<a class="jxr_linenumber" name="676" href="#676">676</a>             }
<a class="jxr_linenumber" name="677" href="#677">677</a>             documentsCSFCreatedinNTS = documentsCSFCreatedinNTS + 1;
<a class="jxr_linenumber" name="678" href="#678">678</a>             documentsCreatedinNTS = documentsCreatedinNTS + 1;
<a class="jxr_linenumber" name="679" href="#679">679</a>         }
<a class="jxr_linenumber" name="680" href="#680">680</a>     }
<a class="jxr_linenumber" name="681" href="#681">681</a> 
<a class="jxr_linenumber" name="682" href="#682">682</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> getAndStoreCurrentGLBCHeaderCandidates(Integer BaseYear) {
<a class="jxr_linenumber" name="683" href="#683">683</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="684" href="#684">684</a>         <em class="jxr_comment">// first build a document set from GL BALANCE</em>
<a class="jxr_linenumber" name="685" href="#685">685</a>         Criteria criteriaId = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="686" href="#686">686</a>         criteriaId.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear);
<a class="jxr_linenumber" name="687" href="#687">687</a>         criteriaId.addEqualTo(KFSPropertyConstants.BALANCE_TYPE_CODE, KFSConstants.BALANCE_TYPE_BASE_BUDGET);
<a class="jxr_linenumber" name="688" href="#688">688</a>         String newAttr = ColumnNames.BEGINNING_BALANCE + <span class="jxr_string">"+"</span> + ColumnNames.ANNUAL_BALANCE;
<a class="jxr_linenumber" name="689" href="#689">689</a>         criteriaId.addNotEqualTo(newAttr, 0);
<a class="jxr_linenumber" name="690" href="#690">690</a>         String[] queryAttr = { KFSPropertyConstants.CHART_OF_ACCOUNTS_CODE, KFSPropertyConstants.ACCOUNT_NUMBER, KFSPropertyConstants.SUB_ACCOUNT_NUMBER };
<a class="jxr_linenumber" name="691" href="#691">691</a>         ReportQueryByCriteria queryId = <strong class="jxr_keyword">new</strong> ReportQueryByCriteria(Balance.<strong class="jxr_keyword">class</strong>, queryAttr, criteriaId, <strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="692" href="#692">692</a>         Iterator RowsReturned = getPersistenceBrokerTemplate().getReportQueryIteratorByQuery(queryId);
<a class="jxr_linenumber" name="693" href="#693">693</a>         <strong class="jxr_keyword">while</strong> (RowsReturned.hasNext()) {
<a class="jxr_linenumber" name="694" href="#694">694</a>             proxyCandidatesReadinTS = proxyCandidatesReadinTS + 1;
<a class="jxr_linenumber" name="695" href="#695">695</a>             Object[] Results = (Object[]) RowsReturned.next();
<a class="jxr_linenumber" name="696" href="#696">696</a>             String testKey = ((String) Results[0]) + ((String) Results[1]) + ((String) Results[2]);
<a class="jxr_linenumber" name="697" href="#697">697</a>             <strong class="jxr_keyword">if</strong> (currentBCHeaderKeys.contains(testKey)) {
<a class="jxr_linenumber" name="698" href="#698">698</a>                 <em class="jxr_comment">// don't create a new row for anything with a current header</em>
<a class="jxr_linenumber" name="699" href="#699">699</a>                 <strong class="jxr_keyword">continue</strong>;
<a class="jxr_linenumber" name="700" href="#700">700</a>             }
<a class="jxr_linenumber" name="701" href="#701">701</a>             <em class="jxr_comment">// set up the Budget Construction Header</em>
<a class="jxr_linenumber" name="702" href="#702">702</a>             <a href="../../../../../../../../org/kuali/kfs/module/bc/document/BudgetConstructionDocument.html">BudgetConstructionDocument</a> newBCHdr;
<a class="jxr_linenumber" name="703" href="#703">703</a>             <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="704" href="#704">704</a>                 newBCHdr = (BudgetConstructionDocument) documentService.getNewDocument(BCConstants.BUDGET_CONSTRUCTION_DOCUMENT_NAME);
<a class="jxr_linenumber" name="705" href="#705">705</a>             }
<a class="jxr_linenumber" name="706" href="#706">706</a>             <strong class="jxr_keyword">catch</strong> (WorkflowException wex) {
<a class="jxr_linenumber" name="707" href="#707">707</a>                 LOG.warn(String.format(<span class="jxr_string">"\nskipping creation of document for GL key: %s %s %s \n(%s)\n"</span>, (String) Results[0], (String) Results[1], (String) Results[2], wex.getMessage()));
<a class="jxr_linenumber" name="708" href="#708">708</a>                 wex.printStackTrace();
<a class="jxr_linenumber" name="709" href="#709">709</a>                 documentsSkippedinNTS = documentsSkippedinNTS + 1;
<a class="jxr_linenumber" name="710" href="#710">710</a>                 <strong class="jxr_keyword">continue</strong>;
<a class="jxr_linenumber" name="711" href="#711">711</a>             }
<a class="jxr_linenumber" name="712" href="#712">712</a>             newBCHdr.setUniversityFiscalYear(RequestYear);
<a class="jxr_linenumber" name="713" href="#713">713</a>             newBCHdr.setChartOfAccountsCode((String) Results[0]);
<a class="jxr_linenumber" name="714" href="#714">714</a>             newBCHdr.setAccountNumber((String) Results[1]);
<a class="jxr_linenumber" name="715" href="#715">715</a>             newBCHdr.setSubAccountNumber((String) Results[2]);
<a class="jxr_linenumber" name="716" href="#716">716</a>             <em class="jxr_comment">//  store the document</em>
<a class="jxr_linenumber" name="717" href="#717">717</a>             <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="718" href="#718">718</a>                 storeANewBCDocument(newBCHdr);
<a class="jxr_linenumber" name="719" href="#719">719</a>             }
<a class="jxr_linenumber" name="720" href="#720">720</a>             <strong class="jxr_keyword">catch</strong> (WorkflowException wex) {
<a class="jxr_linenumber" name="721" href="#721">721</a>                 LOG.warn(String.format(<span class="jxr_string">"\nskipping creation of document for GL key: %s %s %s \n(%s)\n"</span>, newBCHdr.getChartOfAccounts(), newBCHdr.getAccountNumber(), newBCHdr.getSubAccountNumber(), wex.getMessage()));
<a class="jxr_linenumber" name="722" href="#722">722</a>                 wex.printStackTrace();
<a class="jxr_linenumber" name="723" href="#723">723</a>                 documentsSkippedinNTS = documentsSkippedinNTS + 1;
<a class="jxr_linenumber" name="724" href="#724">724</a>                 <strong class="jxr_keyword">continue</strong>;
<a class="jxr_linenumber" name="725" href="#725">725</a> 
<a class="jxr_linenumber" name="726" href="#726">726</a>             }
<a class="jxr_linenumber" name="727" href="#727">727</a>             documentsGLCreatedinNTS = documentsGLCreatedinNTS + 1;
<a class="jxr_linenumber" name="728" href="#728">728</a>             documentsCreatedinNTS = documentsCreatedinNTS + 1;
<a class="jxr_linenumber" name="729" href="#729">729</a>             <em class="jxr_comment">//  add this header to the current BC Header map</em>
<a class="jxr_linenumber" name="730" href="#730">730</a>             currentBCHeaderKeys.add(testKey);
<a class="jxr_linenumber" name="731" href="#731">731</a>         }
<a class="jxr_linenumber" name="732" href="#732">732</a>     }
<a class="jxr_linenumber" name="733" href="#733">733</a> 
<a class="jxr_linenumber" name="734" href="#734">734</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> getCSFCandidateDocumentKeys(Integer BaseYear) {
<a class="jxr_linenumber" name="735" href="#735">735</a>         Criteria criteriaId = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="736" href="#736">736</a>         criteriaId.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear);
<a class="jxr_linenumber" name="737" href="#737">737</a>         criteriaId.addEqualTo(KFSPropertyConstants.CSF_DELETE_CODE, BCConstants.ACTIVE_CSF_DELETE_CODE);
<a class="jxr_linenumber" name="738" href="#738">738</a>         String[] queryAttr = { KFSPropertyConstants.CHART_OF_ACCOUNTS_CODE, KFSPropertyConstants.ACCOUNT_NUMBER, KFSPropertyConstants.SUB_ACCOUNT_NUMBER };
<a class="jxr_linenumber" name="739" href="#739">739</a>         ReportQueryByCriteria queryId = <strong class="jxr_keyword">new</strong> ReportQueryByCriteria(CalculatedSalaryFoundationTracker.<strong class="jxr_keyword">class</strong>, queryAttr, criteriaId, <strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="740" href="#740">740</a>         Iterator rowsReturned = getPersistenceBrokerTemplate().getReportQueryIteratorByQuery(queryId);
<a class="jxr_linenumber" name="741" href="#741">741</a>         <em class="jxr_comment">// decide which keys from CSF need to create new documents</em>
<a class="jxr_linenumber" name="742" href="#742">742</a>         <em class="jxr_comment">// we have already created new documents for all the GL keys</em>
<a class="jxr_linenumber" name="743" href="#743">743</a>         <strong class="jxr_keyword">while</strong> (rowsReturned.hasNext()) {
<a class="jxr_linenumber" name="744" href="#744">744</a>             Object[] returnedRow = (Object[]) rowsReturned.next();
<a class="jxr_linenumber" name="745" href="#745">745</a>             String testKey = ((String) returnedRow[0]) + ((String) returnedRow[1]) + ((String) returnedRow[2]);
<a class="jxr_linenumber" name="746" href="#746">746</a>             <strong class="jxr_keyword">if</strong> (currentBCHeaderKeys.contains(testKey)) {
<a class="jxr_linenumber" name="747" href="#747">747</a>                 <em class="jxr_comment">//  there is no need to create a row for this key</em>
<a class="jxr_linenumber" name="748" href="#748">748</a>                 <strong class="jxr_keyword">continue</strong>;
<a class="jxr_linenumber" name="749" href="#749">749</a>             }
<a class="jxr_linenumber" name="750" href="#750">750</a>             String[] valueCSF = { (String) returnedRow[0], (String) returnedRow[1], (String) returnedRow[2] };
<a class="jxr_linenumber" name="751" href="#751">751</a>             CSFTrackerKeys.put(testKey, valueCSF);
<a class="jxr_linenumber" name="752" href="#752">752</a>         }
<a class="jxr_linenumber" name="753" href="#753">753</a>     }
<a class="jxr_linenumber" name="754" href="#754">754</a> 
<a class="jxr_linenumber" name="755" href="#755">755</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> getCSFOverrideCandidateDocumentKeys(Integer BaseYear) {
<a class="jxr_linenumber" name="756" href="#756">756</a>         Criteria criteriaId = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="757" href="#757">757</a>         criteriaId.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear);
<a class="jxr_linenumber" name="758" href="#758">758</a>         criteriaId.addEqualTo(KFSPropertyConstants.CSF_DELETE_CODE, BCConstants.ACTIVE_CSF_DELETE_CODE);
<a class="jxr_linenumber" name="759" href="#759">759</a>         criteriaId.addEqualTo(KFSPropertyConstants.ACTIVE, <strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="760" href="#760">760</a>         String[] queryAttr = { KFSPropertyConstants.CHART_OF_ACCOUNTS_CODE, KFSPropertyConstants.ACCOUNT_NUMBER, KFSPropertyConstants.SUB_ACCOUNT_NUMBER };
<a class="jxr_linenumber" name="761" href="#761">761</a>         ReportQueryByCriteria queryId = <strong class="jxr_keyword">new</strong> ReportQueryByCriteria(CalculatedSalaryFoundationTrackerOverride.<strong class="jxr_keyword">class</strong>, queryAttr, criteriaId, <strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="762" href="#762">762</a>         Iterator rowsReturned = getPersistenceBrokerTemplate().getReportQueryIteratorByQuery(queryId);
<a class="jxr_linenumber" name="763" href="#763">763</a>         <em class="jxr_comment">// decide which keys from CSF override need to create new documents</em>
<a class="jxr_linenumber" name="764" href="#764">764</a>         <em class="jxr_comment">// we have already read in the CSF keys--existing keys need not be replaced</em>
<a class="jxr_linenumber" name="765" href="#765">765</a>         <em class="jxr_comment">// new active keys from CSF override should be added</em>
<a class="jxr_linenumber" name="766" href="#766">766</a>         <strong class="jxr_keyword">while</strong> (rowsReturned.hasNext()) {
<a class="jxr_linenumber" name="767" href="#767">767</a>             Object[] returnedRow = (Object[]) rowsReturned.next();
<a class="jxr_linenumber" name="768" href="#768">768</a>             String testKey = ((String) returnedRow[0]) + ((String) returnedRow[1]) + ((String) returnedRow[2]);
<a class="jxr_linenumber" name="769" href="#769">769</a>             <strong class="jxr_keyword">if</strong> (currentBCHeaderKeys.contains(testKey)) {
<a class="jxr_linenumber" name="770" href="#770">770</a>                 <em class="jxr_comment">//  there is no need to create a row for this key</em>
<a class="jxr_linenumber" name="771" href="#771">771</a>                 <em class="jxr_comment">//  it is already in the base budget in the GL</em>
<a class="jxr_linenumber" name="772" href="#772">772</a>                 <strong class="jxr_keyword">continue</strong>;
<a class="jxr_linenumber" name="773" href="#773">773</a>             }
<a class="jxr_linenumber" name="774" href="#774">774</a>             String[] valueCSF = { (String) returnedRow[0], (String) returnedRow[1], (String) returnedRow[2] };
<a class="jxr_linenumber" name="775" href="#775">775</a>             CSFTrackerKeys.put(testKey, valueCSF);
<a class="jxr_linenumber" name="776" href="#776">776</a>         }
<a class="jxr_linenumber" name="777" href="#777">777</a>     }
<a class="jxr_linenumber" name="778" href="#778">778</a> 
<a class="jxr_linenumber" name="779" href="#779">779</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> getCSFOverrideDeletedKeys(Integer BaseYear) {
<a class="jxr_linenumber" name="780" href="#780">780</a>         Criteria criteriaId = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="781" href="#781">781</a>         criteriaId.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear);
<a class="jxr_linenumber" name="782" href="#782">782</a>         criteriaId.addNotEqualTo(KFSPropertyConstants.CSF_DELETE_CODE, BCConstants.ACTIVE_CSF_DELETE_CODE);
<a class="jxr_linenumber" name="783" href="#783">783</a>         criteriaId.addEqualTo(KFSPropertyConstants.ACTIVE, <strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="784" href="#784">784</a>         String[] queryAttr = { KFSPropertyConstants.CHART_OF_ACCOUNTS_CODE, KFSPropertyConstants.ACCOUNT_NUMBER, KFSPropertyConstants.SUB_ACCOUNT_NUMBER };
<a class="jxr_linenumber" name="785" href="#785">785</a>         ReportQueryByCriteria queryId = <strong class="jxr_keyword">new</strong> ReportQueryByCriteria(CalculatedSalaryFoundationTrackerOverride.<strong class="jxr_keyword">class</strong>, queryAttr, criteriaId, <strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="786" href="#786">786</a>         Iterator rowsReturned = getPersistenceBrokerTemplate().getReportQueryIteratorByQuery(queryId);
<a class="jxr_linenumber" name="787" href="#787">787</a>         <em class="jxr_comment">// decide which keys from CSF override need to create new documents</em>
<a class="jxr_linenumber" name="788" href="#788">788</a>         <em class="jxr_comment">// we have already read in the CSF keys--any overrides of existing CSF</em>
<a class="jxr_linenumber" name="789" href="#789">789</a>         <em class="jxr_comment">// which carry a delete code should be tentatively removed CSF key table</em>
<a class="jxr_linenumber" name="790" href="#790">790</a>         <strong class="jxr_keyword">while</strong> (rowsReturned.hasNext()) {
<a class="jxr_linenumber" name="791" href="#791">791</a>             Object[] returnedRow = (Object[]) rowsReturned.next();
<a class="jxr_linenumber" name="792" href="#792">792</a>             String testKey = ((String) returnedRow[0]) + ((String) returnedRow[1]) + ((String) returnedRow[2]);
<a class="jxr_linenumber" name="793" href="#793">793</a>             <strong class="jxr_keyword">if</strong> (currentBCHeaderKeys.contains(testKey)) {
<a class="jxr_linenumber" name="794" href="#794">794</a>                 <em class="jxr_comment">//  this key is in the GL base budget</em>
<a class="jxr_linenumber" name="795" href="#795">795</a>                 <em class="jxr_comment">//  it should create a document whether anyone is paid from it</em>
<a class="jxr_linenumber" name="796" href="#796">796</a>                 <em class="jxr_comment">//  or not</em>
<a class="jxr_linenumber" name="797" href="#797">797</a>                 <strong class="jxr_keyword">continue</strong>;
<a class="jxr_linenumber" name="798" href="#798">798</a>             }
<a class="jxr_linenumber" name="799" href="#799">799</a>             <strong class="jxr_keyword">if</strong> (CSFTrackerKeys.containsKey(testKey)) {
<a class="jxr_linenumber" name="800" href="#800">800</a>                 <em class="jxr_comment">// an override row deletes a key in CSF</em>
<a class="jxr_linenumber" name="801" href="#801">801</a>                 <em class="jxr_comment">// we tentatively remove this key from the map</em>
<a class="jxr_linenumber" name="802" href="#802">802</a>                 <em class="jxr_comment">// if there is an active override row for this key as well, it </em>
<a class="jxr_linenumber" name="803" href="#803">803</a>                 <em class="jxr_comment">// will be restored when we read the active override keys</em>
<a class="jxr_linenumber" name="804" href="#804">804</a>                 CSFTrackerKeys.remove(testKey);
<a class="jxr_linenumber" name="805" href="#805">805</a>             }
<a class="jxr_linenumber" name="806" href="#806">806</a>         }
<a class="jxr_linenumber" name="807" href="#807">807</a>     }
<a class="jxr_linenumber" name="808" href="#808">808</a> 
<a class="jxr_linenumber" name="809" href="#809">809</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> getCurrentBCHeaderKeys(Integer BaseYear) {
<a class="jxr_linenumber" name="810" href="#810">810</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="811" href="#811">811</a>         Criteria criteriaId = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="812" href="#812">812</a>         Iterator&lt;Object[]&gt; Results;
<a class="jxr_linenumber" name="813" href="#813">813</a>         criteriaId.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, RequestYear);
<a class="jxr_linenumber" name="814" href="#814">814</a>         String[] selectList = { KFSPropertyConstants.CHART_OF_ACCOUNTS_CODE, KFSPropertyConstants.ACCOUNT_NUMBER, KFSPropertyConstants.SUB_ACCOUNT_NUMBER };
<a class="jxr_linenumber" name="815" href="#815">815</a>         ReportQueryByCriteria queryId = <strong class="jxr_keyword">new</strong> ReportQueryByCriteria(BudgetConstructionHeader.<strong class="jxr_keyword">class</strong>, selectList, criteriaId);
<a class="jxr_linenumber" name="816" href="#816">816</a>         Results = getPersistenceBrokerTemplate().getReportQueryIteratorByQuery(queryId);
<a class="jxr_linenumber" name="817" href="#817">817</a> 
<a class="jxr_linenumber" name="818" href="#818">818</a>         <strong class="jxr_keyword">while</strong> (Results.hasNext()) {
<a class="jxr_linenumber" name="819" href="#819">819</a>             Object[] returnedRow = Results.next();
<a class="jxr_linenumber" name="820" href="#820">820</a>             currentBCHeaderKeys.add(((String) returnedRow[0]) + ((String) returnedRow[1]) + ((String) returnedRow[2]));
<a class="jxr_linenumber" name="821" href="#821">821</a>         }
<a class="jxr_linenumber" name="822" href="#822">822</a>     }
<a class="jxr_linenumber" name="823" href="#823">823</a> 
<a class="jxr_linenumber" name="824" href="#824">824</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setUpCSFHashStructures(Integer BaseYear) {
<a class="jxr_linenumber" name="825" href="#825">825</a>         <em class="jxr_comment">// these are the potential document keys in the CSF tracker</em>
<a class="jxr_linenumber" name="826" href="#826">826</a>         Criteria criteriaId = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="827" href="#827">827</a>         criteriaId.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear);
<a class="jxr_linenumber" name="828" href="#828">828</a>         criteriaId.addEqualTo(KFSPropertyConstants.CSF_DELETE_CODE, BCConstants.ACTIVE_CSF_DELETE_CODE);
<a class="jxr_linenumber" name="829" href="#829">829</a>         String[] propertyString = { KFSPropertyConstants.CHART_OF_ACCOUNTS_CODE, KFSPropertyConstants.ACCOUNT_NUMBER, KFSPropertyConstants.SUB_ACCOUNT_NUMBER };
<a class="jxr_linenumber" name="830" href="#830">830</a>         CSFTrackerKeys = <strong class="jxr_keyword">new</strong> HashMap&lt;String, String[]&gt;(hashObjectSize(CalculatedSalaryFoundationTracker.<strong class="jxr_keyword">class</strong>, criteriaId, propertyString));
<a class="jxr_linenumber" name="831" href="#831">831</a>     }
<a class="jxr_linenumber" name="832" href="#832">832</a> 
<a class="jxr_linenumber" name="833" href="#833">833</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setUpCurrentBCHeaderKeys(Integer BaseYear) {
<a class="jxr_linenumber" name="834" href="#834">834</a>         <em class="jxr_comment">// the BC header keys should be roughly the same as the GL balance BB keys</em>
<a class="jxr_linenumber" name="835" href="#835">835</a>         <em class="jxr_comment">// if any new keys are introduced from CSF, it means that there is money</em>
<a class="jxr_linenumber" name="836" href="#836">836</a>         <em class="jxr_comment">// in the payroll that has NOT been budgeted.  this should be a rare </em>
<a class="jxr_linenumber" name="837" href="#837">837</a>         <em class="jxr_comment">// occurrence.  </em>
<a class="jxr_linenumber" name="838" href="#838">838</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="839" href="#839">839</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear);
<a class="jxr_linenumber" name="840" href="#840">840</a>         criteriaID.addEqualTo(KFSPropertyConstants.BALANCE_TYPE_CODE, KFSConstants.BALANCE_TYPE_BASE_BUDGET);
<a class="jxr_linenumber" name="841" href="#841">841</a>         String[] propertyString = { KFSPropertyConstants.CHART_OF_ACCOUNTS_CODE, KFSPropertyConstants.ACCOUNT_NUMBER, KFSPropertyConstants.SUB_ACCOUNT_NUMBER };
<a class="jxr_linenumber" name="842" href="#842">842</a>         currentBCHeaderKeys = <strong class="jxr_keyword">new</strong> HashSet&lt;String&gt;(hashObjectSize(Balance.<strong class="jxr_keyword">class</strong>, criteriaID, propertyString));
<a class="jxr_linenumber" name="843" href="#843">843</a>     }
<a class="jxr_linenumber" name="844" href="#844">844</a> 
<a class="jxr_linenumber" name="845" href="#845">845</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> storeANewBCDocument(<a href="../../../../../../../../org/kuali/kfs/module/bc/document/BudgetConstructionDocument.html">BudgetConstructionDocument</a> newBCHdr) <strong class="jxr_keyword">throws</strong> WorkflowException {
<a class="jxr_linenumber" name="846" href="#846">846</a>         newBCHdr.setOrganizationLevelChartOfAccountsCode(BCConstants.INITIAL_ORGANIZATION_LEVEL_CHART_OF_ACCOUNTS_CODE);
<a class="jxr_linenumber" name="847" href="#847">847</a>         newBCHdr.setOrganizationLevelOrganizationCode(BCConstants.INITIAL_ORGANIZATION_LEVEL_ORGANIZATION_CODE);
<a class="jxr_linenumber" name="848" href="#848">848</a>         newBCHdr.setOrganizationLevelCode(BCConstants.INITIAL_ORGANIZATION_LEVEL_CODE);
<a class="jxr_linenumber" name="849" href="#849">849</a>         newBCHdr.setBudgetTransactionLockUserIdentifier(BCConstants.DEFAULT_BUDGET_HEADER_LOCK_IDS);
<a class="jxr_linenumber" name="850" href="#850">850</a>         newBCHdr.setBudgetLockUserIdentifier(BCConstants.DEFAULT_BUDGET_HEADER_LOCK_IDS);
<a class="jxr_linenumber" name="851" href="#851">851</a>         newBCHdr.setVersionNumber(DEFAULT_VERSION_NUMBER);
<a class="jxr_linenumber" name="852" href="#852">852</a>         <a href="../../../../../../../../org/kuali/kfs/sys/businessobject/FinancialSystemDocumentHeader.html">FinancialSystemDocumentHeader</a> kualiDocumentHeader = newBCHdr.getDocumentHeader();
<a class="jxr_linenumber" name="853" href="#853">853</a>         newBCHdr.setDocumentNumber(newBCHdr.getDocumentHeader().getDocumentNumber());
<a class="jxr_linenumber" name="854" href="#854">854</a>         kualiDocumentHeader.setOrganizationDocumentNumber(newBCHdr.getUniversityFiscalYear().toString());
<a class="jxr_linenumber" name="855" href="#855">855</a>         kualiDocumentHeader.setFinancialDocumentStatusCode(KFSConstants.INITIAL_KUALI_DOCUMENT_STATUS_CD);
<a class="jxr_linenumber" name="856" href="#856">856</a>         kualiDocumentHeader.setFinancialDocumentTotalAmount(KualiDecimal.ZERO);
<a class="jxr_linenumber" name="857" href="#857">857</a>         kualiDocumentHeader.setDocumentDescription(String.format(<span class="jxr_string">"%s %d %s %s"</span>, BCConstants.BUDGET_CONSTRUCTION_DOCUMENT_DESCRIPTION, newBCHdr.getUniversityFiscalYear(), newBCHdr.getChartOfAccountsCode(), newBCHdr.getAccountNumber()));
<a class="jxr_linenumber" name="858" href="#858">858</a>         kualiDocumentHeader.setExplanation(BCConstants.BUDGET_CONSTRUCTION_DOCUMENT_DESCRIPTION);
<a class="jxr_linenumber" name="859" href="#859">859</a>         getPersistenceBrokerTemplate().store(newBCHdr);
<a class="jxr_linenumber" name="860" href="#860">860</a>         documentService.prepareWorkflowDocument(newBCHdr);
<a class="jxr_linenumber" name="861" href="#861">861</a>         <em class="jxr_comment">// September 2, 2009: since this document is not routed, calling this method should set it to final</em>
<a class="jxr_linenumber" name="862" href="#862">862</a>         documentService.routeDocument(newBCHdr, <span class="jxr_string">"created by Genesis"</span>, <strong class="jxr_keyword">new</strong> ArrayList());
<a class="jxr_linenumber" name="863" href="#863">863</a>     }
<a class="jxr_linenumber" name="864" href="#864">864</a> 
<a class="jxr_linenumber" name="865" href="#865">865</a> 
<a class="jxr_linenumber" name="866" href="#866">866</a>     <em class="jxr_comment">/*</em>
<a class="jxr_linenumber" name="867" href="#867">867</a> <em class="jxr_comment">     *  ****************************************************************************</em>
<a class="jxr_linenumber" name="868" href="#868">868</a> <em class="jxr_comment">     *   (4) here are the routines which freeze accounting at the beginning of     *</em>
<a class="jxr_linenumber" name="869" href="#869">869</a> <em class="jxr_comment">     *       budget construction (so updates can be done in parallel, or updates   *</em>
<a class="jxr_linenumber" name="870" href="#870">870</a> <em class="jxr_comment">     *       for the budget year only can be done without affecting the current    *</em>
<a class="jxr_linenumber" name="871" href="#871">871</a> <em class="jxr_comment">     *       chart of accounts).                                                   *</em>
<a class="jxr_linenumber" name="872" href="#872">872</a> <em class="jxr_comment">     *       These routines only run once, at genesis.                             *</em>
<a class="jxr_linenumber" name="873" href="#873">873</a> <em class="jxr_comment">     *  ****************************************************************************     </em>
<a class="jxr_linenumber" name="874" href="#874">874</a> <em class="jxr_comment">     */</em>
<a class="jxr_linenumber" name="875" href="#875">875</a> 
<a class="jxr_linenumber" name="876" href="#876">876</a>     <em class="jxr_comment">//   public routines</em>
<a class="jxr_linenumber" name="877" href="#877">877</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> createChartForNextBudgetCycle() {
<a class="jxr_linenumber" name="878" href="#878">878</a>         <em class="jxr_comment">// first we have to remove what's there</em>
<a class="jxr_linenumber" name="879" href="#879">879</a>         <em class="jxr_comment">// (the documentation says deleteByQuery (1) ignores object references and (2) does</em>
<a class="jxr_linenumber" name="880" href="#880">880</a>         <em class="jxr_comment">//  not synchronize the cache.  so, we clear the cache before and after.)</em>
<a class="jxr_linenumber" name="881" href="#881">881</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="882" href="#882">882</a>         Criteria criteriaID = QueryByCriteria.CRITERIA_SELECT_ALL;
<a class="jxr_linenumber" name="883" href="#883">883</a>         QueryByCriteria killAcctQuery = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionAccountReports.<strong class="jxr_keyword">class</strong>);
<a class="jxr_linenumber" name="884" href="#884">884</a>         killAcctQuery.setCriteria(criteriaID);
<a class="jxr_linenumber" name="885" href="#885">885</a>         getPersistenceBrokerTemplate().deleteByQuery(killAcctQuery);
<a class="jxr_linenumber" name="886" href="#886">886</a>         QueryByCriteria killOrgQuery = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionOrganizationReports.<strong class="jxr_keyword">class</strong>);
<a class="jxr_linenumber" name="887" href="#887">887</a>         killOrgQuery.setCriteria(criteriaID);
<a class="jxr_linenumber" name="888" href="#888">888</a>         getPersistenceBrokerTemplate().deleteByQuery(killOrgQuery);
<a class="jxr_linenumber" name="889" href="#889">889</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="890" href="#890">890</a>         <em class="jxr_comment">// build the organization table  </em>
<a class="jxr_linenumber" name="891" href="#891">891</a>         buildNewOrganizationReportsTo();
<a class="jxr_linenumber" name="892" href="#892">892</a>         <em class="jxr_comment">// build the account table</em>
<a class="jxr_linenumber" name="893" href="#893">893</a>         buildNewAccountReportsTo();
<a class="jxr_linenumber" name="894" href="#894">894</a>     }
<a class="jxr_linenumber" name="895" href="#895">895</a> 
<a class="jxr_linenumber" name="896" href="#896">896</a>     <em class="jxr_comment">//  private working methods for the BC chart update</em>
<a class="jxr_linenumber" name="897" href="#897">897</a> 
<a class="jxr_linenumber" name="898" href="#898">898</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> buildNewAccountReportsTo() {
<a class="jxr_linenumber" name="899" href="#899">899</a> 
<a class="jxr_linenumber" name="900" href="#900">900</a>         <em class="jxr_comment">//  All active accounts are loaded into the budget accounting table</em>
<a class="jxr_linenumber" name="901" href="#901">901</a> 
<a class="jxr_linenumber" name="902" href="#902">902</a>         Integer sqlChartOfAccountsCode = 0;
<a class="jxr_linenumber" name="903" href="#903">903</a>         Integer sqlAccountNumber = 1;
<a class="jxr_linenumber" name="904" href="#904">904</a>         Integer sqlReportsToChartofAccountsCode = 0;
<a class="jxr_linenumber" name="905" href="#905">905</a>         Integer sqlOrganizationCode = 2;
<a class="jxr_linenumber" name="906" href="#906">906</a> 
<a class="jxr_linenumber" name="907" href="#907">907</a>         Long accountsAdded = <strong class="jxr_keyword">new</strong> Long(0);
<a class="jxr_linenumber" name="908" href="#908">908</a> 
<a class="jxr_linenumber" name="909" href="#909">909</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="910" href="#910">910</a>         <em class="jxr_comment">/*<em class="jxr_comment">  current IU genesis does NOT check for closed accounts--it loads all accounts</em></em>
<a class="jxr_linenumber" name="911" href="#911">911</a> <em class="jxr_comment">         *  it is possible that an account which has been closed still has base budget </em>
<a class="jxr_linenumber" name="912" href="#912">912</a> <em class="jxr_comment">         */</em>
<a class="jxr_linenumber" name="913" href="#913">913</a>         criteriaID = QueryByCriteria.CRITERIA_SELECT_ALL;
<a class="jxr_linenumber" name="914" href="#914">914</a>         String[] queryAttr = { KFSPropertyConstants.CHART_OF_ACCOUNTS_CODE, KFSPropertyConstants.ACCOUNT_NUMBER, KFSPropertyConstants.ORGANIZATION_CODE };
<a class="jxr_linenumber" name="915" href="#915">915</a>         ReportQueryByCriteria queryID = <strong class="jxr_keyword">new</strong> ReportQueryByCriteria(Account.<strong class="jxr_keyword">class</strong>, queryAttr, criteriaID, <strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="916" href="#916">916</a>         Iterator Results = getPersistenceBrokerTemplate().getReportQueryIteratorByQuery(queryID);
<a class="jxr_linenumber" name="917" href="#917">917</a>         <strong class="jxr_keyword">while</strong> (Results.hasNext()) {
<a class="jxr_linenumber" name="918" href="#918">918</a>             Object[] ReturnList = (Object[]) Results.next();
<a class="jxr_linenumber" name="919" href="#919">919</a>             <em class="jxr_comment">// just save this stuff, one at a time</em>
<a class="jxr_linenumber" name="920" href="#920">920</a>             <em class="jxr_comment">// it isn't needed for anything else, so we don't need to store it in memory in a map</em>
<a class="jxr_linenumber" name="921" href="#921">921</a>             <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionAccountReports.html">BudgetConstructionAccountReports</a> acctRpts = <strong class="jxr_keyword">new</strong> <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionAccountReports.html">BudgetConstructionAccountReports</a>();
<a class="jxr_linenumber" name="922" href="#922">922</a>             acctRpts.setChartOfAccountsCode((String) ReturnList[sqlChartOfAccountsCode]);
<a class="jxr_linenumber" name="923" href="#923">923</a>             acctRpts.setAccountNumber((String) ReturnList[sqlAccountNumber]);
<a class="jxr_linenumber" name="924" href="#924">924</a>             acctRpts.setReportsToChartOfAccountsCode((String) ReturnList[sqlReportsToChartofAccountsCode]);
<a class="jxr_linenumber" name="925" href="#925">925</a>             acctRpts.setReportsToOrganizationCode((String) ReturnList[sqlOrganizationCode]);
<a class="jxr_linenumber" name="926" href="#926">926</a>             acctRpts.setVersionNumber(DEFAULT_VERSION_NUMBER);
<a class="jxr_linenumber" name="927" href="#927">927</a>             getPersistenceBrokerTemplate().store(acctRpts);
<a class="jxr_linenumber" name="928" href="#928">928</a>             accountsAdded = accountsAdded + 1;
<a class="jxr_linenumber" name="929" href="#929">929</a>         }
<a class="jxr_linenumber" name="930" href="#930">930</a>         LOG.info(String.format(<span class="jxr_string">"\nAccount reporting lines added to budget construction %d"</span>, accountsAdded));
<a class="jxr_linenumber" name="931" href="#931">931</a>     }
<a class="jxr_linenumber" name="932" href="#932">932</a> 
<a class="jxr_linenumber" name="933" href="#933">933</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> buildNewOrganizationReportsTo() {
<a class="jxr_linenumber" name="934" href="#934">934</a> 
<a class="jxr_linenumber" name="935" href="#935">935</a>         <em class="jxr_comment">//  all active organizations are loaded into the budget construction</em>
<a class="jxr_linenumber" name="936" href="#936">936</a>         <em class="jxr_comment">//  organization table</em>
<a class="jxr_linenumber" name="937" href="#937">937</a> 
<a class="jxr_linenumber" name="938" href="#938">938</a>         Integer sqlChartOfAccountsCode = 0;
<a class="jxr_linenumber" name="939" href="#939">939</a>         Integer sqlOrganizationCode = 1;
<a class="jxr_linenumber" name="940" href="#940">940</a>         Integer sqlReportsToChartOfAccountsCode = 2;
<a class="jxr_linenumber" name="941" href="#941">941</a>         Integer sqlReportsToOrganizationCode = 3;
<a class="jxr_linenumber" name="942" href="#942">942</a>         Integer sqlResponsibilityCenterCode = 4;
<a class="jxr_linenumber" name="943" href="#943">943</a> 
<a class="jxr_linenumber" name="944" href="#944">944</a>         Long organizationsAdded = <strong class="jxr_keyword">new</strong> Long(0);
<a class="jxr_linenumber" name="945" href="#945">945</a> 
<a class="jxr_linenumber" name="946" href="#946">946</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="947" href="#947">947</a>         <em class="jxr_comment">/*</em>
<a class="jxr_linenumber" name="948" href="#948">948</a> <em class="jxr_comment">         *  IU genesis takes all organizations, not just active ones</em>
<a class="jxr_linenumber" name="949" href="#949">949</a> <em class="jxr_comment">         *  the reason is that a closed account which still has a base budget</em>
<a class="jxr_linenumber" name="950" href="#950">950</a> <em class="jxr_comment">         *  might report to one of these organizations </em>
<a class="jxr_linenumber" name="951" href="#951">951</a> <em class="jxr_comment">         */</em>
<a class="jxr_linenumber" name="952" href="#952">952</a>         criteriaID = QueryByCriteria.CRITERIA_SELECT_ALL;
<a class="jxr_linenumber" name="953" href="#953">953</a>         String[] queryAttr = { KFSPropertyConstants.CHART_OF_ACCOUNTS_CODE, KFSPropertyConstants.ORGANIZATION_CODE, KFSPropertyConstants.REPORTS_TO_CHART_OF_ACCOUNTS_CODE, KFSPropertyConstants.REPORTS_TO_ORGANIZATION_CODE, KFSPropertyConstants.RESPONSIBILITY_CENTER_CODE };
<a class="jxr_linenumber" name="954" href="#954">954</a>         ReportQueryByCriteria queryID = <strong class="jxr_keyword">new</strong> ReportQueryByCriteria(Organization.<strong class="jxr_keyword">class</strong>, queryAttr, criteriaID, <strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="955" href="#955">955</a>         Iterator Results = getPersistenceBrokerTemplate().getReportQueryIteratorByQuery(queryID);
<a class="jxr_linenumber" name="956" href="#956">956</a>         <strong class="jxr_keyword">while</strong> (Results.hasNext()) {
<a class="jxr_linenumber" name="957" href="#957">957</a>             Object[] ReturnList = (Object[]) Results.next();
<a class="jxr_linenumber" name="958" href="#958">958</a>             <em class="jxr_comment">// just save this stuff, one at a time</em>
<a class="jxr_linenumber" name="959" href="#959">959</a>             <em class="jxr_comment">// it isn't needed for anything else</em>
<a class="jxr_linenumber" name="960" href="#960">960</a>             <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionOrganizationReports.html">BudgetConstructionOrganizationReports</a> orgRpts = <strong class="jxr_keyword">new</strong> <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionOrganizationReports.html">BudgetConstructionOrganizationReports</a>();
<a class="jxr_linenumber" name="961" href="#961">961</a>             orgRpts.setChartOfAccountsCode((String) ReturnList[sqlChartOfAccountsCode]);
<a class="jxr_linenumber" name="962" href="#962">962</a>             orgRpts.setOrganizationCode((String) ReturnList[sqlOrganizationCode]);
<a class="jxr_linenumber" name="963" href="#963">963</a>             orgRpts.setReportsToChartOfAccountsCode((String) ReturnList[sqlReportsToChartOfAccountsCode]);
<a class="jxr_linenumber" name="964" href="#964">964</a>             orgRpts.setReportsToOrganizationCode((String) ReturnList[sqlReportsToOrganizationCode]);
<a class="jxr_linenumber" name="965" href="#965">965</a>             orgRpts.setResponsibilityCenterCode((String) ReturnList[sqlResponsibilityCenterCode]);
<a class="jxr_linenumber" name="966" href="#966">966</a>             orgRpts.setVersionNumber(DEFAULT_VERSION_NUMBER);
<a class="jxr_linenumber" name="967" href="#967">967</a>             getPersistenceBrokerTemplate().store(orgRpts);
<a class="jxr_linenumber" name="968" href="#968">968</a>             organizationsAdded = organizationsAdded + 1;
<a class="jxr_linenumber" name="969" href="#969">969</a>         }
<a class="jxr_linenumber" name="970" href="#970">970</a>         LOG.info(String.format(<span class="jxr_string">"\nOrganization reporting lines added to budget construction %d"</span>, organizationsAdded));
<a class="jxr_linenumber" name="971" href="#971">971</a>     }
<a class="jxr_linenumber" name="972" href="#972">972</a> 
<a class="jxr_linenumber" name="973" href="#973">973</a>     <em class="jxr_comment">/*</em>
<a class="jxr_linenumber" name="974" href="#974">974</a> <em class="jxr_comment">     *  *********************************************************************************</em>
<a class="jxr_linenumber" name="975" href="#975">975</a> <em class="jxr_comment">     *  (5) these are the routines that build the security organization hierarchy</em>
<a class="jxr_linenumber" name="976" href="#976">976</a> <em class="jxr_comment">     *   -- they run every time the budget construction update process runs</em>
<a class="jxr_linenumber" name="977" href="#977">977</a> <em class="jxr_comment">     *   -- they are designed to pick up any changes made to the BC account and BC</em>
<a class="jxr_linenumber" name="978" href="#978">978</a> <em class="jxr_comment">     *      organization tables</em>
<a class="jxr_linenumber" name="979" href="#979">979</a> <em class="jxr_comment">     *   -- based on changes, they will adjust the security levels of accounts in the BC</em>
<a class="jxr_linenumber" name="980" href="#980">980</a> <em class="jxr_comment">     *      header.  for a header at the level of an organization that is no longer valid,</em>
<a class="jxr_linenumber" name="981" href="#981">981</a> <em class="jxr_comment">     *      the level will return to the account manager level.  for a header at the level</em>
<a class="jxr_linenumber" name="982" href="#982">982</a> <em class="jxr_comment">     *      of an organization that has changed its location in the hierarchy, the new</em>
<a class="jxr_linenumber" name="983" href="#983">983</a> <em class="jxr_comment">     *      level will be replace the former one in the header</em>
<a class="jxr_linenumber" name="984" href="#984">984</a> <em class="jxr_comment">     *   -- this process only affects accounts in the budget construction pending</em>
<a class="jxr_linenumber" name="985" href="#985">985</a> <em class="jxr_comment">     *      general ledger, and it is assumed that all updates to the PBGL have been</em>
<a class="jxr_linenumber" name="986" href="#986">986</a> <em class="jxr_comment">     *      finished when this process runs.       </em>
<a class="jxr_linenumber" name="987" href="#987">987</a> <em class="jxr_comment">     *  *********************************************************************************    </em>
<a class="jxr_linenumber" name="988" href="#988">988</a> <em class="jxr_comment">     */</em>
<a class="jxr_linenumber" name="989" href="#989">989</a> 
<a class="jxr_linenumber" name="990" href="#990">990</a>     <strong class="jxr_keyword">private</strong> HashMap&lt;String, BudgetConstructionAccountReports&gt; acctRptsToMap = <strong class="jxr_keyword">new</strong> HashMap&lt;String, BudgetConstructionAccountReports&gt;(1);
<a class="jxr_linenumber" name="991" href="#991">991</a>     <strong class="jxr_keyword">private</strong> HashMap&lt;String, BudgetConstructionOrganizationReports&gt; orgRptsToMap = <strong class="jxr_keyword">new</strong> HashMap&lt;String, BudgetConstructionOrganizationReports&gt;(1);
<a class="jxr_linenumber" name="992" href="#992">992</a>     <strong class="jxr_keyword">private</strong> HashMap&lt;String, BudgetConstructionAccountOrganizationHierarchy&gt; acctOrgHierMap = <strong class="jxr_keyword">new</strong> HashMap&lt;String, BudgetConstructionAccountOrganizationHierarchy&gt;(1);
<a class="jxr_linenumber" name="993" href="#993">993</a> 
<a class="jxr_linenumber" name="994" href="#994">994</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> organizationHierarchyCleanUp() {
<a class="jxr_linenumber" name="995" href="#995">995</a>         acctRptsToMap.clear();
<a class="jxr_linenumber" name="996" href="#996">996</a>         orgRptsToMap.clear();
<a class="jxr_linenumber" name="997" href="#997">997</a>         acctOrgHierMap.clear();
<a class="jxr_linenumber" name="998" href="#998">998</a>     }
<a class="jxr_linenumber" name="999" href="#999">999</a> 
<a class="jxr_linenumber" name="1000" href="#1000">1000</a>     <strong class="jxr_keyword">private</strong> <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionHeader.html">BudgetConstructionHeader</a> budgetConstructionHeader;
<a class="jxr_linenumber" name="1001" href="#1001">1001</a>     <em class="jxr_comment">//  these are the values at the root of the organization tree</em>
<a class="jxr_linenumber" name="1002" href="#1002">1002</a>     <em class="jxr_comment">//  they report to themselves, and they are at the highest level of every </em>
<a class="jxr_linenumber" name="1003" href="#1003">1003</a>     <em class="jxr_comment">//  organization's reporting chain</em>
<a class="jxr_linenumber" name="1004" href="#1004">1004</a>     <strong class="jxr_keyword">private</strong> String rootChart;
<a class="jxr_linenumber" name="1005" href="#1005">1005</a>     <strong class="jxr_keyword">private</strong> String rootOrganization;
<a class="jxr_linenumber" name="1006" href="#1006">1006</a> 
<a class="jxr_linenumber" name="1007" href="#1007">1007</a>     <strong class="jxr_keyword">private</strong> Integer nHeadersBackToZero = 0;
<a class="jxr_linenumber" name="1008" href="#1008">1008</a>     <strong class="jxr_keyword">private</strong> Integer nHeadersSwitchingLevels = 0;
<a class="jxr_linenumber" name="1009" href="#1009">1009</a> 
<a class="jxr_linenumber" name="1010" href="#1010">1010</a> 
<a class="jxr_linenumber" name="1011" href="#1011">1011</a>     <em class="jxr_comment">/*</em>
<a class="jxr_linenumber" name="1012" href="#1012">1012</a> <em class="jxr_comment">     *  rebuild the organization hierarchy based on changes to BC accounting and BC organization tables</em>
<a class="jxr_linenumber" name="1013" href="#1013">1013</a> <em class="jxr_comment">     */</em>
<a class="jxr_linenumber" name="1014" href="#1014">1014</a> 
<a class="jxr_linenumber" name="1015" href="#1015">1015</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> rebuildOrganizationHierarchy(Integer BaseYear) {
<a class="jxr_linenumber" name="1016" href="#1016">1016</a>         <em class="jxr_comment">// ********</em>
<a class="jxr_linenumber" name="1017" href="#1017">1017</a>         <em class="jxr_comment">// this routine REQUIRES that pending GL is complete</em>
<a class="jxr_linenumber" name="1018" href="#1018">1018</a>         <em class="jxr_comment">// we only build a hierarchy for accounts that exist in the GL</em>
<a class="jxr_linenumber" name="1019" href="#1019">1019</a>         <em class="jxr_comment">// ********</em>
<a class="jxr_linenumber" name="1020" href="#1020">1020</a> 
<a class="jxr_linenumber" name="1021" href="#1021">1021</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="1022" href="#1022">1022</a> 
<a class="jxr_linenumber" name="1023" href="#1023">1023</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1024" href="#1024">1024</a>         <em class="jxr_comment">// first we have to clear out what's there for the coming fiscal year</em>
<a class="jxr_linenumber" name="1025" href="#1025">1025</a>         <em class="jxr_comment">// again, we clear the cache after doing a deleteByQuery</em>
<a class="jxr_linenumber" name="1026" href="#1026">1026</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="1027" href="#1027">1027</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="1028" href="#1028">1028</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, RequestYear);
<a class="jxr_linenumber" name="1029" href="#1029">1029</a>         QueryByCriteria killOrgHierQuery = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionAccountOrganizationHierarchy.<strong class="jxr_keyword">class</strong>, criteriaID);
<a class="jxr_linenumber" name="1030" href="#1030">1030</a>         killOrgHierQuery.setCriteria(criteriaID);
<a class="jxr_linenumber" name="1031" href="#1031">1031</a>         getPersistenceBrokerTemplate().deleteByQuery(killOrgHierQuery);
<a class="jxr_linenumber" name="1032" href="#1032">1032</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="1033" href="#1033">1033</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1034" href="#1034">1034</a>         <em class="jxr_comment">// now we fetch the root of the organization tree</em>
<a class="jxr_linenumber" name="1035" href="#1035">1035</a>         String[] rootNode = SpringContext.getBean(OrganizationService.<strong class="jxr_keyword">class</strong>).getRootOrganizationCode();
<a class="jxr_linenumber" name="1036" href="#1036">1036</a>         rootChart = rootNode[0];
<a class="jxr_linenumber" name="1037" href="#1037">1037</a>         rootOrganization = rootNode[1];
<a class="jxr_linenumber" name="1038" href="#1038">1038</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1039" href="#1039">1039</a>         <em class="jxr_comment">// read the entire account reports to table, and build a hash map for the</em>
<a class="jxr_linenumber" name="1040" href="#1040">1040</a>         <em class="jxr_comment">// join with the PBGL accounts</em>
<a class="jxr_linenumber" name="1041" href="#1041">1041</a>         readAcctReportsTo();
<a class="jxr_linenumber" name="1042" href="#1042">1042</a>         <em class="jxr_comment">// read the entire organization reports to table, and build a hash map for</em>
<a class="jxr_linenumber" name="1043" href="#1043">1043</a>         <em class="jxr_comment">// getting the organization tree</em>
<a class="jxr_linenumber" name="1044" href="#1044">1044</a>         readOrgReportsTo();
<a class="jxr_linenumber" name="1045" href="#1045">1045</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1046" href="#1046">1046</a>         <em class="jxr_comment">//  we query the budget construction header and loop through the results</em>
<a class="jxr_linenumber" name="1047" href="#1047">1047</a>         <em class="jxr_comment">//  we build a hierarchy for every account we find</em>
<a class="jxr_linenumber" name="1048" href="#1048">1048</a>         <em class="jxr_comment">//  we reset level of any account which no longer exists in the hierarchy</em>
<a class="jxr_linenumber" name="1049" href="#1049">1049</a>         criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="1050" href="#1050">1050</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, RequestYear);
<a class="jxr_linenumber" name="1051" href="#1051">1051</a>         acctOrgHierMap = <strong class="jxr_keyword">new</strong> HashMap&lt;String, BudgetConstructionAccountOrganizationHierarchy&gt;(hashObjectSize(BudgetConstructionAccountOrganizationHierarchy.<strong class="jxr_keyword">class</strong>, criteriaID) * BCConstants.AVERAGE_REPORTING_TREE_SIZE);
<a class="jxr_linenumber" name="1052" href="#1052">1052</a>         QueryByCriteria queryID = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionHeader.<strong class="jxr_keyword">class</strong>, criteriaID);
<a class="jxr_linenumber" name="1053" href="#1053">1053</a>         Iterator Results = getPersistenceBrokerTemplate().getIteratorByQuery(queryID);
<a class="jxr_linenumber" name="1054" href="#1054">1054</a>         <strong class="jxr_keyword">while</strong> (Results.hasNext()) {
<a class="jxr_linenumber" name="1055" href="#1055">1055</a>             <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionHeader.html">BudgetConstructionHeader</a> extantBCHdr = (BudgetConstructionHeader) Results.next();
<a class="jxr_linenumber" name="1056" href="#1056">1056</a>             buildAcctOrgHierFromAcctRpts(acctRptsToMap.get(getAcctRptsToKeyFromBCHdr(extantBCHdr)), RequestYear);
<a class="jxr_linenumber" name="1057" href="#1057">1057</a>             updateBudgetConstructionHeaderAsNeeded(extantBCHdr);
<a class="jxr_linenumber" name="1058" href="#1058">1058</a>         }
<a class="jxr_linenumber" name="1059" href="#1059">1059</a>         organizationHierarchyCleanUp();
<a class="jxr_linenumber" name="1060" href="#1060">1060</a>     }
<a class="jxr_linenumber" name="1061" href="#1061">1061</a>     
<a class="jxr_linenumber" name="1062" href="#1062">1062</a>     <em class="jxr_comment">/*</em>
<a class="jxr_linenumber" name="1063" href="#1063">1063</a> <em class="jxr_comment">     *  verify that all the accounts in the budget construction header table are in the budget construction accounting table as well.</em>
<a class="jxr_linenumber" name="1064" href="#1064">1064</a> <em class="jxr_comment">     *</em>
<a class="jxr_linenumber" name="1065" href="#1065">1065</a> <em class="jxr_comment">     *  genesis initially inserts all accounts in the chart of accounts table into the budget construction accounting table.</em>
<a class="jxr_linenumber" name="1066" href="#1066">1066</a> <em class="jxr_comment">     *  after genesis, the budget construction accounting and organization tables must be maintained separately, to allow changes for the coming fiscal year to be made without changing the current account/organization structure.</em>
<a class="jxr_linenumber" name="1067" href="#1067">1067</a> <em class="jxr_comment">     *  this means that accounts can come into budget construction via the general ledger or via payroll (CSF) which were created after genesis but for some reason not entered into the budget construction accounting tables.</em>
<a class="jxr_linenumber" name="1068" href="#1068">1068</a> <em class="jxr_comment">     *  there is no good way for a program to decide why this happened and what to do about it.  (For instance, it could be that the payroll account is not supposed to exist in the coming year, and the account should not be</em>
<a class="jxr_linenumber" name="1069" href="#1069">1069</a> <em class="jxr_comment">     *  in budget construction.  It could also be that some base budget GL was not transferred out of an account which is going away in the new fiscal year.  or, it could be that the chart manager missed something and the account</em>
<a class="jxr_linenumber" name="1070" href="#1070">1070</a> <em class="jxr_comment">     *  should be in the budget construction accounting table.  A real live person needs to decide what happened and what to do.) so, check for this situation and print a log message if it occurs. </em>
<a class="jxr_linenumber" name="1071" href="#1071">1071</a> <em class="jxr_comment">     */</em>
<a class="jxr_linenumber" name="1072" href="#1072">1072</a>     
<a class="jxr_linenumber" name="1073" href="#1073">1073</a>     <strong class="jxr_keyword">public</strong> Map verifyAccountsAreAccessible(Integer requestFiscalYear)
<a class="jxr_linenumber" name="1074" href="#1074">1074</a>     {
<a class="jxr_linenumber" name="1075" href="#1075">1075</a>         HashMap&lt;String,String[]&gt; returnMap = <strong class="jxr_keyword">new</strong> HashMap&lt;String,String[]&gt;();
<a class="jxr_linenumber" name="1076" href="#1076">1076</a>         
<a class="jxr_linenumber" name="1077" href="#1077">1077</a>         Criteria criteriaId = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="1078" href="#1078">1078</a>         <em class="jxr_comment">// allow more than one year in BC</em>
<a class="jxr_linenumber" name="1079" href="#1079">1079</a>         criteriaId.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, requestFiscalYear);
<a class="jxr_linenumber" name="1080" href="#1080">1080</a>         <em class="jxr_comment">// query for the chart, account, and a field unique to the joined BC Account table</em>
<a class="jxr_linenumber" name="1081" href="#1081">1081</a>         String[] selectList = {KFSPropertyConstants.CHART_OF_ACCOUNTS_CODE,
<a class="jxr_linenumber" name="1082" href="#1082">1082</a>                                KFSPropertyConstants.ACCOUNT_NUMBER,
<a class="jxr_linenumber" name="1083" href="#1083">1083</a>                                BCPropertyConstants.BUDGET_CONSTRUCTION_ACCOUNT_REPORTS+<span class="jxr_string">"."</span>+KFSPropertyConstants.REPORTS_TO_ORGANIZATION_CODE};
<a class="jxr_linenumber" name="1084" href="#1084">1084</a>         ReportQueryByCriteria missingBCAccounts = <strong class="jxr_keyword">new</strong> ReportQueryByCriteria(BudgetConstructionHeader.<strong class="jxr_keyword">class</strong>,criteriaId);
<a class="jxr_linenumber" name="1085" href="#1085">1085</a>         missingBCAccounts.setAttributes(selectList);
<a class="jxr_linenumber" name="1086" href="#1086">1086</a>         <em class="jxr_comment">// set up an outer join path to the BC Account table</em>
<a class="jxr_linenumber" name="1087" href="#1087">1087</a>         missingBCAccounts.setPathOuterJoin(BCPropertyConstants.BUDGET_CONSTRUCTION_ACCOUNT_REPORTS);
<a class="jxr_linenumber" name="1088" href="#1088">1088</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1089" href="#1089">1089</a>         <em class="jxr_comment">// look for a null value of the organization code to identify accounts not in Budget Construction Accounting</em>
<a class="jxr_linenumber" name="1090" href="#1090">1090</a>         Iterator &lt;Object[]&gt; returnedRows = getPersistenceBrokerTemplate().getReportQueryIteratorByQuery(missingBCAccounts);
<a class="jxr_linenumber" name="1091" href="#1091">1091</a>         <strong class="jxr_keyword">while</strong> (returnedRows.hasNext())
<a class="jxr_linenumber" name="1092" href="#1092">1092</a>         {
<a class="jxr_linenumber" name="1093" href="#1093">1093</a>             Object[] returnedFields = returnedRows.next();
<a class="jxr_linenumber" name="1094" href="#1094">1094</a>             <strong class="jxr_keyword">if</strong> (returnedFields[2] == <strong class="jxr_keyword">null</strong>)
<a class="jxr_linenumber" name="1095" href="#1095">1095</a>             {
<a class="jxr_linenumber" name="1096" href="#1096">1096</a>                 <em class="jxr_comment">// store the missing row in the map</em>
<a class="jxr_linenumber" name="1097" href="#1097">1097</a>                 String chart = (String) returnedFields[0];
<a class="jxr_linenumber" name="1098" href="#1098">1098</a>                 String account = (String) returnedFields[1];
<a class="jxr_linenumber" name="1099" href="#1099">1099</a>                 String[] chartAccount = {chart, account};
<a class="jxr_linenumber" name="1100" href="#1100">1100</a>                 returnMap.put(chart+account,chartAccount);
<a class="jxr_linenumber" name="1101" href="#1101">1101</a>             }
<a class="jxr_linenumber" name="1102" href="#1102">1102</a>         }
<a class="jxr_linenumber" name="1103" href="#1103">1103</a>         
<a class="jxr_linenumber" name="1104" href="#1104">1104</a>         <strong class="jxr_keyword">return</strong> returnMap;
<a class="jxr_linenumber" name="1105" href="#1105">1105</a>     }
<a class="jxr_linenumber" name="1106" href="#1106">1106</a> 
<a class="jxr_linenumber" name="1107" href="#1107">1107</a>     <em class="jxr_comment">//  private utility methods</em>
<a class="jxr_linenumber" name="1108" href="#1108">1108</a> 
<a class="jxr_linenumber" name="1109" href="#1109">1109</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> buildAcctOrgHierFromAcctRpts(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionAccountReports.html">BudgetConstructionAccountReports</a> acctRpts, Integer RequestYear) {
<a class="jxr_linenumber" name="1110" href="#1110">1110</a>         <em class="jxr_comment">// it is possible that a header row could have an account which exists in the chart but not in account reports to, the parallel chart for budget construction.  these two charts must be maintained in parallel.  if that is the case, a verification routine will print a list of problems at the end.  here we just skip building the hierarchy.</em>
<a class="jxr_linenumber" name="1111" href="#1111">1111</a>         <strong class="jxr_keyword">if</strong> (acctRpts == <strong class="jxr_keyword">null</strong>)
<a class="jxr_linenumber" name="1112" href="#1112">1112</a>         {
<a class="jxr_linenumber" name="1113" href="#1113">1113</a>             <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="1114" href="#1114">1114</a>         }
<a class="jxr_linenumber" name="1115" href="#1115">1115</a>         <em class="jxr_comment">// part of the key of the budget construction header is a sub account</em>
<a class="jxr_linenumber" name="1116" href="#1116">1116</a>         <em class="jxr_comment">// so, our algorithm could visit the same account more than once if the account has more than one subaccount.</em>
<a class="jxr_linenumber" name="1117" href="#1117">1117</a>         <em class="jxr_comment">// if the hierarchy for this account is already built, we skip this routine.</em>
<a class="jxr_linenumber" name="1118" href="#1118">1118</a>         String inKey = getOrgHierarchyKeyFromAcctRpts(acctRpts);
<a class="jxr_linenumber" name="1119" href="#1119">1119</a>         <strong class="jxr_keyword">if</strong> (acctOrgHierMap.get(inKey) != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="1120" href="#1120">1120</a>             <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="1121" href="#1121">1121</a>         }
<a class="jxr_linenumber" name="1122" href="#1122">1122</a>         Integer orgLevel = 1;
<a class="jxr_linenumber" name="1123" href="#1123">1123</a>         <em class="jxr_comment">// the organization the account directly reports to is at level 1</em>
<a class="jxr_linenumber" name="1124" href="#1124">1124</a>         <em class="jxr_comment">// (the account starts out at the account fiscal office level--level 0) </em>
<a class="jxr_linenumber" name="1125" href="#1125">1125</a>         <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionAccountOrganizationHierarchy.html">BudgetConstructionAccountOrganizationHierarchy</a> acctOrgHier;
<a class="jxr_linenumber" name="1126" href="#1126">1126</a>         acctOrgHier = <strong class="jxr_keyword">new</strong> <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionAccountOrganizationHierarchy.html">BudgetConstructionAccountOrganizationHierarchy</a>();
<a class="jxr_linenumber" name="1127" href="#1127">1127</a>         acctOrgHier.setUniversityFiscalYear(RequestYear);
<a class="jxr_linenumber" name="1128" href="#1128">1128</a>         acctOrgHier.setChartOfAccountsCode(acctRpts.getChartOfAccountsCode());
<a class="jxr_linenumber" name="1129" href="#1129">1129</a>         acctOrgHier.setAccountNumber(acctRpts.getAccountNumber());
<a class="jxr_linenumber" name="1130" href="#1130">1130</a>         acctOrgHier.setOrganizationLevelCode(orgLevel);
<a class="jxr_linenumber" name="1131" href="#1131">1131</a>         acctOrgHier.setVersionNumber(DEFAULT_VERSION_NUMBER);
<a class="jxr_linenumber" name="1132" href="#1132">1132</a>         acctOrgHier.setOrganizationChartOfAccountsCode(acctRpts.getReportsToChartOfAccountsCode());
<a class="jxr_linenumber" name="1133" href="#1133">1133</a>         acctOrgHier.setOrganizationCode(acctRpts.getReportsToOrganizationCode());
<a class="jxr_linenumber" name="1134" href="#1134">1134</a>         <em class="jxr_comment">// save the new row</em>
<a class="jxr_linenumber" name="1135" href="#1135">1135</a>         getPersistenceBrokerTemplate().store(acctOrgHier);
<a class="jxr_linenumber" name="1136" href="#1136">1136</a>         <em class="jxr_comment">// save the new row in a hash map so we can merge with the budget header</em>
<a class="jxr_linenumber" name="1137" href="#1137">1137</a>         String mapKey = getOrgHierarchyKey(acctOrgHier);
<a class="jxr_linenumber" name="1138" href="#1138">1138</a>         acctOrgHierMap.put(mapKey, acctOrgHier);
<a class="jxr_linenumber" name="1139" href="#1139">1139</a>         <em class="jxr_comment">// now we have to loop to assign the hierarchy</em>
<a class="jxr_linenumber" name="1140" href="#1140">1140</a>         <em class="jxr_comment">// (especially before testing, we need to be on the look out for infinite</em>
<a class="jxr_linenumber" name="1141" href="#1141">1141</a>         <em class="jxr_comment">//  loops.  assertions are verboten, so we'll just code a high value for</em>
<a class="jxr_linenumber" name="1142" href="#1142">1142</a>         <em class="jxr_comment">//  the level limit, instead of using a potentially infinite while loop.  we have no control over the DB, and there could be a circular reporting loop in the DB.)</em>
<a class="jxr_linenumber" name="1143" href="#1143">1143</a>         <strong class="jxr_keyword">while</strong> (orgLevel &lt; MAXIMUM_ORGANIZATION_TREE_DEPTH) {
<a class="jxr_linenumber" name="1144" href="#1144">1144</a>             <em class="jxr_comment">// find the current organization in the BC organization reports to table</em>
<a class="jxr_linenumber" name="1145" href="#1145">1145</a>             String orgKey = getOrgRptsToKeyFromAcctOrgHier(acctOrgHier);
<a class="jxr_linenumber" name="1146" href="#1146">1146</a>             <strong class="jxr_keyword">if</strong> (noNewMapEntryNeeded(orgRptsToMap.get(orgKey))) {
<a class="jxr_linenumber" name="1147" href="#1147">1147</a>                 <em class="jxr_comment">// get out if we have found the root of the reporting tree</em>
<a class="jxr_linenumber" name="1148" href="#1148">1148</a>                 <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="1149" href="#1149">1149</a>             }
<a class="jxr_linenumber" name="1150" href="#1150">1150</a>             orgLevel = orgLevel + 1;
<a class="jxr_linenumber" name="1151" href="#1151">1151</a>             <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionOrganizationReports.html">BudgetConstructionOrganizationReports</a> orgRpts = orgRptsToMap.get(orgKey);
<a class="jxr_linenumber" name="1152" href="#1152">1152</a>             acctOrgHier = <strong class="jxr_keyword">new</strong> <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionAccountOrganizationHierarchy.html">BudgetConstructionAccountOrganizationHierarchy</a>();
<a class="jxr_linenumber" name="1153" href="#1153">1153</a>             acctOrgHier.setUniversityFiscalYear(RequestYear);
<a class="jxr_linenumber" name="1154" href="#1154">1154</a>             acctOrgHier.setChartOfAccountsCode(acctRpts.getChartOfAccountsCode());
<a class="jxr_linenumber" name="1155" href="#1155">1155</a>             acctOrgHier.setAccountNumber(acctRpts.getAccountNumber());
<a class="jxr_linenumber" name="1156" href="#1156">1156</a>             acctOrgHier.setOrganizationLevelCode(orgLevel);
<a class="jxr_linenumber" name="1157" href="#1157">1157</a>             acctOrgHier.setVersionNumber(DEFAULT_VERSION_NUMBER);
<a class="jxr_linenumber" name="1158" href="#1158">1158</a>             acctOrgHier.setOrganizationChartOfAccountsCode(orgRpts.getReportsToChartOfAccountsCode());
<a class="jxr_linenumber" name="1159" href="#1159">1159</a>             acctOrgHier.setOrganizationCode(orgRpts.getReportsToOrganizationCode());
<a class="jxr_linenumber" name="1160" href="#1160">1160</a>             <em class="jxr_comment">// save the new row</em>
<a class="jxr_linenumber" name="1161" href="#1161">1161</a>             getPersistenceBrokerTemplate().store(acctOrgHier);
<a class="jxr_linenumber" name="1162" href="#1162">1162</a>             <em class="jxr_comment">// save the new row in a hash map so we can merge with the budget header</em>
<a class="jxr_linenumber" name="1163" href="#1163">1163</a>             mapKey = getOrgHierarchyKey(acctOrgHier);
<a class="jxr_linenumber" name="1164" href="#1164">1164</a>             acctOrgHierMap.put(mapKey, acctOrgHier);
<a class="jxr_linenumber" name="1165" href="#1165">1165</a>         }
<a class="jxr_linenumber" name="1166" href="#1166">1166</a>         <strong class="jxr_keyword">if</strong> (orgLevel &gt;= MAXIMUM_ORGANIZATION_TREE_DEPTH) {
<a class="jxr_linenumber" name="1167" href="#1167">1167</a>             LOG.warn(String.format(<span class="jxr_string">"\n%s/%s reports to more than %d organizations"</span>, acctRpts.getChartOfAccountsCode(), acctRpts.getAccountNumber(), MAXIMUM_ORGANIZATION_TREE_DEPTH));
<a class="jxr_linenumber" name="1168" href="#1168">1168</a>         }
<a class="jxr_linenumber" name="1169" href="#1169">1169</a>     }
<a class="jxr_linenumber" name="1170" href="#1170">1170</a> 
<a class="jxr_linenumber" name="1171" href="#1171">1171</a>     <strong class="jxr_keyword">protected</strong> String getAcctRptsToKey(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionAccountReports.html">BudgetConstructionAccountReports</a> acctRpts) {
<a class="jxr_linenumber" name="1172" href="#1172">1172</a>         String TestKey = <strong class="jxr_keyword">new</strong> String();
<a class="jxr_linenumber" name="1173" href="#1173">1173</a>         TestKey = acctRpts.getChartOfAccountsCode() + acctRpts.getAccountNumber();
<a class="jxr_linenumber" name="1174" href="#1174">1174</a>         <strong class="jxr_keyword">return</strong> TestKey;
<a class="jxr_linenumber" name="1175" href="#1175">1175</a>     }
<a class="jxr_linenumber" name="1176" href="#1176">1176</a> 
<a class="jxr_linenumber" name="1177" href="#1177">1177</a>     <strong class="jxr_keyword">protected</strong> String getAcctRptsToKeyFromBCHdr(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionHeader.html">BudgetConstructionHeader</a> bCHdr) {
<a class="jxr_linenumber" name="1178" href="#1178">1178</a>         String TestKey = <strong class="jxr_keyword">new</strong> String();
<a class="jxr_linenumber" name="1179" href="#1179">1179</a>         TestKey = bCHdr.getChartOfAccountsCode() + bCHdr.getAccountNumber();
<a class="jxr_linenumber" name="1180" href="#1180">1180</a>         <strong class="jxr_keyword">return</strong> TestKey;
<a class="jxr_linenumber" name="1181" href="#1181">1181</a>     }
<a class="jxr_linenumber" name="1182" href="#1182">1182</a> 
<a class="jxr_linenumber" name="1183" href="#1183">1183</a>     <strong class="jxr_keyword">protected</strong> String getOrgHierarchyKey(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionAccountOrganizationHierarchy.html">BudgetConstructionAccountOrganizationHierarchy</a> orgHier) {
<a class="jxr_linenumber" name="1184" href="#1184">1184</a>         String TestKey = <strong class="jxr_keyword">new</strong> String();
<a class="jxr_linenumber" name="1185" href="#1185">1185</a>         TestKey = orgHier.getChartOfAccountsCode() + orgHier.getAccountNumber() + orgHier.getOrganizationChartOfAccountsCode() + orgHier.getOrganizationCode();
<a class="jxr_linenumber" name="1186" href="#1186">1186</a>         <strong class="jxr_keyword">return</strong> TestKey;
<a class="jxr_linenumber" name="1187" href="#1187">1187</a>     }
<a class="jxr_linenumber" name="1188" href="#1188">1188</a> 
<a class="jxr_linenumber" name="1189" href="#1189">1189</a>     <strong class="jxr_keyword">protected</strong> String getOrgHierarchyKeyFromAcctRpts(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionAccountReports.html">BudgetConstructionAccountReports</a> acctRpts) {
<a class="jxr_linenumber" name="1190" href="#1190">1190</a>         String TestKey = <strong class="jxr_keyword">new</strong> String();
<a class="jxr_linenumber" name="1191" href="#1191">1191</a>         TestKey = acctRpts.getChartOfAccountsCode() + acctRpts.getAccountNumber() + acctRpts.getReportsToChartOfAccountsCode() + acctRpts.getReportsToOrganizationCode();
<a class="jxr_linenumber" name="1192" href="#1192">1192</a>         <strong class="jxr_keyword">return</strong> TestKey;
<a class="jxr_linenumber" name="1193" href="#1193">1193</a>     }
<a class="jxr_linenumber" name="1194" href="#1194">1194</a> 
<a class="jxr_linenumber" name="1195" href="#1195">1195</a>     <strong class="jxr_keyword">protected</strong> String getOrgHierarchyKeyFromBCHeader(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionHeader.html">BudgetConstructionHeader</a> bCHdr) {
<a class="jxr_linenumber" name="1196" href="#1196">1196</a>         String TestKey = <strong class="jxr_keyword">new</strong> String();
<a class="jxr_linenumber" name="1197" href="#1197">1197</a>         TestKey = bCHdr.getChartOfAccountsCode() + bCHdr.getAccountNumber() + bCHdr.getOrganizationLevelChartOfAccountsCode() + bCHdr.getOrganizationLevelOrganizationCode();
<a class="jxr_linenumber" name="1198" href="#1198">1198</a>         <strong class="jxr_keyword">return</strong> TestKey;
<a class="jxr_linenumber" name="1199" href="#1199">1199</a>     }
<a class="jxr_linenumber" name="1200" href="#1200">1200</a> 
<a class="jxr_linenumber" name="1201" href="#1201">1201</a>     <strong class="jxr_keyword">protected</strong> String getOrgRptsToKey(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionOrganizationReports.html">BudgetConstructionOrganizationReports</a> orgRpts) {
<a class="jxr_linenumber" name="1202" href="#1202">1202</a>         String TestKey = <strong class="jxr_keyword">new</strong> String();
<a class="jxr_linenumber" name="1203" href="#1203">1203</a>         TestKey = orgRpts.getChartOfAccountsCode() + orgRpts.getOrganizationCode();
<a class="jxr_linenumber" name="1204" href="#1204">1204</a>         <strong class="jxr_keyword">return</strong> TestKey;
<a class="jxr_linenumber" name="1205" href="#1205">1205</a>     }
<a class="jxr_linenumber" name="1206" href="#1206">1206</a> 
<a class="jxr_linenumber" name="1207" href="#1207">1207</a>     <strong class="jxr_keyword">protected</strong> String getOrgRptsToKeyFromAcctOrgHier(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionAccountOrganizationHierarchy.html">BudgetConstructionAccountOrganizationHierarchy</a> acctOrgHier) {
<a class="jxr_linenumber" name="1208" href="#1208">1208</a>         String TestKey = <strong class="jxr_keyword">new</strong> String();
<a class="jxr_linenumber" name="1209" href="#1209">1209</a>         TestKey = acctOrgHier.getOrganizationChartOfAccountsCode() + acctOrgHier.getOrganizationCode();
<a class="jxr_linenumber" name="1210" href="#1210">1210</a>         <strong class="jxr_keyword">return</strong> TestKey;
<a class="jxr_linenumber" name="1211" href="#1211">1211</a>     }
<a class="jxr_linenumber" name="1212" href="#1212">1212</a> 
<a class="jxr_linenumber" name="1213" href="#1213">1213</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">boolean</strong> noNewMapEntryNeeded(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionOrganizationReports.html">BudgetConstructionOrganizationReports</a> orgRpts) {
<a class="jxr_linenumber" name="1214" href="#1214">1214</a>         <em class="jxr_comment">// no new entry is needed we are at the root of the organization tree</em>
<a class="jxr_linenumber" name="1215" href="#1215">1215</a>         String thisChart = orgRpts.getChartOfAccountsCode();
<a class="jxr_linenumber" name="1216" href="#1216">1216</a>         String thisOrg = orgRpts.getOrganizationCode();
<a class="jxr_linenumber" name="1217" href="#1217">1217</a>         <strong class="jxr_keyword">if</strong> ((thisChart.compareTo(rootChart) == 0) &amp;&amp; (thisOrg.compareTo(rootOrganization) == 0)) {
<a class="jxr_linenumber" name="1218" href="#1218">1218</a>             <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="1219" href="#1219">1219</a>         }
<a class="jxr_linenumber" name="1220" href="#1220">1220</a>         <em class="jxr_comment">// no new entry is needed if either the chart or the organization </em>
<a class="jxr_linenumber" name="1221" href="#1221">1221</a>         <em class="jxr_comment">// which this organization reports to is null</em>
<a class="jxr_linenumber" name="1222" href="#1222">1222</a>         <em class="jxr_comment">// or if the organization reports to itself</em>
<a class="jxr_linenumber" name="1223" href="#1223">1223</a>         <em class="jxr_comment">// this check is here in case the chart/org reporting hierarchy is not set up properly in the DB, and some organizations do not </em>
<a class="jxr_linenumber" name="1224" href="#1224">1224</a>         <em class="jxr_comment">// ultimately report to a single root of the organization tree.</em>
<a class="jxr_linenumber" name="1225" href="#1225">1225</a>         String rptsToChart = orgRpts.getReportsToChartOfAccountsCode();
<a class="jxr_linenumber" name="1226" href="#1226">1226</a>         <strong class="jxr_keyword">if</strong> (rptsToChart.length() == 0) {
<a class="jxr_linenumber" name="1227" href="#1227">1227</a>             LOG.warn(String.format(<span class="jxr_string">"\n(%s, %s) reports to a null chart"</span>, thisChart, thisOrg));
<a class="jxr_linenumber" name="1228" href="#1228">1228</a>             <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="1229" href="#1229">1229</a>         }
<a class="jxr_linenumber" name="1230" href="#1230">1230</a>         String rptsToOrg = orgRpts.getReportsToOrganizationCode();
<a class="jxr_linenumber" name="1231" href="#1231">1231</a>         <strong class="jxr_keyword">if</strong> (rptsToOrg.length() == 0) {
<a class="jxr_linenumber" name="1232" href="#1232">1232</a>             LOG.warn(String.format(<span class="jxr_string">"\n(%s, %s) reports to a null organization"</span>, thisChart, thisOrg));
<a class="jxr_linenumber" name="1233" href="#1233">1233</a>             <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="1234" href="#1234">1234</a>         }
<a class="jxr_linenumber" name="1235" href="#1235">1235</a>         <strong class="jxr_keyword">if</strong> ((thisChart.compareTo(rptsToChart) == 0) &amp;&amp; (thisOrg.compareTo(rptsToOrg) == 0)) {
<a class="jxr_linenumber" name="1236" href="#1236">1236</a>             LOG.warn(String.format(<span class="jxr_string">"\n(%s,%s) reports to itself and is not the root"</span>, thisChart, thisOrg));
<a class="jxr_linenumber" name="1237" href="#1237">1237</a>             <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="1238" href="#1238">1238</a>         }
<a class="jxr_linenumber" name="1239" href="#1239">1239</a>         <strong class="jxr_keyword">return</strong> false;
<a class="jxr_linenumber" name="1240" href="#1240">1240</a>     }
<a class="jxr_linenumber" name="1241" href="#1241">1241</a> 
<a class="jxr_linenumber" name="1242" href="#1242">1242</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> readAcctReportsTo() {
<a class="jxr_linenumber" name="1243" href="#1243">1243</a>         <em class="jxr_comment">// we will use a report query, to bypass the "persistence" bureaucracy and its cache, saving memory and time</em>
<a class="jxr_linenumber" name="1244" href="#1244">1244</a>         <em class="jxr_comment">// we will use the OJB class as a convenient container object in the hashmap</em>
<a class="jxr_linenumber" name="1245" href="#1245">1245</a>         Integer sqlChartOfAccountsCode = 0;
<a class="jxr_linenumber" name="1246" href="#1246">1246</a>         Integer sqlAccountNumber = 1;
<a class="jxr_linenumber" name="1247" href="#1247">1247</a>         Integer sqlReportsToChartofAccountsCode = 2;
<a class="jxr_linenumber" name="1248" href="#1248">1248</a>         Integer sqlOrganizationCode = 3;
<a class="jxr_linenumber" name="1249" href="#1249">1249</a>         Criteria criteriaID = ReportQueryByCriteria.CRITERIA_SELECT_ALL;
<a class="jxr_linenumber" name="1250" href="#1250">1250</a>         <em class="jxr_comment">// we always get a new copy of the map</em>
<a class="jxr_linenumber" name="1251" href="#1251">1251</a>         acctRptsToMap = <strong class="jxr_keyword">new</strong> HashMap&lt;String, BudgetConstructionAccountReports&gt;(hashObjectSize(BudgetConstructionAccountReports.<strong class="jxr_keyword">class</strong>, criteriaID));
<a class="jxr_linenumber" name="1252" href="#1252">1252</a>         String[] queryAttr = { KFSPropertyConstants.CHART_OF_ACCOUNTS_CODE, KFSPropertyConstants.ACCOUNT_NUMBER, KFSPropertyConstants.REPORTS_TO_CHART_OF_ACCOUNTS_CODE, KFSPropertyConstants.REPORTS_TO_ORGANIZATION_CODE };
<a class="jxr_linenumber" name="1253" href="#1253">1253</a>         ReportQueryByCriteria queryID = <strong class="jxr_keyword">new</strong> ReportQueryByCriteria(BudgetConstructionAccountReports.<strong class="jxr_keyword">class</strong>, queryAttr, criteriaID);
<a class="jxr_linenumber" name="1254" href="#1254">1254</a>         Iterator Results = getPersistenceBrokerTemplate().getReportQueryIteratorByQuery(queryID);
<a class="jxr_linenumber" name="1255" href="#1255">1255</a>         <strong class="jxr_keyword">while</strong> (Results.hasNext()) {
<a class="jxr_linenumber" name="1256" href="#1256">1256</a>             Object[] ReturnList = (Object[]) Results.next();
<a class="jxr_linenumber" name="1257" href="#1257">1257</a>             <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionAccountReports.html">BudgetConstructionAccountReports</a> acctRpts = <strong class="jxr_keyword">new</strong> <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionAccountReports.html">BudgetConstructionAccountReports</a>();
<a class="jxr_linenumber" name="1258" href="#1258">1258</a>             acctRpts.setChartOfAccountsCode((String) ReturnList[sqlChartOfAccountsCode]);
<a class="jxr_linenumber" name="1259" href="#1259">1259</a>             acctRpts.setAccountNumber((String) ReturnList[sqlAccountNumber]);
<a class="jxr_linenumber" name="1260" href="#1260">1260</a>             acctRpts.setReportsToChartOfAccountsCode((String) ReturnList[sqlReportsToChartofAccountsCode]);
<a class="jxr_linenumber" name="1261" href="#1261">1261</a>             acctRpts.setReportsToOrganizationCode((String) ReturnList[sqlOrganizationCode]);
<a class="jxr_linenumber" name="1262" href="#1262">1262</a>             String TestKey = getAcctRptsToKey(acctRpts);
<a class="jxr_linenumber" name="1263" href="#1263">1263</a>             acctRptsToMap.put(TestKey, acctRpts);
<a class="jxr_linenumber" name="1264" href="#1264">1264</a>         }
<a class="jxr_linenumber" name="1265" href="#1265">1265</a>         LOG.info(<span class="jxr_string">"\nAccount Reports To for Organization Hierarchy:"</span>);
<a class="jxr_linenumber" name="1266" href="#1266">1266</a>         LOG.info(String.format(<span class="jxr_string">"\nNumber of account-reports-to rows: %d"</span>, acctRptsToMap.size()));
<a class="jxr_linenumber" name="1267" href="#1267">1267</a>     }
<a class="jxr_linenumber" name="1268" href="#1268">1268</a> 
<a class="jxr_linenumber" name="1269" href="#1269">1269</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> readOrgReportsTo() {
<a class="jxr_linenumber" name="1270" href="#1270">1270</a>         <em class="jxr_comment">// we will use a report query, to bypass the "persistence" bureaucracy and its cache, saving memory and time</em>
<a class="jxr_linenumber" name="1271" href="#1271">1271</a>         <em class="jxr_comment">// we will use the OJB class as a convenient container object in the hashmap</em>
<a class="jxr_linenumber" name="1272" href="#1272">1272</a>         Integer sqlChartOfAccountsCode = 0;
<a class="jxr_linenumber" name="1273" href="#1273">1273</a>         Integer sqlOrganizationCode = 1;
<a class="jxr_linenumber" name="1274" href="#1274">1274</a>         Integer sqlReportsToChartofAccountsCode = 2;
<a class="jxr_linenumber" name="1275" href="#1275">1275</a>         Integer sqlReportsToOrganizationCode = 3;
<a class="jxr_linenumber" name="1276" href="#1276">1276</a>         Criteria criteriaID = ReportQueryByCriteria.CRITERIA_SELECT_ALL;
<a class="jxr_linenumber" name="1277" href="#1277">1277</a>         <em class="jxr_comment">// build a new map</em>
<a class="jxr_linenumber" name="1278" href="#1278">1278</a>         orgRptsToMap = <strong class="jxr_keyword">new</strong> HashMap&lt;String, BudgetConstructionOrganizationReports&gt;(hashObjectSize(BudgetConstructionOrganizationReports.<strong class="jxr_keyword">class</strong>, criteriaID));
<a class="jxr_linenumber" name="1279" href="#1279">1279</a>         String[] queryAttr = { KFSPropertyConstants.CHART_OF_ACCOUNTS_CODE, KFSPropertyConstants.ORGANIZATION_CODE, KFSPropertyConstants.REPORTS_TO_CHART_OF_ACCOUNTS_CODE, KFSPropertyConstants.REPORTS_TO_ORGANIZATION_CODE };
<a class="jxr_linenumber" name="1280" href="#1280">1280</a>         ReportQueryByCriteria queryID = <strong class="jxr_keyword">new</strong> ReportQueryByCriteria(BudgetConstructionOrganizationReports.<strong class="jxr_keyword">class</strong>, queryAttr, criteriaID);
<a class="jxr_linenumber" name="1281" href="#1281">1281</a>         Iterator Results = getPersistenceBrokerTemplate().getReportQueryIteratorByQuery(queryID);
<a class="jxr_linenumber" name="1282" href="#1282">1282</a>         <strong class="jxr_keyword">while</strong> (Results.hasNext()) {
<a class="jxr_linenumber" name="1283" href="#1283">1283</a>             Object[] ReturnList = (Object[]) Results.next();
<a class="jxr_linenumber" name="1284" href="#1284">1284</a>             <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionOrganizationReports.html">BudgetConstructionOrganizationReports</a> orgRpts = <strong class="jxr_keyword">new</strong> <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionOrganizationReports.html">BudgetConstructionOrganizationReports</a>();
<a class="jxr_linenumber" name="1285" href="#1285">1285</a>             orgRpts.setChartOfAccountsCode((String) ReturnList[sqlChartOfAccountsCode]);
<a class="jxr_linenumber" name="1286" href="#1286">1286</a>             orgRpts.setOrganizationCode((String) ReturnList[sqlOrganizationCode]);
<a class="jxr_linenumber" name="1287" href="#1287">1287</a>             orgRpts.setReportsToChartOfAccountsCode((String) ReturnList[sqlReportsToChartofAccountsCode]);
<a class="jxr_linenumber" name="1288" href="#1288">1288</a>             orgRpts.setReportsToOrganizationCode((String) ReturnList[sqlReportsToOrganizationCode]);
<a class="jxr_linenumber" name="1289" href="#1289">1289</a>             String TestKey = getOrgRptsToKey(orgRpts);
<a class="jxr_linenumber" name="1290" href="#1290">1290</a>             orgRptsToMap.put(TestKey, orgRpts);
<a class="jxr_linenumber" name="1291" href="#1291">1291</a>         }
<a class="jxr_linenumber" name="1292" href="#1292">1292</a>         LOG.info(<span class="jxr_string">"\nOrganization Reports To for Organization Hierarchy:"</span>);
<a class="jxr_linenumber" name="1293" href="#1293">1293</a>         LOG.info(String.format(<span class="jxr_string">"\nNumber of organization-reports-to rows: %d"</span>, orgRptsToMap.size()));
<a class="jxr_linenumber" name="1294" href="#1294">1294</a>     }
<a class="jxr_linenumber" name="1295" href="#1295">1295</a> 
<a class="jxr_linenumber" name="1296" href="#1296">1296</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> updateBudgetConstructionHeaderAsNeeded(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionHeader.html">BudgetConstructionHeader</a> bCHdr) {
<a class="jxr_linenumber" name="1297" href="#1297">1297</a>         <em class="jxr_comment">// header rows at the lowest (initial) level should be left alone</em>
<a class="jxr_linenumber" name="1298" href="#1298">1298</a>         <strong class="jxr_keyword">if</strong> (bCHdr.getOrganizationLevelCode().equals(BCConstants.INITIAL_ORGANIZATION_LEVEL_CODE)) {
<a class="jxr_linenumber" name="1299" href="#1299">1299</a>             <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="1300" href="#1300">1300</a>         }
<a class="jxr_linenumber" name="1301" href="#1301">1301</a>         <em class="jxr_comment">// we will only update if the level of the organization has changed </em>
<a class="jxr_linenumber" name="1302" href="#1302">1302</a>         <em class="jxr_comment">// or if the organization has disappeared completely </em>
<a class="jxr_linenumber" name="1303" href="#1303">1303</a>         String mapKey = getOrgHierarchyKeyFromBCHeader(bCHdr);
<a class="jxr_linenumber" name="1304" href="#1304">1304</a>         <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionAccountOrganizationHierarchy.html">BudgetConstructionAccountOrganizationHierarchy</a> acctOrgHier = acctOrgHierMap.get(mapKey);
<a class="jxr_linenumber" name="1305" href="#1305">1305</a>         <strong class="jxr_keyword">if</strong> (acctOrgHier == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="1306" href="#1306">1306</a>             <em class="jxr_comment">// the account no longer reports to this organization</em>
<a class="jxr_linenumber" name="1307" href="#1307">1307</a>             <em class="jxr_comment">// we have to return to the lowest level and the default the</em>
<a class="jxr_linenumber" name="1308" href="#1308">1308</a>             <em class="jxr_comment">// organization reported to</em>
<a class="jxr_linenumber" name="1309" href="#1309">1309</a>             nHeadersBackToZero = nHeadersBackToZero + 1;
<a class="jxr_linenumber" name="1310" href="#1310">1310</a>             bCHdr.setOrganizationLevelChartOfAccountsCode(BCConstants.INITIAL_ORGANIZATION_LEVEL_CHART_OF_ACCOUNTS_CODE);
<a class="jxr_linenumber" name="1311" href="#1311">1311</a>             bCHdr.setOrganizationLevelOrganizationCode(BCConstants.INITIAL_ORGANIZATION_LEVEL_ORGANIZATION_CODE);
<a class="jxr_linenumber" name="1312" href="#1312">1312</a>             bCHdr.setOrganizationLevelCode(BCConstants.INITIAL_ORGANIZATION_LEVEL_CODE);
<a class="jxr_linenumber" name="1313" href="#1313">1313</a>             getPersistenceBrokerTemplate().store(bCHdr);
<a class="jxr_linenumber" name="1314" href="#1314">1314</a>             <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="1315" href="#1315">1315</a>         }
<a class="jxr_linenumber" name="1316" href="#1316">1316</a>         Integer levelFromHierarchy = acctOrgHier.getOrganizationLevelCode();
<a class="jxr_linenumber" name="1317" href="#1317">1317</a>         Integer levelFromHeader = bCHdr.getOrganizationLevelCode();
<a class="jxr_linenumber" name="1318" href="#1318">1318</a>         <strong class="jxr_keyword">if</strong> (!levelFromHierarchy.equals(levelFromHeader)) {
<a class="jxr_linenumber" name="1319" href="#1319">1319</a>             <em class="jxr_comment">// the organization reported to has changed its location in the hierarchy</em>
<a class="jxr_linenumber" name="1320" href="#1320">1320</a>             bCHdr.setOrganizationLevelCode(levelFromHierarchy);
<a class="jxr_linenumber" name="1321" href="#1321">1321</a>             getPersistenceBrokerTemplate().store(bCHdr);
<a class="jxr_linenumber" name="1322" href="#1322">1322</a>             nHeadersSwitchingLevels = nHeadersSwitchingLevels + 1;
<a class="jxr_linenumber" name="1323" href="#1323">1323</a>         }
<a class="jxr_linenumber" name="1324" href="#1324">1324</a>     }
<a class="jxr_linenumber" name="1325" href="#1325">1325</a> 
<a class="jxr_linenumber" name="1326" href="#1326">1326</a> 
<a class="jxr_linenumber" name="1327" href="#1327">1327</a>     <em class="jxr_comment">/*</em>
<a class="jxr_linenumber" name="1328" href="#1328">1328</a> <em class="jxr_comment">     *  **************************************************************************</em>
<a class="jxr_linenumber" name="1329" href="#1329">1329</a> <em class="jxr_comment">     *  (6) here are the routines we will use for updating budget construction GL*</em>
<a class="jxr_linenumber" name="1330" href="#1330">1330</a> <em class="jxr_comment">     *  **************************************************************************</em>
<a class="jxr_linenumber" name="1331" href="#1331">1331</a> <em class="jxr_comment">     */</em>
<a class="jxr_linenumber" name="1332" href="#1332">1332</a>     <em class="jxr_comment">// maps (hash maps) to return the results of the GL call</em>
<a class="jxr_linenumber" name="1333" href="#1333">1333</a>     <em class="jxr_comment">// --pBGLFromGL contains all the rows returned, stuffed into an object that can be </em>
<a class="jxr_linenumber" name="1334" href="#1334">1334</a>     <em class="jxr_comment">//   saved to the pending budget construction general ledger</em>
<a class="jxr_linenumber" name="1335" href="#1335">1335</a>     <em class="jxr_comment">// --bCHdrFromGL contains one entry for each potentially new key for the budget</em>
<a class="jxr_linenumber" name="1336" href="#1336">1336</a>     <em class="jxr_comment">//   construction header table.</em>
<a class="jxr_linenumber" name="1337" href="#1337">1337</a>     <strong class="jxr_keyword">private</strong> HashMap&lt;String, PendingBudgetConstructionGeneralLedger&gt; pBGLFromGL = <strong class="jxr_keyword">new</strong> HashMap&lt;String, PendingBudgetConstructionGeneralLedger&gt;(1);
<a class="jxr_linenumber" name="1338" href="#1338">1338</a>     <strong class="jxr_keyword">private</strong> HashMap&lt;String, String&gt; documentNumberFromBCHdr = <strong class="jxr_keyword">new</strong> HashMap&lt;String, String&gt;(1);
<a class="jxr_linenumber" name="1339" href="#1339">1339</a>     <strong class="jxr_keyword">private</strong> HashMap&lt;String, Integer&gt; skippedPBGLKeys = <strong class="jxr_keyword">new</strong> HashMap();
<a class="jxr_linenumber" name="1340" href="#1340">1340</a> 
<a class="jxr_linenumber" name="1341" href="#1341">1341</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> pBGLCleanUp() {
<a class="jxr_linenumber" name="1342" href="#1342">1342</a>         pBGLFromGL.clear();
<a class="jxr_linenumber" name="1343" href="#1343">1343</a>         documentNumberFromBCHdr.clear();
<a class="jxr_linenumber" name="1344" href="#1344">1344</a>     }
<a class="jxr_linenumber" name="1345" href="#1345">1345</a> 
<a class="jxr_linenumber" name="1346" href="#1346">1346</a>     <em class="jxr_comment">// these are the indexes for each of the fields returned in the select list</em>
<a class="jxr_linenumber" name="1347" href="#1347">1347</a>     <em class="jxr_comment">// of the SQL statement</em>
<a class="jxr_linenumber" name="1348" href="#1348">1348</a>     <strong class="jxr_keyword">private</strong> Integer sqlChartOfAccountsCode = 0;
<a class="jxr_linenumber" name="1349" href="#1349">1349</a>     <strong class="jxr_keyword">private</strong> Integer sqlAccountNumber = 1;
<a class="jxr_linenumber" name="1350" href="#1350">1350</a>     <strong class="jxr_keyword">private</strong> Integer sqlSubAccountNumber = 2;
<a class="jxr_linenumber" name="1351" href="#1351">1351</a>     <strong class="jxr_keyword">private</strong> Integer sqlObjectCode = 3;
<a class="jxr_linenumber" name="1352" href="#1352">1352</a>     <strong class="jxr_keyword">private</strong> Integer sqlSubObjectCode = 4;
<a class="jxr_linenumber" name="1353" href="#1353">1353</a>     <strong class="jxr_keyword">private</strong> Integer sqlBalanceTypeCode = 5;
<a class="jxr_linenumber" name="1354" href="#1354">1354</a>     <strong class="jxr_keyword">private</strong> Integer sqlObjectTypeCode = 6;
<a class="jxr_linenumber" name="1355" href="#1355">1355</a>     <strong class="jxr_keyword">private</strong> Integer sqlAccountLineAnnualBalanceAmount = 7;
<a class="jxr_linenumber" name="1356" href="#1356">1356</a>     <strong class="jxr_keyword">private</strong> Integer sqlBeginningBalanceLineAmount = 8;
<a class="jxr_linenumber" name="1357" href="#1357">1357</a> 
<a class="jxr_linenumber" name="1358" href="#1358">1358</a>     <strong class="jxr_keyword">private</strong> Integer nGLHeadersAdded = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1359" href="#1359">1359</a>     <strong class="jxr_keyword">private</strong> Integer nGLRowsAdded = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1360" href="#1360">1360</a>     <strong class="jxr_keyword">private</strong> Integer nGLRowsUpdated = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1361" href="#1361">1361</a>     <strong class="jxr_keyword">private</strong> Integer nCurrentPBGLRows = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1362" href="#1362">1362</a>     <strong class="jxr_keyword">private</strong> Integer nGLBBRowsZeroNet = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1363" href="#1363">1363</a>     <strong class="jxr_keyword">private</strong> Integer nGLBBRowsRead = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1364" href="#1364">1364</a>     <strong class="jxr_keyword">private</strong> Integer nGLRowsMatchingPBGL = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1365" href="#1365">1365</a>     <strong class="jxr_keyword">private</strong> Integer nGLBBKeysRead = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1366" href="#1366">1366</a>     <strong class="jxr_keyword">private</strong> Integer nGLBBRowsSkipped = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1367" href="#1367">1367</a> 
<a class="jxr_linenumber" name="1368" href="#1368">1368</a>     <em class="jxr_comment">// public methods</em>
<a class="jxr_linenumber" name="1369" href="#1369">1369</a> 
<a class="jxr_linenumber" name="1370" href="#1370">1370</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> clearHangingBCLocks(Integer BaseYear) {
<a class="jxr_linenumber" name="1371" href="#1371">1371</a>         <em class="jxr_comment">// this routine cleans out any locks that might remain from people leaving</em>
<a class="jxr_linenumber" name="1372" href="#1372">1372</a>         <em class="jxr_comment">// the application abnormally (for example, Fire! Fire! Leave your computer and get out now!).  it assumes that</em>
<a class="jxr_linenumber" name="1373" href="#1373">1373</a>         <em class="jxr_comment">// people are shut out of the application during a batch run, and that all</em>
<a class="jxr_linenumber" name="1374" href="#1374">1374</a>         <em class="jxr_comment">// work prior to the batch run has either been committed, or lost because the connection was broken before a save.</em>
<a class="jxr_linenumber" name="1375" href="#1375">1375</a>         <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionHeader.html">BudgetConstructionHeader</a> lockedDocuments;
<a class="jxr_linenumber" name="1376" href="#1376">1376</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1377" href="#1377">1377</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="1378" href="#1378">1378</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="1379" href="#1379">1379</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, RequestYear);
<a class="jxr_linenumber" name="1380" href="#1380">1380</a>         Criteria lockID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="1381" href="#1381">1381</a>         Criteria tranLockID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="1382" href="#1382">1382</a>         <strong class="jxr_keyword">if</strong> (BCConstants.DEFAULT_BUDGET_HEADER_LOCK_IDS == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="1383" href="#1383">1383</a>             <em class="jxr_comment">//  make sure that a NULL test is used in case = NULL is not supported</em>
<a class="jxr_linenumber" name="1384" href="#1384">1384</a>             <em class="jxr_comment">//  by the database</em>
<a class="jxr_linenumber" name="1385" href="#1385">1385</a>             lockID.addNotNull(BCPropertyConstants.BUDGET_LOCK_USER_IDENTIFIER);
<a class="jxr_linenumber" name="1386" href="#1386">1386</a>             tranLockID.addNotNull(BCPropertyConstants.BUDGET_TRANSACTION_LOCK_USER_IDENTIFIER);
<a class="jxr_linenumber" name="1387" href="#1387">1387</a>         }
<a class="jxr_linenumber" name="1388" href="#1388">1388</a>         <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="1389" href="#1389">1389</a>             lockID.addNotEqualTo(BCPropertyConstants.BUDGET_LOCK_USER_IDENTIFIER, BCConstants.DEFAULT_BUDGET_HEADER_LOCK_IDS);
<a class="jxr_linenumber" name="1390" href="#1390">1390</a>             tranLockID.addNotEqualTo(BCPropertyConstants.BUDGET_TRANSACTION_LOCK_USER_IDENTIFIER, BCConstants.DEFAULT_BUDGET_HEADER_LOCK_IDS);
<a class="jxr_linenumber" name="1391" href="#1391">1391</a>         }
<a class="jxr_linenumber" name="1392" href="#1392">1392</a>         ;
<a class="jxr_linenumber" name="1393" href="#1393">1393</a>         lockID.addOrCriteria(tranLockID);
<a class="jxr_linenumber" name="1394" href="#1394">1394</a>         criteriaID.addAndCriteria(lockID);
<a class="jxr_linenumber" name="1395" href="#1395">1395</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1396" href="#1396">1396</a>         QueryByCriteria queryID = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionHeader.<strong class="jxr_keyword">class</strong>, criteriaID);
<a class="jxr_linenumber" name="1397" href="#1397">1397</a>         Iterator Results = getPersistenceBrokerTemplate().getIteratorByQuery(queryID);
<a class="jxr_linenumber" name="1398" href="#1398">1398</a>         <em class="jxr_comment">//  now just loop through and change the locks</em>
<a class="jxr_linenumber" name="1399" href="#1399">1399</a>         <strong class="jxr_keyword">while</strong> (Results.hasNext()) {
<a class="jxr_linenumber" name="1400" href="#1400">1400</a>             lockedDocuments = (BudgetConstructionHeader) Results.next();
<a class="jxr_linenumber" name="1401" href="#1401">1401</a>             lockedDocuments.setBudgetLockUserIdentifier(BCConstants.DEFAULT_BUDGET_HEADER_LOCK_IDS);
<a class="jxr_linenumber" name="1402" href="#1402">1402</a>             lockedDocuments.setBudgetTransactionLockUserIdentifier(BCConstants.DEFAULT_BUDGET_HEADER_LOCK_IDS);
<a class="jxr_linenumber" name="1403" href="#1403">1403</a>             getPersistenceBrokerTemplate().store(lockedDocuments);
<a class="jxr_linenumber" name="1404" href="#1404">1404</a>         }
<a class="jxr_linenumber" name="1405" href="#1405">1405</a>         <em class="jxr_comment">//   we need to clear the position and funding locks as well</em>
<a class="jxr_linenumber" name="1406" href="#1406">1406</a>         clearHangingPositionLocks(RequestYear);
<a class="jxr_linenumber" name="1407" href="#1407">1407</a>         QueryByCriteria queryId = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionFundingLock.<strong class="jxr_keyword">class</strong>, QueryByCriteria.CRITERIA_SELECT_ALL);
<a class="jxr_linenumber" name="1408" href="#1408">1408</a>         getPersistenceBrokerTemplate().deleteByQuery(queryId);
<a class="jxr_linenumber" name="1409" href="#1409">1409</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="1410" href="#1410">1410</a>     }
<a class="jxr_linenumber" name="1411" href="#1411">1411</a> 
<a class="jxr_linenumber" name="1412" href="#1412">1412</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> initialLoadToPBGL(Integer BaseYear) {
<a class="jxr_linenumber" name="1413" href="#1413">1413</a>         readBCHeaderForDocNumber(BaseYear);
<a class="jxr_linenumber" name="1414" href="#1414">1414</a>         <em class="jxr_comment">// exclude rows with a new GL balance of 0 from the initial pending GL</em>
<a class="jxr_linenumber" name="1415" href="#1415">1415</a>         readGLForPBGL(BaseYear,<strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="1416" href="#1416">1416</a>         addNewGLRowsToPBGL(BaseYear);
<a class="jxr_linenumber" name="1417" href="#1417">1417</a>         writeFinalDiagnosticCounts();
<a class="jxr_linenumber" name="1418" href="#1418">1418</a>         pBGLCleanUp();
<a class="jxr_linenumber" name="1419" href="#1419">1419</a>     }
<a class="jxr_linenumber" name="1420" href="#1420">1420</a> 
<a class="jxr_linenumber" name="1421" href="#1421">1421</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> updateToPBGL(Integer BaseYear) {
<a class="jxr_linenumber" name="1422" href="#1422">1422</a>         readBCHeaderForDocNumber(BaseYear);
<a class="jxr_linenumber" name="1423" href="#1423">1423</a>         <em class="jxr_comment">// allow rows with a net GL balance of 0 to update the pending GL</em>
<a class="jxr_linenumber" name="1424" href="#1424">1424</a>         readGLForPBGL(BaseYear,false);
<a class="jxr_linenumber" name="1425" href="#1425">1425</a>         updateCurrentPBGL(BaseYear);
<a class="jxr_linenumber" name="1426" href="#1426">1426</a>         addNewGLRowsToPBGL(BaseYear);
<a class="jxr_linenumber" name="1427" href="#1427">1427</a>         writeFinalDiagnosticCounts();
<a class="jxr_linenumber" name="1428" href="#1428">1428</a>         pBGLCleanUp();
<a class="jxr_linenumber" name="1429" href="#1429">1429</a>     }
<a class="jxr_linenumber" name="1430" href="#1430">1430</a>     
<a class="jxr_linenumber" name="1431" href="#1431">1431</a>     <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1432" href="#1432">1432</a>     <em class="jxr_comment">//  clear any hanging position locks</em>
<a class="jxr_linenumber" name="1433" href="#1433">1433</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearHangingPositionLocks(Integer RequestYear)
<a class="jxr_linenumber" name="1434" href="#1434">1434</a>     {
<a class="jxr_linenumber" name="1435" href="#1435">1435</a>         <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionPosition.html">BudgetConstructionPosition</a> lockedPositions;
<a class="jxr_linenumber" name="1436" href="#1436">1436</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="1437" href="#1437">1437</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, RequestYear);
<a class="jxr_linenumber" name="1438" href="#1438">1438</a>         Criteria lockID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="1439" href="#1439">1439</a>         <strong class="jxr_keyword">if</strong> (BCConstants.DEFAULT_BUDGET_HEADER_LOCK_IDS == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="1440" href="#1440">1440</a>             <em class="jxr_comment">//  make sure that a NULL test is used in case = NULL is not supported</em>
<a class="jxr_linenumber" name="1441" href="#1441">1441</a>             <em class="jxr_comment">//  by the database</em>
<a class="jxr_linenumber" name="1442" href="#1442">1442</a>             lockID.addNotNull(BCPropertyConstants.POSITION_LOCK_USER_IDENTIFIER);
<a class="jxr_linenumber" name="1443" href="#1443">1443</a>         }
<a class="jxr_linenumber" name="1444" href="#1444">1444</a>         <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="1445" href="#1445">1445</a>             lockID.addNotEqualTo(BCPropertyConstants.POSITION_LOCK_USER_IDENTIFIER, BCConstants.DEFAULT_BUDGET_HEADER_LOCK_IDS);
<a class="jxr_linenumber" name="1446" href="#1446">1446</a>         }
<a class="jxr_linenumber" name="1447" href="#1447">1447</a>         ;
<a class="jxr_linenumber" name="1448" href="#1448">1448</a>         criteriaID.addAndCriteria(lockID);
<a class="jxr_linenumber" name="1449" href="#1449">1449</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1450" href="#1450">1450</a>         QueryByCriteria queryID = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionPosition.<strong class="jxr_keyword">class</strong>, criteriaID);
<a class="jxr_linenumber" name="1451" href="#1451">1451</a>         Iterator Results = getPersistenceBrokerTemplate().getIteratorByQuery(queryID);
<a class="jxr_linenumber" name="1452" href="#1452">1452</a>         <em class="jxr_comment">//  now just loop through and change the locks</em>
<a class="jxr_linenumber" name="1453" href="#1453">1453</a>         <strong class="jxr_keyword">while</strong> (Results.hasNext()) {
<a class="jxr_linenumber" name="1454" href="#1454">1454</a>             lockedPositions = (BudgetConstructionPosition) Results.next();
<a class="jxr_linenumber" name="1455" href="#1455">1455</a>             lockedPositions.setPositionLockUserIdentifier(BCConstants.DEFAULT_BUDGET_HEADER_LOCK_IDS);
<a class="jxr_linenumber" name="1456" href="#1456">1456</a>             getPersistenceBrokerTemplate().store(lockedPositions);
<a class="jxr_linenumber" name="1457" href="#1457">1457</a>         }
<a class="jxr_linenumber" name="1458" href="#1458">1458</a>  }
<a class="jxr_linenumber" name="1459" href="#1459">1459</a> 
<a class="jxr_linenumber" name="1460" href="#1460">1460</a>     <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1461" href="#1461">1461</a>     <em class="jxr_comment">//  two test routines to display the field values in the two business objects</em>
<a class="jxr_linenumber" name="1462" href="#1462">1462</a>     <em class="jxr_comment">//  produced from the GL read.  these are primarily here for initial testing</em>
<a class="jxr_linenumber" name="1463" href="#1463">1463</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> info() {
<a class="jxr_linenumber" name="1464" href="#1464">1464</a>         <strong class="jxr_keyword">if</strong> (!LOG.isEnabledFor(Level.INFO)) {
<a class="jxr_linenumber" name="1465" href="#1465">1465</a>             <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="1466" href="#1466">1466</a>         }
<a class="jxr_linenumber" name="1467" href="#1467">1467</a>         ;
<a class="jxr_linenumber" name="1468" href="#1468">1468</a>         <em class="jxr_comment">//  print one header row   </em>
<a class="jxr_linenumber" name="1469" href="#1469">1469</a>         <strong class="jxr_keyword">for</strong> (Map.Entry&lt;String, String&gt; bcHeaderRows : documentNumberFromBCHdr.entrySet()) {
<a class="jxr_linenumber" name="1470" href="#1470">1470</a>             String toPrint = bcHeaderRows.getValue();
<a class="jxr_linenumber" name="1471" href="#1471">1471</a>             LOG.info(String.format(<span class="jxr_string">"\n\nA sample document number %s\n"</span>, toPrint));
<a class="jxr_linenumber" name="1472" href="#1472">1472</a>             <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="1473" href="#1473">1473</a>         }
<a class="jxr_linenumber" name="1474" href="#1474">1474</a>         <em class="jxr_comment">// print one PBGL row</em>
<a class="jxr_linenumber" name="1475" href="#1475">1475</a>         <strong class="jxr_keyword">for</strong> (Map.Entry&lt;String, PendingBudgetConstructionGeneralLedger&gt; pBGLRows : pBGLFromGL.entrySet()) {
<a class="jxr_linenumber" name="1476" href="#1476">1476</a>             <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/PendingBudgetConstructionGeneralLedger.html">PendingBudgetConstructionGeneralLedger</a> toPrint = pBGLRows.getValue();
<a class="jxr_linenumber" name="1477" href="#1477">1477</a>             LOG.info(<span class="jxr_string">"\n\nA sample PBGL row\n"</span>);
<a class="jxr_linenumber" name="1478" href="#1478">1478</a>             LOG.info(String.format(<span class="jxr_string">"\nDocument Number = %s"</span>, toPrint.getDocumentNumber()));
<a class="jxr_linenumber" name="1479" href="#1479">1479</a>             LOG.info(String.format(<span class="jxr_string">"\nUniversity Fiscal Year = %d"</span>, toPrint.getUniversityFiscalYear()));
<a class="jxr_linenumber" name="1480" href="#1480">1480</a>             LOG.info(String.format(<span class="jxr_string">"\nChart: %s"</span>, toPrint.getChartOfAccountsCode()));
<a class="jxr_linenumber" name="1481" href="#1481">1481</a>             LOG.info(String.format(<span class="jxr_string">"\nAccount: %s"</span>, toPrint.getAccountNumber()));
<a class="jxr_linenumber" name="1482" href="#1482">1482</a>             LOG.info(String.format(<span class="jxr_string">"\nSub Account: %s"</span>, toPrint.getSubAccountNumber()));
<a class="jxr_linenumber" name="1483" href="#1483">1483</a>             LOG.info(String.format(<span class="jxr_string">"\nObject Code: %s"</span>, toPrint.getFinancialObjectCode()));
<a class="jxr_linenumber" name="1484" href="#1484">1484</a>             LOG.info(String.format(<span class="jxr_string">"\nSubobject Code: %s"</span>, toPrint.getFinancialSubObjectCode()));
<a class="jxr_linenumber" name="1485" href="#1485">1485</a>             LOG.info(String.format(<span class="jxr_string">"\nBalance Type: %s"</span>, toPrint.getFinancialBalanceTypeCode()));
<a class="jxr_linenumber" name="1486" href="#1486">1486</a>             LOG.info(String.format(<span class="jxr_string">"\nObject Type: %s"</span>, toPrint.getFinancialObjectTypeCode()));
<a class="jxr_linenumber" name="1487" href="#1487">1487</a>             LOG.info(String.format(<span class="jxr_string">"\nBase Amount: %s"</span>, toPrint.getFinancialBeginningBalanceLineAmount().toString()));
<a class="jxr_linenumber" name="1488" href="#1488">1488</a>             LOG.info(String.format(<span class="jxr_string">"\nRequest Amount: %s"</span>, toPrint.getAccountLineAnnualBalanceAmount().toString()));
<a class="jxr_linenumber" name="1489" href="#1489">1489</a>             LOG.info(String.format(<span class="jxr_string">"\nVersion Number: %d"</span>, toPrint.getVersionNumber()));
<a class="jxr_linenumber" name="1490" href="#1490">1490</a>             <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="1491" href="#1491">1491</a>         }
<a class="jxr_linenumber" name="1492" href="#1492">1492</a>     }
<a class="jxr_linenumber" name="1493" href="#1493">1493</a> 
<a class="jxr_linenumber" name="1494" href="#1494">1494</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> debug() {
<a class="jxr_linenumber" name="1495" href="#1495">1495</a>         <strong class="jxr_keyword">if</strong> (!LOG.isEnabledFor(Level.DEBUG)) {
<a class="jxr_linenumber" name="1496" href="#1496">1496</a>             <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="1497" href="#1497">1497</a>         }
<a class="jxr_linenumber" name="1498" href="#1498">1498</a>         ;
<a class="jxr_linenumber" name="1499" href="#1499">1499</a>         <em class="jxr_comment">//  print one header row    </em>
<a class="jxr_linenumber" name="1500" href="#1500">1500</a>         <strong class="jxr_keyword">for</strong> (Map.Entry&lt;String, String&gt; bcHeaderRows : documentNumberFromBCHdr.entrySet()) {
<a class="jxr_linenumber" name="1501" href="#1501">1501</a>             String toPrint = bcHeaderRows.getValue();
<a class="jxr_linenumber" name="1502" href="#1502">1502</a>             LOG.debug(String.format(<span class="jxr_string">"\n\nA sample document number %s\n"</span>, toPrint));
<a class="jxr_linenumber" name="1503" href="#1503">1503</a>             <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="1504" href="#1504">1504</a>         }
<a class="jxr_linenumber" name="1505" href="#1505">1505</a>         <em class="jxr_comment">// print one PBGL row</em>
<a class="jxr_linenumber" name="1506" href="#1506">1506</a>         <strong class="jxr_keyword">for</strong> (Map.Entry&lt;String, PendingBudgetConstructionGeneralLedger&gt; pBGLRows : pBGLFromGL.entrySet()) {
<a class="jxr_linenumber" name="1507" href="#1507">1507</a>             <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/PendingBudgetConstructionGeneralLedger.html">PendingBudgetConstructionGeneralLedger</a> toPrint = pBGLRows.getValue();
<a class="jxr_linenumber" name="1508" href="#1508">1508</a>             LOG.debug(<span class="jxr_string">"\n\nA sample PBGL row\n"</span>);
<a class="jxr_linenumber" name="1509" href="#1509">1509</a>             LOG.debug(String.format(<span class="jxr_string">"\nDocument Number = %s"</span>, toPrint.getDocumentNumber()));
<a class="jxr_linenumber" name="1510" href="#1510">1510</a>             LOG.debug(String.format(<span class="jxr_string">"\nUniversity Fiscal Year = %d"</span>, toPrint.getUniversityFiscalYear()));
<a class="jxr_linenumber" name="1511" href="#1511">1511</a>             LOG.debug(String.format(<span class="jxr_string">"\nChart: %s"</span>, toPrint.getChartOfAccountsCode()));
<a class="jxr_linenumber" name="1512" href="#1512">1512</a>             LOG.debug(String.format(<span class="jxr_string">"\nAccount: %s"</span>, toPrint.getAccountNumber()));
<a class="jxr_linenumber" name="1513" href="#1513">1513</a>             LOG.debug(String.format(<span class="jxr_string">"\nSub Account: %s"</span>, toPrint.getSubAccountNumber()));
<a class="jxr_linenumber" name="1514" href="#1514">1514</a>             LOG.debug(String.format(<span class="jxr_string">"\nObject Code: %s"</span>, toPrint.getFinancialObjectCode()));
<a class="jxr_linenumber" name="1515" href="#1515">1515</a>             LOG.debug(String.format(<span class="jxr_string">"\nSubobject Code: %s"</span>, toPrint.getFinancialSubObjectCode()));
<a class="jxr_linenumber" name="1516" href="#1516">1516</a>             LOG.debug(String.format(<span class="jxr_string">"\nBalance Type: %s"</span>, toPrint.getFinancialBalanceTypeCode()));
<a class="jxr_linenumber" name="1517" href="#1517">1517</a>             LOG.debug(String.format(<span class="jxr_string">"\nObject Type: %s"</span>, toPrint.getFinancialObjectTypeCode()));
<a class="jxr_linenumber" name="1518" href="#1518">1518</a>             LOG.debug(String.format(<span class="jxr_string">"\nBase Amount: %s"</span>, toPrint.getFinancialBeginningBalanceLineAmount().toString()));
<a class="jxr_linenumber" name="1519" href="#1519">1519</a>             LOG.debug(String.format(<span class="jxr_string">"\nRequest Amount: %s"</span>, toPrint.getAccountLineAnnualBalanceAmount().toString()));
<a class="jxr_linenumber" name="1520" href="#1520">1520</a>             LOG.debug(String.format(<span class="jxr_string">"\nVersion Number: %d"</span>, toPrint.getVersionNumber()));
<a class="jxr_linenumber" name="1521" href="#1521">1521</a>             <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="1522" href="#1522">1522</a>         }
<a class="jxr_linenumber" name="1523" href="#1523">1523</a>     }
<a class="jxr_linenumber" name="1524" href="#1524">1524</a> 
<a class="jxr_linenumber" name="1525" href="#1525">1525</a>     <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1526" href="#1526">1526</a>     <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1527" href="#1527">1527</a>     <em class="jxr_comment">// private working methods</em>
<a class="jxr_linenumber" name="1528" href="#1528">1528</a> 
<a class="jxr_linenumber" name="1529" href="#1529">1529</a>     <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1530" href="#1530">1530</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> addNewGLRowsToPBGL(Integer BaseYear) {
<a class="jxr_linenumber" name="1531" href="#1531">1531</a>         <em class="jxr_comment">// this method adds the GL rows not yet in PBGL to PBGL</em>
<a class="jxr_linenumber" name="1532" href="#1532">1532</a>         <strong class="jxr_keyword">for</strong> (Map.Entry&lt;String, PendingBudgetConstructionGeneralLedger&gt; newPBGLRows : pBGLFromGL.entrySet()) {
<a class="jxr_linenumber" name="1533" href="#1533">1533</a>             <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/PendingBudgetConstructionGeneralLedger.html">PendingBudgetConstructionGeneralLedger</a> rowToAdd = newPBGLRows.getValue();
<a class="jxr_linenumber" name="1534" href="#1534">1534</a>             <em class="jxr_comment">// no rows with zero base are added to the budget construction pending general ledger</em>
<a class="jxr_linenumber" name="1535" href="#1535">1535</a>             <strong class="jxr_keyword">if</strong> (rowToAdd.getFinancialBeginningBalanceLineAmount().isZero())
<a class="jxr_linenumber" name="1536" href="#1536">1536</a>             {
<a class="jxr_linenumber" name="1537" href="#1537">1537</a>               nGLBBRowsZeroNet = nGLBBRowsZeroNet + 1;
<a class="jxr_linenumber" name="1538" href="#1538">1538</a>             }
<a class="jxr_linenumber" name="1539" href="#1539">1539</a>             <strong class="jxr_keyword">else</strong>
<a class="jxr_linenumber" name="1540" href="#1540">1540</a>             {
<a class="jxr_linenumber" name="1541" href="#1541">1541</a>               nGLRowsAdded = nGLRowsAdded + 1;
<a class="jxr_linenumber" name="1542" href="#1542">1542</a>               getPersistenceBrokerTemplate().store(rowToAdd);
<a class="jxr_linenumber" name="1543" href="#1543">1543</a>             }
<a class="jxr_linenumber" name="1544" href="#1544">1544</a>         }
<a class="jxr_linenumber" name="1545" href="#1545">1545</a>     }
<a class="jxr_linenumber" name="1546" href="#1546">1546</a> 
<a class="jxr_linenumber" name="1547" href="#1547">1547</a>     <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1548" href="#1548">1548</a>     <em class="jxr_comment">// these two methods build the GL field string that triggers creation of a new</em>
<a class="jxr_linenumber" name="1549" href="#1549">1549</a>     <em class="jxr_comment">// pending budget construction general ledger row</em>
<a class="jxr_linenumber" name="1550" href="#1550">1550</a>     <strong class="jxr_keyword">protected</strong> String buildGLTestKeyFromPBGL(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/PendingBudgetConstructionGeneralLedger.html">PendingBudgetConstructionGeneralLedger</a> pendingBudgetConstructionGeneralLedger) {
<a class="jxr_linenumber" name="1551" href="#1551">1551</a>         String PBGLTestKey = <strong class="jxr_keyword">new</strong> String();
<a class="jxr_linenumber" name="1552" href="#1552">1552</a>         PBGLTestKey = pendingBudgetConstructionGeneralLedger.getChartOfAccountsCode() + pendingBudgetConstructionGeneralLedger.getAccountNumber() + pendingBudgetConstructionGeneralLedger.getSubAccountNumber() + pendingBudgetConstructionGeneralLedger.getFinancialObjectCode() + pendingBudgetConstructionGeneralLedger.getFinancialSubObjectCode() + pendingBudgetConstructionGeneralLedger.getFinancialBalanceTypeCode() + pendingBudgetConstructionGeneralLedger.getFinancialObjectTypeCode();
<a class="jxr_linenumber" name="1553" href="#1553">1553</a>         <strong class="jxr_keyword">return</strong> PBGLTestKey;
<a class="jxr_linenumber" name="1554" href="#1554">1554</a>     }
<a class="jxr_linenumber" name="1555" href="#1555">1555</a> 
<a class="jxr_linenumber" name="1556" href="#1556">1556</a>     <strong class="jxr_keyword">protected</strong> String buildGLTestKeyFromSQLResults(Object[] sqlResult) {
<a class="jxr_linenumber" name="1557" href="#1557">1557</a>         String GLTestKey = <strong class="jxr_keyword">new</strong> String();
<a class="jxr_linenumber" name="1558" href="#1558">1558</a>         GLTestKey = (String) sqlResult[sqlChartOfAccountsCode] + (String) sqlResult[sqlAccountNumber] + (String) sqlResult[sqlSubAccountNumber] + (String) sqlResult[sqlObjectCode] + (String) sqlResult[sqlSubObjectCode] + (String) sqlResult[sqlBalanceTypeCode] + (String) sqlResult[sqlObjectTypeCode];
<a class="jxr_linenumber" name="1559" href="#1559">1559</a>         <strong class="jxr_keyword">return</strong> GLTestKey;
<a class="jxr_linenumber" name="1560" href="#1560">1560</a>     }
<a class="jxr_linenumber" name="1561" href="#1561">1561</a> 
<a class="jxr_linenumber" name="1562" href="#1562">1562</a>     <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1563" href="#1563">1563</a>     <em class="jxr_comment">// these two methods build the GL field string that triggers creation of a new</em>
<a class="jxr_linenumber" name="1564" href="#1564">1564</a>     <em class="jxr_comment">// budget construction header</em>
<a class="jxr_linenumber" name="1565" href="#1565">1565</a>     <strong class="jxr_keyword">public</strong> String buildHeaderTestKeyFromPBGL(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/PendingBudgetConstructionGeneralLedger.html">PendingBudgetConstructionGeneralLedger</a> pendingBudgetConstructionGeneralLedger) {
<a class="jxr_linenumber" name="1566" href="#1566">1566</a>         String headerBCTestKey = <strong class="jxr_keyword">new</strong> String();
<a class="jxr_linenumber" name="1567" href="#1567">1567</a>         headerBCTestKey = pendingBudgetConstructionGeneralLedger.getChartOfAccountsCode() + pendingBudgetConstructionGeneralLedger.getAccountNumber() + pendingBudgetConstructionGeneralLedger.getSubAccountNumber();
<a class="jxr_linenumber" name="1568" href="#1568">1568</a>         <strong class="jxr_keyword">return</strong> headerBCTestKey;
<a class="jxr_linenumber" name="1569" href="#1569">1569</a>     }
<a class="jxr_linenumber" name="1570" href="#1570">1570</a> 
<a class="jxr_linenumber" name="1571" href="#1571">1571</a>     <strong class="jxr_keyword">protected</strong> String buildHeaderTestKeyFromSQLResults(Object[] sqlResult) {
<a class="jxr_linenumber" name="1572" href="#1572">1572</a>         String headerBCTestKey = <strong class="jxr_keyword">new</strong> String();
<a class="jxr_linenumber" name="1573" href="#1573">1573</a>         headerBCTestKey = (String) sqlResult[sqlChartOfAccountsCode] + (String) sqlResult[sqlAccountNumber] + (String) sqlResult[sqlSubAccountNumber];
<a class="jxr_linenumber" name="1574" href="#1574">1574</a>         <strong class="jxr_keyword">return</strong> headerBCTestKey;
<a class="jxr_linenumber" name="1575" href="#1575">1575</a>     }
<a class="jxr_linenumber" name="1576" href="#1576">1576</a> 
<a class="jxr_linenumber" name="1577" href="#1577">1577</a>     <strong class="jxr_keyword">protected</strong> <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/PendingBudgetConstructionGeneralLedger.html">PendingBudgetConstructionGeneralLedger</a> newPBGLBusinessObject(Integer RequestYear, Object[] sqlResult) {
<a class="jxr_linenumber" name="1578" href="#1578">1578</a>         <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/PendingBudgetConstructionGeneralLedger.html">PendingBudgetConstructionGeneralLedger</a> PBGLObj = <strong class="jxr_keyword">new</strong> <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/PendingBudgetConstructionGeneralLedger.html">PendingBudgetConstructionGeneralLedger</a>();
<a class="jxr_linenumber" name="1579" href="#1579">1579</a>         <em class="jxr_comment">/*<em class="jxr_comment">  </em></em>
<a class="jxr_linenumber" name="1580" href="#1580">1580</a> <em class="jxr_comment">         * the document number will be set later if we have to store this in a new document</em>
<a class="jxr_linenumber" name="1581" href="#1581">1581</a> <em class="jxr_comment">         * a new row in an existing document will take it's document number from the existing document</em>
<a class="jxr_linenumber" name="1582" href="#1582">1582</a> <em class="jxr_comment">         * otherwise (existing document, existing row), the only field in this that will be different from</em>
<a class="jxr_linenumber" name="1583" href="#1583">1583</a> <em class="jxr_comment">         * the existing row is the beginning balance amount</em>
<a class="jxr_linenumber" name="1584" href="#1584">1584</a> <em class="jxr_comment">         */</em>
<a class="jxr_linenumber" name="1585" href="#1585">1585</a>         PBGLObj.setUniversityFiscalYear(RequestYear);
<a class="jxr_linenumber" name="1586" href="#1586">1586</a>         PBGLObj.setChartOfAccountsCode((String) sqlResult[sqlChartOfAccountsCode]);
<a class="jxr_linenumber" name="1587" href="#1587">1587</a>         PBGLObj.setAccountNumber((String) sqlResult[sqlAccountNumber]);
<a class="jxr_linenumber" name="1588" href="#1588">1588</a>         PBGLObj.setSubAccountNumber((String) sqlResult[sqlSubAccountNumber]);
<a class="jxr_linenumber" name="1589" href="#1589">1589</a>         PBGLObj.setFinancialObjectCode((String) sqlResult[sqlObjectCode]);
<a class="jxr_linenumber" name="1590" href="#1590">1590</a>         PBGLObj.setFinancialSubObjectCode((String) sqlResult[sqlSubObjectCode]);
<a class="jxr_linenumber" name="1591" href="#1591">1591</a>         PBGLObj.setFinancialBalanceTypeCode((String) sqlResult[sqlBalanceTypeCode]);
<a class="jxr_linenumber" name="1592" href="#1592">1592</a>         PBGLObj.setFinancialObjectTypeCode((String) sqlResult[sqlObjectTypeCode]);
<a class="jxr_linenumber" name="1593" href="#1593">1593</a>         KualiDecimal BaseAmount = (KualiDecimal) sqlResult[sqlBeginningBalanceLineAmount];
<a class="jxr_linenumber" name="1594" href="#1594">1594</a>         BaseAmount = BaseAmount.add((KualiDecimal) sqlResult[sqlAccountLineAnnualBalanceAmount]);
<a class="jxr_linenumber" name="1595" href="#1595">1595</a>         KualiInteger DollarBaseAmount = <strong class="jxr_keyword">new</strong> KualiInteger(BaseAmount.bigDecimalValue());
<a class="jxr_linenumber" name="1596" href="#1596">1596</a>         PBGLObj.setFinancialBeginningBalanceLineAmount(DollarBaseAmount);
<a class="jxr_linenumber" name="1597" href="#1597">1597</a>         PBGLObj.setAccountLineAnnualBalanceAmount(KualiInteger.ZERO);
<a class="jxr_linenumber" name="1598" href="#1598">1598</a>         <em class="jxr_comment">//  ObjectID is set in the BusinessObjectBase on insert and update</em>
<a class="jxr_linenumber" name="1599" href="#1599">1599</a>         <em class="jxr_comment">//  but, we must set the version number</em>
<a class="jxr_linenumber" name="1600" href="#1600">1600</a>         PBGLObj.setVersionNumber(DEFAULT_VERSION_NUMBER);
<a class="jxr_linenumber" name="1601" href="#1601">1601</a>         <strong class="jxr_keyword">return</strong> PBGLObj;
<a class="jxr_linenumber" name="1602" href="#1602">1602</a>     }
<a class="jxr_linenumber" name="1603" href="#1603">1603</a> 
<a class="jxr_linenumber" name="1604" href="#1604">1604</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> readBCHeaderForDocNumber(Integer BaseYear) {
<a class="jxr_linenumber" name="1605" href="#1605">1605</a>         <em class="jxr_comment">//  we have to read all the budget construction header objects so that</em>
<a class="jxr_linenumber" name="1606" href="#1606">1606</a>         <em class="jxr_comment">//  we can use them to assign document numbers</em>
<a class="jxr_linenumber" name="1607" href="#1607">1607</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1608" href="#1608">1608</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="1609" href="#1609">1609</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1610" href="#1610">1610</a>         Long documentsRead = <strong class="jxr_keyword">new</strong> Long(0);
<a class="jxr_linenumber" name="1611" href="#1611">1611</a>         Criteria criteriaId = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="1612" href="#1612">1612</a>         criteriaId.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, RequestYear);
<a class="jxr_linenumber" name="1613" href="#1613">1613</a>         documentNumberFromBCHdr = <strong class="jxr_keyword">new</strong> HashMap&lt;String, String&gt;(hashObjectSize(BudgetConstructionHeader.<strong class="jxr_keyword">class</strong>, criteriaId));
<a class="jxr_linenumber" name="1614" href="#1614">1614</a>         String[] queryAttr = { KFSPropertyConstants.CHART_OF_ACCOUNTS_CODE, KFSPropertyConstants.ACCOUNT_NUMBER, KFSPropertyConstants.SUB_ACCOUNT_NUMBER, KFSPropertyConstants.DOCUMENT_NUMBER };
<a class="jxr_linenumber" name="1615" href="#1615">1615</a>         ReportQueryByCriteria queryId = <strong class="jxr_keyword">new</strong> ReportQueryByCriteria(BudgetConstructionHeader.<strong class="jxr_keyword">class</strong>, queryAttr, criteriaId);
<a class="jxr_linenumber" name="1616" href="#1616">1616</a>         Iterator Results = getPersistenceBrokerTemplate().getReportQueryIteratorByQuery(queryId);
<a class="jxr_linenumber" name="1617" href="#1617">1617</a>         <strong class="jxr_keyword">while</strong> (Results.hasNext()) {
<a class="jxr_linenumber" name="1618" href="#1618">1618</a>             Object[] rowReturned = (Object[]) Results.next();
<a class="jxr_linenumber" name="1619" href="#1619">1619</a>             String hashKey = ((String) rowReturned[0]) + ((String) rowReturned[1]) + ((String) rowReturned[2]);
<a class="jxr_linenumber" name="1620" href="#1620">1620</a>             documentNumberFromBCHdr.put(hashKey, ((String) rowReturned[3]));
<a class="jxr_linenumber" name="1621" href="#1621">1621</a>             documentsRead = documentsRead + 1;
<a class="jxr_linenumber" name="1622" href="#1622">1622</a>         }
<a class="jxr_linenumber" name="1623" href="#1623">1623</a>         LOG.info(String.format(<span class="jxr_string">"\nBC Headers read = %d"</span>, documentsRead));
<a class="jxr_linenumber" name="1624" href="#1624">1624</a>     }
<a class="jxr_linenumber" name="1625" href="#1625">1625</a> 
<a class="jxr_linenumber" name="1626" href="#1626">1626</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> readGLForPBGL(Integer BaseYear, <strong class="jxr_keyword">boolean</strong> excludeZeroNetAmounts) {
<a class="jxr_linenumber" name="1627" href="#1627">1627</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="1628" href="#1628">1628</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1629" href="#1629">1629</a>         <em class="jxr_comment">//  set up a report query to fetch all the GL rows we are going to need</em>
<a class="jxr_linenumber" name="1630" href="#1630">1630</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="1631" href="#1631">1631</a>         <em class="jxr_comment">// we only pick up a single balance type</em>
<a class="jxr_linenumber" name="1632" href="#1632">1632</a>         <em class="jxr_comment">// we also use an integer fiscal year</em>
<a class="jxr_linenumber" name="1633" href="#1633">1633</a>         <em class="jxr_comment">// *** this is a point of change if either of these criteria change ***</em>
<a class="jxr_linenumber" name="1634" href="#1634">1634</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear);
<a class="jxr_linenumber" name="1635" href="#1635">1635</a>         criteriaID.addEqualTo(KFSPropertyConstants.BALANCE_TYPE_CODE, KFSConstants.BALANCE_TYPE_BASE_BUDGET);
<a class="jxr_linenumber" name="1636" href="#1636">1636</a>         <em class="jxr_comment">//  we'll estimate the size of the PBGL map from the number of</em>
<a class="jxr_linenumber" name="1637" href="#1637">1637</a>         <em class="jxr_comment">//  base budget rows in the GL.  this should be close</em>
<a class="jxr_linenumber" name="1638" href="#1638">1638</a>         pBGLFromGL = <strong class="jxr_keyword">new</strong> HashMap&lt;String, PendingBudgetConstructionGeneralLedger&gt;(hashObjectSize(Balance.<strong class="jxr_keyword">class</strong>, criteriaID));
<a class="jxr_linenumber" name="1639" href="#1639">1639</a>         String[] queryAttr = { KFSPropertyConstants.CHART_OF_ACCOUNTS_CODE, KFSPropertyConstants.ACCOUNT_NUMBER, KFSPropertyConstants.SUB_ACCOUNT_NUMBER, KFSPropertyConstants.OBJECT_CODE, KFSPropertyConstants.SUB_OBJECT_CODE, KFSPropertyConstants.BALANCE_TYPE_CODE, KFSPropertyConstants.OBJECT_TYPE_CODE, KFSPropertyConstants.ACCOUNT_LINE_ANNUAL_BALANCE_AMOUNT, KFSPropertyConstants.BEGINNING_BALANCE_LINE_AMOUNT };
<a class="jxr_linenumber" name="1640" href="#1640">1640</a>         ReportQueryByCriteria queryID = <strong class="jxr_keyword">new</strong> ReportQueryByCriteria(Balance.<strong class="jxr_keyword">class</strong>, queryAttr, criteriaID, <strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="1641" href="#1641">1641</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1642" href="#1642">1642</a>         <em class="jxr_comment">// set up the hashmaps by iterating through the results</em>
<a class="jxr_linenumber" name="1643" href="#1643">1643</a> 
<a class="jxr_linenumber" name="1644" href="#1644">1644</a>         LOG.info(<span class="jxr_string">"\nGL Query started: "</span> + String.format(<span class="jxr_string">"%tT"</span>, dateTimeService.getCurrentDate()));
<a class="jxr_linenumber" name="1645" href="#1645">1645</a>         Iterator Results = getPersistenceBrokerTemplate().getReportQueryIteratorByQuery(queryID);
<a class="jxr_linenumber" name="1646" href="#1646">1646</a>         LOG.info(<span class="jxr_string">"\nGL Query finished: "</span> + String.format(<span class="jxr_string">"%tT"</span>, dateTimeService.getCurrentDate()));
<a class="jxr_linenumber" name="1647" href="#1647">1647</a>         <strong class="jxr_keyword">while</strong> (Results.hasNext()) {
<a class="jxr_linenumber" name="1648" href="#1648">1648</a>             Object[] ReturnList = (Object[]) Results.next();
<a class="jxr_linenumber" name="1649" href="#1649">1649</a>             LOG.debug(String.format(<span class="jxr_string">"\nfields returned = %d\n"</span>, ReturnList.length));
<a class="jxr_linenumber" name="1650" href="#1650">1650</a>             LOG.debug(String.format(<span class="jxr_string">"\nvalue in last field = %s\n"</span>, ReturnList[sqlBeginningBalanceLineAmount].toString()));
<a class="jxr_linenumber" name="1651" href="#1651">1651</a>             <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1652" href="#1652">1652</a>             <em class="jxr_comment">// we never load a new pending budget construction row from a general ledger row which has a net zero balance</em>
<a class="jxr_linenumber" name="1653" href="#1653">1653</a>             <em class="jxr_comment">// but we allow for the fact that the general ledger counterpart of a pending row already loaded could be netted to zero by a budget transfer. in this case, we need to update the pending amount.</em>
<a class="jxr_linenumber" name="1654" href="#1654">1654</a>             KualiDecimal BaseAmount = (KualiDecimal) ReturnList[sqlBeginningBalanceLineAmount];
<a class="jxr_linenumber" name="1655" href="#1655">1655</a>             BaseAmount = BaseAmount.add((KualiDecimal) ReturnList[sqlAccountLineAnnualBalanceAmount]);
<a class="jxr_linenumber" name="1656" href="#1656">1656</a>             <em class="jxr_comment">// even when we are updating, it could be that the entire key is not in the pending general ledger because the amounts in all GL rows for that key have always netted to zero.</em>
<a class="jxr_linenumber" name="1657" href="#1657">1657</a>             <em class="jxr_comment">// in this case, there will be no document number, and we should skip the row.</em>
<a class="jxr_linenumber" name="1658" href="#1658">1658</a>             String HeaderTestKey = buildHeaderTestKeyFromSQLResults(ReturnList);
<a class="jxr_linenumber" name="1659" href="#1659">1659</a>             String documentNumberForKey = documentNumberFromBCHdr.get(HeaderTestKey);
<a class="jxr_linenumber" name="1660" href="#1660">1660</a>             <strong class="jxr_keyword">if</strong> (documentNumberForKey == <strong class="jxr_keyword">null</strong>)
<a class="jxr_linenumber" name="1661" href="#1661">1661</a>             {
<a class="jxr_linenumber" name="1662" href="#1662">1662</a>                 <strong class="jxr_keyword">if</strong> (BaseAmount.isZero())
<a class="jxr_linenumber" name="1663" href="#1663">1663</a>                 {
<a class="jxr_linenumber" name="1664" href="#1664">1664</a>                   <em class="jxr_comment">// keys in which all rows have base amounts of zero need not have a key   </em>
<a class="jxr_linenumber" name="1665" href="#1665">1665</a>                   nGLBBRowsRead = nGLBBRowsRead + 1;
<a class="jxr_linenumber" name="1666" href="#1666">1666</a>                   nGLBBRowsZeroNet = nGLBBRowsZeroNet + 1;
<a class="jxr_linenumber" name="1667" href="#1667">1667</a>                 }
<a class="jxr_linenumber" name="1668" href="#1668">1668</a>                 <strong class="jxr_keyword">else</strong>
<a class="jxr_linenumber" name="1669" href="#1669">1669</a>                 {
<a class="jxr_linenumber" name="1670" href="#1670">1670</a>                     <em class="jxr_comment">// the amounts are *not* zero--the row should *not* be skipped, and we need to log an error</em>
<a class="jxr_linenumber" name="1671" href="#1671">1671</a>                     recordSkippedKeys(HeaderTestKey);
<a class="jxr_linenumber" name="1672" href="#1672">1672</a>                 }
<a class="jxr_linenumber" name="1673" href="#1673">1673</a>                 <strong class="jxr_keyword">continue</strong>;
<a class="jxr_linenumber" name="1674" href="#1674">1674</a>             }
<a class="jxr_linenumber" name="1675" href="#1675">1675</a>             <strong class="jxr_keyword">if</strong> ((excludeZeroNetAmounts) &amp;&amp; BaseAmount.isZero())
<a class="jxr_linenumber" name="1676" href="#1676">1676</a>             {    
<a class="jxr_linenumber" name="1677" href="#1677">1677</a>               <em class="jxr_comment">//  exclude any rows where the amounts add to 0</em>
<a class="jxr_linenumber" name="1678" href="#1678">1678</a>               <em class="jxr_comment">//  (we don't do it in the WHERE clause to be certain we are ANSI standard)</em>
<a class="jxr_linenumber" name="1679" href="#1679">1679</a>                   nGLBBRowsRead = nGLBBRowsRead + 1;
<a class="jxr_linenumber" name="1680" href="#1680">1680</a>                   nGLBBRowsZeroNet = nGLBBRowsZeroNet + 1;
<a class="jxr_linenumber" name="1681" href="#1681">1681</a>                   <strong class="jxr_keyword">continue</strong>;
<a class="jxr_linenumber" name="1682" href="#1682">1682</a>             }
<a class="jxr_linenumber" name="1683" href="#1683">1683</a>             <em class="jxr_comment">//  </em>
<a class="jxr_linenumber" name="1684" href="#1684">1684</a>             <em class="jxr_comment">//  we always need to build a new PGBL object</em>
<a class="jxr_linenumber" name="1685" href="#1685">1685</a>             <em class="jxr_comment">//  we have selected the entire key from GL_BALANCE_T</em>
<a class="jxr_linenumber" name="1686" href="#1686">1686</a>             String GLTestKey = buildGLTestKeyFromSQLResults(ReturnList);
<a class="jxr_linenumber" name="1687" href="#1687">1687</a>             pBGLFromGL.put(GLTestKey, newPBGLBusinessObject(RequestYear, ReturnList));
<a class="jxr_linenumber" name="1688" href="#1688">1688</a>             <em class="jxr_comment">//  we need to add a document number to the PBGL object</em>
<a class="jxr_linenumber" name="1689" href="#1689">1689</a>             pBGLFromGL.get(GLTestKey).setDocumentNumber(documentNumberForKey);
<a class="jxr_linenumber" name="1690" href="#1690">1690</a>         }
<a class="jxr_linenumber" name="1691" href="#1691">1691</a>         LOG.info(<span class="jxr_string">"\nHash maps built: "</span> + String.format(<span class="jxr_string">"%tT"</span>, dateTimeService.getCurrentDate()));
<a class="jxr_linenumber" name="1692" href="#1692">1692</a>         info();
<a class="jxr_linenumber" name="1693" href="#1693">1693</a>         nGLBBKeysRead = documentNumberFromBCHdr.size();
<a class="jxr_linenumber" name="1694" href="#1694">1694</a>         nGLBBRowsRead = pBGLFromGL.size() + nGLBBRowsRead;
<a class="jxr_linenumber" name="1695" href="#1695">1695</a>     }
<a class="jxr_linenumber" name="1696" href="#1696">1696</a> 
<a class="jxr_linenumber" name="1697" href="#1697">1697</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> recordSkippedKeys(String badGLKey) {
<a class="jxr_linenumber" name="1698" href="#1698">1698</a>         nGLBBRowsSkipped = nGLBBRowsSkipped + 1;
<a class="jxr_linenumber" name="1699" href="#1699">1699</a>         <strong class="jxr_keyword">if</strong> (skippedPBGLKeys.get(badGLKey) == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="1700" href="#1700">1700</a>             skippedPBGLKeys.put(badGLKey, <strong class="jxr_keyword">new</strong> Integer(1));
<a class="jxr_linenumber" name="1701" href="#1701">1701</a>         }
<a class="jxr_linenumber" name="1702" href="#1702">1702</a>         <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="1703" href="#1703">1703</a>             Integer rowCount = skippedPBGLKeys.get(badGLKey) + 1;
<a class="jxr_linenumber" name="1704" href="#1704">1704</a>             skippedPBGLKeys.put(badGLKey, rowCount);
<a class="jxr_linenumber" name="1705" href="#1705">1705</a>         }
<a class="jxr_linenumber" name="1706" href="#1706">1706</a>     }
<a class="jxr_linenumber" name="1707" href="#1707">1707</a> 
<a class="jxr_linenumber" name="1708" href="#1708">1708</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> updateBaseBudgetAmount(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/PendingBudgetConstructionGeneralLedger.html">PendingBudgetConstructionGeneralLedger</a> currentPBGLInstance) {
<a class="jxr_linenumber" name="1709" href="#1709">1709</a>         String TestKey = buildGLTestKeyFromPBGL(currentPBGLInstance);
<a class="jxr_linenumber" name="1710" href="#1710">1710</a>         <strong class="jxr_keyword">if</strong> (!pBGLFromGL.containsKey(TestKey)) {
<a class="jxr_linenumber" name="1711" href="#1711">1711</a>             <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="1712" href="#1712">1712</a>         }
<a class="jxr_linenumber" name="1713" href="#1713">1713</a>         <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/PendingBudgetConstructionGeneralLedger.html">PendingBudgetConstructionGeneralLedger</a> matchFromGL = pBGLFromGL.get(TestKey);
<a class="jxr_linenumber" name="1714" href="#1714">1714</a>         KualiInteger baseFromCurrentGL = matchFromGL.getFinancialBeginningBalanceLineAmount();
<a class="jxr_linenumber" name="1715" href="#1715">1715</a>         KualiInteger baseFromPBGL = currentPBGLInstance.getFinancialBeginningBalanceLineAmount();
<a class="jxr_linenumber" name="1716" href="#1716">1716</a>         <em class="jxr_comment">// remove the candidate GL from the hash list</em>
<a class="jxr_linenumber" name="1717" href="#1717">1717</a>         <em class="jxr_comment">// it won't match with anything else</em>
<a class="jxr_linenumber" name="1718" href="#1718">1718</a>         <em class="jxr_comment">// it should NOT be inserted into the PBGL table</em>
<a class="jxr_linenumber" name="1719" href="#1719">1719</a>         pBGLFromGL.remove(TestKey);
<a class="jxr_linenumber" name="1720" href="#1720">1720</a>         <strong class="jxr_keyword">if</strong> (baseFromCurrentGL.equals(baseFromPBGL)) {
<a class="jxr_linenumber" name="1721" href="#1721">1721</a>             <em class="jxr_comment">// no need to update--false alarm</em>
<a class="jxr_linenumber" name="1722" href="#1722">1722</a>             nGLRowsMatchingPBGL = nGLRowsMatchingPBGL+1;
<a class="jxr_linenumber" name="1723" href="#1723">1723</a>             <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="1724" href="#1724">1724</a>         }
<a class="jxr_linenumber" name="1725" href="#1725">1725</a>         <em class="jxr_comment">// update the base amount and store the updated PBGL row</em>
<a class="jxr_linenumber" name="1726" href="#1726">1726</a>         nGLRowsUpdated = nGLRowsUpdated + 1;
<a class="jxr_linenumber" name="1727" href="#1727">1727</a>         currentPBGLInstance.setFinancialBeginningBalanceLineAmount(baseFromCurrentGL);
<a class="jxr_linenumber" name="1728" href="#1728">1728</a>         getPersistenceBrokerTemplate().store(currentPBGLInstance);
<a class="jxr_linenumber" name="1729" href="#1729">1729</a>     }
<a class="jxr_linenumber" name="1730" href="#1730">1730</a> 
<a class="jxr_linenumber" name="1731" href="#1731">1731</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> updateCurrentPBGL(Integer BaseYear) {
<a class="jxr_linenumber" name="1732" href="#1732">1732</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="1733" href="#1733">1733</a> 
<a class="jxr_linenumber" name="1734" href="#1734">1734</a> 
<a class="jxr_linenumber" name="1735" href="#1735">1735</a>         <em class="jxr_comment">// what we are going to do here is what Oracle calls a hash join</em>
<a class="jxr_linenumber" name="1736" href="#1736">1736</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1737" href="#1737">1737</a>         <em class="jxr_comment">// we will merge the current PBGL rows with the GL detail, and </em>
<a class="jxr_linenumber" name="1738" href="#1738">1738</a>         <em class="jxr_comment">// replace the amount on each current PBGL row which matches from</em>
<a class="jxr_linenumber" name="1739" href="#1739">1739</a>         <em class="jxr_comment">// the GL row, and remove the GL row </em>
<a class="jxr_linenumber" name="1740" href="#1740">1740</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1741" href="#1741">1741</a>         <em class="jxr_comment">// we will compare the GL Key row with the the current PBGL row,</em>
<a class="jxr_linenumber" name="1742" href="#1742">1742</a>         <em class="jxr_comment">// and if the keys are the same, we will eliminate the GL key row</em>
<a class="jxr_linenumber" name="1743" href="#1743">1743</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1744" href="#1744">1744</a>         <em class="jxr_comment">//  fetch the current PBGL rows</em>
<a class="jxr_linenumber" name="1745" href="#1745">1745</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="1746" href="#1746">1746</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, RequestYear);
<a class="jxr_linenumber" name="1747" href="#1747">1747</a>         QueryByCriteria queryID = <strong class="jxr_keyword">new</strong> QueryByCriteria(PendingBudgetConstructionGeneralLedger.<strong class="jxr_keyword">class</strong>, criteriaID);
<a class="jxr_linenumber" name="1748" href="#1748">1748</a>         Iterator Results = getPersistenceBrokerTemplate().getIteratorByQuery(queryID);
<a class="jxr_linenumber" name="1749" href="#1749">1749</a>         <em class="jxr_comment">//  loop through the results</em>
<a class="jxr_linenumber" name="1750" href="#1750">1750</a>         <strong class="jxr_keyword">while</strong> (Results.hasNext()) {
<a class="jxr_linenumber" name="1751" href="#1751">1751</a>             nCurrentPBGLRows = nCurrentPBGLRows + 1;
<a class="jxr_linenumber" name="1752" href="#1752">1752</a>             <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/PendingBudgetConstructionGeneralLedger.html">PendingBudgetConstructionGeneralLedger</a> currentPBGLInstance = (PendingBudgetConstructionGeneralLedger) Results.next();
<a class="jxr_linenumber" name="1753" href="#1753">1753</a>             <em class="jxr_comment">// update the base amount and store the result if necessary</em>
<a class="jxr_linenumber" name="1754" href="#1754">1754</a>             updateBaseBudgetAmount(currentPBGLInstance);
<a class="jxr_linenumber" name="1755" href="#1755">1755</a>         }
<a class="jxr_linenumber" name="1756" href="#1756">1756</a>     }
<a class="jxr_linenumber" name="1757" href="#1757">1757</a> 
<a class="jxr_linenumber" name="1758" href="#1758">1758</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> writeFinalDiagnosticCounts() {
<a class="jxr_linenumber" name="1759" href="#1759">1759</a>         LOG.info(String.format(<span class="jxr_string">"\n\nGeneral Ledger Run Statistics\n\n"</span>));
<a class="jxr_linenumber" name="1760" href="#1760">1760</a>         LOG.info(String.format(<span class="jxr_string">"\nGeneral Ledger BB Keys read: %d"</span>, nGLBBKeysRead));
<a class="jxr_linenumber" name="1761" href="#1761">1761</a>         LOG.info(String.format(<span class="jxr_string">"\nGeneral Ledger BB Rows read: %d"</span>, nGLBBRowsRead));
<a class="jxr_linenumber" name="1762" href="#1762">1762</a>         LOG.info(String.format(<span class="jxr_string">"\nExisting Pending General Ledger rows: %d"</span>, nCurrentPBGLRows));
<a class="jxr_linenumber" name="1763" href="#1763">1763</a>         LOG.info(String.format(<span class="jxr_string">"\nof these..."</span>));
<a class="jxr_linenumber" name="1764" href="#1764">1764</a>         LOG.info(String.format(<span class="jxr_string">"\nnew PBGL rows written: %d"</span>, nGLRowsAdded));
<a class="jxr_linenumber" name="1765" href="#1765">1765</a>         LOG.info(String.format(<span class="jxr_string">"\ncurrent PBGL amounts updated: %d"</span>, nGLRowsUpdated));
<a class="jxr_linenumber" name="1766" href="#1766">1766</a>         LOG.info(String.format(<span class="jxr_string">"\ncurrent PBGL rows already matching a GL row: %d"</span>,nGLRowsMatchingPBGL));
<a class="jxr_linenumber" name="1767" href="#1767">1767</a>         LOG.info(String.format(<span class="jxr_string">"\nGL rows with zero net amounts (skipped) %d\n"</span>, nGLBBRowsZeroNet));
<a class="jxr_linenumber" name="1768" href="#1768">1768</a>         LOG.info(String.format(<span class="jxr_string">"\nGL account/subaccount keys skipped: %d"</span>, nGLBBRowsSkipped));
<a class="jxr_linenumber" name="1769" href="#1769">1769</a>         <strong class="jxr_keyword">if</strong> (!skippedPBGLKeys.isEmpty()) {
<a class="jxr_linenumber" name="1770" href="#1770">1770</a>             <strong class="jxr_keyword">for</strong> (Map.Entry&lt;String, Integer&gt; skippedRows : skippedPBGLKeys.entrySet()) {
<a class="jxr_linenumber" name="1771" href="#1771">1771</a>                 LOG.info(String.format(<span class="jxr_string">"\nGL key %s with %d rows skipped--no document header"</span>, skippedRows.getKey(), skippedRows.getValue()));
<a class="jxr_linenumber" name="1772" href="#1772">1772</a> 
<a class="jxr_linenumber" name="1773" href="#1773">1773</a>             }
<a class="jxr_linenumber" name="1774" href="#1774">1774</a>         }
<a class="jxr_linenumber" name="1775" href="#1775">1775</a>         LOG.info(String.format(<span class="jxr_string">"\n\nend of General Ledger run statics"</span>));
<a class="jxr_linenumber" name="1776" href="#1776">1776</a>     }
<a class="jxr_linenumber" name="1777" href="#1777">1777</a> 
<a class="jxr_linenumber" name="1778" href="#1778">1778</a>     <em class="jxr_comment">/*</em>
<a class="jxr_linenumber" name="1779" href="#1779">1779</a> <em class="jxr_comment">     * ******************************************************************************</em>
<a class="jxr_linenumber" name="1780" href="#1780">1780</a> <em class="jxr_comment">     * (7)  there could be an object class in the object code table that was marked</em>
<a class="jxr_linenumber" name="1781" href="#1781">1781</a> <em class="jxr_comment">     *      as inactive during the current fiscal year.  there could also be GL rows</em>
<a class="jxr_linenumber" name="1782" href="#1782">1782</a> <em class="jxr_comment">     *      with base budget which refer to this object code.  the fiscal year makers</em>
<a class="jxr_linenumber" name="1783" href="#1783">1783</a> <em class="jxr_comment">     *      routine would NOT copy a deleted object code into the new fiscal year.</em>
<a class="jxr_linenumber" name="1784" href="#1784">1784</a> <em class="jxr_comment">     *      to maintain referential integrity, we will copy such an object code (but</em>
<a class="jxr_linenumber" name="1785" href="#1785">1785</a> <em class="jxr_comment">     *      mark it as deleted) into the new fiscal year if it will occur in budget</em>
<a class="jxr_linenumber" name="1786" href="#1786">1786</a> <em class="jxr_comment">     *      construction.</em>
<a class="jxr_linenumber" name="1787" href="#1787">1787</a> <em class="jxr_comment">     */</em>
<a class="jxr_linenumber" name="1788" href="#1788">1788</a> 
<a class="jxr_linenumber" name="1789" href="#1789">1789</a>     <strong class="jxr_keyword">private</strong> HashMap&lt;String, String[]&gt; baseYearInactiveObjects = <strong class="jxr_keyword">new</strong> HashMap&lt;String, String[]&gt;(1);
<a class="jxr_linenumber" name="1790" href="#1790">1790</a>     <strong class="jxr_keyword">private</strong> HashMap&lt;String, String[]&gt; gLBBObjects = <strong class="jxr_keyword">new</strong> HashMap&lt;String, String[]&gt;(1);
<a class="jxr_linenumber" name="1791" href="#1791">1791</a>     <strong class="jxr_keyword">private</strong> Integer nInactiveBBObjectCodes = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1792" href="#1792">1792</a> 
<a class="jxr_linenumber" name="1793" href="#1793">1793</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> objectClassRICleanUp() {
<a class="jxr_linenumber" name="1794" href="#1794">1794</a>         baseYearInactiveObjects.clear();
<a class="jxr_linenumber" name="1795" href="#1795">1795</a>         gLBBObjects.clear();
<a class="jxr_linenumber" name="1796" href="#1796">1796</a>     }
<a class="jxr_linenumber" name="1797" href="#1797">1797</a> 
<a class="jxr_linenumber" name="1798" href="#1798">1798</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> ensureObjectClassRIForBudget(Integer BaseYear) {
<a class="jxr_linenumber" name="1799" href="#1799">1799</a>         readBaseYearInactiveObjects(BaseYear);
<a class="jxr_linenumber" name="1800" href="#1800">1800</a>         <strong class="jxr_keyword">if</strong> (baseYearInactiveObjects.isEmpty()) {
<a class="jxr_linenumber" name="1801" href="#1801">1801</a>             <em class="jxr_comment">// no problems</em>
<a class="jxr_linenumber" name="1802" href="#1802">1802</a>             LOG.info(String.format(<span class="jxr_string">"\nInactive Object Codes in BC GL: %d"</span>, nInactiveBBObjectCodes));
<a class="jxr_linenumber" name="1803" href="#1803">1803</a>             <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="1804" href="#1804">1804</a>         }
<a class="jxr_linenumber" name="1805" href="#1805">1805</a>         readAndFilterGLBBObjects(BaseYear);
<a class="jxr_linenumber" name="1806" href="#1806">1806</a>         <strong class="jxr_keyword">if</strong> (gLBBObjects.isEmpty()) {
<a class="jxr_linenumber" name="1807" href="#1807">1807</a>             <em class="jxr_comment">// no problems</em>
<a class="jxr_linenumber" name="1808" href="#1808">1808</a>             LOG.info(String.format(<span class="jxr_string">"\nInactive Object Codes in BC GL: %d"</span>, nInactiveBBObjectCodes));
<a class="jxr_linenumber" name="1809" href="#1809">1809</a>             <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="1810" href="#1810">1810</a>         }
<a class="jxr_linenumber" name="1811" href="#1811">1811</a>         <em class="jxr_comment">// we have to create an object row for the request year</em>
<a class="jxr_linenumber" name="1812" href="#1812">1812</a>         addRIObjectClassesForBB(BaseYear);
<a class="jxr_linenumber" name="1813" href="#1813">1813</a>         LOG.info(String.format(<span class="jxr_string">"\nInactive Object Codes in BC GL: %d"</span>, nInactiveBBObjectCodes));
<a class="jxr_linenumber" name="1814" href="#1814">1814</a>         objectClassRICleanUp();
<a class="jxr_linenumber" name="1815" href="#1815">1815</a>     }
<a class="jxr_linenumber" name="1816" href="#1816">1816</a> 
<a class="jxr_linenumber" name="1817" href="#1817">1817</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> addRIObjectClassesForBB(Integer BaseYear) {
<a class="jxr_linenumber" name="1818" href="#1818">1818</a>         <em class="jxr_comment">//  we will read the object table for the request year first</em>
<a class="jxr_linenumber" name="1819" href="#1819">1819</a>         <em class="jxr_comment">//  if the row is there (someone could have added it, or updated it),</em>
<a class="jxr_linenumber" name="1820" href="#1820">1820</a>         <em class="jxr_comment">//  we will not change it at all.</em>
<a class="jxr_linenumber" name="1821" href="#1821">1821</a>         <em class="jxr_comment">//  this is an extra read, but overall looking just for problems</em>
<a class="jxr_linenumber" name="1822" href="#1822">1822</a>         <em class="jxr_comment">//  will require many fewer reads than comparing all object codes in the</em>
<a class="jxr_linenumber" name="1823" href="#1823">1823</a>         <em class="jxr_comment">//  request year to all object codes in the GL BB base.</em>
<a class="jxr_linenumber" name="1824" href="#1824">1824</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="1825" href="#1825">1825</a>         <strong class="jxr_keyword">for</strong> (Map.Entry&lt;String, String[]&gt; problemObjectCodes : gLBBObjects.entrySet()) {
<a class="jxr_linenumber" name="1826" href="#1826">1826</a>             String problemChart = problemObjectCodes.getValue()[0];
<a class="jxr_linenumber" name="1827" href="#1827">1827</a>             String problemObject = problemObjectCodes.getValue()[1];
<a class="jxr_linenumber" name="1828" href="#1828">1828</a>             <strong class="jxr_keyword">if</strong> (isObjectInRequestYear(BaseYear, problemChart, problemObject)) {
<a class="jxr_linenumber" name="1829" href="#1829">1829</a>                 <em class="jxr_comment">// everything is fine</em>
<a class="jxr_linenumber" name="1830" href="#1830">1830</a>                 <strong class="jxr_keyword">continue</strong>;
<a class="jxr_linenumber" name="1831" href="#1831">1831</a>             }
<a class="jxr_linenumber" name="1832" href="#1832">1832</a>             <em class="jxr_comment">//  now we have to add the object to the request year as an inactive object</em>
<a class="jxr_linenumber" name="1833" href="#1833">1833</a>             Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="1834" href="#1834">1834</a>             criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear);
<a class="jxr_linenumber" name="1835" href="#1835">1835</a>             criteriaID.addColumnEqualTo(KFSPropertyConstants.CHART_OF_ACCOUNTS_CODE, problemChart);
<a class="jxr_linenumber" name="1836" href="#1836">1836</a>             criteriaID.addEqualTo(KFSPropertyConstants.FINANCIAL_OBJECT_CODE, problemObject);
<a class="jxr_linenumber" name="1837" href="#1837">1837</a>             ReportQueryByCriteria queryID = <strong class="jxr_keyword">new</strong> ReportQueryByCriteria(ObjectCode.<strong class="jxr_keyword">class</strong>, criteriaID);
<a class="jxr_linenumber" name="1838" href="#1838">1838</a>             Iterator Results = getPersistenceBrokerTemplate().getReportQueryIteratorByQuery(queryID);
<a class="jxr_linenumber" name="1839" href="#1839">1839</a>             <strong class="jxr_keyword">if</strong> (!Results.hasNext()) {
<a class="jxr_linenumber" name="1840" href="#1840">1840</a>                 <em class="jxr_comment">// this should never happen</em>
<a class="jxr_linenumber" name="1841" href="#1841">1841</a>                 <em class="jxr_comment">// if it does, it will cause an RI exception in the GL load to BC</em>
<a class="jxr_linenumber" name="1842" href="#1842">1842</a>                 <em class="jxr_comment">// at least this message will give some clue</em>
<a class="jxr_linenumber" name="1843" href="#1843">1843</a>                 LOG.warn(String.format(<span class="jxr_string">"could not find BB object (%s, %s) in %d"</span>, problemChart, problemObject, BaseYear));
<a class="jxr_linenumber" name="1844" href="#1844">1844</a>                 <strong class="jxr_keyword">continue</strong>;
<a class="jxr_linenumber" name="1845" href="#1845">1845</a>             }
<a class="jxr_linenumber" name="1846" href="#1846">1846</a>             <a href="../../../../../../../../org/kuali/kfs/coa/businessobject/ObjectCode.html">ObjectCode</a> baseYearObject = (ObjectCode) TransactionalServiceUtils.retrieveFirstAndExhaustIterator(Results);
<a class="jxr_linenumber" name="1847" href="#1847">1847</a>             baseYearObject.setUniversityFiscalYear(RequestYear);
<a class="jxr_linenumber" name="1848" href="#1848">1848</a>             baseYearObject.setActive(false);
<a class="jxr_linenumber" name="1849" href="#1849">1849</a>             getPersistenceBrokerTemplate().store(baseYearObject);
<a class="jxr_linenumber" name="1850" href="#1850">1850</a>         }
<a class="jxr_linenumber" name="1851" href="#1851">1851</a>     }
<a class="jxr_linenumber" name="1852" href="#1852">1852</a> 
<a class="jxr_linenumber" name="1853" href="#1853">1853</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">boolean</strong> isObjectInRequestYear(Integer BaseYear, String Chart, String <a href="../../../../../../../../org/kuali/kfs/coa/businessobject/ObjectCode.html">ObjectCode</a>) {
<a class="jxr_linenumber" name="1854" href="#1854">1854</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="1855" href="#1855">1855</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="1856" href="#1856">1856</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, RequestYear);
<a class="jxr_linenumber" name="1857" href="#1857">1857</a>         criteriaID.addEqualTo(KFSPropertyConstants.CHART_OF_ACCOUNTS_CODE, <a href="../../../../../../../../org/kuali/kfs/coa/businessobject/Chart.html">Chart</a>);
<a class="jxr_linenumber" name="1858" href="#1858">1858</a>         criteriaID.addEqualTo(KFSPropertyConstants.FINANCIAL_OBJECT_CODE, <a href="../../../../../../../../org/kuali/kfs/coa/businessobject/ObjectCode.html">ObjectCode</a>);
<a class="jxr_linenumber" name="1859" href="#1859">1859</a>         QueryByCriteria queryID = <strong class="jxr_keyword">new</strong> QueryByCriteria(ObjectCode.<strong class="jxr_keyword">class</strong>, criteriaID);
<a class="jxr_linenumber" name="1860" href="#1860">1860</a>         Integer result = getPersistenceBrokerTemplate().getCount(queryID);
<a class="jxr_linenumber" name="1861" href="#1861">1861</a>         <strong class="jxr_keyword">return</strong> (!result.equals(0));
<a class="jxr_linenumber" name="1862" href="#1862">1862</a>     }
<a class="jxr_linenumber" name="1863" href="#1863">1863</a> 
<a class="jxr_linenumber" name="1864" href="#1864">1864</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> readBaseYearInactiveObjects(Integer BaseYear) {
<a class="jxr_linenumber" name="1865" href="#1865">1865</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="1866" href="#1866">1866</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear);
<a class="jxr_linenumber" name="1867" href="#1867">1867</a>         criteriaID.addEqualTo(KFSPropertyConstants.ACTIVE, false);
<a class="jxr_linenumber" name="1868" href="#1868">1868</a>         baseYearInactiveObjects = <strong class="jxr_keyword">new</strong> HashMap&lt;String, String[]&gt;(hashObjectSize(ObjectCode.<strong class="jxr_keyword">class</strong>, criteriaID));
<a class="jxr_linenumber" name="1869" href="#1869">1869</a>         String[] queryAttr = { KFSPropertyConstants.CHART_OF_ACCOUNTS_CODE, KFSPropertyConstants.FINANCIAL_OBJECT_CODE };
<a class="jxr_linenumber" name="1870" href="#1870">1870</a>         ReportQueryByCriteria queryID = <strong class="jxr_keyword">new</strong> ReportQueryByCriteria(ObjectCode.<strong class="jxr_keyword">class</strong>, queryAttr, criteriaID);
<a class="jxr_linenumber" name="1871" href="#1871">1871</a>         Iterator result = getPersistenceBrokerTemplate().getReportQueryIteratorByQuery(queryID);
<a class="jxr_linenumber" name="1872" href="#1872">1872</a>         <strong class="jxr_keyword">while</strong> (result.hasNext()) {
<a class="jxr_linenumber" name="1873" href="#1873">1873</a>             Object[] resultRow = (Object[]) result.next();
<a class="jxr_linenumber" name="1874" href="#1874">1874</a>             String[] hashMapValue = <strong class="jxr_keyword">new</strong> String[2];
<a class="jxr_linenumber" name="1875" href="#1875">1875</a>             hashMapValue[0] = (String) resultRow[0];
<a class="jxr_linenumber" name="1876" href="#1876">1876</a>             hashMapValue[1] = (String) resultRow[1];
<a class="jxr_linenumber" name="1877" href="#1877">1877</a>             String hashMapKey = hashMapValue[0] + hashMapValue[1];
<a class="jxr_linenumber" name="1878" href="#1878">1878</a>             baseYearInactiveObjects.put(hashMapKey, hashMapValue);
<a class="jxr_linenumber" name="1879" href="#1879">1879</a>         }
<a class="jxr_linenumber" name="1880" href="#1880">1880</a>     }
<a class="jxr_linenumber" name="1881" href="#1881">1881</a> 
<a class="jxr_linenumber" name="1882" href="#1882">1882</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> readAndFilterGLBBObjects(Integer BaseYear) {
<a class="jxr_linenumber" name="1883" href="#1883">1883</a>         <em class="jxr_comment">// this must be done before we read GL for PBGL</em>
<a class="jxr_linenumber" name="1884" href="#1884">1884</a>         <em class="jxr_comment">// otherwise, we will get an RI violation when we try to add a PBGL</em>
<a class="jxr_linenumber" name="1885" href="#1885">1885</a>         <em class="jxr_comment">// row with an object inactive in the current year</em>
<a class="jxr_linenumber" name="1886" href="#1886">1886</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="1887" href="#1887">1887</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear);
<a class="jxr_linenumber" name="1888" href="#1888">1888</a>         criteriaID.addEqualTo(KFSPropertyConstants.BALANCE_TYPE_CODE, KFSConstants.BALANCE_TYPE_BASE_BUDGET);
<a class="jxr_linenumber" name="1889" href="#1889">1889</a>         gLBBObjects = <strong class="jxr_keyword">new</strong> HashMap&lt;String, String[]&gt;(hashObjectSize(Balance.<strong class="jxr_keyword">class</strong>, criteriaID));
<a class="jxr_linenumber" name="1890" href="#1890">1890</a>         String[] queryAttr = { KFSPropertyConstants.CHART_OF_ACCOUNTS_CODE, KFSPropertyConstants.OBJECT_CODE };
<a class="jxr_linenumber" name="1891" href="#1891">1891</a>         ReportQueryByCriteria queryID = <strong class="jxr_keyword">new</strong> ReportQueryByCriteria(Balance.<strong class="jxr_keyword">class</strong>, queryAttr, criteriaID, <strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="1892" href="#1892">1892</a>         Iterator result = getPersistenceBrokerTemplate().getReportQueryIteratorByQuery(queryID);
<a class="jxr_linenumber" name="1893" href="#1893">1893</a>         <strong class="jxr_keyword">while</strong> (result.hasNext()) {
<a class="jxr_linenumber" name="1894" href="#1894">1894</a>             Object[] resultRow = (Object[]) result.next();
<a class="jxr_linenumber" name="1895" href="#1895">1895</a>             String[] hashMapValue = <strong class="jxr_keyword">new</strong> String[2];
<a class="jxr_linenumber" name="1896" href="#1896">1896</a>             hashMapValue[0] = (String) resultRow[0];
<a class="jxr_linenumber" name="1897" href="#1897">1897</a>             hashMapValue[1] = (String) resultRow[1];
<a class="jxr_linenumber" name="1898" href="#1898">1898</a>             String hashMapKey = hashMapValue[0] + hashMapValue[1];
<a class="jxr_linenumber" name="1899" href="#1899">1899</a>             <strong class="jxr_keyword">if</strong> (baseYearInactiveObjects.get(hashMapKey) != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="1900" href="#1900">1900</a>                 gLBBObjects.put(hashMapKey, hashMapValue);
<a class="jxr_linenumber" name="1901" href="#1901">1901</a>                 nInactiveBBObjectCodes = nInactiveBBObjectCodes + 1;
<a class="jxr_linenumber" name="1902" href="#1902">1902</a>             }
<a class="jxr_linenumber" name="1903" href="#1903">1903</a>         }
<a class="jxr_linenumber" name="1904" href="#1904">1904</a>     }
<a class="jxr_linenumber" name="1905" href="#1905">1905</a> 
<a class="jxr_linenumber" name="1906" href="#1906">1906</a>     <em class="jxr_javadoccomment">/**</em><em class="jxr_javadoccomment">**************************************************************************************</em>
<a class="jxr_linenumber" name="1907" href="#1907">1907</a> <em class="jxr_javadoccomment">     * (9)  this code builds the budget construction CSF tracker and the budget construction</em>
<a class="jxr_linenumber" name="1908" href="#1908">1908</a> <em class="jxr_javadoccomment">     *      appointment funding</em>
<a class="jxr_linenumber" name="1909" href="#1909">1909</a> <em class="jxr_javadoccomment">     ****************************************************************************************</em>
<a class="jxr_linenumber" name="1910" href="#1910">1910</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="1911" href="#1911">1911</a> 
<a class="jxr_linenumber" name="1912" href="#1912">1912</a>     <em class="jxr_comment">// the set of new BCSF objects to be written</em>
<a class="jxr_linenumber" name="1913" href="#1913">1913</a>     <strong class="jxr_keyword">private</strong> HashMap&lt;String, BudgetConstructionCalculatedSalaryFoundationTracker&gt; bCSF = <strong class="jxr_keyword">new</strong> HashMap&lt;String, BudgetConstructionCalculatedSalaryFoundationTracker&gt;(1);
<a class="jxr_linenumber" name="1914" href="#1914">1914</a>     <em class="jxr_comment">// hashmap to hold the document numbers for each accounting key in the header</em>
<a class="jxr_linenumber" name="1915" href="#1915">1915</a>     <strong class="jxr_keyword">private</strong> HashMap&lt;String, String&gt; bcHdrDocNumbers = <strong class="jxr_keyword">new</strong> HashMap&lt;String, String&gt;(1);
<a class="jxr_linenumber" name="1916" href="#1916">1916</a>     <em class="jxr_comment">// hashset to hold the accounting string for each pending GL entry</em>
<a class="jxr_linenumber" name="1917" href="#1917">1917</a>     <strong class="jxr_keyword">private</strong> HashSet&lt;String&gt; currentPBGLKeys = <strong class="jxr_keyword">new</strong> HashSet&lt;String&gt;(1);
<a class="jxr_linenumber" name="1918" href="#1918">1918</a>     <em class="jxr_comment">// hashMap for finding the object type of "detailed position" object codes</em>
<a class="jxr_linenumber" name="1919" href="#1919">1919</a>     <strong class="jxr_keyword">private</strong> HashMap&lt;String, String&gt; detailedPositionObjectTypes = <strong class="jxr_keyword">new</strong> HashMap&lt;String, String&gt;(1);
<a class="jxr_linenumber" name="1920" href="#1920">1920</a>     <em class="jxr_comment">// keys for deleted or vacant rows present in the override CSF: none of these keys</em>
<a class="jxr_linenumber" name="1921" href="#1921">1921</a>     <em class="jxr_comment">// will load to BCSF from either the override or actual CSF (even if they</em>
<a class="jxr_linenumber" name="1922" href="#1922">1922</a>     <em class="jxr_comment">// are active in the actual CSF) </em>
<a class="jxr_linenumber" name="1923" href="#1923">1923</a>     <strong class="jxr_keyword">private</strong> HashSet&lt;String&gt; csfOverrideKeys = <strong class="jxr_keyword">new</strong> HashSet&lt;String&gt;(1);;
<a class="jxr_linenumber" name="1924" href="#1924">1924</a>     <em class="jxr_comment">// EMPLID's in CSF which have more than one active row</em>
<a class="jxr_linenumber" name="1925" href="#1925">1925</a>     <em class="jxr_comment">// we budget in whole dollars, while payroll deals in pennies</em>
<a class="jxr_linenumber" name="1926" href="#1926">1926</a>     <em class="jxr_comment">// we will use this for our complicated rounding algorithm, to keep the total budget base salary within a dollar of the payroll salary</em>
<a class="jxr_linenumber" name="1927" href="#1927">1927</a>     <strong class="jxr_keyword">private</strong> HashMap&lt;String, roundMechanism&gt; keysNeedingRounding = <strong class="jxr_keyword">new</strong> HashMap&lt;String, roundMechanism&gt;(1);
<a class="jxr_linenumber" name="1928" href="#1928">1928</a>     <em class="jxr_comment">// we need the position normal work months to write a new appointment funding row: the normal work months is the "months appointment"</em>
<a class="jxr_linenumber" name="1929" href="#1929">1929</a>     <strong class="jxr_keyword">private</strong> HashMap&lt;String, Integer&gt; positionNormalWorkMonths = <strong class="jxr_keyword">new</strong> HashMap&lt;String, Integer&gt;(1);
<a class="jxr_linenumber" name="1930" href="#1930">1930</a> 
<a class="jxr_linenumber" name="1931" href="#1931">1931</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> buildAppointmentFundingCleanUp() {
<a class="jxr_linenumber" name="1932" href="#1932">1932</a>         bCSF.clear();
<a class="jxr_linenumber" name="1933" href="#1933">1933</a>         bcHdrDocNumbers.clear();
<a class="jxr_linenumber" name="1934" href="#1934">1934</a>         currentPBGLKeys.clear();
<a class="jxr_linenumber" name="1935" href="#1935">1935</a>         detailedPositionObjectTypes.clear();
<a class="jxr_linenumber" name="1936" href="#1936">1936</a>         csfOverrideKeys.clear();
<a class="jxr_linenumber" name="1937" href="#1937">1937</a>         keysNeedingRounding.clear();
<a class="jxr_linenumber" name="1938" href="#1938">1938</a>         positionNormalWorkMonths.clear();
<a class="jxr_linenumber" name="1939" href="#1939">1939</a>     }
<a class="jxr_linenumber" name="1940" href="#1940">1940</a> 
<a class="jxr_linenumber" name="1941" href="#1941">1941</a>     <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1942" href="#1942">1942</a>     <em class="jxr_comment">// counters</em>
<a class="jxr_linenumber" name="1943" href="#1943">1943</a>     <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="1944" href="#1944">1944</a>     Integer CSFRowsRead = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1945" href="#1945">1945</a>     Integer CSFRowsVacant = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1946" href="#1946">1946</a>     Integer CSFVacantsConsolidated = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1947" href="#1947">1947</a>     Integer CSFOverrideDeletesRead = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1948" href="#1948">1948</a>     Integer CSFOverrideRead = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1949" href="#1949">1949</a>     Integer CSFOverrideVacant = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1950" href="#1950">1950</a>     Integer CSFForBCSF = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1951" href="#1951">1951</a>     Integer CSFCurrentGLRows = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1952" href="#1952">1952</a>     Integer CSFCurrentBCAFRows = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1953" href="#1953">1953</a>     Integer CSFBCSFRowsMatchingGL = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1954" href="#1954">1954</a>     Integer CSFBCSFRowsMatchingBCAF = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1955" href="#1955">1955</a>     Integer CSFNewGLRows = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1956" href="#1956">1956</a>     Integer CSFNewBCAFRows = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1957" href="#1957">1957</a>     Integer CSFBCAFRowsMarkedDeleted = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1958" href="#1958">1958</a>     Integer CSFBCAFRowsMissing = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1959" href="#1959">1959</a>     Integer CSFBadObjectsSkipped = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="1960" href="#1960">1960</a> 
<a class="jxr_linenumber" name="1961" href="#1961">1961</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> buildAppointmentFundingAndBCSF(Integer BaseYear) {
<a class="jxr_linenumber" name="1962" href="#1962">1962</a>         <em class="jxr_javadoccomment">/**</em><em class="jxr_javadoccomment">*******************************************************************</em>
<a class="jxr_linenumber" name="1963" href="#1963">1963</a> <em class="jxr_javadoccomment">         * RI requirements:</em>
<a class="jxr_linenumber" name="1964" href="#1964">1964</a> <em class="jxr_javadoccomment">         * this method assumes that ALL budget construction positions for the</em>
<a class="jxr_linenumber" name="1965" href="#1965">1965</a> <em class="jxr_javadoccomment">         * request year are in the position table, </em>
<a class="jxr_linenumber" name="1966" href="#1966">1966</a> <em class="jxr_javadoccomment">         * and</em>
<a class="jxr_linenumber" name="1967" href="#1967">1967</a> <em class="jxr_javadoccomment">         * that budget construction documents for every accounting key in the</em>
<a class="jxr_linenumber" name="1968" href="#1968">1968</a> <em class="jxr_javadoccomment">         * CSF tables have been created </em>
<a class="jxr_linenumber" name="1969" href="#1969">1969</a> <em class="jxr_javadoccomment">         **********************************************************************/</em>
<a class="jxr_linenumber" name="1970" href="#1970">1970</a>         <em class="jxr_comment">// budget construction CSF tracker is always rebuilt from scratch from the CSF Tracker</em>
<a class="jxr_linenumber" name="1971" href="#1971">1971</a>         <em class="jxr_comment">// (it doesn't make sense to carry a base salary line that has </em>
<a class="jxr_linenumber" name="1972" href="#1972">1972</a>         <em class="jxr_comment">//  has disappeared from the CSF Tracker--hence from the payroll system, hence the current base--from</em>
<a class="jxr_linenumber" name="1973" href="#1973">1973</a>         <em class="jxr_comment">//  one run of the batch update process to the next.)</em>
<a class="jxr_linenumber" name="1974" href="#1974">1974</a>         clearBCCSF(BaseYear);
<a class="jxr_linenumber" name="1975" href="#1975">1975</a>         clearBCCSF(BaseYear + 1);
<a class="jxr_linenumber" name="1976" href="#1976">1976</a>         <em class="jxr_comment">// build the new BC CSF objects in memory</em>
<a class="jxr_linenumber" name="1977" href="#1977">1977</a>         setUpCSFOverrideKeys(BaseYear);
<a class="jxr_linenumber" name="1978" href="#1978">1978</a>         setUpBCSFMap(BaseYear);
<a class="jxr_linenumber" name="1979" href="#1979">1979</a>         setUpKeysNeedingRounding(BaseYear);
<a class="jxr_linenumber" name="1980" href="#1980">1980</a>         readCSFOverride(BaseYear);
<a class="jxr_linenumber" name="1981" href="#1981">1981</a>         readCSF(BaseYear);
<a class="jxr_linenumber" name="1982" href="#1982">1982</a>         CSFForBCSF = bCSF.size();
<a class="jxr_linenumber" name="1983" href="#1983">1983</a>         adjustCSFRounding();
<a class="jxr_linenumber" name="1984" href="#1984">1984</a>         <em class="jxr_comment">//  store bCSF rows matching current appointment funding</em>
<a class="jxr_linenumber" name="1985" href="#1985">1985</a>         readExistingAppointmentFunding(BaseYear);
<a class="jxr_linenumber" name="1986" href="#1986">1986</a>         <em class="jxr_comment">//  if all of the bCSF rows have been stored (they all already exist in PBGL, so we don't have to worry about PBLG), we can quit here</em>
<a class="jxr_linenumber" name="1987" href="#1987">1987</a>         <strong class="jxr_keyword">if</strong> (bCSF.size() == 0) {
<a class="jxr_linenumber" name="1988" href="#1988">1988</a>             CSFDiagnostics();
<a class="jxr_linenumber" name="1989" href="#1989">1989</a>             buildAppointmentFundingCleanUp();
<a class="jxr_linenumber" name="1990" href="#1990">1990</a>             <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="1991" href="#1991">1991</a>         }
<a class="jxr_linenumber" name="1992" href="#1992">1992</a>         <em class="jxr_comment">//  what we have left are the bCSF rows that do NOT match appointment funding</em>
<a class="jxr_linenumber" name="1993" href="#1993">1993</a>         <em class="jxr_comment">//  -- createNewBCDocumentsFromGLCSF is called in both the genesis and update</em>
<a class="jxr_linenumber" name="1994" href="#1994">1994</a>         <em class="jxr_comment">//     steps, before anything else is done.  therefore, we are assured that </em>
<a class="jxr_linenumber" name="1995" href="#1995">1995</a>         <em class="jxr_comment">//     all the documents exist.</em>
<a class="jxr_linenumber" name="1996" href="#1996">1996</a>         <em class="jxr_comment">//  -- we need to create new GL (if the accounting key is not yet in GL).</em>
<a class="jxr_linenumber" name="1997" href="#1997">1997</a>         <em class="jxr_comment">//     this requires that we have a document number, so we need to read those.</em>
<a class="jxr_linenumber" name="1998" href="#1998">1998</a>         <em class="jxr_comment">//     this happens regardless of whether GL updates are allowed, because we</em>
<a class="jxr_linenumber" name="1999" href="#1999">1999</a>         <em class="jxr_comment">//     will only be adding GL rows with 0 amounts when an account not yet in budget construction comes in from payroll.</em>
<a class="jxr_linenumber" name="2000" href="#2000">2000</a>         <em class="jxr_comment">//     there is only base in CSF, no request, and obviously no base budget in the GL exists for an account that isn't in GL.</em>
<a class="jxr_linenumber" name="2001" href="#2001">2001</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="2002" href="#2002">2002</a>         <em class="jxr_comment">//  &gt;&gt; RI requires that data is stored in the order indicated.</em>
<a class="jxr_linenumber" name="2003" href="#2003">2003</a>         <em class="jxr_comment">//  -- we will also have to create new appointment funding rows (again, with</em>
<a class="jxr_linenumber" name="2004" href="#2004">2004</a>         <em class="jxr_comment">//     no request.</em>
<a class="jxr_linenumber" name="2005" href="#2005">2005</a>         <em class="jxr_comment">//  -- finally, we will have to store the bCSF rows themselves.</em>
<a class="jxr_linenumber" name="2006" href="#2006">2006</a>         setUpbcHdrDocNumbers(BaseYear);
<a class="jxr_linenumber" name="2007" href="#2007">2007</a>         setUpCurrentPBGLKeys(BaseYear);
<a class="jxr_linenumber" name="2008" href="#2008">2008</a>         setUpPositionNormalWorkMonths(BaseYear);
<a class="jxr_linenumber" name="2009" href="#2009">2009</a>         readAndWriteBCSFAndNewAppointmentFundingAndNewPBGL(BaseYear);
<a class="jxr_linenumber" name="2010" href="#2010">2010</a>         CSFDiagnostics();
<a class="jxr_linenumber" name="2011" href="#2011">2011</a>         buildAppointmentFundingCleanUp();
<a class="jxr_linenumber" name="2012" href="#2012">2012</a>     }
<a class="jxr_linenumber" name="2013" href="#2013">2013</a> 
<a class="jxr_linenumber" name="2014" href="#2014">2014</a>     <em class="jxr_comment">// overload the vacant BCSF line object builders</em>
<a class="jxr_linenumber" name="2015" href="#2015">2015</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> addToExistingBCSFVacant(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/CalculatedSalaryFoundationTrackerOverride.html">CalculatedSalaryFoundationTrackerOverride</a> csf, String csfKey) {
<a class="jxr_linenumber" name="2016" href="#2016">2016</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="2017" href="#2017">2017</a>         <em class="jxr_comment">// this method takes care of a rare occurrence.</em>
<a class="jxr_linenumber" name="2018" href="#2018">2018</a>         <em class="jxr_comment">// - more than one person shares a position in the same line.</em>
<a class="jxr_linenumber" name="2019" href="#2019">2019</a>         <em class="jxr_comment">// - both people leave on the same day </em>
<a class="jxr_linenumber" name="2020" href="#2020">2020</a>         <em class="jxr_comment">// - since each vacant CSF line carries the EMPLID of the last</em>
<a class="jxr_linenumber" name="2021" href="#2021">2021</a>         <em class="jxr_comment">//   incumbent, and EMPLID is part of the key, there are two</em>
<a class="jxr_linenumber" name="2022" href="#2022">2022</a>         <em class="jxr_comment">//   separate lines in CSF.</em>
<a class="jxr_linenumber" name="2023" href="#2023">2023</a>         <em class="jxr_comment">// - the EMPLID is replaced with the vacant ID in BCSF, so there</em>
<a class="jxr_linenumber" name="2024" href="#2024">2024</a>         <em class="jxr_comment">//   will only be one line in BCSF, and we need to aggregate the</em>
<a class="jxr_linenumber" name="2025" href="#2025">2025</a>         <em class="jxr_comment">//   amounts and effort  </em>
<a class="jxr_linenumber" name="2026" href="#2026">2026</a>         <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionCalculatedSalaryFoundationTracker.html">BudgetConstructionCalculatedSalaryFoundationTracker</a> nowBCSF = bCSF.get(csfKey);
<a class="jxr_linenumber" name="2027" href="#2027">2027</a>         <em class="jxr_comment">// first round the amount to whole dollars</em>
<a class="jxr_linenumber" name="2028" href="#2028">2028</a>         KualiInteger roundedAmount = <strong class="jxr_keyword">new</strong> KualiInteger(csf.getCsfAmount(), RoundingMode.valueOf(KualiInteger.ROUND_BEHAVIOR));
<a class="jxr_linenumber" name="2029" href="#2029">2029</a>         nowBCSF.setCsfAmount(nowBCSF.getCsfAmount().add(roundedAmount));
<a class="jxr_linenumber" name="2030" href="#2030">2030</a>         <em class="jxr_comment">// increase the percent time (maximum of 100)</em>
<a class="jxr_linenumber" name="2031" href="#2031">2031</a>         BigDecimal pctTime = nowBCSF.getCsfTimePercent();
<a class="jxr_linenumber" name="2032" href="#2032">2032</a>         pctTime = pctTime.add(csf.getCsfTimePercent());
<a class="jxr_linenumber" name="2033" href="#2033">2033</a>         <strong class="jxr_keyword">if</strong> (pctTime.floatValue() &gt; 100.0) {
<a class="jxr_linenumber" name="2034" href="#2034">2034</a>             pctTime = <strong class="jxr_keyword">new</strong> BigDecimal(100.00);
<a class="jxr_linenumber" name="2035" href="#2035">2035</a>         }
<a class="jxr_linenumber" name="2036" href="#2036">2036</a>         nowBCSF.setCsfTimePercent(pctTime);
<a class="jxr_linenumber" name="2037" href="#2037">2037</a>         <em class="jxr_comment">// increase the FTE (full-time equivalent) (maximum of 1.0)</em>
<a class="jxr_linenumber" name="2038" href="#2038">2038</a>         BigDecimal csfFTE = nowBCSF.getCsfFullTimeEmploymentQuantity();
<a class="jxr_linenumber" name="2039" href="#2039">2039</a>         csfFTE = csfFTE.add(csf.getCsfFullTimeEmploymentQuantity());
<a class="jxr_linenumber" name="2040" href="#2040">2040</a>         <strong class="jxr_keyword">if</strong> (csfFTE.floatValue() &gt; 1.0) {
<a class="jxr_linenumber" name="2041" href="#2041">2041</a>             csfFTE = <strong class="jxr_keyword">new</strong> BigDecimal(1.00);
<a class="jxr_linenumber" name="2042" href="#2042">2042</a>         }
<a class="jxr_linenumber" name="2043" href="#2043">2043</a>         nowBCSF.setCsfFullTimeEmploymentQuantity(csfFTE);
<a class="jxr_linenumber" name="2044" href="#2044">2044</a>         CSFVacantsConsolidated = CSFVacantsConsolidated + 1;
<a class="jxr_linenumber" name="2045" href="#2045">2045</a>     }
<a class="jxr_linenumber" name="2046" href="#2046">2046</a> 
<a class="jxr_linenumber" name="2047" href="#2047">2047</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> addToExistingBCSFVacant(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/CalculatedSalaryFoundationTracker.html">CalculatedSalaryFoundationTracker</a> csf, String csfKey) {
<a class="jxr_linenumber" name="2048" href="#2048">2048</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="2049" href="#2049">2049</a>         <em class="jxr_comment">// this method takes care of a rare occurrence.</em>
<a class="jxr_linenumber" name="2050" href="#2050">2050</a>         <em class="jxr_comment">// - more than one person shares a position in the same line.</em>
<a class="jxr_linenumber" name="2051" href="#2051">2051</a>         <em class="jxr_comment">// - both people leave on the same day </em>
<a class="jxr_linenumber" name="2052" href="#2052">2052</a>         <em class="jxr_comment">// - since each vacant CSF line carries the EMPLID of the last</em>
<a class="jxr_linenumber" name="2053" href="#2053">2053</a>         <em class="jxr_comment">//   incumbent, and EMPLID is part of the key, there are two</em>
<a class="jxr_linenumber" name="2054" href="#2054">2054</a>         <em class="jxr_comment">//   separate lines in CSF.</em>
<a class="jxr_linenumber" name="2055" href="#2055">2055</a>         <em class="jxr_comment">// - the EMPLID is replaced with the vacant ID in BCSF, so there</em>
<a class="jxr_linenumber" name="2056" href="#2056">2056</a>         <em class="jxr_comment">//   will only be one line in BCSF, and we need to aggregate the</em>
<a class="jxr_linenumber" name="2057" href="#2057">2057</a>         <em class="jxr_comment">//   amounts and effort  </em>
<a class="jxr_linenumber" name="2058" href="#2058">2058</a>         <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionCalculatedSalaryFoundationTracker.html">BudgetConstructionCalculatedSalaryFoundationTracker</a> nowBCSF = bCSF.get(csfKey);
<a class="jxr_linenumber" name="2059" href="#2059">2059</a>         <em class="jxr_comment">// first round the amount to whole dollars</em>
<a class="jxr_linenumber" name="2060" href="#2060">2060</a>         KualiInteger roundedAmount = <strong class="jxr_keyword">new</strong> KualiInteger(csf.getCsfAmount(), RoundingMode.valueOf(KualiInteger.ROUND_BEHAVIOR));
<a class="jxr_linenumber" name="2061" href="#2061">2061</a>         nowBCSF.setCsfAmount(nowBCSF.getCsfAmount().add(roundedAmount));
<a class="jxr_linenumber" name="2062" href="#2062">2062</a>         <em class="jxr_comment">// increase the percent time (maximum of 100)</em>
<a class="jxr_linenumber" name="2063" href="#2063">2063</a>         BigDecimal pctTime = nowBCSF.getCsfTimePercent();
<a class="jxr_linenumber" name="2064" href="#2064">2064</a>         pctTime = pctTime.add(csf.getCsfTimePercent());
<a class="jxr_linenumber" name="2065" href="#2065">2065</a>         <strong class="jxr_keyword">if</strong> (pctTime.floatValue() &gt; 100.0) {
<a class="jxr_linenumber" name="2066" href="#2066">2066</a>             pctTime = <strong class="jxr_keyword">new</strong> BigDecimal(100.00);
<a class="jxr_linenumber" name="2067" href="#2067">2067</a>         }
<a class="jxr_linenumber" name="2068" href="#2068">2068</a>         nowBCSF.setCsfTimePercent(pctTime);
<a class="jxr_linenumber" name="2069" href="#2069">2069</a>         <em class="jxr_comment">// increase the FTE (full-time equivalent) (maximum of 1.0)</em>
<a class="jxr_linenumber" name="2070" href="#2070">2070</a>         BigDecimal csfFTE = nowBCSF.getCsfFullTimeEmploymentQuantity();
<a class="jxr_linenumber" name="2071" href="#2071">2071</a>         csfFTE = csfFTE.add(csf.getCsfFullTimeEmploymentQuantity());
<a class="jxr_linenumber" name="2072" href="#2072">2072</a>         <strong class="jxr_keyword">if</strong> (csfFTE.floatValue() &gt; 1.0) {
<a class="jxr_linenumber" name="2073" href="#2073">2073</a>             csfFTE = <strong class="jxr_keyword">new</strong> BigDecimal(1.00);
<a class="jxr_linenumber" name="2074" href="#2074">2074</a>         }
<a class="jxr_linenumber" name="2075" href="#2075">2075</a>         nowBCSF.setCsfFullTimeEmploymentQuantity(csfFTE);
<a class="jxr_linenumber" name="2076" href="#2076">2076</a>         CSFVacantsConsolidated = CSFVacantsConsolidated + 1;
<a class="jxr_linenumber" name="2077" href="#2077">2077</a>     }
<a class="jxr_linenumber" name="2078" href="#2078">2078</a> 
<a class="jxr_linenumber" name="2079" href="#2079">2079</a>     <em class="jxr_comment">// make the rounding adjustments</em>
<a class="jxr_linenumber" name="2080" href="#2080">2080</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> adjustCSFRounding() {
<a class="jxr_linenumber" name="2081" href="#2081">2081</a>         <strong class="jxr_keyword">for</strong> (Map.Entry&lt;String, roundMechanism&gt; roundMap : keysNeedingRounding.entrySet()) {
<a class="jxr_linenumber" name="2082" href="#2082">2082</a>             <a href="../../../../../../../../org/kuali/kfs/module/bc/batch/dataaccess/impl/GenesisDaoOjb.html">roundMechanism</a> rx = roundMap.getValue();
<a class="jxr_linenumber" name="2083" href="#2083">2083</a>             rx.fixRoundErrors();
<a class="jxr_linenumber" name="2084" href="#2084">2084</a>         }
<a class="jxr_linenumber" name="2085" href="#2085">2085</a>         <em class="jxr_comment">// we can reclaim the storage</em>
<a class="jxr_linenumber" name="2086" href="#2086">2086</a>         keysNeedingRounding.clear();
<a class="jxr_linenumber" name="2087" href="#2087">2087</a>     }
<a class="jxr_linenumber" name="2088" href="#2088">2088</a> 
<a class="jxr_linenumber" name="2089" href="#2089">2089</a>     <em class="jxr_comment">// overload the BCSF object builders</em>
<a class="jxr_linenumber" name="2090" href="#2090">2090</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> buildAndStoreBCSFfromCSF(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/CalculatedSalaryFoundationTrackerOverride.html">CalculatedSalaryFoundationTrackerOverride</a> csf, String csfKey) {
<a class="jxr_linenumber" name="2091" href="#2091">2091</a>         <strong class="jxr_keyword">boolean</strong> vacantLine = isVacantLine(csf);
<a class="jxr_linenumber" name="2092" href="#2092">2092</a>         <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionCalculatedSalaryFoundationTracker.html">BudgetConstructionCalculatedSalaryFoundationTracker</a> csfBC = <strong class="jxr_keyword">new</strong> <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionCalculatedSalaryFoundationTracker.html">BudgetConstructionCalculatedSalaryFoundationTracker</a>();
<a class="jxr_linenumber" name="2093" href="#2093">2093</a>         <em class="jxr_comment">// budget construction CSF contains the coming fiscal year</em>
<a class="jxr_linenumber" name="2094" href="#2094">2094</a>         csfBC.setUniversityFiscalYear(csf.getUniversityFiscalYear() + 1);
<a class="jxr_linenumber" name="2095" href="#2095">2095</a>         csfBC.setChartOfAccountsCode(csf.getChartOfAccountsCode());
<a class="jxr_linenumber" name="2096" href="#2096">2096</a>         csfBC.setAccountNumber(csf.getAccountNumber());
<a class="jxr_linenumber" name="2097" href="#2097">2097</a>         csfBC.setSubAccountNumber(csf.getSubAccountNumber());
<a class="jxr_linenumber" name="2098" href="#2098">2098</a>         csfBC.setFinancialObjectCode(csf.getFinancialObjectCode());
<a class="jxr_linenumber" name="2099" href="#2099">2099</a>         csfBC.setFinancialSubObjectCode(csf.getFinancialSubObjectCode());
<a class="jxr_linenumber" name="2100" href="#2100">2100</a>         csfBC.setPositionNumber(csf.getPositionNumber());
<a class="jxr_linenumber" name="2101" href="#2101">2101</a>         <em class="jxr_comment">// budget construction CSF always contains the vacant EMPLID, not</em>
<a class="jxr_linenumber" name="2102" href="#2102">2102</a>         <em class="jxr_comment">// the EMPLID of the last incumbent</em>
<a class="jxr_linenumber" name="2103" href="#2103">2103</a>         csfBC.setEmplid((vacantLine ? BCConstants.VACANT_EMPLID : csf.getEmplid()));
<a class="jxr_linenumber" name="2104" href="#2104">2104</a>         csfBC.setCsfFullTimeEmploymentQuantity(csf.getCsfFullTimeEmploymentQuantity());
<a class="jxr_linenumber" name="2105" href="#2105">2105</a>         csfBC.setCsfTimePercent(csf.getCsfTimePercent());
<a class="jxr_linenumber" name="2106" href="#2106">2106</a>         csfBC.setCsfFundingStatusCode(csf.getCsfFundingStatusCode());
<a class="jxr_linenumber" name="2107" href="#2107">2107</a>         <em class="jxr_comment">// we only worry about rounding errors when the line is not vacant</em>
<a class="jxr_linenumber" name="2108" href="#2108">2108</a>         <em class="jxr_comment">// since all vacant lines in CSF have the same (vacant) EMPLID, we</em>
<a class="jxr_linenumber" name="2109" href="#2109">2109</a>         <em class="jxr_comment">// would have to round by position. </em>
<a class="jxr_linenumber" name="2110" href="#2110">2110</a>         <strong class="jxr_keyword">if</strong> (!vacantLine) {
<a class="jxr_linenumber" name="2111" href="#2111">2111</a>             <em class="jxr_comment">// changed BO type from KualiDecimal to KualiInteger (June 1, 2007) </em>
<a class="jxr_linenumber" name="2112" href="#2112">2112</a>             <em class="jxr_comment">// csfBC.setCsfAmount(csf.getCsfAmount());</em>
<a class="jxr_linenumber" name="2113" href="#2113">2113</a>             bCSF.put(csfKey, csfBC);
<a class="jxr_linenumber" name="2114" href="#2114">2114</a>             <em class="jxr_comment">// now we have to round and save the rounding error</em>
<a class="jxr_linenumber" name="2115" href="#2115">2115</a>             <a href="../../../../../../../../org/kuali/kfs/module/bc/batch/dataaccess/impl/GenesisDaoOjb.html">roundMechanism</a> rX = keysNeedingRounding.get(csf.getEmplid());
<a class="jxr_linenumber" name="2116" href="#2116">2116</a>             rX.addNewBCSF(csfBC, csf.getCsfAmount());
<a class="jxr_linenumber" name="2117" href="#2117">2117</a>         }
<a class="jxr_linenumber" name="2118" href="#2118">2118</a>         <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="2119" href="#2119">2119</a>             <em class="jxr_comment">// for vacant lines, we have to round to whole dollars</em>
<a class="jxr_linenumber" name="2120" href="#2120">2120</a>             csfBC.setCsfAmount(<strong class="jxr_keyword">new</strong> KualiInteger(csf.getCsfAmount(), RoundingMode.valueOf(KualiInteger.ROUND_BEHAVIOR)));
<a class="jxr_linenumber" name="2121" href="#2121">2121</a>             bCSF.put(csfKey, csfBC);
<a class="jxr_linenumber" name="2122" href="#2122">2122</a>         }
<a class="jxr_linenumber" name="2123" href="#2123">2123</a>     }
<a class="jxr_linenumber" name="2124" href="#2124">2124</a> 
<a class="jxr_linenumber" name="2125" href="#2125">2125</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> buildAndStoreBCSFfromCSF(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/CalculatedSalaryFoundationTracker.html">CalculatedSalaryFoundationTracker</a> csf, String csfKey) {
<a class="jxr_linenumber" name="2126" href="#2126">2126</a>         <strong class="jxr_keyword">boolean</strong> vacantLine = isVacantLine(csf);
<a class="jxr_linenumber" name="2127" href="#2127">2127</a>         <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionCalculatedSalaryFoundationTracker.html">BudgetConstructionCalculatedSalaryFoundationTracker</a> csfBC = <strong class="jxr_keyword">new</strong> <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionCalculatedSalaryFoundationTracker.html">BudgetConstructionCalculatedSalaryFoundationTracker</a>();
<a class="jxr_linenumber" name="2128" href="#2128">2128</a>         <em class="jxr_comment">// budget construction CSF contains the coming fiscal year</em>
<a class="jxr_linenumber" name="2129" href="#2129">2129</a>         csfBC.setUniversityFiscalYear(csf.getUniversityFiscalYear() + 1);
<a class="jxr_linenumber" name="2130" href="#2130">2130</a>         csfBC.setChartOfAccountsCode(csf.getChartOfAccountsCode());
<a class="jxr_linenumber" name="2131" href="#2131">2131</a>         csfBC.setAccountNumber(csf.getAccountNumber());
<a class="jxr_linenumber" name="2132" href="#2132">2132</a>         csfBC.setSubAccountNumber(csf.getSubAccountNumber());
<a class="jxr_linenumber" name="2133" href="#2133">2133</a>         csfBC.setFinancialObjectCode(csf.getFinancialObjectCode());
<a class="jxr_linenumber" name="2134" href="#2134">2134</a>         csfBC.setFinancialSubObjectCode(csf.getFinancialSubObjectCode());
<a class="jxr_linenumber" name="2135" href="#2135">2135</a>         csfBC.setPositionNumber(csf.getPositionNumber());
<a class="jxr_linenumber" name="2136" href="#2136">2136</a>         <em class="jxr_comment">// budget construction CSF always contains the vacant EMPLID, not</em>
<a class="jxr_linenumber" name="2137" href="#2137">2137</a>         <em class="jxr_comment">// the EMPLID of the last incumbent</em>
<a class="jxr_linenumber" name="2138" href="#2138">2138</a>         csfBC.setEmplid((vacantLine ? BCConstants.VACANT_EMPLID : csf.getEmplid()));
<a class="jxr_linenumber" name="2139" href="#2139">2139</a>         csfBC.setCsfFullTimeEmploymentQuantity(csf.getCsfFullTimeEmploymentQuantity());
<a class="jxr_linenumber" name="2140" href="#2140">2140</a>         csfBC.setCsfTimePercent(csf.getCsfTimePercent());
<a class="jxr_linenumber" name="2141" href="#2141">2141</a>         csfBC.setCsfFundingStatusCode(csf.getCsfFundingStatusCode());
<a class="jxr_linenumber" name="2142" href="#2142">2142</a>         <em class="jxr_comment">// we only worry about rounding errors when the line is not vacant</em>
<a class="jxr_linenumber" name="2143" href="#2143">2143</a>         <em class="jxr_comment">// since all vacant lines in CSF have the same (vacant) EMPLID, we</em>
<a class="jxr_linenumber" name="2144" href="#2144">2144</a>         <em class="jxr_comment">// would have to round by position, and positions can be shared. </em>
<a class="jxr_linenumber" name="2145" href="#2145">2145</a>         <strong class="jxr_keyword">if</strong> (!vacantLine) {
<a class="jxr_linenumber" name="2146" href="#2146">2146</a>             bCSF.put(csfKey, csfBC);
<a class="jxr_linenumber" name="2147" href="#2147">2147</a>             <em class="jxr_comment">// now we have to round and save the rounding error</em>
<a class="jxr_linenumber" name="2148" href="#2148">2148</a>             <a href="../../../../../../../../org/kuali/kfs/module/bc/batch/dataaccess/impl/GenesisDaoOjb.html">roundMechanism</a> rX = keysNeedingRounding.get(csf.getEmplid());
<a class="jxr_linenumber" name="2149" href="#2149">2149</a>             rX.addNewBCSF(csfBC, csf.getCsfAmount());
<a class="jxr_linenumber" name="2150" href="#2150">2150</a>         }
<a class="jxr_linenumber" name="2151" href="#2151">2151</a>         <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="2152" href="#2152">2152</a>             <em class="jxr_comment">// for vacant lines, we have to round to whole dollars</em>
<a class="jxr_linenumber" name="2153" href="#2153">2153</a>             csfBC.setCsfAmount(<strong class="jxr_keyword">new</strong> KualiInteger(csf.getCsfAmount(), RoundingMode.valueOf(KualiInteger.ROUND_BEHAVIOR)));
<a class="jxr_linenumber" name="2154" href="#2154">2154</a>             bCSF.put(csfKey, csfBC);
<a class="jxr_linenumber" name="2155" href="#2155">2155</a>         }
<a class="jxr_linenumber" name="2156" href="#2156">2156</a>     }
<a class="jxr_linenumber" name="2157" href="#2157">2157</a> 
<a class="jxr_linenumber" name="2158" href="#2158">2158</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> buildAppointemntFundingFromBCSF(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionCalculatedSalaryFoundationTracker.html">BudgetConstructionCalculatedSalaryFoundationTracker</a> bcsf) {
<a class="jxr_linenumber" name="2159" href="#2159">2159</a>         <em class="jxr_comment">// current referential integrity insists that the position exists</em>
<a class="jxr_linenumber" name="2160" href="#2160">2160</a>         <em class="jxr_comment">// if implementers take it out, we hedge our bets below</em>
<a class="jxr_linenumber" name="2161" href="#2161">2161</a>         String positionNumber = bcsf.getPositionNumber();
<a class="jxr_linenumber" name="2162" href="#2162">2162</a>         Integer normalWorkMonths = (positionNormalWorkMonths.containsKey(positionNumber) ? positionNormalWorkMonths.get(positionNumber) : 12);
<a class="jxr_linenumber" name="2163" href="#2163">2163</a>         <em class="jxr_comment">// rqstAmount and notOnLeave are used elsewhere and defined globally</em>
<a class="jxr_linenumber" name="2164" href="#2164">2164</a>         KualiInteger defaultAmount = KualiInteger.ZERO;
<a class="jxr_linenumber" name="2165" href="#2165">2165</a>         BigDecimal defaultFractions = <strong class="jxr_keyword">new</strong> BigDecimal(0);
<a class="jxr_linenumber" name="2166" href="#2166">2166</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="2167" href="#2167">2167</a>         <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/PendingBudgetConstructionAppointmentFunding.html">PendingBudgetConstructionAppointmentFunding</a> bcaf = <strong class="jxr_keyword">new</strong> <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/PendingBudgetConstructionAppointmentFunding.html">PendingBudgetConstructionAppointmentFunding</a>();
<a class="jxr_linenumber" name="2168" href="#2168">2168</a>         bcaf.setUniversityFiscalYear(bcsf.getUniversityFiscalYear());
<a class="jxr_linenumber" name="2169" href="#2169">2169</a>         bcaf.setChartOfAccountsCode(bcsf.getChartOfAccountsCode());
<a class="jxr_linenumber" name="2170" href="#2170">2170</a>         bcaf.setAccountNumber(bcsf.getAccountNumber());
<a class="jxr_linenumber" name="2171" href="#2171">2171</a>         bcaf.setSubAccountNumber(bcsf.getSubAccountNumber());
<a class="jxr_linenumber" name="2172" href="#2172">2172</a>         bcaf.setFinancialObjectCode(bcsf.getFinancialObjectCode());
<a class="jxr_linenumber" name="2173" href="#2173">2173</a>         bcaf.setFinancialSubObjectCode(bcsf.getFinancialSubObjectCode());
<a class="jxr_linenumber" name="2174" href="#2174">2174</a>         bcaf.setEmplid(bcsf.getEmplid());
<a class="jxr_linenumber" name="2175" href="#2175">2175</a>         bcaf.setPositionNumber(positionNumber);
<a class="jxr_linenumber" name="2176" href="#2176">2176</a>         bcaf.setAppointmentRequestedFteQuantity(bcsf.getCsfFullTimeEmploymentQuantity());
<a class="jxr_linenumber" name="2177" href="#2177">2177</a>         bcaf.setAppointmentRequestedTimePercent(bcsf.getCsfTimePercent());
<a class="jxr_linenumber" name="2178" href="#2178">2178</a>         <em class="jxr_comment">// set the defaults</em>
<a class="jxr_linenumber" name="2179" href="#2179">2179</a>         bcaf.setAppointmentFundingDurationCode(notOnLeave);
<a class="jxr_linenumber" name="2180" href="#2180">2180</a>         bcaf.setAppointmentRequestedCsfAmount(defaultAmount);
<a class="jxr_linenumber" name="2181" href="#2181">2181</a>         bcaf.setAppointmentRequestedCsfFteQuantity(defaultFractions);
<a class="jxr_linenumber" name="2182" href="#2182">2182</a>         bcaf.setAppointmentRequestedCsfTimePercent(defaultFractions);
<a class="jxr_linenumber" name="2183" href="#2183">2183</a>         bcaf.setAppointmentTotalIntendedAmount(defaultAmount);
<a class="jxr_linenumber" name="2184" href="#2184">2184</a>         bcaf.setAppointmentTotalIntendedFteQuantity(defaultFractions);
<a class="jxr_linenumber" name="2185" href="#2185">2185</a>         bcaf.setAppointmentRequestedAmount(rqstAmount);
<a class="jxr_linenumber" name="2186" href="#2186">2186</a>         bcaf.setAppointmentRequestedPayRate(defaultFractions);
<a class="jxr_linenumber" name="2187" href="#2187">2187</a>         bcaf.setAppointmentFundingMonth(normalWorkMonths);
<a class="jxr_linenumber" name="2188" href="#2188">2188</a>         <em class="jxr_comment">// for a new row, these are always false</em>
<a class="jxr_linenumber" name="2189" href="#2189">2189</a>         bcaf.setAppointmentFundingDeleteIndicator(false);
<a class="jxr_linenumber" name="2190" href="#2190">2190</a>         bcaf.setPositionObjectChangeIndicator(false);
<a class="jxr_linenumber" name="2191" href="#2191">2191</a>         bcaf.setPositionSalaryChangeIndicator(false);
<a class="jxr_linenumber" name="2192" href="#2192">2192</a>         <em class="jxr_comment">// now store the result</em>
<a class="jxr_linenumber" name="2193" href="#2193">2193</a>         getPersistenceBrokerTemplate().store(bcaf);
<a class="jxr_linenumber" name="2194" href="#2194">2194</a>         <em class="jxr_comment">// store the new BCSF row as well</em>
<a class="jxr_linenumber" name="2195" href="#2195">2195</a>         getPersistenceBrokerTemplate().store(bcsf);
<a class="jxr_linenumber" name="2196" href="#2196">2196</a>     }
<a class="jxr_linenumber" name="2197" href="#2197">2197</a> 
<a class="jxr_linenumber" name="2198" href="#2198">2198</a>     <strong class="jxr_keyword">protected</strong> String buildAppointmentFundingKey(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/PendingBudgetConstructionAppointmentFunding.html">PendingBudgetConstructionAppointmentFunding</a> bcaf) {
<a class="jxr_linenumber" name="2199" href="#2199">2199</a>         <strong class="jxr_keyword">return</strong> (bcaf.getEmplid()) + bcaf.getPositionNumber() + bcaf.getAccountNumber() + bcaf.getChartOfAccountsCode() + bcaf.getSubAccountNumber() + bcaf.getFinancialObjectCode() + bcaf.getFinancialSubObjectCode();
<a class="jxr_linenumber" name="2200" href="#2200">2200</a>     }
<a class="jxr_linenumber" name="2201" href="#2201">2201</a> 
<a class="jxr_linenumber" name="2202" href="#2202">2202</a>     <em class="jxr_comment">// overload the CSF key builders </em>
<a class="jxr_linenumber" name="2203" href="#2203">2203</a>     <strong class="jxr_keyword">protected</strong> String buildCSFKey(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/CalculatedSalaryFoundationTrackerOverride.html">CalculatedSalaryFoundationTrackerOverride</a> csf) {
<a class="jxr_linenumber" name="2204" href="#2204">2204</a>         <strong class="jxr_keyword">return</strong> (csf.getEmplid()) + csf.getPositionNumber() + csf.getAccountNumber() + csf.getChartOfAccountsCode() + csf.getSubAccountNumber() + csf.getFinancialObjectCode() + csf.getFinancialSubObjectCode();
<a class="jxr_linenumber" name="2205" href="#2205">2205</a>     }
<a class="jxr_linenumber" name="2206" href="#2206">2206</a> 
<a class="jxr_linenumber" name="2207" href="#2207">2207</a>     <strong class="jxr_keyword">protected</strong> String buildCSFKey(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/CalculatedSalaryFoundationTracker.html">CalculatedSalaryFoundationTracker</a> csf) {
<a class="jxr_linenumber" name="2208" href="#2208">2208</a>         <strong class="jxr_keyword">return</strong> (csf.getEmplid()) + csf.getPositionNumber() + csf.getAccountNumber() + csf.getChartOfAccountsCode() + csf.getSubAccountNumber() + csf.getFinancialObjectCode() + csf.getFinancialSubObjectCode();
<a class="jxr_linenumber" name="2209" href="#2209">2209</a>     }
<a class="jxr_linenumber" name="2210" href="#2210">2210</a> 
<a class="jxr_linenumber" name="2211" href="#2211">2211</a>     <strong class="jxr_keyword">protected</strong> String buildDocKeyFromBCSF(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionCalculatedSalaryFoundationTracker.html">BudgetConstructionCalculatedSalaryFoundationTracker</a> bcsf) {
<a class="jxr_linenumber" name="2212" href="#2212">2212</a>         <em class="jxr_comment">// see setUpbcHdrDocNumbers for the correct key elements</em>
<a class="jxr_linenumber" name="2213" href="#2213">2213</a>         <em class="jxr_comment">// the order here must match the order there</em>
<a class="jxr_linenumber" name="2214" href="#2214">2214</a>         <strong class="jxr_keyword">return</strong> bcsf.getChartOfAccountsCode() + bcsf.getAccountNumber() + bcsf.getSubAccountNumber();
<a class="jxr_linenumber" name="2215" href="#2215">2215</a>     }
<a class="jxr_linenumber" name="2216" href="#2216">2216</a> 
<a class="jxr_linenumber" name="2217" href="#2217">2217</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">boolean</strong> buildPBGLFromBCSFAndStore(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionCalculatedSalaryFoundationTracker.html">BudgetConstructionCalculatedSalaryFoundationTracker</a> bcsf) {
<a class="jxr_linenumber" name="2218" href="#2218">2218</a>         <em class="jxr_comment">// first we need to see if a new PBGL row is needed</em>
<a class="jxr_linenumber" name="2219" href="#2219">2219</a>         String testKey = buildPBGLKey(bcsf);
<a class="jxr_linenumber" name="2220" href="#2220">2220</a>         <strong class="jxr_keyword">if</strong> (currentPBGLKeys.contains(testKey)) {
<a class="jxr_linenumber" name="2221" href="#2221">2221</a>             <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="2222" href="#2222">2222</a>         }
<a class="jxr_linenumber" name="2223" href="#2223">2223</a>         <em class="jxr_comment">// Budget construction cannot show detailed salary lines unless the object code supports "detailed positions".   But, the CSF is a plug-in, so Kuali cannot assume that the CSF enforces this rule.  </em>
<a class="jxr_linenumber" name="2224" href="#2224">2224</a>         <em class="jxr_comment">// Here, we test whether the object class is valid.  if it is not, we write a message and skip the row.</em>
<a class="jxr_linenumber" name="2225" href="#2225">2225</a>         <em class="jxr_comment">// we do this before the GL check, so we can be sure we log all the rows that have problems instead of requiring multiple runs to find them all.</em>
<a class="jxr_linenumber" name="2226" href="#2226">2226</a>         String objectType = detailedPositionObjectTypes.get(bcsf.getChartOfAccountsCode() + bcsf.getFinancialObjectCode());
<a class="jxr_linenumber" name="2227" href="#2227">2227</a>         <strong class="jxr_keyword">if</strong> (objectType == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="2228" href="#2228">2228</a>             LOG.warn(String.format(<span class="jxr_string">"\nthis row has an object class which does not support"</span> + <span class="jxr_string">" detailed positions (skipped):\n"</span> + <span class="jxr_string">"position: %s, EMPLID: %s, accounting string ="</span> + <span class="jxr_string">"(%s,%s,%s,%s,%s"</span>, bcsf.getPositionNumber(), bcsf.getEmplid(), bcsf.getChartOfAccountsCode(), bcsf.getAccountNumber(), bcsf.getSubAccountNumber(), bcsf.getFinancialObjectCode(), bcsf.getFinancialSubObjectCode()));
<a class="jxr_linenumber" name="2229" href="#2229">2229</a>             CSFBadObjectsSkipped = CSFBadObjectsSkipped + 1;
<a class="jxr_linenumber" name="2230" href="#2230">2230</a>             <strong class="jxr_keyword">return</strong> false;
<a class="jxr_linenumber" name="2231" href="#2231">2231</a>         }
<a class="jxr_linenumber" name="2232" href="#2232">2232</a>         <em class="jxr_comment">// we need a new row.  </em>
<a class="jxr_linenumber" name="2233" href="#2233">2233</a>         <em class="jxr_comment">// store the key so we won't try to add another row from a different person's bcsf which has the same key.</em>
<a class="jxr_linenumber" name="2234" href="#2234">2234</a>         currentPBGLKeys.add(testKey);
<a class="jxr_linenumber" name="2235" href="#2235">2235</a>         String docKey = buildDocKeyFromBCSF(bcsf);
<a class="jxr_linenumber" name="2236" href="#2236">2236</a>         <em class="jxr_comment">// we never have to build a new document header because createNewBCDocumentsFromGLCSF is always called earlier in the step containing this routine. </em>
<a class="jxr_linenumber" name="2237" href="#2237">2237</a>         <em class="jxr_comment">// fill in the fields.</em>
<a class="jxr_linenumber" name="2238" href="#2238">2238</a>         <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/PendingBudgetConstructionGeneralLedger.html">PendingBudgetConstructionGeneralLedger</a> pbGL = <strong class="jxr_keyword">new</strong> <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/PendingBudgetConstructionGeneralLedger.html">PendingBudgetConstructionGeneralLedger</a>();
<a class="jxr_linenumber" name="2239" href="#2239">2239</a>         pbGL.setDocumentNumber(bcHdrDocNumbers.get(docKey));
<a class="jxr_linenumber" name="2240" href="#2240">2240</a>         pbGL.setUniversityFiscalYear(bcsf.getUniversityFiscalYear());
<a class="jxr_linenumber" name="2241" href="#2241">2241</a>         pbGL.setChartOfAccountsCode(bcsf.getChartOfAccountsCode());
<a class="jxr_linenumber" name="2242" href="#2242">2242</a>         pbGL.setAccountNumber(bcsf.getAccountNumber());
<a class="jxr_linenumber" name="2243" href="#2243">2243</a>         pbGL.setSubAccountNumber(bcsf.getSubAccountNumber());
<a class="jxr_linenumber" name="2244" href="#2244">2244</a>         pbGL.setFinancialObjectCode(bcsf.getFinancialObjectCode());
<a class="jxr_linenumber" name="2245" href="#2245">2245</a>         pbGL.setFinancialSubObjectCode(bcsf.getFinancialSubObjectCode());
<a class="jxr_linenumber" name="2246" href="#2246">2246</a>         pbGL.setFinancialBalanceTypeCode(KFSConstants.BALANCE_TYPE_BASE_BUDGET);
<a class="jxr_linenumber" name="2247" href="#2247">2247</a>         pbGL.setFinancialObjectTypeCode(objectType);
<a class="jxr_linenumber" name="2248" href="#2248">2248</a>         pbGL.setAccountLineAnnualBalanceAmount(KualiInteger.ZERO);
<a class="jxr_linenumber" name="2249" href="#2249">2249</a>         pbGL.setFinancialBeginningBalanceLineAmount(KualiInteger.ZERO);
<a class="jxr_linenumber" name="2250" href="#2250">2250</a>         <em class="jxr_comment">// store the new PBGL row</em>
<a class="jxr_linenumber" name="2251" href="#2251">2251</a>         getPersistenceBrokerTemplate().store(pbGL);
<a class="jxr_linenumber" name="2252" href="#2252">2252</a>         CSFNewGLRows = CSFNewGLRows + 1;
<a class="jxr_linenumber" name="2253" href="#2253">2253</a>         <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="2254" href="#2254">2254</a>     }
<a class="jxr_linenumber" name="2255" href="#2255">2255</a> 
<a class="jxr_linenumber" name="2256" href="#2256">2256</a>     <em class="jxr_comment">// these two rows are overloaded so we have a standardized key</em>
<a class="jxr_linenumber" name="2257" href="#2257">2257</a>     <strong class="jxr_keyword">protected</strong> String buildPBGLKey(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionCalculatedSalaryFoundationTracker.html">BudgetConstructionCalculatedSalaryFoundationTracker</a> bcsf) {
<a class="jxr_linenumber" name="2258" href="#2258">2258</a>         <strong class="jxr_keyword">return</strong> bcsf.getAccountNumber() + bcsf.getFinancialObjectCode() + bcsf.getChartOfAccountsCode() + bcsf.getSubAccountNumber() + bcsf.getFinancialSubObjectCode();
<a class="jxr_linenumber" name="2259" href="#2259">2259</a>     }
<a class="jxr_linenumber" name="2260" href="#2260">2260</a> 
<a class="jxr_linenumber" name="2261" href="#2261">2261</a>     <strong class="jxr_keyword">protected</strong> String buildPBGLKey(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/PendingBudgetConstructionGeneralLedger.html">PendingBudgetConstructionGeneralLedger</a> pbgl) {
<a class="jxr_linenumber" name="2262" href="#2262">2262</a>         <strong class="jxr_keyword">return</strong> pbgl.getAccountNumber() + pbgl.getFinancialObjectCode() + pbgl.getChartOfAccountsCode() + pbgl.getSubAccountNumber() + pbgl.getFinancialSubObjectCode();
<a class="jxr_linenumber" name="2263" href="#2263">2263</a>     }
<a class="jxr_linenumber" name="2264" href="#2264">2264</a> 
<a class="jxr_linenumber" name="2265" href="#2265">2265</a>     <strong class="jxr_keyword">protected</strong> String buildVacantCSFKey(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/CalculatedSalaryFoundationTrackerOverride.html">CalculatedSalaryFoundationTrackerOverride</a> csf) {
<a class="jxr_linenumber" name="2266" href="#2266">2266</a>         <strong class="jxr_keyword">boolean</strong> vacantLine = isVacantLine(csf);
<a class="jxr_linenumber" name="2267" href="#2267">2267</a>         <strong class="jxr_keyword">return</strong> (vacantLine ? BCConstants.VACANT_EMPLID : csf.getEmplid()) + csf.getPositionNumber() + csf.getAccountNumber() + csf.getChartOfAccountsCode() + csf.getSubAccountNumber() + csf.getFinancialObjectCode() + csf.getFinancialSubObjectCode();
<a class="jxr_linenumber" name="2268" href="#2268">2268</a>     }
<a class="jxr_linenumber" name="2269" href="#2269">2269</a> 
<a class="jxr_linenumber" name="2270" href="#2270">2270</a>     <strong class="jxr_keyword">protected</strong> String buildVacantCSFKey(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/CalculatedSalaryFoundationTracker.html">CalculatedSalaryFoundationTracker</a> csf) {
<a class="jxr_linenumber" name="2271" href="#2271">2271</a>         <strong class="jxr_keyword">boolean</strong> vacantLine = isVacantLine(csf);
<a class="jxr_linenumber" name="2272" href="#2272">2272</a>         <strong class="jxr_keyword">return</strong> (vacantLine ? BCConstants.VACANT_EMPLID : csf.getEmplid()) + csf.getPositionNumber() + csf.getAccountNumber() + csf.getChartOfAccountsCode() + csf.getSubAccountNumber() + csf.getFinancialObjectCode() + csf.getFinancialSubObjectCode();
<a class="jxr_linenumber" name="2273" href="#2273">2273</a>     }
<a class="jxr_linenumber" name="2274" href="#2274">2274</a> 
<a class="jxr_linenumber" name="2275" href="#2275">2275</a>     <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="2276" href="#2276">2276</a>     <em class="jxr_comment">// clean out the existing BCSF data for the key in question.</em>
<a class="jxr_linenumber" name="2277" href="#2277">2277</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> clearBCCSF(Integer FiscalYear) {
<a class="jxr_linenumber" name="2278" href="#2278">2278</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="2279" href="#2279">2279</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, FiscalYear);
<a class="jxr_linenumber" name="2280" href="#2280">2280</a>         QueryByCriteria queryID = <strong class="jxr_keyword">new</strong> QueryByCriteria(BudgetConstructionCalculatedSalaryFoundationTracker.<strong class="jxr_keyword">class</strong>, criteriaID);
<a class="jxr_linenumber" name="2281" href="#2281">2281</a>         getPersistenceBrokerTemplate().deleteByQuery(queryID);
<a class="jxr_linenumber" name="2282" href="#2282">2282</a>         <em class="jxr_comment">// as always, we should clear the cache after a bulk delete, even though in this case we haven't yet fetched much</em>
<a class="jxr_linenumber" name="2283" href="#2283">2283</a>         getPersistenceBrokerTemplate().clearCache();
<a class="jxr_linenumber" name="2284" href="#2284">2284</a>     }
<a class="jxr_linenumber" name="2285" href="#2285">2285</a> 
<a class="jxr_linenumber" name="2286" href="#2286">2286</a> 
<a class="jxr_linenumber" name="2287" href="#2287">2287</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> CSFDiagnostics() {
<a class="jxr_linenumber" name="2288" href="#2288">2288</a>         LOG.info(String.format(<span class="jxr_string">"\n\nResults of building BC CSF"</span>));
<a class="jxr_linenumber" name="2289" href="#2289">2289</a>         LOG.info(String.format(<span class="jxr_string">"\nCSF override active rows %d"</span>, CSFOverrideRead));
<a class="jxr_linenumber" name="2290" href="#2290">2290</a>         LOG.info(String.format(<span class="jxr_string">"\nCSF override deletes     %d"</span>, CSFOverrideDeletesRead));
<a class="jxr_linenumber" name="2291" href="#2291">2291</a>         LOG.info(String.format(<span class="jxr_string">"\nCSF rows read            %d"</span>, CSFRowsRead));
<a class="jxr_linenumber" name="2292" href="#2292">2292</a>         LOG.info(String.format(<span class="jxr_string">"\n\nCSF overrides vacant    %d"</span>, CSFOverrideVacant));
<a class="jxr_linenumber" name="2293" href="#2293">2293</a>         LOG.info(String.format(<span class="jxr_string">"\nCSF vacant               %d"</span>, CSFRowsVacant));
<a class="jxr_linenumber" name="2294" href="#2294">2294</a>         LOG.info(String.format(<span class="jxr_string">"\nCSF vacants consolidated %d"</span>, CSFVacantsConsolidated));
<a class="jxr_linenumber" name="2295" href="#2295">2295</a>         LOG.info(String.format(<span class="jxr_string">"\n\nBudgetConstruction CSF rows %d"</span>, CSFForBCSF));
<a class="jxr_linenumber" name="2296" href="#2296">2296</a>         LOG.info(String.format(<span class="jxr_string">"\n\nCurrent PBGL rows with position object classes %d"</span>, CSFCurrentGLRows));
<a class="jxr_linenumber" name="2297" href="#2297">2297</a>         LOG.info(String.format(<span class="jxr_string">"\nNew PBGL rows created from CSF %d"</span>, CSFNewGLRows));
<a class="jxr_linenumber" name="2298" href="#2298">2298</a>         LOG.info(String.format(<span class="jxr_string">"\nCSF rows skipped: bad obj code %d"</span>,CSFBadObjectsSkipped));
<a class="jxr_linenumber" name="2299" href="#2299">2299</a>         LOG.info(String.format(<span class="jxr_string">"\n\nCurrent appt funding rows      %d"</span>, CSFCurrentBCAFRows));
<a class="jxr_linenumber" name="2300" href="#2300">2300</a>         LOG.info(String.format(<span class="jxr_string">"\nNew appt funding rows from CSF   %d"</span>,CSFNewBCAFRows));
<a class="jxr_linenumber" name="2301" href="#2301">2301</a>         LOG.info(String.format(<span class="jxr_string">"\nAppt funding rows not in BCSF    %d"</span>, CSFBCAFRowsMissing));
<a class="jxr_linenumber" name="2302" href="#2302">2302</a>         LOG.info(String.format(<span class="jxr_string">"\nAppt funding rows marked deleted %d"</span>, CSFBCAFRowsMarkedDeleted));
<a class="jxr_linenumber" name="2303" href="#2303">2303</a>         LOG.info(String.format(<span class="jxr_string">"\n\nend of BC CSF build statistics"</span>));
<a class="jxr_linenumber" name="2304" href="#2304">2304</a>     }
<a class="jxr_linenumber" name="2305" href="#2305">2305</a> 
<a class="jxr_linenumber" name="2306" href="#2306">2306</a>     <strong class="jxr_keyword">protected</strong> ArrayList&lt;String&gt; findPositionRequiredObjectCodes(Integer BaseYear) {
<a class="jxr_linenumber" name="2307" href="#2307">2307</a>         <em class="jxr_comment">// we want to build an SQL IN criteria to filter a return set. </em>
<a class="jxr_linenumber" name="2308" href="#2308">2308</a>         <em class="jxr_comment">// we will find distinct objects only, regardless of chart, so OJB can build the SQL instead of our having to concatenate the chart and object code fields.  </em>
<a class="jxr_linenumber" name="2309" href="#2309">2309</a>         <em class="jxr_comment">// this will not be a concern--it will make the return set bigger,but include every case we want. </em>
<a class="jxr_linenumber" name="2310" href="#2310">2310</a>         <em class="jxr_comment">// the result will be used to build a list to check for missing PBGL rows, so having more PBGL rows than we need will not cause us to miss any.</em>
<a class="jxr_linenumber" name="2311" href="#2311">2311</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="2312" href="#2312">2312</a>         ArrayList&lt;String&gt; objectCodesWithIndividualPositions = <strong class="jxr_keyword">new</strong> ArrayList&lt;String&gt;(10);
<a class="jxr_linenumber" name="2313" href="#2313">2313</a>         
<a class="jxr_linenumber" name="2314" href="#2314">2314</a>         Map&lt;String, Object&gt; laborObjectCodeMap = <strong class="jxr_keyword">new</strong> HashMap&lt;String, Object&gt;();
<a class="jxr_linenumber" name="2315" href="#2315">2315</a>         laborObjectCodeMap.put(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, RequestYear);
<a class="jxr_linenumber" name="2316" href="#2316">2316</a>         laborObjectCodeMap.put(KFSPropertyConstants.DETAIL_POSITION_REQUIRED_INDICATOR, <strong class="jxr_keyword">true</strong>);    
<a class="jxr_linenumber" name="2317" href="#2317">2317</a>         laborObjectCodeMap.put(KFSPropertyConstants.ACTIVE,<strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="2318" href="#2318">2318</a>         List&lt;LaborLedgerObject&gt; laborLedgerObjects = kualiModuleService.getResponsibleModuleService(LaborLedgerObject.<strong class="jxr_keyword">class</strong>).getExternalizableBusinessObjectsList(LaborLedgerObject.<strong class="jxr_keyword">class</strong>, laborObjectCodeMap);
<a class="jxr_linenumber" name="2319" href="#2319">2319</a>         
<a class="jxr_linenumber" name="2320" href="#2320">2320</a>         <strong class="jxr_keyword">for</strong>(<a href="../../../../../../../../org/kuali/kfs/integration/ld/LaborLedgerObject.html">LaborLedgerObject</a> laborObject: laborLedgerObjects) {
<a class="jxr_linenumber" name="2321" href="#2321">2321</a>             objectCodesWithIndividualPositions.add(laborObject.getFinancialObjectCode());
<a class="jxr_linenumber" name="2322" href="#2322">2322</a>         }
<a class="jxr_linenumber" name="2323" href="#2323">2323</a>         
<a class="jxr_linenumber" name="2324" href="#2324">2324</a>         <strong class="jxr_keyword">return</strong> objectCodesWithIndividualPositions;
<a class="jxr_linenumber" name="2325" href="#2325">2325</a>     }
<a class="jxr_linenumber" name="2326" href="#2326">2326</a> 
<a class="jxr_linenumber" name="2327" href="#2327">2327</a>     <em class="jxr_comment">//  we will overload both of these checks as well             </em>
<a class="jxr_linenumber" name="2328" href="#2328">2328</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">boolean</strong> isVacantLine(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/CalculatedSalaryFoundationTracker.html">CalculatedSalaryFoundationTracker</a> csf) {
<a class="jxr_linenumber" name="2329" href="#2329">2329</a>         <strong class="jxr_keyword">return</strong> ((csf.getCsfFundingStatusCode().equals(BCConstants.csfFundingStatusFlag.VACANT.getFlagValue())) || (csf.getCsfFundingStatusCode().equals(BCConstants.csfFundingStatusFlag.UNFUNDED.getFlagValue())));
<a class="jxr_linenumber" name="2330" href="#2330">2330</a>     }
<a class="jxr_linenumber" name="2331" href="#2331">2331</a> 
<a class="jxr_linenumber" name="2332" href="#2332">2332</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">boolean</strong> isVacantLine(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/CalculatedSalaryFoundationTrackerOverride.html">CalculatedSalaryFoundationTrackerOverride</a> csf) {
<a class="jxr_linenumber" name="2333" href="#2333">2333</a>         <strong class="jxr_keyword">return</strong> ((csf.getCsfFundingStatusCode().equals(BCConstants.csfFundingStatusFlag.VACANT.getFlagValue())) || (csf.getCsfFundingStatusCode().equals(BCConstants.csfFundingStatusFlag.UNFUNDED.getFlagValue())));
<a class="jxr_linenumber" name="2334" href="#2334">2334</a>     }
<a class="jxr_linenumber" name="2335" href="#2335">2335</a> 
<a class="jxr_linenumber" name="2336" href="#2336">2336</a>     <em class="jxr_comment">// here are the routines to build BCSF</em>
<a class="jxr_linenumber" name="2337" href="#2337">2337</a> 
<a class="jxr_linenumber" name="2338" href="#2338">2338</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> readAndWriteBCSFAndNewAppointmentFundingAndNewPBGL(Integer BaseYear) {
<a class="jxr_linenumber" name="2339" href="#2339">2339</a>         <em class="jxr_comment">// read through the remaining BCSF objects (those that do not presently exist in appointment funding (BCAF).</em>
<a class="jxr_linenumber" name="2340" href="#2340">2340</a>         <em class="jxr_comment">// we will check whether they exist in Pending GL (PBGL), and, if not, write a new GL line.  </em>
<a class="jxr_linenumber" name="2341" href="#2341">2341</a>         <em class="jxr_comment">// Then, we will write a PBGL row and a BCSF row (in that order, because of referential integrity.  </em>
<a class="jxr_linenumber" name="2342" href="#2342">2342</a>         <em class="jxr_comment">// The PBGL and BCAF rows will have 0 amounts.</em>
<a class="jxr_linenumber" name="2343" href="#2343">2343</a>         <em class="jxr_comment">// People will have to fill in the budgets (or mark the funding deleted) to cover people in the payroll in budgeted positions, but not funding in the base budget in GL.</em>
<a class="jxr_linenumber" name="2344" href="#2344">2344</a>         CSFNewBCAFRows = bCSF.size();
<a class="jxr_linenumber" name="2345" href="#2345">2345</a>         <strong class="jxr_keyword">for</strong> (Map.Entry&lt;String, BudgetConstructionCalculatedSalaryFoundationTracker&gt; orphanBCSF : bCSF.entrySet()) {
<a class="jxr_linenumber" name="2346" href="#2346">2346</a>             <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionCalculatedSalaryFoundationTracker.html">BudgetConstructionCalculatedSalaryFoundationTracker</a> bcsf = orphanBCSF.getValue();
<a class="jxr_linenumber" name="2347" href="#2347">2347</a>             <strong class="jxr_keyword">if</strong> (!buildPBGLFromBCSFAndStore(bcsf)) {
<a class="jxr_linenumber" name="2348" href="#2348">2348</a>                 <strong class="jxr_keyword">continue</strong>;
<a class="jxr_linenumber" name="2349" href="#2349">2349</a>             }
<a class="jxr_linenumber" name="2350" href="#2350">2350</a>             buildAppointemntFundingFromBCSF(bcsf);
<a class="jxr_linenumber" name="2351" href="#2351">2351</a>         }
<a class="jxr_linenumber" name="2352" href="#2352">2352</a>     }
<a class="jxr_linenumber" name="2353" href="#2353">2353</a> 
<a class="jxr_linenumber" name="2354" href="#2354">2354</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> readCSF(Integer BaseYear) {
<a class="jxr_linenumber" name="2355" href="#2355">2355</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="2356" href="#2356">2356</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear);
<a class="jxr_linenumber" name="2357" href="#2357">2357</a>         criteriaID.addEqualTo(KFSPropertyConstants.CSF_DELETE_CODE, BCConstants.ACTIVE_CSF_DELETE_CODE);
<a class="jxr_linenumber" name="2358" href="#2358">2358</a>         QueryByCriteria queryID = <strong class="jxr_keyword">new</strong> QueryByCriteria(CalculatedSalaryFoundationTracker.<strong class="jxr_keyword">class</strong>, criteriaID);
<a class="jxr_linenumber" name="2359" href="#2359">2359</a>         Iterator csfResultSet = getPersistenceBrokerTemplate().getIteratorByQuery(queryID);
<a class="jxr_linenumber" name="2360" href="#2360">2360</a>         <strong class="jxr_keyword">while</strong> (csfResultSet.hasNext()) {
<a class="jxr_linenumber" name="2361" href="#2361">2361</a>             <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/CalculatedSalaryFoundationTracker.html">CalculatedSalaryFoundationTracker</a> csfRow = (CalculatedSalaryFoundationTracker) csfResultSet.next();
<a class="jxr_linenumber" name="2362" href="#2362">2362</a>             CSFRowsRead = CSFRowsRead + 1;
<a class="jxr_linenumber" name="2363" href="#2363">2363</a>             CSFRowsVacant = CSFRowsVacant + (isVacantLine(csfRow) ? 1 : 0);
<a class="jxr_linenumber" name="2364" href="#2364">2364</a>             <em class="jxr_comment">// has this been overridden?  if so, don't store it</em>
<a class="jxr_linenumber" name="2365" href="#2365">2365</a>             String testKey = buildCSFKey(csfRow);
<a class="jxr_linenumber" name="2366" href="#2366">2366</a>             <strong class="jxr_keyword">if</strong> (csfOverrideKeys.contains(testKey)) {
<a class="jxr_linenumber" name="2367" href="#2367">2367</a>                 <strong class="jxr_keyword">continue</strong>;
<a class="jxr_linenumber" name="2368" href="#2368">2368</a>             }
<a class="jxr_linenumber" name="2369" href="#2369">2369</a>             <em class="jxr_comment">// is the line vacant</em>
<a class="jxr_linenumber" name="2370" href="#2370">2370</a>             testKey = buildVacantCSFKey(csfRow);
<a class="jxr_linenumber" name="2371" href="#2371">2371</a>             <strong class="jxr_keyword">if</strong> (isVacantLine(csfRow) &amp;&amp; (bCSF.containsKey(testKey))) {
<a class="jxr_linenumber" name="2372" href="#2372">2372</a>                 <em class="jxr_comment">//the line is vacant and it is already in CSF</em>
<a class="jxr_linenumber" name="2373" href="#2373">2373</a>                 addToExistingBCSFVacant(csfRow, testKey);
<a class="jxr_linenumber" name="2374" href="#2374">2374</a>             }
<a class="jxr_linenumber" name="2375" href="#2375">2375</a>             <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="2376" href="#2376">2376</a>                 buildAndStoreBCSFfromCSF(csfRow, testKey);
<a class="jxr_linenumber" name="2377" href="#2377">2377</a>             }
<a class="jxr_linenumber" name="2378" href="#2378">2378</a>         }
<a class="jxr_linenumber" name="2379" href="#2379">2379</a>         <em class="jxr_comment">// we no longer need the list of csf override keys--recycle</em>
<a class="jxr_linenumber" name="2380" href="#2380">2380</a>         csfOverrideKeys.clear();
<a class="jxr_linenumber" name="2381" href="#2381">2381</a>     }
<a class="jxr_linenumber" name="2382" href="#2382">2382</a> 
<a class="jxr_linenumber" name="2383" href="#2383">2383</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> readCSFOverride(Integer BaseYear) {
<a class="jxr_linenumber" name="2384" href="#2384">2384</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="2385" href="#2385">2385</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear);
<a class="jxr_linenumber" name="2386" href="#2386">2386</a>         criteriaID.addEqualTo(KFSPropertyConstants.CSF_DELETE_CODE, BCConstants.ACTIVE_CSF_DELETE_CODE);
<a class="jxr_linenumber" name="2387" href="#2387">2387</a>         criteriaID.addEqualTo(KFSPropertyConstants.ACTIVE, <strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="2388" href="#2388">2388</a>         QueryByCriteria queryID = <strong class="jxr_keyword">new</strong> QueryByCriteria(CalculatedSalaryFoundationTrackerOverride.<strong class="jxr_keyword">class</strong>, criteriaID);
<a class="jxr_linenumber" name="2389" href="#2389">2389</a>         Iterator csfResultSet = getPersistenceBrokerTemplate().getIteratorByQuery(queryID);
<a class="jxr_linenumber" name="2390" href="#2390">2390</a>         <strong class="jxr_keyword">while</strong> (csfResultSet.hasNext()) {
<a class="jxr_linenumber" name="2391" href="#2391">2391</a>             <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/CalculatedSalaryFoundationTrackerOverride.html">CalculatedSalaryFoundationTrackerOverride</a> csfRow = (CalculatedSalaryFoundationTrackerOverride) csfResultSet.next();
<a class="jxr_linenumber" name="2392" href="#2392">2392</a>             CSFOverrideRead = CSFOverrideRead + 1;
<a class="jxr_linenumber" name="2393" href="#2393">2393</a>             CSFOverrideVacant = CSFOverrideVacant + (isVacantLine(csfRow) ? 1 : 0);
<a class="jxr_linenumber" name="2394" href="#2394">2394</a>             <em class="jxr_comment">// is the line vacant</em>
<a class="jxr_linenumber" name="2395" href="#2395">2395</a>             String testKey = buildVacantCSFKey(csfRow);
<a class="jxr_linenumber" name="2396" href="#2396">2396</a>             <strong class="jxr_keyword">if</strong> (isVacantLine(csfRow) &amp;&amp; (bCSF.containsKey(testKey))) {
<a class="jxr_linenumber" name="2397" href="#2397">2397</a>                 <em class="jxr_comment">//the line is vacant and it is already in CSF</em>
<a class="jxr_linenumber" name="2398" href="#2398">2398</a>                 addToExistingBCSFVacant(csfRow, testKey);
<a class="jxr_linenumber" name="2399" href="#2399">2399</a>             }
<a class="jxr_linenumber" name="2400" href="#2400">2400</a>             <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="2401" href="#2401">2401</a>                 buildAndStoreBCSFfromCSF(csfRow, testKey);
<a class="jxr_linenumber" name="2402" href="#2402">2402</a>             }
<a class="jxr_linenumber" name="2403" href="#2403">2403</a>         }
<a class="jxr_linenumber" name="2404" href="#2404">2404</a>     }
<a class="jxr_linenumber" name="2405" href="#2405">2405</a> 
<a class="jxr_linenumber" name="2406" href="#2406">2406</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> readExistingAppointmentFunding(Integer BaseYear) {
<a class="jxr_linenumber" name="2407" href="#2407">2407</a>         <em class="jxr_comment">// we will read all existing appointment funding (BCAF).</em>
<a class="jxr_linenumber" name="2408" href="#2408">2408</a>         <em class="jxr_comment">// -- if a BCAF object matches with a BCSF row, we will store and remove the BCSF row, and ignore the AF object</em>
<a class="jxr_linenumber" name="2409" href="#2409">2409</a>         <em class="jxr_comment">// -- if a BCAF object does NOT match with a BCSF row, we will check to see if it has been altered by a user.  if not, we will mark it deleted and store it as such.</em>
<a class="jxr_linenumber" name="2410" href="#2410">2410</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="2411" href="#2411">2411</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="2412" href="#2412">2412</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="2413" href="#2413">2413</a>         <em class="jxr_comment">// we add this criterion so that it is possible to have more than one year at a time in budget construction if an institution wants to do that.</em>
<a class="jxr_linenumber" name="2414" href="#2414">2414</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, RequestYear);
<a class="jxr_linenumber" name="2415" href="#2415">2415</a>         QueryByCriteria queryID = <strong class="jxr_keyword">new</strong> QueryByCriteria(PendingBudgetConstructionAppointmentFunding.<strong class="jxr_keyword">class</strong>, criteriaID);
<a class="jxr_linenumber" name="2416" href="#2416">2416</a>         Iterator bcafResults = getPersistenceBrokerTemplate().getIteratorByQuery(queryID);
<a class="jxr_linenumber" name="2417" href="#2417">2417</a>         <strong class="jxr_keyword">while</strong> (bcafResults.hasNext()) {
<a class="jxr_linenumber" name="2418" href="#2418">2418</a>             CSFCurrentBCAFRows = CSFCurrentBCAFRows + 1;
<a class="jxr_linenumber" name="2419" href="#2419">2419</a>             <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/PendingBudgetConstructionAppointmentFunding.html">PendingBudgetConstructionAppointmentFunding</a> bcaf = (PendingBudgetConstructionAppointmentFunding) bcafResults.next();
<a class="jxr_linenumber" name="2420" href="#2420">2420</a>             String testKey = buildAppointmentFundingKey(bcaf);
<a class="jxr_linenumber" name="2421" href="#2421">2421</a>             <strong class="jxr_keyword">if</strong> (bCSF.containsKey(testKey)) {
<a class="jxr_linenumber" name="2422" href="#2422">2422</a>                 <em class="jxr_comment">// the new BCSF row is already in appointment funding. </em>
<a class="jxr_linenumber" name="2423" href="#2423">2423</a>                 <em class="jxr_comment">// we store the BCSF row, delete it from the hash map, and go on.</em>
<a class="jxr_linenumber" name="2424" href="#2424">2424</a>                 <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionCalculatedSalaryFoundationTracker.html">BudgetConstructionCalculatedSalaryFoundationTracker</a> bCSFRow = bCSF.get(testKey);
<a class="jxr_linenumber" name="2425" href="#2425">2425</a>                 getPersistenceBrokerTemplate().store(bCSFRow);
<a class="jxr_linenumber" name="2426" href="#2426">2426</a>                 bCSF.remove(testKey);
<a class="jxr_linenumber" name="2427" href="#2427">2427</a>             }
<a class="jxr_linenumber" name="2428" href="#2428">2428</a>             <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="2429" href="#2429">2429</a>                 <em class="jxr_comment">// the current funding row is NOT in the new base set. </em>
<a class="jxr_linenumber" name="2430" href="#2430">2430</a>                 <em class="jxr_comment">// we will mark it deleted if it came in from CSF and has not been altered by a user.</em>
<a class="jxr_linenumber" name="2431" href="#2431">2431</a>                 <em class="jxr_comment">// we never remove any existing rows from BCAF in batch.</em>
<a class="jxr_linenumber" name="2432" href="#2432">2432</a>                 untouchedAppointmentFunding(bcaf);
<a class="jxr_linenumber" name="2433" href="#2433">2433</a>             }
<a class="jxr_linenumber" name="2434" href="#2434">2434</a>         }
<a class="jxr_linenumber" name="2435" href="#2435">2435</a>     }
<a class="jxr_linenumber" name="2436" href="#2436">2436</a> 
<a class="jxr_linenumber" name="2437" href="#2437">2437</a>     <em class="jxr_comment">// set up the hash objects   </em>
<a class="jxr_linenumber" name="2438" href="#2438">2438</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> setUpBCSFMap(Integer BaseYear) {
<a class="jxr_linenumber" name="2439" href="#2439">2439</a>         <em class="jxr_comment">// we'll just overestimate, making the size equal to active override rows and active CSF rows, even though the former might replace some of the latter</em>
<a class="jxr_linenumber" name="2440" href="#2440">2440</a>         Integer bCSFSize = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="2441" href="#2441">2441</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="2442" href="#2442">2442</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear);
<a class="jxr_linenumber" name="2443" href="#2443">2443</a>         criteriaID.addEqualTo(KFSPropertyConstants.CSF_DELETE_CODE, BCConstants.ACTIVE_CSF_DELETE_CODE);
<a class="jxr_linenumber" name="2444" href="#2444">2444</a>         criteriaID.addEqualTo(KFSPropertyConstants.ACTIVE,<strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="2445" href="#2445">2445</a>         Criteria criteriaIDCSF = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="2446" href="#2446">2446</a>         criteriaIDCSF.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear);
<a class="jxr_linenumber" name="2447" href="#2447">2447</a>         criteriaIDCSF.addEqualTo(KFSPropertyConstants.CSF_DELETE_CODE, BCConstants.ACTIVE_CSF_DELETE_CODE);
<a class="jxr_linenumber" name="2448" href="#2448">2448</a>         bCSFSize = hashObjectSize(CalculatedSalaryFoundationTrackerOverride.<strong class="jxr_keyword">class</strong>, criteriaID) + hashObjectSize(CalculatedSalaryFoundationTracker.<strong class="jxr_keyword">class</strong>, criteriaIDCSF);
<a class="jxr_linenumber" name="2449" href="#2449">2449</a>         bCSF = <strong class="jxr_keyword">new</strong> HashMap&lt;String, BudgetConstructionCalculatedSalaryFoundationTracker&gt;(bCSFSize);
<a class="jxr_linenumber" name="2450" href="#2450">2450</a>     }
<a class="jxr_linenumber" name="2451" href="#2451">2451</a> 
<a class="jxr_linenumber" name="2452" href="#2452">2452</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> setUpbcHdrDocNumbers(Integer BaseYear) {
<a class="jxr_linenumber" name="2453" href="#2453">2453</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="2454" href="#2454">2454</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="2455" href="#2455">2455</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, RequestYear);
<a class="jxr_linenumber" name="2456" href="#2456">2456</a>         bcHdrDocNumbers = <strong class="jxr_keyword">new</strong> HashMap&lt;String, String&gt;(hashObjectSize(BudgetConstructionHeader.<strong class="jxr_keyword">class</strong>, criteriaID));
<a class="jxr_linenumber" name="2457" href="#2457">2457</a>         <em class="jxr_comment">//  now we have to get the actual data</em>
<a class="jxr_linenumber" name="2458" href="#2458">2458</a>         String[] headerList = { KFSPropertyConstants.CHART_OF_ACCOUNTS_CODE, KFSPropertyConstants.ACCOUNT_NUMBER, KFSPropertyConstants.SUB_ACCOUNT_NUMBER, KFSPropertyConstants.DOCUMENT_NUMBER };
<a class="jxr_linenumber" name="2459" href="#2459">2459</a>         ReportQueryByCriteria queryID = <strong class="jxr_keyword">new</strong> ReportQueryByCriteria(BudgetConstructionHeader.<strong class="jxr_keyword">class</strong>, headerList, criteriaID);
<a class="jxr_linenumber" name="2460" href="#2460">2460</a>         Iterator headerRows = getPersistenceBrokerTemplate().getReportQueryIteratorByQuery(queryID);
<a class="jxr_linenumber" name="2461" href="#2461">2461</a>         <strong class="jxr_keyword">while</strong> (headerRows.hasNext()) {
<a class="jxr_linenumber" name="2462" href="#2462">2462</a>             Object[] headerRow = (Object[]) headerRows.next();
<a class="jxr_linenumber" name="2463" href="#2463">2463</a>             String testKey = ((String) headerRow[0]) + ((String) headerRow[1]) + ((String) headerRow[2]);
<a class="jxr_linenumber" name="2464" href="#2464">2464</a>             bcHdrDocNumbers.put(testKey, ((String) headerRow[3]));
<a class="jxr_linenumber" name="2465" href="#2465">2465</a>         }
<a class="jxr_linenumber" name="2466" href="#2466">2466</a>     }
<a class="jxr_linenumber" name="2467" href="#2467">2467</a> 
<a class="jxr_linenumber" name="2468" href="#2468">2468</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> setUpCSFOverrideKeys(Integer BaseYear) {
<a class="jxr_linenumber" name="2469" href="#2469">2469</a>         <em class="jxr_comment">//  these are rows in CSF Override--they should take precedence over what is in CSF</em>
<a class="jxr_linenumber" name="2470" href="#2470">2470</a>         <em class="jxr_comment">//  the idea is this:</em>
<a class="jxr_linenumber" name="2471" href="#2471">2471</a>         <em class="jxr_comment">//  (1) we build BCSF from CSF Override first.  so, when we read CSF, we will not create a new BCSF entry if the override already has created one.</em>
<a class="jxr_linenumber" name="2472" href="#2472">2472</a>         <em class="jxr_comment">//  (2) the override will create an entry with the same key as CSF unless (a) the override has a deleted row or (b) the override has a vacant row so that the EMPLID is changed to the vacant EMPLID in BCSF.</em>
<a class="jxr_linenumber" name="2473" href="#2473">2473</a>         <em class="jxr_comment">//   So, we create a list of override keys possibly missing in BCSF which can be used to eliminate CSF candidates for BCSF.    </em>
<a class="jxr_linenumber" name="2474" href="#2474">2474</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="2475" href="#2475">2475</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear);
<a class="jxr_linenumber" name="2476" href="#2476">2476</a>         criteriaID.addEqualTo(KFSPropertyConstants.ACTIVE, <strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="2477" href="#2477">2477</a>         Criteria deleteCriteria = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="2478" href="#2478">2478</a>         deleteCriteria.addNotEqualTo(KFSPropertyConstants.CSF_DELETE_CODE, BCConstants.ACTIVE_CSF_DELETE_CODE);
<a class="jxr_linenumber" name="2479" href="#2479">2479</a>         Criteria vacantCriteria = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="2480" href="#2480">2480</a>         vacantCriteria.addEqualTo(KFSPropertyConstants.CSF_FUNDING_STATUS_CODE, BCConstants.csfFundingStatusFlag.VACANT.getFlagValue());
<a class="jxr_linenumber" name="2481" href="#2481">2481</a>         deleteCriteria.addOrCriteria(vacantCriteria);
<a class="jxr_linenumber" name="2482" href="#2482">2482</a>         criteriaID.addAndCriteria(deleteCriteria);
<a class="jxr_linenumber" name="2483" href="#2483">2483</a>         csfOverrideKeys = <strong class="jxr_keyword">new</strong> HashSet&lt;String&gt;(hashObjectSize(CalculatedSalaryFoundationTrackerOverride.<strong class="jxr_keyword">class</strong>, criteriaID));
<a class="jxr_linenumber" name="2484" href="#2484">2484</a>         <em class="jxr_comment">// now we want to build the hash set</em>
<a class="jxr_linenumber" name="2485" href="#2485">2485</a>         QueryByCriteria qry = <strong class="jxr_keyword">new</strong> QueryByCriteria(CalculatedSalaryFoundationTrackerOverride.<strong class="jxr_keyword">class</strong>, criteriaID);
<a class="jxr_linenumber" name="2486" href="#2486">2486</a>         Iterator&lt;CalculatedSalaryFoundationTrackerOverride&gt; csfOvrd = getPersistenceBrokerTemplate().getIteratorByQuery(qry);
<a class="jxr_linenumber" name="2487" href="#2487">2487</a>         <strong class="jxr_keyword">while</strong> (csfOvrd.hasNext()) {
<a class="jxr_linenumber" name="2488" href="#2488">2488</a>             <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/CalculatedSalaryFoundationTrackerOverride.html">CalculatedSalaryFoundationTrackerOverride</a> csfOvrdRow = csfOvrd.next();
<a class="jxr_linenumber" name="2489" href="#2489">2489</a>             csfOverrideKeys.add(buildCSFKey(csfOvrdRow));
<a class="jxr_linenumber" name="2490" href="#2490">2490</a>             CSFOverrideDeletesRead = CSFOverrideDeletesRead + ((csfOvrdRow.getCsfDeleteCode().equals(BCConstants.ACTIVE_CSF_DELETE_CODE)? 0 : 1));
<a class="jxr_linenumber" name="2491" href="#2491">2491</a>         }
<a class="jxr_linenumber" name="2492" href="#2492">2492</a>     }
<a class="jxr_linenumber" name="2493" href="#2493">2493</a> 
<a class="jxr_linenumber" name="2494" href="#2494">2494</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> setUpCurrentPBGLKeys(Integer BaseYear) {
<a class="jxr_linenumber" name="2495" href="#2495">2495</a>         <em class="jxr_comment">// this will actually set up two maps. </em>
<a class="jxr_linenumber" name="2496" href="#2496">2496</a>         <em class="jxr_comment">// both will be used in the same routine to build the PBGL for BCSF.  </em>
<a class="jxr_linenumber" name="2497" href="#2497">2497</a>         <em class="jxr_comment">// keys not in the base budget (someone is being paid from an account, but no one has yet bothered to move base budget funding into the account to cover the expense).</em>
<a class="jxr_linenumber" name="2498" href="#2498">2498</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="2499" href="#2499">2499</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="2500" href="#2500">2500</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, RequestYear);
<a class="jxr_linenumber" name="2501" href="#2501">2501</a>         criteriaID.addIn(KFSPropertyConstants.FINANCIAL_OBJECT_CODE, <strong class="jxr_keyword">this</strong>.findPositionRequiredObjectCodes(BaseYear));
<a class="jxr_linenumber" name="2502" href="#2502">2502</a>         currentPBGLKeys = <strong class="jxr_keyword">new</strong> HashSet&lt;String&gt;(hashObjectSize(PendingBudgetConstructionGeneralLedger.<strong class="jxr_keyword">class</strong>, criteriaID));
<a class="jxr_linenumber" name="2503" href="#2503">2503</a>         <em class="jxr_comment">// now do the same for the detailed position object code--&gt; object type map (object codes that are allowed to fund individual HR positions)</em>
<a class="jxr_linenumber" name="2504" href="#2504">2504</a>         detailedPositionObjectTypes = <strong class="jxr_keyword">new</strong> HashMap&lt;String, String&gt;(hashObjectSize(ObjectCode.<strong class="jxr_keyword">class</strong>, criteriaID));
<a class="jxr_linenumber" name="2505" href="#2505">2505</a>         <em class="jxr_comment">// the PBGL has already been built.</em>
<a class="jxr_linenumber" name="2506" href="#2506">2506</a>         <em class="jxr_comment">// we will get business objects so we can use an overloaded method that will be easy to change in order to extract the key.</em>
<a class="jxr_linenumber" name="2507" href="#2507">2507</a>         <em class="jxr_comment">// the objects are of no further use, and will disappear when we clear the cache</em>
<a class="jxr_linenumber" name="2508" href="#2508">2508</a>         <strong class="jxr_keyword">int</strong> counter = 0;
<a class="jxr_linenumber" name="2509" href="#2509">2509</a>         QueryByCriteria pbGLQuery = <strong class="jxr_keyword">new</strong> QueryByCriteria(PendingBudgetConstructionGeneralLedger.<strong class="jxr_keyword">class</strong>, criteriaID);
<a class="jxr_linenumber" name="2510" href="#2510">2510</a>         Iterator pbGLObjects = getPersistenceBrokerTemplate().getIteratorByQuery(pbGLQuery);
<a class="jxr_linenumber" name="2511" href="#2511">2511</a>         <strong class="jxr_keyword">while</strong> (pbGLObjects.hasNext()) {
<a class="jxr_linenumber" name="2512" href="#2512">2512</a>             <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/PendingBudgetConstructionGeneralLedger.html">PendingBudgetConstructionGeneralLedger</a> pbGLRow = (PendingBudgetConstructionGeneralLedger) pbGLObjects.next();
<a class="jxr_linenumber" name="2513" href="#2513">2513</a>             String testKey = <strong class="jxr_keyword">this</strong>.buildPBGLKey(pbGLRow);
<a class="jxr_linenumber" name="2514" href="#2514">2514</a>             currentPBGLKeys.add(testKey);
<a class="jxr_linenumber" name="2515" href="#2515">2515</a>             counter = counter + 1;
<a class="jxr_linenumber" name="2516" href="#2516">2516</a>         }
<a class="jxr_linenumber" name="2517" href="#2517">2517</a>         CSFCurrentGLRows = <strong class="jxr_keyword">new</strong> Integer(counter);
<a class="jxr_linenumber" name="2518" href="#2518">2518</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="2519" href="#2519">2519</a>         <em class="jxr_comment">// now we have to set up the query to read the object types</em>
<a class="jxr_linenumber" name="2520" href="#2520">2520</a>         String[] objectTypeSelectList = { KFSPropertyConstants.CHART_OF_ACCOUNTS_CODE, KFSPropertyConstants.FINANCIAL_OBJECT_CODE, KFSPropertyConstants.FINANCIAL_OBJECT_TYPE_CODE };
<a class="jxr_linenumber" name="2521" href="#2521">2521</a>         ReportQueryByCriteria queryID = <strong class="jxr_keyword">new</strong> ReportQueryByCriteria(ObjectCode.<strong class="jxr_keyword">class</strong>, objectTypeSelectList, criteriaID);
<a class="jxr_linenumber" name="2522" href="#2522">2522</a>         Iterator objectTypeRowReturned = getPersistenceBrokerTemplate().getReportQueryIteratorByQuery(queryID);
<a class="jxr_linenumber" name="2523" href="#2523">2523</a>         <strong class="jxr_keyword">while</strong> (objectTypeRowReturned.hasNext()) {
<a class="jxr_linenumber" name="2524" href="#2524">2524</a>             Object[] objectRow = (Object[]) objectTypeRowReturned.next();
<a class="jxr_linenumber" name="2525" href="#2525">2525</a>             String keyString = ((String) objectRow[0]) + ((String) objectRow[1]);
<a class="jxr_linenumber" name="2526" href="#2526">2526</a>             String valueString = (String) objectRow[2];
<a class="jxr_linenumber" name="2527" href="#2527">2527</a>             detailedPositionObjectTypes.put(keyString, valueString);
<a class="jxr_linenumber" name="2528" href="#2528">2528</a>         }
<a class="jxr_linenumber" name="2529" href="#2529">2529</a>     }
<a class="jxr_linenumber" name="2530" href="#2530">2530</a> 
<a class="jxr_linenumber" name="2531" href="#2531">2531</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> setUpKeysNeedingRounding(Integer BaseYear) {
<a class="jxr_linenumber" name="2532" href="#2532">2532</a>         Integer emplidCSFOvrdCount = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="2533" href="#2533">2533</a>         Integer emplidCSFCount = <strong class="jxr_keyword">new</strong> Integer(0);
<a class="jxr_linenumber" name="2534" href="#2534">2534</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="2535" href="#2535">2535</a>         criteriaID.addEqualTo(KFSPropertyConstants.CSF_DELETE_CODE, BCConstants.ACTIVE_CSF_DELETE_CODE);
<a class="jxr_linenumber" name="2536" href="#2536">2536</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear);
<a class="jxr_linenumber" name="2537" href="#2537">2537</a>         criteriaID.addEqualTo(KFSPropertyConstants.ACTIVE, <strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="2538" href="#2538">2538</a>         Criteria criteriaIDCSF = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="2539" href="#2539">2539</a>         criteriaIDCSF.addEqualTo(KFSPropertyConstants.CSF_DELETE_CODE, BCConstants.ACTIVE_CSF_DELETE_CODE);
<a class="jxr_linenumber" name="2540" href="#2540">2540</a>         criteriaIDCSF.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, BaseYear);
<a class="jxr_linenumber" name="2541" href="#2541">2541</a>         keysNeedingRounding = <strong class="jxr_keyword">new</strong> HashMap&lt;String, roundMechanism&gt;(hashObjectSize(CalculatedSalaryFoundationTrackerOverride.<strong class="jxr_keyword">class</strong>, criteriaID, KFSPropertyConstants.EMPLID) + hashObjectSize(CalculatedSalaryFoundationTracker.<strong class="jxr_keyword">class</strong>, criteriaIDCSF, KFSPropertyConstants.EMPLID));
<a class="jxr_linenumber" name="2542" href="#2542">2542</a>         <em class="jxr_comment">//     now fill the hashmap: there will be one rounding bucket for each EMPLID</em>
<a class="jxr_linenumber" name="2543" href="#2543">2543</a>         String[] columnList = { KFSPropertyConstants.EMPLID };
<a class="jxr_linenumber" name="2544" href="#2544">2544</a>         <em class="jxr_comment">//     first use CSF Override</em>
<a class="jxr_linenumber" name="2545" href="#2545">2545</a>         ReportQueryByCriteria queryID = <strong class="jxr_keyword">new</strong> ReportQueryByCriteria(CalculatedSalaryFoundationTrackerOverride.<strong class="jxr_keyword">class</strong>, columnList, criteriaID, <strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="2546" href="#2546">2546</a>         Iterator emplidOvrd = getPersistenceBrokerTemplate().getReportQueryIteratorByQuery(queryID);
<a class="jxr_linenumber" name="2547" href="#2547">2547</a>         <strong class="jxr_keyword">while</strong> (emplidOvrd.hasNext()) {
<a class="jxr_linenumber" name="2548" href="#2548">2548</a>             String newKey = (String) ((Object[]) emplidOvrd.next())[0];
<a class="jxr_linenumber" name="2549" href="#2549">2549</a>             keysNeedingRounding.put(newKey, <strong class="jxr_keyword">new</strong> <a href="../../../../../../../../org/kuali/kfs/module/bc/batch/dataaccess/impl/GenesisDaoOjb.html">roundMechanism</a>());
<a class="jxr_linenumber" name="2550" href="#2550">2550</a>         }
<a class="jxr_linenumber" name="2551" href="#2551">2551</a>         LOG.info(String.format(<span class="jxr_string">"\nEMPLID's from CSF override: %d"</span>, keysNeedingRounding.size()));
<a class="jxr_linenumber" name="2552" href="#2552">2552</a>         <em class="jxr_comment">//     now add the EMPLID's from CSF itself (the criterion differs because of the active code on CSF override--CSF override *must* precede CSF here)</em>
<a class="jxr_linenumber" name="2553" href="#2553">2553</a>         queryID = <strong class="jxr_keyword">new</strong> ReportQueryByCriteria(CalculatedSalaryFoundationTracker.<strong class="jxr_keyword">class</strong>, columnList, criteriaIDCSF, <strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="2554" href="#2554">2554</a>         Iterator emplidIter = getPersistenceBrokerTemplate().getReportQueryIteratorByQuery(queryID);
<a class="jxr_linenumber" name="2555" href="#2555">2555</a>         <strong class="jxr_keyword">while</strong> (emplidIter.hasNext()) {
<a class="jxr_linenumber" name="2556" href="#2556">2556</a>             String newKey = (String) ((Object[]) emplidIter.next())[0];
<a class="jxr_linenumber" name="2557" href="#2557">2557</a>             <em class="jxr_comment">// insert what is not already there from CSF override</em>
<a class="jxr_linenumber" name="2558" href="#2558">2558</a>             <strong class="jxr_keyword">if</strong> (!keysNeedingRounding.containsKey(newKey)) {
<a class="jxr_linenumber" name="2559" href="#2559">2559</a>                 keysNeedingRounding.put(newKey, <strong class="jxr_keyword">new</strong> <a href="../../../../../../../../org/kuali/kfs/module/bc/batch/dataaccess/impl/GenesisDaoOjb.html">roundMechanism</a>());
<a class="jxr_linenumber" name="2560" href="#2560">2560</a>             }
<a class="jxr_linenumber" name="2561" href="#2561">2561</a>         }
<a class="jxr_linenumber" name="2562" href="#2562">2562</a>         LOG.info(String.format(<span class="jxr_string">"\nEMPLID total for BCSF: %d"</span>, keysNeedingRounding.size()));
<a class="jxr_linenumber" name="2563" href="#2563">2563</a>     }
<a class="jxr_linenumber" name="2564" href="#2564">2564</a> 
<a class="jxr_linenumber" name="2565" href="#2565">2565</a>     <em class="jxr_comment">// read the position table so we can attach normal work months to new bcaf rows</em>
<a class="jxr_linenumber" name="2566" href="#2566">2566</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> setUpPositionNormalWorkMonths(Integer BaseYear) {
<a class="jxr_linenumber" name="2567" href="#2567">2567</a>         Integer RequestYear = BaseYear + 1;
<a class="jxr_linenumber" name="2568" href="#2568">2568</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="2569" href="#2569">2569</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, RequestYear);
<a class="jxr_linenumber" name="2570" href="#2570">2570</a>         positionNormalWorkMonths = <strong class="jxr_keyword">new</strong> HashMap&lt;String, Integer&gt;(hashObjectSize(BudgetConstructionPosition.<strong class="jxr_keyword">class</strong>, criteriaID));
<a class="jxr_linenumber" name="2571" href="#2571">2571</a>         String[] fieldList = { KFSPropertyConstants.POSITION_NUMBER, KFSPropertyConstants.IU_NORMAL_WORK_MONTHS };
<a class="jxr_linenumber" name="2572" href="#2572">2572</a>         ReportQueryByCriteria queryID = <strong class="jxr_keyword">new</strong> ReportQueryByCriteria(BudgetConstructionPosition.<strong class="jxr_keyword">class</strong>, fieldList, criteriaID);
<a class="jxr_linenumber" name="2573" href="#2573">2573</a>         Iterator positionRows = getPersistenceBrokerTemplate().getReportQueryIteratorByQuery(queryID);
<a class="jxr_linenumber" name="2574" href="#2574">2574</a>         <strong class="jxr_keyword">while</strong> (positionRows.hasNext()) {
<a class="jxr_linenumber" name="2575" href="#2575">2575</a>             <em class="jxr_comment">// apparently, numbers come back from report queries in DB-specific ways.  use Number to be safe (as OJB itself does) since the results do not go through the business object</em>
<a class="jxr_linenumber" name="2576" href="#2576">2576</a>             Object[] positionRow = (Object[]) positionRows.next();
<a class="jxr_linenumber" name="2577" href="#2577">2577</a>             positionNormalWorkMonths.put((String) positionRow[0], (Integer) ((Number) positionRow[1]).intValue());
<a class="jxr_linenumber" name="2578" href="#2578">2578</a>         }
<a class="jxr_linenumber" name="2579" href="#2579">2579</a>     }
<a class="jxr_linenumber" name="2580" href="#2580">2580</a> 
<a class="jxr_linenumber" name="2581" href="#2581">2581</a>     <em class="jxr_comment">//     these are the four values used to decide whether the current appointment funding row, missing from BCSF, has been entered by a user or is due to a CSF row that has since gone away</em>
<a class="jxr_linenumber" name="2582" href="#2582">2582</a>     String notOnLeave = <strong class="jxr_keyword">new</strong> String(BCConstants.AppointmentFundingDurationCodes.NONE.durationCode);
<a class="jxr_linenumber" name="2583" href="#2583">2583</a>     KualiInteger rqstAmount = <strong class="jxr_keyword">new</strong> KualiInteger(0);
<a class="jxr_linenumber" name="2584" href="#2584">2584</a>     BigDecimal pctTime = <strong class="jxr_keyword">new</strong> BigDecimal(0);
<a class="jxr_linenumber" name="2585" href="#2585">2585</a>     BigDecimal FTE = <strong class="jxr_keyword">new</strong> BigDecimal(0);
<a class="jxr_linenumber" name="2586" href="#2586">2586</a> 
<a class="jxr_linenumber" name="2587" href="#2587">2587</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> untouchedAppointmentFunding(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/PendingBudgetConstructionAppointmentFunding.html">PendingBudgetConstructionAppointmentFunding</a> bcaf) {
<a class="jxr_linenumber" name="2588" href="#2588">2588</a>         <em class="jxr_comment">//     this checks to see whether the missing row could have come in from CSF earlier, but the CSF row which created it is not inactive.  </em>
<a class="jxr_linenumber" name="2589" href="#2589">2589</a>         <em class="jxr_comment">//     if they it not come in from CSF, then it follows that someone entered it and we should not touch it.  </em>
<a class="jxr_linenumber" name="2590" href="#2590">2590</a>         CSFBCAFRowsMissing = CSFBCAFRowsMissing + 1;
<a class="jxr_linenumber" name="2591" href="#2591">2591</a>         <strong class="jxr_keyword">if</strong> ((bcaf.getAppointmentRequestedAmount().compareTo(rqstAmount) != 0) || (bcaf.getAppointmentFundingDurationCode().compareTo(notOnLeave) != 0) || (bcaf.isAppointmentFundingDeleteIndicator())) {
<a class="jxr_linenumber" name="2592" href="#2592">2592</a>             <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="2593" href="#2593">2593</a>         }
<a class="jxr_linenumber" name="2594" href="#2594">2594</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="2595" href="#2595">2595</a>         <em class="jxr_comment">//     this should happen so rarely that we trade time for space, and do</em>
<a class="jxr_linenumber" name="2596" href="#2596">2596</a>         <em class="jxr_comment">//     an individual OBJ SQL call to see whether the missing row did in fact </em>
<a class="jxr_linenumber" name="2597" href="#2597">2597</a>         <em class="jxr_comment">//     come in from CSF.  anecdotal evidence indicates there are about 25 or so</em>
<a class="jxr_linenumber" name="2598" href="#2598">2598</a>         <em class="jxr_comment">//     a day.  if this gets to be a major run-time problem, the fix would be to </em>
<a class="jxr_linenumber" name="2599" href="#2599">2599</a>         <em class="jxr_comment">//     create another hashMap&lt;String,BigDecimal[]), where the key would be </em>
<a class="jxr_linenumber" name="2600" href="#2600">2600</a>         <em class="jxr_comment">//     the accounting key, position, and EMPLID (and if the line were vacant, </em>
<a class="jxr_linenumber" name="2601" href="#2601">2601</a>         <em class="jxr_comment">//     another key differing only by the replacement of EMPLID by the VACANT_EMPLID</em>
<a class="jxr_linenumber" name="2602" href="#2602">2602</a>         <em class="jxr_comment">//     value). The BigDecimal[] would be csfTimePercent and </em>
<a class="jxr_linenumber" name="2603" href="#2603">2603</a>         <em class="jxr_comment">//     csfFullTimeEmploymentQuantity.</em>
<a class="jxr_linenumber" name="2604" href="#2604">2604</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="2605" href="#2605">2605</a>         Criteria criteriaID = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="2606" href="#2606">2606</a>         criteriaID.addEqualTo(KFSPropertyConstants.UNIVERSITY_FISCAL_YEAR, bcaf.getUniversityFiscalYear() - 1);
<a class="jxr_linenumber" name="2607" href="#2607">2607</a>         criteriaID.addEqualTo(KFSPropertyConstants.CHART_OF_ACCOUNTS_CODE, bcaf.getChartOfAccountsCode());
<a class="jxr_linenumber" name="2608" href="#2608">2608</a>         criteriaID.addEqualTo(KFSPropertyConstants.ACCOUNT_NUMBER, bcaf.getAccountNumber());
<a class="jxr_linenumber" name="2609" href="#2609">2609</a>         criteriaID.addEqualTo(KFSPropertyConstants.SUB_ACCOUNT_NUMBER, bcaf.getSubAccountNumber());
<a class="jxr_linenumber" name="2610" href="#2610">2610</a>         criteriaID.addEqualTo(KFSPropertyConstants.FINANCIAL_OBJECT_CODE, bcaf.getFinancialObjectCode());
<a class="jxr_linenumber" name="2611" href="#2611">2611</a>         criteriaID.addEqualTo(KFSPropertyConstants.FINANCIAL_SUB_OBJECT_CODE, bcaf.getFinancialSubObjectCode());
<a class="jxr_linenumber" name="2612" href="#2612">2612</a>         criteriaID.addEqualTo(KFSPropertyConstants.POSITION_NUMBER, bcaf.getPositionNumber());
<a class="jxr_linenumber" name="2613" href="#2613">2613</a>         <em class="jxr_comment">// if the budget construction appointment funding (BCAF) row has a vacant ID, we look for vacant flags in CSF.</em>
<a class="jxr_linenumber" name="2614" href="#2614">2614</a>         <strong class="jxr_keyword">if</strong> (bcaf.getEmplid().equals(BCConstants.VACANT_EMPLID))
<a class="jxr_linenumber" name="2615" href="#2615">2615</a>         {
<a class="jxr_linenumber" name="2616" href="#2616">2616</a>             <em class="jxr_comment">// the EMPLID in CSF will not match with BCAF: we want to see if a row matching on the other criteria is vacant</em>
<a class="jxr_linenumber" name="2617" href="#2617">2617</a>             <em class="jxr_comment">//     funding status is "vacant" or "unfunded"</em>
<a class="jxr_linenumber" name="2618" href="#2618">2618</a>             Criteria flagCriteria = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="2619" href="#2619">2619</a>             flagCriteria.addEqualTo(KFSPropertyConstants.CSF_FUNDING_STATUS_CODE, BCConstants.csfFundingStatusFlag.VACANT.getFlagValue());
<a class="jxr_linenumber" name="2620" href="#2620">2620</a>             Criteria vacantCriteria = <strong class="jxr_keyword">new</strong> Criteria();
<a class="jxr_linenumber" name="2621" href="#2621">2621</a>             vacantCriteria.addEqualTo(KFSPropertyConstants.CSF_FUNDING_STATUS_CODE, BCConstants.csfFundingStatusFlag.UNFUNDED.getFlagValue());
<a class="jxr_linenumber" name="2622" href="#2622">2622</a>             flagCriteria.addOrCriteria(vacantCriteria);
<a class="jxr_linenumber" name="2623" href="#2623">2623</a>             criteriaID.addAndCriteria(flagCriteria);
<a class="jxr_linenumber" name="2624" href="#2624">2624</a>         }
<a class="jxr_linenumber" name="2625" href="#2625">2625</a>         <strong class="jxr_keyword">else</strong>
<a class="jxr_linenumber" name="2626" href="#2626">2626</a>         {
<a class="jxr_linenumber" name="2627" href="#2627">2627</a>             <em class="jxr_comment">// since the BCAF row is not vacant, we require that it match CSF on EMPLID</em>
<a class="jxr_linenumber" name="2628" href="#2628">2628</a>             criteriaID.addEqualTo(KFSPropertyConstants.EMPLID, bcaf.getEmplid());
<a class="jxr_linenumber" name="2629" href="#2629">2629</a>         }
<a class="jxr_linenumber" name="2630" href="#2630">2630</a>         <em class="jxr_comment">// we are going to compare two numbers (an FTE and a Percent Time), which both originated from CSF.  We have to go through the Kuali filters to make sure the values are strictly comparable.  We can't do a report query.</em>
<a class="jxr_linenumber" name="2631" href="#2631">2631</a>         QueryByCriteria queryID = <strong class="jxr_keyword">new</strong> QueryByCriteria(CalculatedSalaryFoundationTracker.<strong class="jxr_keyword">class</strong>, criteriaID);
<a class="jxr_linenumber" name="2632" href="#2632">2632</a>         Iterator&lt;CalculatedSalaryFoundationTracker&gt; resultSet = getPersistenceBrokerTemplate().getIteratorByQuery(queryID);        
<a class="jxr_linenumber" name="2633" href="#2633">2633</a>         <strong class="jxr_keyword">if</strong> (!resultSet.hasNext()) {
<a class="jxr_linenumber" name="2634" href="#2634">2634</a>             <em class="jxr_comment">// the line did not come from CSF, so it must have been added by a user. </em>
<a class="jxr_linenumber" name="2635" href="#2635">2635</a>             <em class="jxr_comment">// therefore, we should *not* mark it deleted  </em>
<a class="jxr_linenumber" name="2636" href="#2636">2636</a>             <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="2637" href="#2637">2637</a>         }
<a class="jxr_linenumber" name="2638" href="#2638">2638</a>         <em class="jxr_comment">// we have to check whether the CFTE and the percent time are the same. </em>
<a class="jxr_linenumber" name="2639" href="#2639">2639</a>         <em class="jxr_comment">// rounding is required because these can be stored as large numbers in the DB.</em>
<a class="jxr_linenumber" name="2640" href="#2640">2640</a>         <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/CalculatedSalaryFoundationTracker.html">CalculatedSalaryFoundationTracker</a> resultCSF = resultSet.next();
<a class="jxr_linenumber" name="2641" href="#2641">2641</a>         <strong class="jxr_keyword">if</strong> (untouchedFTEPercentTimeCheck(bcaf, resultCSF))
<a class="jxr_linenumber" name="2642" href="#2642">2642</a>         {
<a class="jxr_linenumber" name="2643" href="#2643">2643</a>           <em class="jxr_comment">//     we need to mark this bcaf line deleted</em>
<a class="jxr_linenumber" name="2644" href="#2644">2644</a>           bcaf.setAppointmentRequestedFteQuantity(FTE);
<a class="jxr_linenumber" name="2645" href="#2645">2645</a>           bcaf.setAppointmentRequestedTimePercent(pctTime);
<a class="jxr_linenumber" name="2646" href="#2646">2646</a>           bcaf.setAppointmentFundingDeleteIndicator(<strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="2647" href="#2647">2647</a>           getPersistenceBrokerTemplate().store(bcaf);
<a class="jxr_linenumber" name="2648" href="#2648">2648</a>           CSFBCAFRowsMarkedDeleted = CSFBCAFRowsMarkedDeleted + 1;
<a class="jxr_linenumber" name="2649" href="#2649">2649</a>         }
<a class="jxr_linenumber" name="2650" href="#2650">2650</a>         <em class="jxr_comment">// we also need to exhaust the iterator, so OJB will close the cursor (Oracle)</em>
<a class="jxr_linenumber" name="2651" href="#2651">2651</a>         TransactionalServiceUtils.exhaustIterator(resultSet);
<a class="jxr_linenumber" name="2652" href="#2652">2652</a>     }
<a class="jxr_linenumber" name="2653" href="#2653">2653</a>     
<a class="jxr_linenumber" name="2654" href="#2654">2654</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> MathContext compareContext = <strong class="jxr_keyword">new</strong> MathContext(2,RoundingMode.HALF_UP);
<a class="jxr_linenumber" name="2655" href="#2655">2655</a> 
<a class="jxr_linenumber" name="2656" href="#2656">2656</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">boolean</strong> untouchedFTEPercentTimeCheck(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/PendingBudgetConstructionAppointmentFunding.html">PendingBudgetConstructionAppointmentFunding</a> bcaf, <a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/CalculatedSalaryFoundationTracker.html">CalculatedSalaryFoundationTracker</a> resultCSF)
<a class="jxr_linenumber" name="2657" href="#2657">2657</a>     {
<a class="jxr_linenumber" name="2658" href="#2658">2658</a>         <em class="jxr_comment">// we need to check whether the current appointment funding row not in BCSF should be marked deleted.</em>
<a class="jxr_linenumber" name="2659" href="#2659">2659</a>         <em class="jxr_comment">// it should be if it has not been "touched" by a user.  </em>
<a class="jxr_linenumber" name="2660" href="#2660">2660</a>         <em class="jxr_comment">// the criteria for "not touched by a user" are (a) it got into appointment funding via CSF, so it matched with a CSF row, (b) the request amount is 0, and (c) the request FTE and percent time match those of the CSF row.</em>
<a class="jxr_linenumber" name="2661" href="#2661">2661</a>         <em class="jxr_comment">// (b) was checked earlier, since it can be checked without a CSF look-up and if the amount is not 0 we can avoid an expensive DB call.</em>
<a class="jxr_linenumber" name="2662" href="#2662">2662</a>         <em class="jxr_comment">// (a) is a given, because the resultCSF comes from the matching CSF row.  So, all that is left is (c).  we do this in a separate method because it is convoluted and doing so isolates the code.</em>
<a class="jxr_linenumber" name="2663" href="#2663">2663</a>         <em class="jxr_comment">// (c) must be done with rounded values, to avoid letting differences in high-order decimal places in DB storage make equivalent values technically unequal. </em>
<a class="jxr_linenumber" name="2664" href="#2664">2664</a>         <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="2665" href="#2665">2665</a>         <em class="jxr_comment">// we are making the assumption here, based on the business object, that these values are BigDecimal</em>
<a class="jxr_linenumber" name="2666" href="#2666">2666</a>         <em class="jxr_comment">// for BigDecimal, compareTo ignores the scale if it differs between the two comparands and only looks at the values (2 = 2.00), while equals will return false for the same value but different scales</em>
<a class="jxr_linenumber" name="2667" href="#2667">2667</a>         BigDecimal CSFFTE  = resultCSF.getCsfFullTimeEmploymentQuantity().round(compareContext);
<a class="jxr_linenumber" name="2668" href="#2668">2668</a>         BigDecimal BCAFFTE = bcaf.getAppointmentRequestedFteQuantity().round(compareContext);
<a class="jxr_linenumber" name="2669" href="#2669">2669</a>         <strong class="jxr_keyword">boolean</strong> FTEOK = (CSFFTE.compareTo(BCAFFTE) == 0);
<a class="jxr_linenumber" name="2670" href="#2670">2670</a>         BigDecimal CSFPctTime  = resultCSF.getCsfTimePercent().round(compareContext);
<a class="jxr_linenumber" name="2671" href="#2671">2671</a>         BigDecimal BCAFPctTime = bcaf.getAppointmentRequestedTimePercent().round(compareContext);
<a class="jxr_linenumber" name="2672" href="#2672">2672</a>         <strong class="jxr_keyword">boolean</strong> PctTimeOK = (CSFPctTime.compareTo(BCAFPctTime) == 0);
<a class="jxr_linenumber" name="2673" href="#2673">2673</a>         String bcafPosition = bcaf.getPositionNumber();
<a class="jxr_linenumber" name="2674" href="#2674">2674</a>         <strong class="jxr_keyword">return</strong> (FTEOK &amp;&amp; PctTimeOK);
<a class="jxr_linenumber" name="2675" href="#2675">2675</a>     }
<a class="jxr_linenumber" name="2676" href="#2676">2676</a> 
<a class="jxr_linenumber" name="2677" href="#2677">2677</a>     <em class="jxr_comment">//     this is an inner class which will store the data we need to perform the rounding, and supply the methods as well    </em>
<a class="jxr_linenumber" name="2678" href="#2678">2678</a>     KualiDecimal shavePennies = <strong class="jxr_keyword">new</strong> KualiDecimal(100);
<a class="jxr_linenumber" name="2679" href="#2679">2679</a> 
<a class="jxr_linenumber" name="2680" href="#2680">2680</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">class</strong> <a href="../../../../../../../../org/kuali/kfs/module/bc/batch/dataaccess/impl/GenesisDaoOjb.html">roundMechanism</a> {
<a class="jxr_linenumber" name="2681" href="#2681">2681</a>         <em class="jxr_comment">//     the idea here is that people split over many lines could lose or gain several dollars if we rounded each salary line individually.  so, we do the following.</em>
<a class="jxr_linenumber" name="2682" href="#2682">2682</a>         <em class="jxr_comment">//     (1) assume that all the amounts are positive</em>
<a class="jxr_linenumber" name="2683" href="#2683">2683</a>         <em class="jxr_comment">//     (2) truncate the actual amount to the next lowest integer (round floor)</em>
<a class="jxr_linenumber" name="2684" href="#2684">2684</a>         <em class="jxr_comment">//     (3) accumulate the difference in a running total to two decimal places</em>
<a class="jxr_linenumber" name="2685" href="#2685">2685</a>         <em class="jxr_comment">//     (4) when all the lines for a person have been encountered, we round the</em>
<a class="jxr_linenumber" name="2686" href="#2686">2686</a>         <em class="jxr_comment">//         difference to the next whole integer.</em>
<a class="jxr_linenumber" name="2687" href="#2687">2687</a>         <em class="jxr_comment">//     (5) add the difference in dollar increments to each of the lines until the</em>
<a class="jxr_linenumber" name="2688" href="#2688">2688</a>         <em class="jxr_comment">//         difference amount is exhausted  </em>
<a class="jxr_linenumber" name="2689" href="#2689">2689</a>         <em class="jxr_comment">//     In other words, we only use "bankers rounding" at the end.  We truncate by converting to an int, which calls BigDecimal.intvalue.        </em>
<a class="jxr_linenumber" name="2690" href="#2690">2690</a>         <strong class="jxr_keyword">private</strong> KualiDecimal diffAmount = <strong class="jxr_keyword">new</strong> KualiDecimal(0);
<a class="jxr_linenumber" name="2691" href="#2691">2691</a>         <strong class="jxr_keyword">private</strong> ArrayList&lt;BudgetConstructionCalculatedSalaryFoundationTracker&gt; candidateBCSFRows = <strong class="jxr_keyword">new</strong> ArrayList&lt;BudgetConstructionCalculatedSalaryFoundationTracker&gt;(10);
<a class="jxr_linenumber" name="2692" href="#2692">2692</a> 
<a class="jxr_linenumber" name="2693" href="#2693">2693</a>         <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> addNewBCSF(<a href="../../../../../../../../org/kuali/kfs/module/bc/businessobject/BudgetConstructionCalculatedSalaryFoundationTracker.html">BudgetConstructionCalculatedSalaryFoundationTracker</a> bCSF, KualiDecimal amountFromCSFToSet) {
<a class="jxr_linenumber" name="2694" href="#2694">2694</a>             <em class="jxr_comment">// lop off the pennies--go down to the nearest whole dollar </em>
<a class="jxr_linenumber" name="2695" href="#2695">2695</a>             KualiInteger wholeDollarsCSFAmount = <strong class="jxr_keyword">new</strong> KualiInteger(amountFromCSFToSet, RoundingMode.FLOOR);
<a class="jxr_linenumber" name="2696" href="#2696">2696</a>             <em class="jxr_comment">// store the whole dollar amount in the budget construction CSF object</em>
<a class="jxr_linenumber" name="2697" href="#2697">2697</a>             bCSF.setCsfAmount(wholeDollarsCSFAmount);
<a class="jxr_linenumber" name="2698" href="#2698">2698</a>             <em class="jxr_comment">// find the pennies that were shaved off</em>
<a class="jxr_linenumber" name="2699" href="#2699">2699</a>             KualiDecimal penniesFromCSFAmount = amountFromCSFToSet;
<a class="jxr_linenumber" name="2700" href="#2700">2700</a>             <em class="jxr_comment">// BigDecimal values are immutable.  So, we have to reset the pointer  after the subtract</em>
<a class="jxr_linenumber" name="2701" href="#2701">2701</a>             penniesFromCSFAmount = penniesFromCSFAmount.subtract(wholeDollarsCSFAmount.kualiDecimalValue());
<a class="jxr_linenumber" name="2702" href="#2702">2702</a>             <em class="jxr_comment">//  just round negative amounts and return.</em>
<a class="jxr_linenumber" name="2703" href="#2703">2703</a>             <em class="jxr_comment">//  this is only a safety measure.  negative salaries are illegal in budget construction. </em>
<a class="jxr_linenumber" name="2704" href="#2704">2704</a>             <strong class="jxr_keyword">if</strong> (wholeDollarsCSFAmount.isNegative()) {
<a class="jxr_linenumber" name="2705" href="#2705">2705</a>                 <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="2706" href="#2706">2706</a>             }
<a class="jxr_linenumber" name="2707" href="#2707">2707</a>             <em class="jxr_comment">// save the difference. (KualiDecimal values are immutable, so we need to redirect the diffAmount pointer to a new one.)</em>
<a class="jxr_linenumber" name="2708" href="#2708">2708</a>             diffAmount = diffAmount.add(penniesFromCSFAmount);
<a class="jxr_linenumber" name="2709" href="#2709">2709</a>             <em class="jxr_comment">// store the budget construction CSF row with the truncated amount for possible adjustment later</em>
<a class="jxr_linenumber" name="2710" href="#2710">2710</a>             candidateBCSFRows.add(bCSF);
<a class="jxr_linenumber" name="2711" href="#2711">2711</a>         }
<a class="jxr_linenumber" name="2712" href="#2712">2712</a> 
<a class="jxr_linenumber" name="2713" href="#2713">2713</a>         <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> fixRoundErrors() {
<a class="jxr_linenumber" name="2714" href="#2714">2714</a>             <em class="jxr_comment">// this routine adjusts the BCSF values so that the total for each EMPLID round to the nearest whole dollar amount</em>
<a class="jxr_linenumber" name="2715" href="#2715">2715</a>             <strong class="jxr_keyword">if</strong> (!diffAmount.isGreaterThan(KualiDecimal.ZERO)) {
<a class="jxr_linenumber" name="2716" href="#2716">2716</a>                 <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="2717" href="#2717">2717</a>             }
<a class="jxr_linenumber" name="2718" href="#2718">2718</a>             KualiDecimal adjustAmount = <strong class="jxr_keyword">new</strong> KualiDecimal(1);
<a class="jxr_linenumber" name="2719" href="#2719">2719</a>             <em class="jxr_comment">// no rounding is necessary if the difference is less than a half a buck. </em>
<a class="jxr_linenumber" name="2720" href="#2720">2720</a>             <em class="jxr_comment">// this will also prevent our accessing an empty array list. </em>
<a class="jxr_linenumber" name="2721" href="#2721">2721</a>             <em class="jxr_comment">// we should adjust things with only one row if the pennies were &gt;= .5, though. </em>
<a class="jxr_linenumber" name="2722" href="#2722">2722</a>             <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="2723" href="#2723">2723</a>             <em class="jxr_comment">// now we use "banker's rounding" on the adjustment amount</em>
<a class="jxr_linenumber" name="2724" href="#2724">2724</a>             <strong class="jxr_keyword">if</strong> (diffAmount.multiply(shavePennies).mod(shavePennies).isGreaterEqual(<strong class="jxr_keyword">new</strong> KualiDecimal(50))) {
<a class="jxr_linenumber" name="2725" href="#2725">2725</a>                 diffAmount = diffAmount.add(adjustAmount);
<a class="jxr_linenumber" name="2726" href="#2726">2726</a>             }
<a class="jxr_linenumber" name="2727" href="#2727">2727</a>             <strong class="jxr_keyword">if</strong> (diffAmount.isLessThan(adjustAmount)) {
<a class="jxr_linenumber" name="2728" href="#2728">2728</a>                 <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="2729" href="#2729">2729</a>             }
<a class="jxr_linenumber" name="2730" href="#2730">2730</a>             <strong class="jxr_keyword">for</strong> (BudgetConstructionCalculatedSalaryFoundationTracker rCSF : candidateBCSFRows) {
<a class="jxr_linenumber" name="2731" href="#2731">2731</a>                 KualiInteger fixBCSFAmount = rCSF.getCsfAmount();
<a class="jxr_linenumber" name="2732" href="#2732">2732</a>                 rCSF.setCsfAmount(fixBCSFAmount.add(<strong class="jxr_keyword">new</strong> KualiInteger(adjustAmount.intValue())));
<a class="jxr_linenumber" name="2733" href="#2733">2733</a>                 diffAmount = diffAmount.subtract(adjustAmount);
<a class="jxr_linenumber" name="2734" href="#2734">2734</a>                 <strong class="jxr_keyword">if</strong> (diffAmount.isLessThan(adjustAmount)) {
<a class="jxr_linenumber" name="2735" href="#2735">2735</a>                     <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="2736" href="#2736">2736</a>                 }
<a class="jxr_linenumber" name="2737" href="#2737">2737</a>             }
<a class="jxr_linenumber" name="2738" href="#2738">2738</a>         }
<a class="jxr_linenumber" name="2739" href="#2739">2739</a>     }
<a class="jxr_linenumber" name="2740" href="#2740">2740</a> 
<a class="jxr_linenumber" name="2741" href="#2741">2741</a>     <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="2742" href="#2742">2742</a>     <em class="jxr_comment">//  here are the routines Spring uses to "wire the beans"</em>
<a class="jxr_linenumber" name="2743" href="#2743">2743</a>     <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="2744" href="#2744">2744</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setDocumentService(DocumentService documentService) {
<a class="jxr_linenumber" name="2745" href="#2745">2745</a>         <strong class="jxr_keyword">this</strong>.documentService = documentService;
<a class="jxr_linenumber" name="2746" href="#2746">2746</a>     }
<a class="jxr_linenumber" name="2747" href="#2747">2747</a> 
<a class="jxr_linenumber" name="2748" href="#2748">2748</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setDateTimeService(DateTimeService dateTimeService) {
<a class="jxr_linenumber" name="2749" href="#2749">2749</a>         <strong class="jxr_keyword">this</strong>.dateTimeService = dateTimeService;
<a class="jxr_linenumber" name="2750" href="#2750">2750</a>     }
<a class="jxr_linenumber" name="2751" href="#2751">2751</a>     
<a class="jxr_linenumber" name="2752" href="#2752">2752</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setBudgetConstructionHumanResourcesPayrollInterfaceDao(<a href="../../../../../../../../org/kuali/kfs/module/bc/batch/dataaccess/BudgetConstructionHumanResourcesPayrollInterfaceDao.html">BudgetConstructionHumanResourcesPayrollInterfaceDao</a> budgetConstructionHumanResourcesPayrollInterfaceDao) {
<a class="jxr_linenumber" name="2753" href="#2753">2753</a>         <em class="jxr_comment">// at IU, some of the tables in Genesis take data from base tables (not budget tables) in the Human Resources/payroll system.</em>
<a class="jxr_linenumber" name="2754" href="#2754">2754</a>         <em class="jxr_comment">// (specifically, the months appointment in appointment funding is set from the position table, and some budget construction CSF tracker rows are set to vacant based on attributes of the appointment--the incumbent's position does not match the appointment's "grandfathered" attribute.)  </em>
<a class="jxr_linenumber" name="2755" href="#2755">2755</a>         <em class="jxr_comment">// these cases are particular to IU, so are not included in Kuali.  but, the idea that budget tables built with this Dao may need to interact with HR/payroll is accommodated with the injection of this service.</em>
<a class="jxr_linenumber" name="2756" href="#2756">2756</a>         <strong class="jxr_keyword">this</strong>.budgetConstructionHumanResourcesPayrollInterfaceDao = budgetConstructionHumanResourcesPayrollInterfaceDao;
<a class="jxr_linenumber" name="2757" href="#2757">2757</a>     }
<a class="jxr_linenumber" name="2758" href="#2758">2758</a> 
<a class="jxr_linenumber" name="2759" href="#2759">2759</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setWorkflowDocumentService(WorkflowDocumentService workflowDocumentService) {
<a class="jxr_linenumber" name="2760" href="#2760">2760</a>         <strong class="jxr_keyword">this</strong>.workflowDocumentService = workflowDocumentService;
<a class="jxr_linenumber" name="2761" href="#2761">2761</a>     }
<a class="jxr_linenumber" name="2762" href="#2762">2762</a> 
<a class="jxr_linenumber" name="2763" href="#2763">2763</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="2764" href="#2764">2764</a> <em class="jxr_javadoccomment">     * Sets the kualiModuleService attribute value.</em>
<a class="jxr_linenumber" name="2765" href="#2765">2765</a> <em class="jxr_javadoccomment">     * @param kualiModuleService The kualiModuleService to set.</em>
<a class="jxr_linenumber" name="2766" href="#2766">2766</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="2767" href="#2767">2767</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setKualiModuleService(KualiModuleService kualiModuleService) {
<a class="jxr_linenumber" name="2768" href="#2768">2768</a>         <strong class="jxr_keyword">this</strong>.kualiModuleService = kualiModuleService;
<a class="jxr_linenumber" name="2769" href="#2769">2769</a>     }
<a class="jxr_linenumber" name="2770" href="#2770">2770</a> 
<a class="jxr_linenumber" name="2771" href="#2771">2771</a> 
<a class="jxr_linenumber" name="2772" href="#2772">2772</a> }
</pre>
<hr/><div id="footer">This page was automatically generated by <a href="http://maven.apache.org/">Maven</a></div></body>
</html>

