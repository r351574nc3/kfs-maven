<HTML>
<BODY BGCOLOR="white">
<PRE>
<FONT color="green">001</FONT>    /*<a name="line.1"></a>
<FONT color="green">002</FONT>     * Copyright 2011 The Kuali Foundation.<a name="line.2"></a>
<FONT color="green">003</FONT>     * <a name="line.3"></a>
<FONT color="green">004</FONT>     * Licensed under the Educational Community License, Version 2.0 (the "License");<a name="line.4"></a>
<FONT color="green">005</FONT>     * you may not use this file except in compliance with the License.<a name="line.5"></a>
<FONT color="green">006</FONT>     * You may obtain a copy of the License at<a name="line.6"></a>
<FONT color="green">007</FONT>     * <a name="line.7"></a>
<FONT color="green">008</FONT>     * http://www.opensource.org/licenses/ecl2.php<a name="line.8"></a>
<FONT color="green">009</FONT>     * <a name="line.9"></a>
<FONT color="green">010</FONT>     * Unless required by applicable law or agreed to in writing, software<a name="line.10"></a>
<FONT color="green">011</FONT>     * distributed under the License is distributed on an "AS IS" BASIS,<a name="line.11"></a>
<FONT color="green">012</FONT>     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.<a name="line.12"></a>
<FONT color="green">013</FONT>     * See the License for the specific language governing permissions and<a name="line.13"></a>
<FONT color="green">014</FONT>     * limitations under the License.<a name="line.14"></a>
<FONT color="green">015</FONT>     */<a name="line.15"></a>
<FONT color="green">016</FONT>    package org.kuali.kfs.pdp.service.impl;<a name="line.16"></a>
<FONT color="green">017</FONT>    <a name="line.17"></a>
<FONT color="green">018</FONT>    import java.sql.Timestamp;<a name="line.18"></a>
<FONT color="green">019</FONT>    import java.util.ArrayList;<a name="line.19"></a>
<FONT color="green">020</FONT>    import java.util.Date;<a name="line.20"></a>
<FONT color="green">021</FONT>    import java.util.HashMap;<a name="line.21"></a>
<FONT color="green">022</FONT>    import java.util.Iterator;<a name="line.22"></a>
<FONT color="green">023</FONT>    import java.util.List;<a name="line.23"></a>
<FONT color="green">024</FONT>    import java.util.Map;<a name="line.24"></a>
<FONT color="green">025</FONT>    <a name="line.25"></a>
<FONT color="green">026</FONT>    import org.apache.commons.lang.StringUtils;<a name="line.26"></a>
<FONT color="green">027</FONT>    import org.kuali.kfs.pdp.PdpConstants;<a name="line.27"></a>
<FONT color="green">028</FONT>    import org.kuali.kfs.pdp.PdpKeyConstants;<a name="line.28"></a>
<FONT color="green">029</FONT>    import org.kuali.kfs.pdp.PdpParameterConstants;<a name="line.29"></a>
<FONT color="green">030</FONT>    import org.kuali.kfs.pdp.PdpPropertyConstants;<a name="line.30"></a>
<FONT color="green">031</FONT>    import org.kuali.kfs.pdp.batch.service.ExtractPaymentService;<a name="line.31"></a>
<FONT color="green">032</FONT>    import org.kuali.kfs.pdp.businessobject.AchAccountNumber;<a name="line.32"></a>
<FONT color="green">033</FONT>    import org.kuali.kfs.pdp.businessobject.CustomerBank;<a name="line.33"></a>
<FONT color="green">034</FONT>    import org.kuali.kfs.pdp.businessobject.CustomerProfile;<a name="line.34"></a>
<FONT color="green">035</FONT>    import org.kuali.kfs.pdp.businessobject.DisbursementNumberRange;<a name="line.35"></a>
<FONT color="green">036</FONT>    import org.kuali.kfs.pdp.businessobject.DisbursementType;<a name="line.36"></a>
<FONT color="green">037</FONT>    import org.kuali.kfs.pdp.businessobject.FormatProcess;<a name="line.37"></a>
<FONT color="green">038</FONT>    import org.kuali.kfs.pdp.businessobject.FormatProcessSummary;<a name="line.38"></a>
<FONT color="green">039</FONT>    import org.kuali.kfs.pdp.businessobject.FormatSelection;<a name="line.39"></a>
<FONT color="green">040</FONT>    import org.kuali.kfs.pdp.businessobject.PayeeACHAccount;<a name="line.40"></a>
<FONT color="green">041</FONT>    import org.kuali.kfs.pdp.businessobject.PaymentChangeCode;<a name="line.41"></a>
<FONT color="green">042</FONT>    import org.kuali.kfs.pdp.businessobject.PaymentDetail;<a name="line.42"></a>
<FONT color="green">043</FONT>    import org.kuali.kfs.pdp.businessobject.PaymentGroup;<a name="line.43"></a>
<FONT color="green">044</FONT>    import org.kuali.kfs.pdp.businessobject.PaymentGroupHistory;<a name="line.44"></a>
<FONT color="green">045</FONT>    import org.kuali.kfs.pdp.businessobject.PaymentProcess;<a name="line.45"></a>
<FONT color="green">046</FONT>    import org.kuali.kfs.pdp.businessobject.PaymentStatus;<a name="line.46"></a>
<FONT color="green">047</FONT>    import org.kuali.kfs.pdp.dataaccess.FormatPaymentDao;<a name="line.47"></a>
<FONT color="green">048</FONT>    import org.kuali.kfs.pdp.dataaccess.PaymentDetailDao;<a name="line.48"></a>
<FONT color="green">049</FONT>    import org.kuali.kfs.pdp.dataaccess.PaymentGroupDao;<a name="line.49"></a>
<FONT color="green">050</FONT>    import org.kuali.kfs.pdp.dataaccess.ProcessDao;<a name="line.50"></a>
<FONT color="green">051</FONT>    import org.kuali.kfs.pdp.service.AchService;<a name="line.51"></a>
<FONT color="green">052</FONT>    import org.kuali.kfs.pdp.service.FormatService;<a name="line.52"></a>
<FONT color="green">053</FONT>    import org.kuali.kfs.pdp.service.PaymentGroupService;<a name="line.53"></a>
<FONT color="green">054</FONT>    import org.kuali.kfs.pdp.service.PendingTransactionService;<a name="line.54"></a>
<FONT color="green">055</FONT>    import org.kuali.kfs.pdp.service.impl.exception.FormatException;<a name="line.55"></a>
<FONT color="green">056</FONT>    import org.kuali.kfs.sys.DynamicCollectionComparator;<a name="line.56"></a>
<FONT color="green">057</FONT>    import org.kuali.kfs.sys.KFSConstants;<a name="line.57"></a>
<FONT color="green">058</FONT>    import org.kuali.kfs.sys.KFSPropertyConstants;<a name="line.58"></a>
<FONT color="green">059</FONT>    import org.kuali.kfs.sys.batch.service.SchedulerService;<a name="line.59"></a>
<FONT color="green">060</FONT>    import org.kuali.kfs.sys.businessobject.Bank;<a name="line.60"></a>
<FONT color="green">061</FONT>    import org.kuali.kfs.sys.context.SpringContext;<a name="line.61"></a>
<FONT color="green">062</FONT>    import org.kuali.kfs.sys.service.impl.KfsParameterConstants;<a name="line.62"></a>
<FONT color="green">063</FONT>    import org.kuali.rice.kim.bo.Person;<a name="line.63"></a>
<FONT color="green">064</FONT>    import org.kuali.rice.kim.service.PersonService;<a name="line.64"></a>
<FONT color="green">065</FONT>    import org.kuali.rice.kns.service.BusinessObjectService;<a name="line.65"></a>
<FONT color="green">066</FONT>    import org.kuali.rice.kns.service.DateTimeService;<a name="line.66"></a>
<FONT color="green">067</FONT>    import org.kuali.rice.kns.service.ParameterService;<a name="line.67"></a>
<FONT color="green">068</FONT>    import org.kuali.rice.kns.util.GlobalVariables;<a name="line.68"></a>
<FONT color="green">069</FONT>    import org.kuali.rice.kns.util.KualiInteger;<a name="line.69"></a>
<FONT color="green">070</FONT>    import org.kuali.rice.kns.util.ObjectUtils;<a name="line.70"></a>
<FONT color="green">071</FONT>    import org.springframework.transaction.annotation.Transactional;<a name="line.71"></a>
<FONT color="green">072</FONT>    <a name="line.72"></a>
<FONT color="green">073</FONT>    @Transactional<a name="line.73"></a>
<FONT color="green">074</FONT>    public class FormatServiceImpl implements FormatService {<a name="line.74"></a>
<FONT color="green">075</FONT>        private static org.apache.log4j.Logger LOG = org.apache.log4j.Logger.getLogger(FormatServiceImpl.class);<a name="line.75"></a>
<FONT color="green">076</FONT>    <a name="line.76"></a>
<FONT color="green">077</FONT>        private PaymentDetailDao paymentDetailDao;<a name="line.77"></a>
<FONT color="green">078</FONT>        private PaymentGroupDao paymentGroupDao;<a name="line.78"></a>
<FONT color="green">079</FONT>        private ProcessDao processDao;<a name="line.79"></a>
<FONT color="green">080</FONT>        private AchService achService;<a name="line.80"></a>
<FONT color="green">081</FONT>        private PendingTransactionService glPendingTransactionService;<a name="line.81"></a>
<FONT color="green">082</FONT>        private ParameterService parameterService;<a name="line.82"></a>
<FONT color="green">083</FONT>        private FormatPaymentDao formatPaymentDao;<a name="line.83"></a>
<FONT color="green">084</FONT>        private SchedulerService schedulerService;<a name="line.84"></a>
<FONT color="green">085</FONT>        private BusinessObjectService businessObjectService;<a name="line.85"></a>
<FONT color="green">086</FONT>        private PaymentGroupService paymentGroupService;<a name="line.86"></a>
<FONT color="green">087</FONT>        private DateTimeService dateTimeService;<a name="line.87"></a>
<FONT color="green">088</FONT>        private ExtractPaymentService extractPaymentService;<a name="line.88"></a>
<FONT color="green">089</FONT>        private PersonService&lt;Person&gt; personService;<a name="line.89"></a>
<FONT color="green">090</FONT>    <a name="line.90"></a>
<FONT color="green">091</FONT>        /**<a name="line.91"></a>
<FONT color="green">092</FONT>         * Constructs a FormatServiceImpl.java.<a name="line.92"></a>
<FONT color="green">093</FONT>         */<a name="line.93"></a>
<FONT color="green">094</FONT>        public FormatServiceImpl() {<a name="line.94"></a>
<FONT color="green">095</FONT>            super();<a name="line.95"></a>
<FONT color="green">096</FONT>        }<a name="line.96"></a>
<FONT color="green">097</FONT>    <a name="line.97"></a>
<FONT color="green">098</FONT>        /**<a name="line.98"></a>
<FONT color="green">099</FONT>         * @see org.kuali.kfs.pdp.service.FormatProcessService#getDataForFormat(org.kuali.rice.kim.bo.Person)<a name="line.99"></a>
<FONT color="green">100</FONT>         */<a name="line.100"></a>
<FONT color="green">101</FONT>        public FormatSelection getDataForFormat(Person user) {<a name="line.101"></a>
<FONT color="green">102</FONT>    <a name="line.102"></a>
<FONT color="green">103</FONT>            String campusCode = user.getCampusCode();<a name="line.103"></a>
<FONT color="green">104</FONT>            Date formatStartDate = getFormatProcessStartDate(campusCode);<a name="line.104"></a>
<FONT color="green">105</FONT>    <a name="line.105"></a>
<FONT color="green">106</FONT>            // create new FormatSelection object an set the campus code and the start date<a name="line.106"></a>
<FONT color="green">107</FONT>            FormatSelection formatSelection = new FormatSelection();<a name="line.107"></a>
<FONT color="green">108</FONT>            formatSelection.setCampus(campusCode);<a name="line.108"></a>
<FONT color="green">109</FONT>            formatSelection.setStartDate(formatStartDate);<a name="line.109"></a>
<FONT color="green">110</FONT>    <a name="line.110"></a>
<FONT color="green">111</FONT>            // if format process not started yet, populate the other data as well<a name="line.111"></a>
<FONT color="green">112</FONT>            if (formatStartDate == null) {<a name="line.112"></a>
<FONT color="green">113</FONT>                formatSelection.setCustomerList(getAllCustomerProfiles());<a name="line.113"></a>
<FONT color="green">114</FONT>                formatSelection.setRangeList(getAllDisbursementNumberRanges());<a name="line.114"></a>
<FONT color="green">115</FONT>            }<a name="line.115"></a>
<FONT color="green">116</FONT>    <a name="line.116"></a>
<FONT color="green">117</FONT>            return formatSelection;<a name="line.117"></a>
<FONT color="green">118</FONT>        }<a name="line.118"></a>
<FONT color="green">119</FONT>    <a name="line.119"></a>
<FONT color="green">120</FONT>        /**<a name="line.120"></a>
<FONT color="green">121</FONT>         * @see org.kuali.kfs.pdp.service.FormatService#getFormatProcessStartDate(java.lang.String)<a name="line.121"></a>
<FONT color="green">122</FONT>         */<a name="line.122"></a>
<FONT color="green">123</FONT>        @SuppressWarnings("rawtypes")<a name="line.123"></a>
<FONT color="green">124</FONT>        public Date getFormatProcessStartDate(String campus) {<a name="line.124"></a>
<FONT color="green">125</FONT>            LOG.debug("getFormatProcessStartDate() started");<a name="line.125"></a>
<FONT color="green">126</FONT>    <a name="line.126"></a>
<FONT color="green">127</FONT>            Map primaryKeys = new HashMap();<a name="line.127"></a>
<FONT color="green">128</FONT>            primaryKeys.put(PdpPropertyConstants.PHYS_CAMPUS_PROCESS_CODE, campus);<a name="line.128"></a>
<FONT color="green">129</FONT>            FormatProcess formatProcess = (FormatProcess) this.businessObjectService.findByPrimaryKey(FormatProcess.class, primaryKeys);<a name="line.129"></a>
<FONT color="green">130</FONT>    <a name="line.130"></a>
<FONT color="green">131</FONT>            if (formatProcess != null) {<a name="line.131"></a>
<FONT color="green">132</FONT>                LOG.debug("getFormatProcessStartDate() found");<a name="line.132"></a>
<FONT color="green">133</FONT>                return new Date(formatProcess.getBeginFormat().getTime());<a name="line.133"></a>
<FONT color="green">134</FONT>            }<a name="line.134"></a>
<FONT color="green">135</FONT>            else {<a name="line.135"></a>
<FONT color="green">136</FONT>                LOG.debug("getFormatProcessStartDate() not found");<a name="line.136"></a>
<FONT color="green">137</FONT>                return null;<a name="line.137"></a>
<FONT color="green">138</FONT>            }<a name="line.138"></a>
<FONT color="green">139</FONT>        }<a name="line.139"></a>
<FONT color="green">140</FONT>    <a name="line.140"></a>
<FONT color="green">141</FONT>        /**<a name="line.141"></a>
<FONT color="green">142</FONT>         * @see org.kuali.kfs.pdp.service.FormatService#startFormatProcess(org.kuali.rice.kim.bo.Person, java.lang.String,<a name="line.142"></a>
<FONT color="green">143</FONT>         *      java.util.List, java.util.Date, java.lang.String)<a name="line.143"></a>
<FONT color="green">144</FONT>         */<a name="line.144"></a>
<FONT color="green">145</FONT>        public FormatProcessSummary startFormatProcess(Person user, String campus, List&lt;CustomerProfile&gt; customers, Date paydate, String paymentTypes) {<a name="line.145"></a>
<FONT color="green">146</FONT>            LOG.debug("startFormatProcess() started");<a name="line.146"></a>
<FONT color="green">147</FONT>    <a name="line.147"></a>
<FONT color="green">148</FONT>            for (CustomerProfile element : customers) {<a name="line.148"></a>
<FONT color="green">149</FONT>                LOG.debug("startFormatProcess() Customer: " + element);<a name="line.149"></a>
<FONT color="green">150</FONT>            }<a name="line.150"></a>
<FONT color="green">151</FONT>            <a name="line.151"></a>
<FONT color="green">152</FONT>            // Create the process<a name="line.152"></a>
<FONT color="green">153</FONT>            Date d = new Date();<a name="line.153"></a>
<FONT color="green">154</FONT>            PaymentProcess paymentProcess = new PaymentProcess();<a name="line.154"></a>
<FONT color="green">155</FONT>            paymentProcess.setCampusCode(campus);<a name="line.155"></a>
<FONT color="green">156</FONT>            paymentProcess.setProcessUser(user);<a name="line.156"></a>
<FONT color="green">157</FONT>            paymentProcess.setProcessTimestamp(new Timestamp(d.getTime()));<a name="line.157"></a>
<FONT color="green">158</FONT>    <a name="line.158"></a>
<FONT color="green">159</FONT>            this.businessObjectService.save(paymentProcess);<a name="line.159"></a>
<FONT color="green">160</FONT>    <a name="line.160"></a>
<FONT color="green">161</FONT>            // add an entry in the format process table (to lock the format process)<a name="line.161"></a>
<FONT color="green">162</FONT>            FormatProcess formatProcess = new FormatProcess();<a name="line.162"></a>
<FONT color="green">163</FONT>    <a name="line.163"></a>
<FONT color="green">164</FONT>            formatProcess.setPhysicalCampusProcessCode(campus);<a name="line.164"></a>
<FONT color="green">165</FONT>            formatProcess.setBeginFormat(dateTimeService.getCurrentTimestamp());<a name="line.165"></a>
<FONT color="green">166</FONT>            formatProcess.setPaymentProcIdentifier(paymentProcess.getId().intValue());<a name="line.166"></a>
<FONT color="green">167</FONT>    <a name="line.167"></a>
<FONT color="green">168</FONT>            this.businessObjectService.save(formatProcess);<a name="line.168"></a>
<FONT color="green">169</FONT>    <a name="line.169"></a>
<FONT color="green">170</FONT>            // Mark all of them ready for format<a name="line.170"></a>
<FONT color="green">171</FONT>            formatPaymentDao.markPaymentsForFormat(paymentProcess, customers, paydate, paymentTypes);<a name="line.171"></a>
<FONT color="green">172</FONT>    <a name="line.172"></a>
<FONT color="green">173</FONT>            // summarize them<a name="line.173"></a>
<FONT color="green">174</FONT>            FormatProcessSummary preFormatProcessSummary = new FormatProcessSummary();<a name="line.174"></a>
<FONT color="green">175</FONT>            Iterator&lt;PaymentGroup&gt; iterator = this.paymentGroupService.getByProcess(paymentProcess);<a name="line.175"></a>
<FONT color="green">176</FONT>    <a name="line.176"></a>
<FONT color="green">177</FONT>            while (iterator.hasNext()) {<a name="line.177"></a>
<FONT color="green">178</FONT>                PaymentGroup paymentGroup = iterator.next();<a name="line.178"></a>
<FONT color="green">179</FONT>                preFormatProcessSummary.add(paymentGroup);<a name="line.179"></a>
<FONT color="green">180</FONT>            }<a name="line.180"></a>
<FONT color="green">181</FONT>    <a name="line.181"></a>
<FONT color="green">182</FONT>            // if no payments found for format clear the format process<a name="line.182"></a>
<FONT color="green">183</FONT>            if (preFormatProcessSummary.getProcessSummaryList().size() == 0) {<a name="line.183"></a>
<FONT color="green">184</FONT>                LOG.debug("startFormatProcess() No payments to process.  Format process ending");<a name="line.184"></a>
<FONT color="green">185</FONT>                clearUnfinishedFormat(paymentProcess.getId().intValue());// ?? maybe call end format process<a name="line.185"></a>
<FONT color="green">186</FONT>            }<a name="line.186"></a>
<FONT color="green">187</FONT>    <a name="line.187"></a>
<FONT color="green">188</FONT>            return preFormatProcessSummary;<a name="line.188"></a>
<FONT color="green">189</FONT>        }<a name="line.189"></a>
<FONT color="green">190</FONT>    <a name="line.190"></a>
<FONT color="green">191</FONT>    <a name="line.191"></a>
<FONT color="green">192</FONT>        /**<a name="line.192"></a>
<FONT color="green">193</FONT>         * This method gets the maximum number of lines in a note.<a name="line.193"></a>
<FONT color="green">194</FONT>         * <a name="line.194"></a>
<FONT color="green">195</FONT>         * @return the maximum number of lines in a note<a name="line.195"></a>
<FONT color="green">196</FONT>         */<a name="line.196"></a>
<FONT color="green">197</FONT>        protected int getMaxNoteLines() {<a name="line.197"></a>
<FONT color="green">198</FONT>            String maxLines = parameterService.getParameterValue(KfsParameterConstants.PRE_DISBURSEMENT_ALL.class, PdpParameterConstants.MAX_NOTE_LINES);<a name="line.198"></a>
<FONT color="green">199</FONT>            if (StringUtils.isBlank(maxLines)) {<a name="line.199"></a>
<FONT color="green">200</FONT>                throw new RuntimeException("System parameter for max note lines is blank");<a name="line.200"></a>
<FONT color="green">201</FONT>            }<a name="line.201"></a>
<FONT color="green">202</FONT>    <a name="line.202"></a>
<FONT color="green">203</FONT>            return Integer.parseInt(maxLines);<a name="line.203"></a>
<FONT color="green">204</FONT>        }<a name="line.204"></a>
<FONT color="green">205</FONT>    <a name="line.205"></a>
<FONT color="green">206</FONT>        /**<a name="line.206"></a>
<FONT color="green">207</FONT>         * @see org.kuali.kfs.pdp.service.FormatService#performFormat(java.lang.Integer)<a name="line.207"></a>
<FONT color="green">208</FONT>         */<a name="line.208"></a>
<FONT color="green">209</FONT>        public void performFormat(Integer processId) throws FormatException {<a name="line.209"></a>
<FONT color="green">210</FONT>            LOG.debug("performFormat() started");<a name="line.210"></a>
<FONT color="green">211</FONT>    <a name="line.211"></a>
<FONT color="green">212</FONT>            // get the PaymentProcess for the given id<a name="line.212"></a>
<FONT color="green">213</FONT>            @SuppressWarnings("rawtypes")<a name="line.213"></a>
<FONT color="green">214</FONT>            Map primaryKeys = new HashMap();<a name="line.214"></a>
<FONT color="green">215</FONT>            primaryKeys.put(PdpPropertyConstants.PaymentProcess.PAYMENT_PROCESS_ID, processId);<a name="line.215"></a>
<FONT color="green">216</FONT>            PaymentProcess paymentProcess = (PaymentProcess) this.businessObjectService.findByPrimaryKey(PaymentProcess.class, primaryKeys);<a name="line.216"></a>
<FONT color="green">217</FONT>            if (paymentProcess == null) {<a name="line.217"></a>
<FONT color="green">218</FONT>                LOG.error("performFormat() Invalid proc ID " + processId);<a name="line.218"></a>
<FONT color="green">219</FONT>                throw new RuntimeException("Invalid proc ID");<a name="line.219"></a>
<FONT color="green">220</FONT>            }<a name="line.220"></a>
<FONT color="green">221</FONT>            <a name="line.221"></a>
<FONT color="green">222</FONT>            String processCampus = paymentProcess.getCampusCode();<a name="line.222"></a>
<FONT color="green">223</FONT>            FormatProcessSummary postFormatProcessSummary = new FormatProcessSummary();<a name="line.223"></a>
<FONT color="green">224</FONT>    <a name="line.224"></a>
<FONT color="green">225</FONT>            // step 1 get ACH or Check, Bank info, ACH info, sorting<a name="line.225"></a>
<FONT color="green">226</FONT>            Iterator&lt;PaymentGroup&gt; paymentGroupIterator = this.paymentGroupService.getByProcess(paymentProcess);<a name="line.226"></a>
<FONT color="green">227</FONT>            while (paymentGroupIterator.hasNext()) {<a name="line.227"></a>
<FONT color="green">228</FONT>                PaymentGroup paymentGroup = paymentGroupIterator.next();<a name="line.228"></a>
<FONT color="green">229</FONT>                LOG.debug("performFormat() Step 1 Payment Group ID " + paymentGroup.getId());<a name="line.229"></a>
<FONT color="green">230</FONT>    <a name="line.230"></a>
<FONT color="green">231</FONT>                // process payment group data<a name="line.231"></a>
<FONT color="green">232</FONT>                boolean groupProcessed = processPaymentGroup(paymentGroup, paymentProcess);<a name="line.232"></a>
<FONT color="green">233</FONT>                if (!groupProcessed) {<a name="line.233"></a>
<FONT color="green">234</FONT>                    throw new FormatException("Error encountered during format");<a name="line.234"></a>
<FONT color="green">235</FONT>                }<a name="line.235"></a>
<FONT color="green">236</FONT>    <a name="line.236"></a>
<FONT color="green">237</FONT>                // save payment group<a name="line.237"></a>
<FONT color="green">238</FONT>                this.businessObjectService.save(paymentGroup);<a name="line.238"></a>
<FONT color="green">239</FONT>    <a name="line.239"></a>
<FONT color="green">240</FONT>                // Add to summary information<a name="line.240"></a>
<FONT color="green">241</FONT>                postFormatProcessSummary.add(paymentGroup);<a name="line.241"></a>
<FONT color="green">242</FONT>            }<a name="line.242"></a>
<FONT color="green">243</FONT>    <a name="line.243"></a>
<FONT color="green">244</FONT>            // step 2 assign disbursement numbers and combine checks into one if possible<a name="line.244"></a>
<FONT color="green">245</FONT>            boolean disbursementNumbersAssigned = assignDisbursementNumbersAndCombineChecks(paymentProcess, postFormatProcessSummary);<a name="line.245"></a>
<FONT color="green">246</FONT>            if (!disbursementNumbersAssigned) {<a name="line.246"></a>
<FONT color="green">247</FONT>                throw new FormatException("Error encountered during format");<a name="line.247"></a>
<FONT color="green">248</FONT>            }<a name="line.248"></a>
<FONT color="green">249</FONT>    <a name="line.249"></a>
<FONT color="green">250</FONT>            // step 3 save the summarizing info<a name="line.250"></a>
<FONT color="green">251</FONT>            LOG.debug("performFormat() Save summarizing information");<a name="line.251"></a>
<FONT color="green">252</FONT>            postFormatProcessSummary.save();<a name="line.252"></a>
<FONT color="green">253</FONT>    <a name="line.253"></a>
<FONT color="green">254</FONT>            // step 4 set formatted indicator to true and save in the db<a name="line.254"></a>
<FONT color="green">255</FONT>            paymentProcess.setFormattedIndicator(true);<a name="line.255"></a>
<FONT color="green">256</FONT>            businessObjectService.save(paymentProcess);<a name="line.256"></a>
<FONT color="green">257</FONT>    <a name="line.257"></a>
<FONT color="green">258</FONT>            // step 5 end the format process for this campus<a name="line.258"></a>
<FONT color="green">259</FONT>            LOG.debug("performFormat() End the format process for this campus");<a name="line.259"></a>
<FONT color="green">260</FONT>            endFormatProcess(processCampus);<a name="line.260"></a>
<FONT color="green">261</FONT>    <a name="line.261"></a>
<FONT color="green">262</FONT>            // step 6 tell the extract batch job to start<a name="line.262"></a>
<FONT color="green">263</FONT>            LOG.debug("performFormat() Start extract");<a name="line.263"></a>
<FONT color="green">264</FONT>            extractChecks();<a name="line.264"></a>
<FONT color="green">265</FONT>        }<a name="line.265"></a>
<FONT color="green">266</FONT>    <a name="line.266"></a>
<FONT color="green">267</FONT>        /**<a name="line.267"></a>
<FONT color="green">268</FONT>         * This method processes the payment group data.<a name="line.268"></a>
<FONT color="green">269</FONT>         * <a name="line.269"></a>
<FONT color="green">270</FONT>         * @param paymentGroup<a name="line.270"></a>
<FONT color="green">271</FONT>         * @param paymentProcess<a name="line.271"></a>
<FONT color="green">272</FONT>         */<a name="line.272"></a>
<FONT color="green">273</FONT>        protected boolean processPaymentGroup(PaymentGroup paymentGroup, PaymentProcess paymentProcess) {<a name="line.273"></a>
<FONT color="green">274</FONT>            boolean successful = true;<a name="line.274"></a>
<FONT color="green">275</FONT>    <a name="line.275"></a>
<FONT color="green">276</FONT>            paymentGroup.setSortValue(paymentGroupService.getSortGroupId(paymentGroup));<a name="line.276"></a>
<FONT color="green">277</FONT>            paymentGroup.setPhysCampusProcessCd(paymentProcess.getCampusCode());<a name="line.277"></a>
<FONT color="green">278</FONT>            paymentGroup.setProcess(paymentProcess);<a name="line.278"></a>
<FONT color="green">279</FONT>    <a name="line.279"></a>
<FONT color="green">280</FONT>            // If any one of the payment details in the group are negative, we always force a check<a name="line.280"></a>
<FONT color="green">281</FONT>            boolean noNegativeDetails = true;<a name="line.281"></a>
<FONT color="green">282</FONT>    <a name="line.282"></a>
<FONT color="green">283</FONT>            // If any one of the payment details in the group are negative, we always force a check<a name="line.283"></a>
<FONT color="green">284</FONT>            List&lt;PaymentDetail&gt; paymentDetailsList = paymentGroup.getPaymentDetails();<a name="line.284"></a>
<FONT color="green">285</FONT>            for (PaymentDetail paymentDetail : paymentDetailsList) {<a name="line.285"></a>
<FONT color="green">286</FONT>                if (paymentDetail.getNetPaymentAmount().doubleValue() &lt; 0) {<a name="line.286"></a>
<FONT color="green">287</FONT>                    LOG.debug("performFormat() Payment Group " + paymentGroup + " has payment detail net payment amount " + paymentDetail.getNetPaymentAmount());<a name="line.287"></a>
<FONT color="green">288</FONT>                    LOG.debug("performFormat() Forcing a Check for Group");<a name="line.288"></a>
<FONT color="green">289</FONT>                    noNegativeDetails = false;<a name="line.289"></a>
<FONT color="green">290</FONT>                    break;<a name="line.290"></a>
<FONT color="green">291</FONT>                }<a name="line.291"></a>
<FONT color="green">292</FONT>            }<a name="line.292"></a>
<FONT color="green">293</FONT>    <a name="line.293"></a>
<FONT color="green">294</FONT>            // determine whether payment should be ACH or Check<a name="line.294"></a>
<FONT color="green">295</FONT>            CustomerProfile customer = paymentGroup.getBatch().getCustomerProfile();<a name="line.295"></a>
<FONT color="green">296</FONT>            <a name="line.296"></a>
<FONT color="green">297</FONT>            PayeeACHAccount payeeAchAccount = null;<a name="line.297"></a>
<FONT color="green">298</FONT>            boolean isCheck = true;<a name="line.298"></a>
<FONT color="green">299</FONT>            if (PdpConstants.PayeeIdTypeCodes.VENDOR_ID.equals(paymentGroup.getPayeeIdTypeCd()) || PdpConstants.PayeeIdTypeCodes.EMPLOYEE.equals(paymentGroup.getPayeeIdTypeCd()) || PdpConstants.PayeeIdTypeCodes.ENTITY.equals(paymentGroup.getPayeeIdTypeCd())) {<a name="line.299"></a>
<FONT color="green">300</FONT>                if (StringUtils.isNotBlank(paymentGroup.getPayeeId()) &amp;&amp; !paymentGroup.getPymtAttachment() &amp;&amp; !paymentGroup.getProcessImmediate() &amp;&amp; !paymentGroup.getPymtSpecialHandling() &amp;&amp; (customer.getAchTransactionType() != null) &amp;&amp; noNegativeDetails) {<a name="line.300"></a>
<FONT color="green">301</FONT>                    LOG.debug("performFormat() Checking ACH");<a name="line.301"></a>
<FONT color="green">302</FONT>                    payeeAchAccount = achService.getAchInformation(paymentGroup.getPayeeIdTypeCd(), paymentGroup.getPayeeId(), customer.getAchTransactionType());<a name="line.302"></a>
<FONT color="green">303</FONT>                    isCheck = (payeeAchAccount == null);<a name="line.303"></a>
<FONT color="green">304</FONT>                }<a name="line.304"></a>
<FONT color="green">305</FONT>            }<a name="line.305"></a>
<FONT color="green">306</FONT>    <a name="line.306"></a>
<FONT color="green">307</FONT>            DisbursementType disbursementType = null;<a name="line.307"></a>
<FONT color="green">308</FONT>            if (isCheck) {<a name="line.308"></a>
<FONT color="green">309</FONT>                PaymentStatus paymentStatus = (PaymentStatus) businessObjectService.findBySinglePrimaryKey(PaymentStatus.class, PdpConstants.PaymentStatusCodes.PENDING_CHECK);<a name="line.309"></a>
<FONT color="green">310</FONT>                paymentGroup.setPaymentStatus(paymentStatus);<a name="line.310"></a>
<FONT color="green">311</FONT>    <a name="line.311"></a>
<FONT color="green">312</FONT>                disbursementType = (DisbursementType) businessObjectService.findBySinglePrimaryKey(DisbursementType.class, PdpConstants.DisbursementTypeCodes.CHECK);<a name="line.312"></a>
<FONT color="green">313</FONT>                paymentGroup.setDisbursementType(disbursementType);<a name="line.313"></a>
<FONT color="green">314</FONT>            }<a name="line.314"></a>
<FONT color="green">315</FONT>            else {<a name="line.315"></a>
<FONT color="green">316</FONT>                PaymentStatus paymentStatus = (PaymentStatus) businessObjectService.findBySinglePrimaryKey(PaymentStatus.class, PdpConstants.PaymentStatusCodes.PENDING_ACH);<a name="line.316"></a>
<FONT color="green">317</FONT>                paymentGroup.setPaymentStatus(paymentStatus);<a name="line.317"></a>
<FONT color="green">318</FONT>                <a name="line.318"></a>
<FONT color="green">319</FONT>                disbursementType = (DisbursementType) businessObjectService.findBySinglePrimaryKey(DisbursementType.class, PdpConstants.DisbursementTypeCodes.ACH);<a name="line.319"></a>
<FONT color="green">320</FONT>                paymentGroup.setDisbursementType(disbursementType);<a name="line.320"></a>
<FONT color="green">321</FONT>    <a name="line.321"></a>
<FONT color="green">322</FONT>                paymentGroup.setAchBankRoutingNbr(payeeAchAccount.getBankRoutingNumber());<a name="line.322"></a>
<FONT color="green">323</FONT>                paymentGroup.setAdviceEmailAddress(payeeAchAccount.getPayeeEmailAddress());<a name="line.323"></a>
<FONT color="green">324</FONT>                paymentGroup.setAchAccountType(payeeAchAccount.getBankAccountTypeCode());<a name="line.324"></a>
<FONT color="green">325</FONT>    <a name="line.325"></a>
<FONT color="green">326</FONT>                AchAccountNumber achAccountNumber = new AchAccountNumber();<a name="line.326"></a>
<FONT color="green">327</FONT>                achAccountNumber.setAchBankAccountNbr(payeeAchAccount.getBankAccountNumber());<a name="line.327"></a>
<FONT color="green">328</FONT>                achAccountNumber.setId(paymentGroup.getId());<a name="line.328"></a>
<FONT color="green">329</FONT>                paymentGroup.setAchAccountNumber(achAccountNumber);<a name="line.329"></a>
<FONT color="green">330</FONT>            }<a name="line.330"></a>
<FONT color="green">331</FONT>            <a name="line.331"></a>
<FONT color="green">332</FONT>            // set payment group bank<a name="line.332"></a>
<FONT color="green">333</FONT>            successful &amp;= validateAndUpdatePaymentGroupBankCode(paymentGroup, disbursementType, customer);<a name="line.333"></a>
<FONT color="green">334</FONT>            <a name="line.334"></a>
<FONT color="green">335</FONT>            return successful;<a name="line.335"></a>
<FONT color="green">336</FONT>        }<a name="line.336"></a>
<FONT color="green">337</FONT>        <a name="line.337"></a>
<FONT color="green">338</FONT>        /**<a name="line.338"></a>
<FONT color="green">339</FONT>         * Verifies a valid bank is set on the payment group. A bank is valid if it is active and supports the given disbursement type. If the payment group already has an<a name="line.339"></a>
<FONT color="green">340</FONT>         * assigned bank it will be used unless it is not valid. If the payment group bank is not valid or was not given the bank specified on the customer profile to use<a name="line.340"></a>
<FONT color="green">341</FONT>         * for the given disbursement type is used. If this bank is inactive then its continuation bank is used. If not valid bank to use is found an error is added to the<a name="line.341"></a>
<FONT color="green">342</FONT>         * global message map.<a name="line.342"></a>
<FONT color="green">343</FONT>         * <a name="line.343"></a>
<FONT color="green">344</FONT>         * @param paymentGroup group to set bank on<a name="line.344"></a>
<FONT color="green">345</FONT>         * @param disbursementType type of disbursement for given payment group<a name="line.345"></a>
<FONT color="green">346</FONT>         * @param customer customer profile for payment group<a name="line.346"></a>
<FONT color="green">347</FONT>         * @return boolean true if a valid bank is set on the payment group, false otherwise<a name="line.347"></a>
<FONT color="green">348</FONT>         */<a name="line.348"></a>
<FONT color="green">349</FONT>        protected boolean validateAndUpdatePaymentGroupBankCode(PaymentGroup paymentGroup, DisbursementType disbursementType, CustomerProfile customer) {<a name="line.349"></a>
<FONT color="green">350</FONT>            boolean bankValid = true;<a name="line.350"></a>
<FONT color="green">351</FONT>            <a name="line.351"></a>
<FONT color="green">352</FONT>            String originalBankCode = paymentGroup.getBankCode();<a name="line.352"></a>
<FONT color="green">353</FONT>            if (ObjectUtils.isNull(paymentGroup.getBank()) || ((disbursementType.getCode().equals(PdpConstants.DisbursementTypeCodes.ACH) &amp;&amp; !paymentGroup.getBank().isBankAchIndicator()) || (disbursementType.getCode().equals(PdpConstants.DisbursementTypeCodes.CHECK) &amp;&amp; !paymentGroup.getBank().isBankCheckIndicator())) || !paymentGroup.getBank().isActive()) {<a name="line.353"></a>
<FONT color="green">354</FONT>                CustomerBank customerBank = customer.getCustomerBankByDisbursementType(disbursementType.getCode());<a name="line.354"></a>
<FONT color="green">355</FONT>                if (ObjectUtils.isNotNull(customerBank) &amp;&amp; customerBank.isActive() &amp;&amp; ObjectUtils.isNotNull(customerBank.getBank()) &amp;&amp; customerBank.getBank().isActive()) {<a name="line.355"></a>
<FONT color="green">356</FONT>                    paymentGroup.setBankCode(customerBank.getBankCode());<a name="line.356"></a>
<FONT color="green">357</FONT>                    paymentGroup.setBank(customerBank.getBank());<a name="line.357"></a>
<FONT color="green">358</FONT>                }<a name="line.358"></a>
<FONT color="green">359</FONT>                else if (ObjectUtils.isNotNull(customerBank) &amp;&amp; ObjectUtils.isNotNull(customerBank.getBank()) &amp;&amp; ObjectUtils.isNotNull(customerBank.getBank().getContinuationBank()) &amp;&amp; customerBank.getBank().getContinuationBank().isActive()) {<a name="line.359"></a>
<FONT color="green">360</FONT>                    paymentGroup.setBankCode(customerBank.getBank().getContinuationBank().getBankCode());<a name="line.360"></a>
<FONT color="green">361</FONT>                    paymentGroup.setBank(customerBank.getBank().getContinuationBank());<a name="line.361"></a>
<FONT color="green">362</FONT>                }<a name="line.362"></a>
<FONT color="green">363</FONT>            }<a name="line.363"></a>
<FONT color="green">364</FONT>    <a name="line.364"></a>
<FONT color="green">365</FONT>            if (ObjectUtils.isNull(paymentGroup.getBank())) {<a name="line.365"></a>
<FONT color="green">366</FONT>                LOG.error("performFormat() A bank is needed for " + disbursementType.getName() + " disbursement type for customer: " + customer);<a name="line.366"></a>
<FONT color="green">367</FONT>                GlobalVariables.getMessageMap().putError(KFSConstants.GLOBAL_ERRORS, PdpKeyConstants.Format.ErrorMessages.ERROR_FORMAT_BANK_MISSING, customer.getCustomerShortName());<a name="line.367"></a>
<FONT color="green">368</FONT>                bankValid = false;<a name="line.368"></a>
<FONT color="green">369</FONT>                <a name="line.369"></a>
<FONT color="green">370</FONT>                return bankValid;<a name="line.370"></a>
<FONT color="green">371</FONT>            }<a name="line.371"></a>
<FONT color="green">372</FONT>            <a name="line.372"></a>
<FONT color="green">373</FONT>            // create payment history record if bank was changed<a name="line.373"></a>
<FONT color="green">374</FONT>            if (StringUtils.isNotBlank(originalBankCode) &amp;&amp; !paymentGroup.getBankCode().equals(originalBankCode)) {<a name="line.374"></a>
<FONT color="green">375</FONT>                PaymentGroupHistory paymentGroupHistory = new PaymentGroupHistory();<a name="line.375"></a>
<FONT color="green">376</FONT>    <a name="line.376"></a>
<FONT color="green">377</FONT>                PaymentChangeCode paymentChangeCode = (PaymentChangeCode) businessObjectService.findBySinglePrimaryKey(PaymentChangeCode.class, PdpConstants.PaymentChangeCodes.BANK_CHNG_CD);<a name="line.377"></a>
<FONT color="green">378</FONT>                paymentGroupHistory.setPaymentChange(paymentChangeCode);<a name="line.378"></a>
<FONT color="green">379</FONT>                paymentGroupHistory.setOrigBankCode(originalBankCode);<a name="line.379"></a>
<FONT color="green">380</FONT>                <a name="line.380"></a>
<FONT color="green">381</FONT>                Bank originalBank = (Bank) businessObjectService.findBySinglePrimaryKey(Bank.class, originalBankCode);<a name="line.381"></a>
<FONT color="green">382</FONT>                paymentGroupHistory.setBank(originalBank);<a name="line.382"></a>
<FONT color="green">383</FONT>                paymentGroupHistory.setOrigPaymentStatus(paymentGroup.getPaymentStatus());<a name="line.383"></a>
<FONT color="green">384</FONT>                <a name="line.384"></a>
<FONT color="green">385</FONT>                Person changeUser = getPersonService().getPerson(KFSConstants.SYSTEM_USER);<a name="line.385"></a>
<FONT color="green">386</FONT>                paymentGroupHistory.setChangeUser(changeUser);<a name="line.386"></a>
<FONT color="green">387</FONT>                paymentGroupHistory.setPaymentGroup(paymentGroup);<a name="line.387"></a>
<FONT color="green">388</FONT>                paymentGroupHistory.setChangeTime(new Timestamp(new Date().getTime()));<a name="line.388"></a>
<FONT color="green">389</FONT>    <a name="line.389"></a>
<FONT color="green">390</FONT>                // save payment group history<a name="line.390"></a>
<FONT color="green">391</FONT>                businessObjectService.save(paymentGroupHistory);<a name="line.391"></a>
<FONT color="green">392</FONT>            }<a name="line.392"></a>
<FONT color="green">393</FONT>            <a name="line.393"></a>
<FONT color="green">394</FONT>            return bankValid;<a name="line.394"></a>
<FONT color="green">395</FONT>        }<a name="line.395"></a>
<FONT color="green">396</FONT>    <a name="line.396"></a>
<FONT color="green">397</FONT>        /**<a name="line.397"></a>
<FONT color="green">398</FONT>         * This method assigns disbursement numbers and tries to combine payment groups with disbursement type check if possible.<a name="line.398"></a>
<FONT color="green">399</FONT>         * <a name="line.399"></a>
<FONT color="green">400</FONT>         * @param paymentProcess<a name="line.400"></a>
<FONT color="green">401</FONT>         * @param postFormatProcessSummary<a name="line.401"></a>
<FONT color="green">402</FONT>         */<a name="line.402"></a>
<FONT color="green">403</FONT>        protected boolean assignDisbursementNumbersAndCombineChecks(PaymentProcess paymentProcess, FormatProcessSummary postFormatProcessSummary) {<a name="line.403"></a>
<FONT color="green">404</FONT>            boolean successful = true;<a name="line.404"></a>
<FONT color="green">405</FONT>    <a name="line.405"></a>
<FONT color="green">406</FONT>            // keep a map with paymentGroupKey and PaymentInfo (disbursementNumber, noteLines)<a name="line.406"></a>
<FONT color="green">407</FONT>            Map&lt;String, PaymentInfo&gt; combinedChecksMap = new HashMap&lt;String, PaymentInfo&gt;();<a name="line.407"></a>
<FONT color="green">408</FONT>    <a name="line.408"></a>
<FONT color="green">409</FONT>            Iterator&lt;PaymentGroup&gt; paymentGroupIterator = this.paymentGroupService.getByProcess(paymentProcess);<a name="line.409"></a>
<FONT color="green">410</FONT>            int maxNoteLines = getMaxNoteLines();<a name="line.410"></a>
<FONT color="green">411</FONT>    <a name="line.411"></a>
<FONT color="green">412</FONT>            while (paymentGroupIterator.hasNext()) {<a name="line.412"></a>
<FONT color="green">413</FONT>                PaymentGroup paymentGroup = paymentGroupIterator.next();<a name="line.413"></a>
<FONT color="green">414</FONT>                LOG.debug("performFormat() Payment Group ID " + paymentGroup.getId());<a name="line.414"></a>
<FONT color="green">415</FONT>    <a name="line.415"></a>
<FONT color="green">416</FONT>                //Use the customer's profile's campus code to check for disbursement ranges<a name="line.416"></a>
<FONT color="green">417</FONT>                String campus = paymentGroup.getBatch().getCustomerProfile().getDefaultPhysicalCampusProcessingCode();<a name="line.417"></a>
<FONT color="green">418</FONT>                List&lt;DisbursementNumberRange&gt; disbursementRanges = paymentDetailDao.getDisbursementNumberRanges(campus);<a name="line.418"></a>
<FONT color="green">419</FONT>                <a name="line.419"></a>
<FONT color="green">420</FONT>                DisbursementNumberRange range = getRange(disbursementRanges, paymentGroup.getBank(), paymentGroup.getDisbursementType().getCode());<a name="line.420"></a>
<FONT color="green">421</FONT>    <a name="line.421"></a>
<FONT color="green">422</FONT>                if (range == null) {<a name="line.422"></a>
<FONT color="green">423</FONT>                    GlobalVariables.getMessageMap().putError(KFSConstants.GLOBAL_ERRORS, PdpKeyConstants.Format.ErrorMessages.ERROR_FORMAT_DISBURSEMENT_MISSING, campus, paymentGroup.getBank().getBankCode(), paymentGroup.getDisbursementType().getCode());<a name="line.423"></a>
<FONT color="green">424</FONT>                    successful = false;<a name="line.424"></a>
<FONT color="green">425</FONT>                    return successful;<a name="line.425"></a>
<FONT color="green">426</FONT>                }<a name="line.426"></a>
<FONT color="green">427</FONT>    <a name="line.427"></a>
<FONT color="green">428</FONT>                if (PdpConstants.DisbursementTypeCodes.CHECK.equals(paymentGroup.getDisbursementType().getCode())) {<a name="line.428"></a>
<FONT color="green">429</FONT>    <a name="line.429"></a>
<FONT color="green">430</FONT>                    if (paymentGroup.getPymtAttachment().booleanValue() || paymentGroup.getProcessImmediate().booleanValue() || paymentGroup.getPymtSpecialHandling().booleanValue() || (!paymentGroup.getCombineGroups())) {<a name="line.430"></a>
<FONT color="green">431</FONT>                        assignDisbursementNumber(campus, range, paymentGroup, postFormatProcessSummary);<a name="line.431"></a>
<FONT color="green">432</FONT>                    }<a name="line.432"></a>
<FONT color="green">433</FONT>                    else {<a name="line.433"></a>
<FONT color="green">434</FONT>                        String paymentGroupKey = paymentGroup.toStringKey();<a name="line.434"></a>
<FONT color="green">435</FONT>                        // check if there was another paymentGroup we can combine with<a name="line.435"></a>
<FONT color="green">436</FONT>                        if (combinedChecksMap.containsKey(paymentGroupKey)) {<a name="line.436"></a>
<FONT color="green">437</FONT>                            PaymentInfo paymentInfo = combinedChecksMap.get(paymentGroupKey);<a name="line.437"></a>
<FONT color="green">438</FONT>                            paymentInfo.noteLines = paymentInfo.noteLines.add(new KualiInteger(paymentGroup.getNoteLines()));<a name="line.438"></a>
<FONT color="green">439</FONT>    <a name="line.439"></a>
<FONT color="green">440</FONT>                            // if noteLines don't excede the maximum assign the same disbursementNumber<a name="line.440"></a>
<FONT color="green">441</FONT>                            if (paymentInfo.noteLines.intValue() &lt;= maxNoteLines) {<a name="line.441"></a>
<FONT color="green">442</FONT>                                KualiInteger checkNumber = paymentInfo.disbursementNumber;<a name="line.442"></a>
<FONT color="green">443</FONT>                                paymentGroup.setDisbursementNbr(checkNumber);<a name="line.443"></a>
<FONT color="green">444</FONT>    <a name="line.444"></a>
<FONT color="green">445</FONT>                                // update payment info for new noteLines value<a name="line.445"></a>
<FONT color="green">446</FONT>                                combinedChecksMap.put(paymentGroupKey, paymentInfo);<a name="line.446"></a>
<FONT color="green">447</FONT>                            }<a name="line.447"></a>
<FONT color="green">448</FONT>                            // it noteLines more than maxNoteLines we remove the old entry and get a new disbursement number<a name="line.448"></a>
<FONT color="green">449</FONT>                            else {<a name="line.449"></a>
<FONT color="green">450</FONT>                                // remove old entry for this paymentGroupKey<a name="line.450"></a>
<FONT color="green">451</FONT>                                combinedChecksMap.remove(paymentGroupKey);<a name="line.451"></a>
<FONT color="green">452</FONT>    <a name="line.452"></a>
<FONT color="green">453</FONT>                                // get a new check number and the paymentGroup noteLines<a name="line.453"></a>
<FONT color="green">454</FONT>                                KualiInteger checkNumber = assignDisbursementNumber(campus, range, paymentGroup, postFormatProcessSummary);<a name="line.454"></a>
<FONT color="green">455</FONT>                                int noteLines = paymentGroup.getNoteLines();<a name="line.455"></a>
<FONT color="green">456</FONT>    <a name="line.456"></a>
<FONT color="green">457</FONT>                                // create new payment info with these two<a name="line.457"></a>
<FONT color="green">458</FONT>                                paymentInfo = new PaymentInfo(checkNumber, new KualiInteger(noteLines));<a name="line.458"></a>
<FONT color="green">459</FONT>    <a name="line.459"></a>
<FONT color="green">460</FONT>                                // add new entry in the map for this paymentGroupKey<a name="line.460"></a>
<FONT color="green">461</FONT>                                combinedChecksMap.put(paymentGroupKey, paymentInfo);<a name="line.461"></a>
<FONT color="green">462</FONT>    <a name="line.462"></a>
<FONT color="green">463</FONT>                            }<a name="line.463"></a>
<FONT color="green">464</FONT>                        }<a name="line.464"></a>
<FONT color="green">465</FONT>                        // if no entry in the map for this payment group we create a new one<a name="line.465"></a>
<FONT color="green">466</FONT>                        else {<a name="line.466"></a>
<FONT color="green">467</FONT>                            // get a new check number and the paymentGroup noteLines<a name="line.467"></a>
<FONT color="green">468</FONT>                            KualiInteger checkNumber = assignDisbursementNumber(campus, range, paymentGroup, postFormatProcessSummary);<a name="line.468"></a>
<FONT color="green">469</FONT>                            int noteLines = paymentGroup.getNoteLines();<a name="line.469"></a>
<FONT color="green">470</FONT>    <a name="line.470"></a>
<FONT color="green">471</FONT>                            // create new payment info with these two<a name="line.471"></a>
<FONT color="green">472</FONT>                            PaymentInfo paymentInfo = new PaymentInfo(checkNumber, new KualiInteger(noteLines));<a name="line.472"></a>
<FONT color="green">473</FONT>    <a name="line.473"></a>
<FONT color="green">474</FONT>                            // add new entry in the map for this paymentGroupKey<a name="line.474"></a>
<FONT color="green">475</FONT>                            combinedChecksMap.put(paymentGroupKey, paymentInfo);<a name="line.475"></a>
<FONT color="green">476</FONT>                        }<a name="line.476"></a>
<FONT color="green">477</FONT>                    }<a name="line.477"></a>
<FONT color="green">478</FONT>                }<a name="line.478"></a>
<FONT color="green">479</FONT>                else if (PdpConstants.DisbursementTypeCodes.ACH.equals(paymentGroup.getDisbursementType().getCode())) {<a name="line.479"></a>
<FONT color="green">480</FONT>                    assignDisbursementNumber(campus, range, paymentGroup, postFormatProcessSummary);<a name="line.480"></a>
<FONT color="green">481</FONT>                }<a name="line.481"></a>
<FONT color="green">482</FONT>                else {<a name="line.482"></a>
<FONT color="green">483</FONT>                    // if it isn't check or ach, we're in trouble<a name="line.483"></a>
<FONT color="green">484</FONT>                    LOG.error("assignDisbursementNumbers() Payment group " + paymentGroup.getId() + " must be CHCK or ACH.  It is: " + paymentGroup.getDisbursementType());<a name="line.484"></a>
<FONT color="green">485</FONT>                    throw new IllegalArgumentException("Payment group " + paymentGroup.getId() + " must be Check or ACH");<a name="line.485"></a>
<FONT color="green">486</FONT>                }<a name="line.486"></a>
<FONT color="green">487</FONT>    <a name="line.487"></a>
<FONT color="green">488</FONT>                this.businessObjectService.save(paymentGroup);<a name="line.488"></a>
<FONT color="green">489</FONT>    <a name="line.489"></a>
<FONT color="green">490</FONT>                // Generate a GL entry for CHCK &amp; ACH<a name="line.490"></a>
<FONT color="green">491</FONT>                glPendingTransactionService.generatePaymentGeneralLedgerPendingEntry(paymentGroup);<a name="line.491"></a>
<FONT color="green">492</FONT>                <a name="line.492"></a>
<FONT color="green">493</FONT>                // Update all the ranges<a name="line.493"></a>
<FONT color="green">494</FONT>                LOG.debug("assignDisbursementNumbers() Save ranges");<a name="line.494"></a>
<FONT color="green">495</FONT>                for (DisbursementNumberRange element : disbursementRanges) {<a name="line.495"></a>
<FONT color="green">496</FONT>                    this.businessObjectService.save(element);<a name="line.496"></a>
<FONT color="green">497</FONT>                }<a name="line.497"></a>
<FONT color="green">498</FONT>            }<a name="line.498"></a>
<FONT color="green">499</FONT>    <a name="line.499"></a>
<FONT color="green">500</FONT>            return successful;<a name="line.500"></a>
<FONT color="green">501</FONT>        }<a name="line.501"></a>
<FONT color="green">502</FONT>    <a name="line.502"></a>
<FONT color="green">503</FONT>        /**<a name="line.503"></a>
<FONT color="green">504</FONT>         * This method gets a new disbursement number and sets it on the payment group and process summary.<a name="line.504"></a>
<FONT color="green">505</FONT>         * <a name="line.505"></a>
<FONT color="green">506</FONT>         * @param campus<a name="line.506"></a>
<FONT color="green">507</FONT>         * @param range<a name="line.507"></a>
<FONT color="green">508</FONT>         * @param paymentGroup<a name="line.508"></a>
<FONT color="green">509</FONT>         * @param postFormatProcessSummary<a name="line.509"></a>
<FONT color="green">510</FONT>         * @return<a name="line.510"></a>
<FONT color="green">511</FONT>         */<a name="line.511"></a>
<FONT color="green">512</FONT>        protected KualiInteger assignDisbursementNumber(String campus, DisbursementNumberRange range, PaymentGroup paymentGroup, FormatProcessSummary postFormatProcessSummary) {<a name="line.512"></a>
<FONT color="green">513</FONT>            KualiInteger disbursementNumber = new KualiInteger(1 + range.getLastAssignedDisbNbr().intValue());<a name="line.513"></a>
<FONT color="green">514</FONT>    <a name="line.514"></a>
<FONT color="green">515</FONT>            if (disbursementNumber.isGreaterThan(range.getEndDisbursementNbr())) {<a name="line.515"></a>
<FONT color="green">516</FONT>                GlobalVariables.getMessageMap().putError(KFSConstants.GLOBAL_ERRORS, PdpKeyConstants.Format.ErrorMessages.ERROR_FORMAT_DISBURSEMENT_EXHAUSTED, campus, paymentGroup.getBank().getBankCode(), paymentGroup.getDisbursementType().getCode());<a name="line.516"></a>
<FONT color="green">517</FONT>    <a name="line.517"></a>
<FONT color="green">518</FONT>                throw new FormatException("No more disbursement numbers for bank code " + paymentGroup.getBank().getBankCode() + " and disbursement type code " + paymentGroup.getDisbursementType().getCode());<a name="line.518"></a>
<FONT color="green">519</FONT>            }<a name="line.519"></a>
<FONT color="green">520</FONT>    <a name="line.520"></a>
<FONT color="green">521</FONT>            paymentGroup.setDisbursementNbr(disbursementNumber);<a name="line.521"></a>
<FONT color="green">522</FONT>            range.setLastAssignedDisbNbr(disbursementNumber);<a name="line.522"></a>
<FONT color="green">523</FONT>    <a name="line.523"></a>
<FONT color="green">524</FONT>            // Update the summary information<a name="line.524"></a>
<FONT color="green">525</FONT>            postFormatProcessSummary.setDisbursementNumber(paymentGroup, disbursementNumber.intValue());<a name="line.525"></a>
<FONT color="green">526</FONT>    <a name="line.526"></a>
<FONT color="green">527</FONT>            return disbursementNumber;<a name="line.527"></a>
<FONT color="green">528</FONT>        }<a name="line.528"></a>
<FONT color="green">529</FONT>    <a name="line.529"></a>
<FONT color="green">530</FONT>        /**<a name="line.530"></a>
<FONT color="green">531</FONT>         * runs the extract process.<a name="line.531"></a>
<FONT color="green">532</FONT>         */<a name="line.532"></a>
<FONT color="green">533</FONT>        protected void extractChecks() {<a name="line.533"></a>
<FONT color="green">534</FONT>            LOG.debug("extractChecks() started");<a name="line.534"></a>
<FONT color="green">535</FONT>    <a name="line.535"></a>
<FONT color="green">536</FONT>            extractPaymentService.extractChecks();<a name="line.536"></a>
<FONT color="green">537</FONT>        }<a name="line.537"></a>
<FONT color="green">538</FONT>    <a name="line.538"></a>
<FONT color="green">539</FONT>        /**<a name="line.539"></a>
<FONT color="green">540</FONT>         * @see org.kuali.kfs.pdp.service.FormatService#clearUnfinishedFormat(java.lang.Integer)<a name="line.540"></a>
<FONT color="green">541</FONT>         */<a name="line.541"></a>
<FONT color="green">542</FONT>        @SuppressWarnings("rawtypes")<a name="line.542"></a>
<FONT color="green">543</FONT>        public void clearUnfinishedFormat(Integer processId) {<a name="line.543"></a>
<FONT color="green">544</FONT>            LOG.debug("clearUnfinishedFormat() started");<a name="line.544"></a>
<FONT color="green">545</FONT>    <a name="line.545"></a>
<FONT color="green">546</FONT>            Map primaryKeys = new HashMap();<a name="line.546"></a>
<FONT color="green">547</FONT>            primaryKeys.put(PdpPropertyConstants.PaymentProcess.PAYMENT_PROCESS_ID, processId);<a name="line.547"></a>
<FONT color="green">548</FONT>            PaymentProcess paymentProcess = (PaymentProcess) this.businessObjectService.findByPrimaryKey(PaymentProcess.class, primaryKeys);<a name="line.548"></a>
<FONT color="green">549</FONT>            LOG.debug("clearUnfinishedFormat() Process: " + paymentProcess);<a name="line.549"></a>
<FONT color="green">550</FONT>    <a name="line.550"></a>
<FONT color="green">551</FONT>            formatPaymentDao.unmarkPaymentsForFormat(paymentProcess);<a name="line.551"></a>
<FONT color="green">552</FONT>    <a name="line.552"></a>
<FONT color="green">553</FONT>            endFormatProcess(paymentProcess.getCampusCode());<a name="line.553"></a>
<FONT color="green">554</FONT>        }<a name="line.554"></a>
<FONT color="green">555</FONT>    <a name="line.555"></a>
<FONT color="green">556</FONT>        /**<a name="line.556"></a>
<FONT color="green">557</FONT>         * @see org.kuali.kfs.pdp.service.FormatService#resetFormatPayments(java.lang.Integer)<a name="line.557"></a>
<FONT color="green">558</FONT>         */<a name="line.558"></a>
<FONT color="green">559</FONT>        public void resetFormatPayments(Integer processId) {<a name="line.559"></a>
<FONT color="green">560</FONT>            LOG.debug("resetFormatPayments() started");<a name="line.560"></a>
<FONT color="green">561</FONT>            clearUnfinishedFormat(processId);<a name="line.561"></a>
<FONT color="green">562</FONT>        }<a name="line.562"></a>
<FONT color="green">563</FONT>    <a name="line.563"></a>
<FONT color="green">564</FONT>        /**<a name="line.564"></a>
<FONT color="green">565</FONT>         * @see org.kuali.kfs.pdp.service.FormatService#endFormatProcess(java.lang.String)<a name="line.565"></a>
<FONT color="green">566</FONT>         */<a name="line.566"></a>
<FONT color="green">567</FONT>        @SuppressWarnings("rawtypes")<a name="line.567"></a>
<FONT color="green">568</FONT>        public void endFormatProcess(String campus) {<a name="line.568"></a>
<FONT color="green">569</FONT>            LOG.debug("endFormatProcess() starting");<a name="line.569"></a>
<FONT color="green">570</FONT>    <a name="line.570"></a>
<FONT color="green">571</FONT>            Map primaryKeys = new HashMap();<a name="line.571"></a>
<FONT color="green">572</FONT>            primaryKeys.put(PdpPropertyConstants.PHYS_CAMPUS_PROCESS_CODE, campus);<a name="line.572"></a>
<FONT color="green">573</FONT>    <a name="line.573"></a>
<FONT color="green">574</FONT>            this.businessObjectService.deleteMatching(FormatProcess.class, primaryKeys);<a name="line.574"></a>
<FONT color="green">575</FONT>        }<a name="line.575"></a>
<FONT color="green">576</FONT>    <a name="line.576"></a>
<FONT color="green">577</FONT>        /**<a name="line.577"></a>
<FONT color="green">578</FONT>         * @see org.kuali.kfs.pdp.service.FormatService#getAllCustomerProfiles()<a name="line.578"></a>
<FONT color="green">579</FONT>         */<a name="line.579"></a>
<FONT color="green">580</FONT>        public List&lt;CustomerProfile&gt; getAllCustomerProfiles() {<a name="line.580"></a>
<FONT color="green">581</FONT>            if (LOG.isDebugEnabled()) {<a name="line.581"></a>
<FONT color="green">582</FONT>                LOG.debug("getAllCustomerProfiles() started");<a name="line.582"></a>
<FONT color="green">583</FONT>            }<a name="line.583"></a>
<FONT color="green">584</FONT>            Map&lt;String, Object&gt; criteria = new HashMap&lt;String, Object&gt;();<a name="line.584"></a>
<FONT color="green">585</FONT>            criteria.put(KFSPropertyConstants.ACTIVE, Boolean.TRUE);<a name="line.585"></a>
<FONT color="green">586</FONT>    <a name="line.586"></a>
<FONT color="green">587</FONT>            List&lt;CustomerProfile&gt; customerProfileList = (List&lt;CustomerProfile&gt;) getBusinessObjectService().findMatching(CustomerProfile.class, criteria);<a name="line.587"></a>
<FONT color="green">588</FONT>    <a name="line.588"></a>
<FONT color="green">589</FONT>            DynamicCollectionComparator.sort(customerProfileList, PdpPropertyConstants.CustomerProfile.CUSTOMER_PROFILE_CHART_CODE, PdpPropertyConstants.CustomerProfile.CUSTOMER_PROFILE_UNIT_CODE, PdpPropertyConstants.CustomerProfile.CUSTOMER_PROFILE_SUB_UNIT_CODE);<a name="line.589"></a>
<FONT color="green">590</FONT>    <a name="line.590"></a>
<FONT color="green">591</FONT>            return customerProfileList;<a name="line.591"></a>
<FONT color="green">592</FONT>        }<a name="line.592"></a>
<FONT color="green">593</FONT>    <a name="line.593"></a>
<FONT color="green">594</FONT>        /**<a name="line.594"></a>
<FONT color="green">595</FONT>         * @see org.kuali.kfs.pdp.service.FormatService#getAllDisbursementNumberRanges()<a name="line.595"></a>
<FONT color="green">596</FONT>         */<a name="line.596"></a>
<FONT color="green">597</FONT>        public List&lt;DisbursementNumberRange&gt; getAllDisbursementNumberRanges() {<a name="line.597"></a>
<FONT color="green">598</FONT>            if (LOG.isDebugEnabled()) {<a name="line.598"></a>
<FONT color="green">599</FONT>                LOG.debug("getAllDisbursementNumberRanges() started");<a name="line.599"></a>
<FONT color="green">600</FONT>            }<a name="line.600"></a>
<FONT color="green">601</FONT>            Map&lt;String, Object&gt; criteria = new HashMap&lt;String, Object&gt;();<a name="line.601"></a>
<FONT color="green">602</FONT>            criteria.put(KFSPropertyConstants.ACTIVE, Boolean.TRUE);<a name="line.602"></a>
<FONT color="green">603</FONT>    <a name="line.603"></a>
<FONT color="green">604</FONT>            List&lt;DisbursementNumberRange&gt; disbursementNumberRangeList = (List&lt;DisbursementNumberRange&gt;) getBusinessObjectService().findMatching(DisbursementNumberRange.class, criteria);<a name="line.604"></a>
<FONT color="green">605</FONT>            DynamicCollectionComparator.sort(disbursementNumberRangeList, PdpPropertyConstants.DisbursementNumberRange.DISBURSEMENT_NUMBER_RANGE_PHYS_CAMPUS_PROC_CODE, PdpPropertyConstants.DisbursementNumberRange.DISBURSEMENT_NUMBER_RANGE_TYPE_CODE);<a name="line.605"></a>
<FONT color="green">606</FONT>    <a name="line.606"></a>
<FONT color="green">607</FONT>            return disbursementNumberRangeList;<a name="line.607"></a>
<FONT color="green">608</FONT>        }<a name="line.608"></a>
<FONT color="green">609</FONT>    <a name="line.609"></a>
<FONT color="green">610</FONT>        /**<a name="line.610"></a>
<FONT color="green">611</FONT>         * Given the List of disbursement number ranges for the processing campus, finds matches for the bank code and disbursement type<a name="line.611"></a>
<FONT color="green">612</FONT>         * code. If more than one match is found, the range with the latest start date (before or equal to today) will be returned.<a name="line.612"></a>
<FONT color="green">613</FONT>         * <a name="line.613"></a>
<FONT color="green">614</FONT>         * @param ranges List of disbursement ranges to search (already filtered to processing campus, active, and start date before or<a name="line.614"></a>
<FONT color="green">615</FONT>         *        equal to today)<a name="line.615"></a>
<FONT color="green">616</FONT>         * @param bank bank code to find range for<a name="line.616"></a>
<FONT color="green">617</FONT>         * @param disbursementTypeCode disbursement type code to find range for<a name="line.617"></a>
<FONT color="green">618</FONT>         * @return found &lt;code&gt;DisbursementNumberRange&lt;/code or null if one was not found<a name="line.618"></a>
<FONT color="green">619</FONT>         */<a name="line.619"></a>
<FONT color="green">620</FONT>        protected DisbursementNumberRange getRange(List&lt;DisbursementNumberRange&gt; ranges, Bank bank, String disbursementTypeCode) {<a name="line.620"></a>
<FONT color="green">621</FONT>            LOG.debug("getRange() Looking for bank = " + bank.getBankCode() + " and disbursement type " + disbursementTypeCode);<a name="line.621"></a>
<FONT color="green">622</FONT>    <a name="line.622"></a>
<FONT color="green">623</FONT>            List&lt;DisbursementNumberRange&gt; rangeMatches = new ArrayList&lt;DisbursementNumberRange&gt;();<a name="line.623"></a>
<FONT color="green">624</FONT>            for (DisbursementNumberRange range : ranges) {<a name="line.624"></a>
<FONT color="green">625</FONT>                if (range.getBank().getBankCode().equals(bank.getBankCode()) &amp;&amp; range.getDisbursementTypeCode().equals(disbursementTypeCode)) {<a name="line.625"></a>
<FONT color="green">626</FONT>                    rangeMatches.add(range);<a name="line.626"></a>
<FONT color="green">627</FONT>                }<a name="line.627"></a>
<FONT color="green">628</FONT>            }<a name="line.628"></a>
<FONT color="green">629</FONT>    <a name="line.629"></a>
<FONT color="green">630</FONT>            // if more than one match we need to take the range with the latest start date<a name="line.630"></a>
<FONT color="green">631</FONT>            if (rangeMatches.size() &gt; 0) {<a name="line.631"></a>
<FONT color="green">632</FONT>                DisbursementNumberRange maxStartDateRange = rangeMatches.get(0);<a name="line.632"></a>
<FONT color="green">633</FONT>                for (DisbursementNumberRange range : rangeMatches) {<a name="line.633"></a>
<FONT color="green">634</FONT>                    if (range.getDisbNbrRangeStartDt().compareTo(maxStartDateRange.getDisbNbrRangeStartDt()) &gt; 0) {<a name="line.634"></a>
<FONT color="green">635</FONT>                        maxStartDateRange = range;<a name="line.635"></a>
<FONT color="green">636</FONT>                    }<a name="line.636"></a>
<FONT color="green">637</FONT>                }<a name="line.637"></a>
<FONT color="green">638</FONT>    <a name="line.638"></a>
<FONT color="green">639</FONT>                return maxStartDateRange;<a name="line.639"></a>
<FONT color="green">640</FONT>            }<a name="line.640"></a>
<FONT color="green">641</FONT>    <a name="line.641"></a>
<FONT color="green">642</FONT>            return null;<a name="line.642"></a>
<FONT color="green">643</FONT>        }<a name="line.643"></a>
<FONT color="green">644</FONT>    <a name="line.644"></a>
<FONT color="green">645</FONT>        /**<a name="line.645"></a>
<FONT color="green">646</FONT>         * This method sets the formatPaymentDao<a name="line.646"></a>
<FONT color="green">647</FONT>         * <a name="line.647"></a>
<FONT color="green">648</FONT>         * @param fpd<a name="line.648"></a>
<FONT color="green">649</FONT>         */<a name="line.649"></a>
<FONT color="green">650</FONT>        public void setFormatPaymentDao(FormatPaymentDao fpd) {<a name="line.650"></a>
<FONT color="green">651</FONT>            formatPaymentDao = fpd;<a name="line.651"></a>
<FONT color="green">652</FONT>        }<a name="line.652"></a>
<FONT color="green">653</FONT>    <a name="line.653"></a>
<FONT color="green">654</FONT>        /**<a name="line.654"></a>
<FONT color="green">655</FONT>         * This method sets the glPendingTransactionService<a name="line.655"></a>
<FONT color="green">656</FONT>         * <a name="line.656"></a>
<FONT color="green">657</FONT>         * @param gs<a name="line.657"></a>
<FONT color="green">658</FONT>         */<a name="line.658"></a>
<FONT color="green">659</FONT>        public void setGlPendingTransactionService(PendingTransactionService gs) {<a name="line.659"></a>
<FONT color="green">660</FONT>            glPendingTransactionService = gs;<a name="line.660"></a>
<FONT color="green">661</FONT>        }<a name="line.661"></a>
<FONT color="green">662</FONT>    <a name="line.662"></a>
<FONT color="green">663</FONT>        /**<a name="line.663"></a>
<FONT color="green">664</FONT>         * This method sets the achService<a name="line.664"></a>
<FONT color="green">665</FONT>         * <a name="line.665"></a>
<FONT color="green">666</FONT>         * @param as<a name="line.666"></a>
<FONT color="green">667</FONT>         */<a name="line.667"></a>
<FONT color="green">668</FONT>        public void setAchService(AchService as) {<a name="line.668"></a>
<FONT color="green">669</FONT>            achService = as;<a name="line.669"></a>
<FONT color="green">670</FONT>        }<a name="line.670"></a>
<FONT color="green">671</FONT>    <a name="line.671"></a>
<FONT color="green">672</FONT>        /**<a name="line.672"></a>
<FONT color="green">673</FONT>         * This method sets the processDao<a name="line.673"></a>
<FONT color="green">674</FONT>         * <a name="line.674"></a>
<FONT color="green">675</FONT>         * @param pd<a name="line.675"></a>
<FONT color="green">676</FONT>         */<a name="line.676"></a>
<FONT color="green">677</FONT>        public void setProcessDao(ProcessDao pd) {<a name="line.677"></a>
<FONT color="green">678</FONT>            processDao = pd;<a name="line.678"></a>
<FONT color="green">679</FONT>        }<a name="line.679"></a>
<FONT color="green">680</FONT>    <a name="line.680"></a>
<FONT color="green">681</FONT>        /**<a name="line.681"></a>
<FONT color="green">682</FONT>         * This method sets the paymentGroupDao<a name="line.682"></a>
<FONT color="green">683</FONT>         * <a name="line.683"></a>
<FONT color="green">684</FONT>         * @param pgd<a name="line.684"></a>
<FONT color="green">685</FONT>         */<a name="line.685"></a>
<FONT color="green">686</FONT>        public void setPaymentGroupDao(PaymentGroupDao pgd) {<a name="line.686"></a>
<FONT color="green">687</FONT>            paymentGroupDao = pgd;<a name="line.687"></a>
<FONT color="green">688</FONT>        }<a name="line.688"></a>
<FONT color="green">689</FONT>    <a name="line.689"></a>
<FONT color="green">690</FONT>        /**<a name="line.690"></a>
<FONT color="green">691</FONT>         * This method sets the paymentDetailDao<a name="line.691"></a>
<FONT color="green">692</FONT>         * <a name="line.692"></a>
<FONT color="green">693</FONT>         * @param pdd<a name="line.693"></a>
<FONT color="green">694</FONT>         */<a name="line.694"></a>
<FONT color="green">695</FONT>        public void setPaymentDetailDao(PaymentDetailDao pdd) {<a name="line.695"></a>
<FONT color="green">696</FONT>            paymentDetailDao = pdd;<a name="line.696"></a>
<FONT color="green">697</FONT>        }<a name="line.697"></a>
<FONT color="green">698</FONT>    <a name="line.698"></a>
<FONT color="green">699</FONT>        /**<a name="line.699"></a>
<FONT color="green">700</FONT>         * This method sets the schedulerService<a name="line.700"></a>
<FONT color="green">701</FONT>         * <a name="line.701"></a>
<FONT color="green">702</FONT>         * @param ss<a name="line.702"></a>
<FONT color="green">703</FONT>         */<a name="line.703"></a>
<FONT color="green">704</FONT>        public void setSchedulerService(SchedulerService ss) {<a name="line.704"></a>
<FONT color="green">705</FONT>            schedulerService = ss;<a name="line.705"></a>
<FONT color="green">706</FONT>        }<a name="line.706"></a>
<FONT color="green">707</FONT>    <a name="line.707"></a>
<FONT color="green">708</FONT>        /**<a name="line.708"></a>
<FONT color="green">709</FONT>         * This method sets the parameterService<a name="line.709"></a>
<FONT color="green">710</FONT>         * <a name="line.710"></a>
<FONT color="green">711</FONT>         * @param parameterService<a name="line.711"></a>
<FONT color="green">712</FONT>         */<a name="line.712"></a>
<FONT color="green">713</FONT>        public void setParameterService(ParameterService parameterService) {<a name="line.713"></a>
<FONT color="green">714</FONT>            this.parameterService = parameterService;<a name="line.714"></a>
<FONT color="green">715</FONT>        }<a name="line.715"></a>
<FONT color="green">716</FONT>    <a name="line.716"></a>
<FONT color="green">717</FONT>        /**<a name="line.717"></a>
<FONT color="green">718</FONT>         * Gets the businessObjectService attribute. <a name="line.718"></a>
<FONT color="green">719</FONT>         * @return Returns the businessObjectService.<a name="line.719"></a>
<FONT color="green">720</FONT>         */<a name="line.720"></a>
<FONT color="green">721</FONT>        public BusinessObjectService getBusinessObjectService() {<a name="line.721"></a>
<FONT color="green">722</FONT>            return businessObjectService;<a name="line.722"></a>
<FONT color="green">723</FONT>        }<a name="line.723"></a>
<FONT color="green">724</FONT>        <a name="line.724"></a>
<FONT color="green">725</FONT>        /**<a name="line.725"></a>
<FONT color="green">726</FONT>         * This method sets the businessObjectService<a name="line.726"></a>
<FONT color="green">727</FONT>         * <a name="line.727"></a>
<FONT color="green">728</FONT>         * @param bos<a name="line.728"></a>
<FONT color="green">729</FONT>         */<a name="line.729"></a>
<FONT color="green">730</FONT>        public void setBusinessObjectService(BusinessObjectService bos) {<a name="line.730"></a>
<FONT color="green">731</FONT>            this.businessObjectService = bos;<a name="line.731"></a>
<FONT color="green">732</FONT>        }<a name="line.732"></a>
<FONT color="green">733</FONT>    <a name="line.733"></a>
<FONT color="green">734</FONT>        /**<a name="line.734"></a>
<FONT color="green">735</FONT>         * This method sets the paymentGroupService<a name="line.735"></a>
<FONT color="green">736</FONT>         * <a name="line.736"></a>
<FONT color="green">737</FONT>         * @param paymentGroupService<a name="line.737"></a>
<FONT color="green">738</FONT>         */<a name="line.738"></a>
<FONT color="green">739</FONT>        public void setPaymentGroupService(PaymentGroupService paymentGroupService) {<a name="line.739"></a>
<FONT color="green">740</FONT>            this.paymentGroupService = paymentGroupService;<a name="line.740"></a>
<FONT color="green">741</FONT>        }<a name="line.741"></a>
<FONT color="green">742</FONT>    <a name="line.742"></a>
<FONT color="green">743</FONT>        /**<a name="line.743"></a>
<FONT color="green">744</FONT>         * This method sets the dateTimeService<a name="line.744"></a>
<FONT color="green">745</FONT>         * <a name="line.745"></a>
<FONT color="green">746</FONT>         * @param dateTimeService<a name="line.746"></a>
<FONT color="green">747</FONT>         */<a name="line.747"></a>
<FONT color="green">748</FONT>        public void setDateTimeService(DateTimeService dateTimeService) {<a name="line.748"></a>
<FONT color="green">749</FONT>            this.dateTimeService = dateTimeService;<a name="line.749"></a>
<FONT color="green">750</FONT>        }<a name="line.750"></a>
<FONT color="green">751</FONT>    <a name="line.751"></a>
<FONT color="green">752</FONT>        /**<a name="line.752"></a>
<FONT color="green">753</FONT>         * Gets the extractPaymentService attribute.<a name="line.753"></a>
<FONT color="green">754</FONT>         * <a name="line.754"></a>
<FONT color="green">755</FONT>         * @return Returns the extractPaymentService.<a name="line.755"></a>
<FONT color="green">756</FONT>         */<a name="line.756"></a>
<FONT color="green">757</FONT>        protected ExtractPaymentService getExtractPaymentService() {<a name="line.757"></a>
<FONT color="green">758</FONT>            return extractPaymentService;<a name="line.758"></a>
<FONT color="green">759</FONT>        }<a name="line.759"></a>
<FONT color="green">760</FONT>    <a name="line.760"></a>
<FONT color="green">761</FONT>        /**<a name="line.761"></a>
<FONT color="green">762</FONT>         * Sets the extractPaymentService attribute value.<a name="line.762"></a>
<FONT color="green">763</FONT>         * <a name="line.763"></a>
<FONT color="green">764</FONT>         * @param extractPaymentService The extractPaymentService to set.<a name="line.764"></a>
<FONT color="green">765</FONT>         */<a name="line.765"></a>
<FONT color="green">766</FONT>        public void setExtractPaymentService(ExtractPaymentService extractPaymentService) {<a name="line.766"></a>
<FONT color="green">767</FONT>            this.extractPaymentService = extractPaymentService;<a name="line.767"></a>
<FONT color="green">768</FONT>        }<a name="line.768"></a>
<FONT color="green">769</FONT>    <a name="line.769"></a>
<FONT color="green">770</FONT>        /**<a name="line.770"></a>
<FONT color="green">771</FONT>         * @return Returns the personService.<a name="line.771"></a>
<FONT color="green">772</FONT>         */<a name="line.772"></a>
<FONT color="green">773</FONT>        protected PersonService&lt;Person&gt; getPersonService() {<a name="line.773"></a>
<FONT color="green">774</FONT>            if(personService==null) {<a name="line.774"></a>
<FONT color="green">775</FONT>                personService = SpringContext.getBean(PersonService.class);<a name="line.775"></a>
<FONT color="green">776</FONT>            }<a name="line.776"></a>
<FONT color="green">777</FONT>            return personService;<a name="line.777"></a>
<FONT color="green">778</FONT>        }<a name="line.778"></a>
<FONT color="green">779</FONT>    <a name="line.779"></a>
<FONT color="green">780</FONT>        /**<a name="line.780"></a>
<FONT color="green">781</FONT>         * This class holds disbursement number and noteLines info for payment group disbursement number assignment and combine checks.<a name="line.781"></a>
<FONT color="green">782</FONT>         */<a name="line.782"></a>
<FONT color="green">783</FONT>        protected class PaymentInfo {<a name="line.783"></a>
<FONT color="green">784</FONT>            public KualiInteger disbursementNumber;<a name="line.784"></a>
<FONT color="green">785</FONT>            public KualiInteger noteLines;<a name="line.785"></a>
<FONT color="green">786</FONT>    <a name="line.786"></a>
<FONT color="green">787</FONT>            public PaymentInfo(KualiInteger disbursementNumber, KualiInteger noteLines) {<a name="line.787"></a>
<FONT color="green">788</FONT>                this.disbursementNumber = disbursementNumber;<a name="line.788"></a>
<FONT color="green">789</FONT>                this.noteLines = noteLines;<a name="line.789"></a>
<FONT color="green">790</FONT>            }<a name="line.790"></a>
<FONT color="green">791</FONT>        }<a name="line.791"></a>
<FONT color="green">792</FONT>    <a name="line.792"></a>
<FONT color="green">793</FONT>    }<a name="line.793"></a>




























































</PRE>
</BODY>
</HTML>
