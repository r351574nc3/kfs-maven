<HTML>
<BODY BGCOLOR="white">
<PRE>
<FONT color="green">001</FONT>    /*<a name="line.1"></a>
<FONT color="green">002</FONT>     * Copyright 2011 The Kuali Foundation.<a name="line.2"></a>
<FONT color="green">003</FONT>     * <a name="line.3"></a>
<FONT color="green">004</FONT>     * Licensed under the Educational Community License, Version 2.0 (the "License");<a name="line.4"></a>
<FONT color="green">005</FONT>     * you may not use this file except in compliance with the License.<a name="line.5"></a>
<FONT color="green">006</FONT>     * You may obtain a copy of the License at<a name="line.6"></a>
<FONT color="green">007</FONT>     * <a name="line.7"></a>
<FONT color="green">008</FONT>     * http://www.opensource.org/licenses/ecl2.php<a name="line.8"></a>
<FONT color="green">009</FONT>     * <a name="line.9"></a>
<FONT color="green">010</FONT>     * Unless required by applicable law or agreed to in writing, software<a name="line.10"></a>
<FONT color="green">011</FONT>     * distributed under the License is distributed on an "AS IS" BASIS,<a name="line.11"></a>
<FONT color="green">012</FONT>     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.<a name="line.12"></a>
<FONT color="green">013</FONT>     * See the License for the specific language governing permissions and<a name="line.13"></a>
<FONT color="green">014</FONT>     * limitations under the License.<a name="line.14"></a>
<FONT color="green">015</FONT>     */<a name="line.15"></a>
<FONT color="green">016</FONT>    package org.kuali.kfs.module.bc.document.dataaccess.impl;<a name="line.16"></a>
<FONT color="green">017</FONT>    <a name="line.17"></a>
<FONT color="green">018</FONT>    import java.util.ArrayList;<a name="line.18"></a>
<FONT color="green">019</FONT>    <a name="line.19"></a>
<FONT color="green">020</FONT>    import org.kuali.kfs.module.bc.batch.dataaccess.impl.SQLForStep;<a name="line.20"></a>
<FONT color="green">021</FONT>    import org.kuali.kfs.module.bc.document.dataaccess.BudgetConstructionList2PLGReportDao;<a name="line.21"></a>
<FONT color="green">022</FONT>    import org.kuali.kfs.sys.KFSConstants.BudgetConstructionConstants;<a name="line.22"></a>
<FONT color="green">023</FONT>    import org.kuali.rice.kns.service.PersistenceService;<a name="line.23"></a>
<FONT color="green">024</FONT>    <a name="line.24"></a>
<FONT color="green">025</FONT>    /**<a name="line.25"></a>
<FONT color="green">026</FONT>     * builds the report for accounts which are out of balance because benefits have been calculated on salaries and the amounts don't match what is in GL.  the discrepancy is in an object code called '2PLG'.<a name="line.26"></a>
<FONT color="green">027</FONT>     */<a name="line.27"></a>
<FONT color="green">028</FONT>    <a name="line.28"></a>
<FONT color="green">029</FONT>    public class BudgetConstructionList2PLGReportDaoJdbc extends BudgetConstructionDaoJdbcBase implements BudgetConstructionList2PLGReportDao {<a name="line.29"></a>
<FONT color="green">030</FONT>        private static org.apache.log4j.Logger LOG = org.apache.log4j.Logger.getLogger(BudgetConstructionList2PLGReportDaoJdbc.class);<a name="line.30"></a>
<FONT color="green">031</FONT>    <a name="line.31"></a>
<FONT color="green">032</FONT>        private static ArrayList&lt;SQLForStep&gt; updateReportsList2PLGTable = new ArrayList&lt;SQLForStep&gt;(1);<a name="line.32"></a>
<FONT color="green">033</FONT>        <a name="line.33"></a>
<FONT color="green">034</FONT>        private PersistenceService persistenceService;<a name="line.34"></a>
<FONT color="green">035</FONT>    <a name="line.35"></a>
<FONT color="green">036</FONT>        public BudgetConstructionList2PLGReportDaoJdbc() {<a name="line.36"></a>
<FONT color="green">037</FONT>    <a name="line.37"></a>
<FONT color="green">038</FONT>            ArrayList&lt;Integer&gt; insertionPoints = new ArrayList&lt;Integer&gt;(1);<a name="line.38"></a>
<FONT color="green">039</FONT>            <a name="line.39"></a>
<FONT color="green">040</FONT>            // builds and updates List2PLGReports<a name="line.40"></a>
<FONT color="green">041</FONT>            /* get accounts, sub-accounts that have an imbalance between detailed salary and general ledger, displayed in the object class 2PLG */<a name="line.41"></a>
<FONT color="green">042</FONT>            StringBuilder sqlText = new StringBuilder(500);<a name="line.42"></a>
<FONT color="green">043</FONT>            sqlText.append("INSERT INTO LD_BCN_2PLG_LIST_MT \n");<a name="line.43"></a>
<FONT color="green">044</FONT>            sqlText.append("(PERSON_UNVL_ID, ORG_FIN_COA_CD, ORG_CD, FIN_COA_CD, ACCOUNT_NBR, SUB_ACCT_NBR, ACLN_ANNL_BAL_AMT) \n");<a name="line.44"></a>
<FONT color="green">045</FONT>            sqlText.append("SELECT ?, ctrl.sel_org_fin_coa, ctrl.sel_org_cd, ctrl.fin_coa_cd, ctrl.account_nbr, ctrl.sub_acct_nbr, pbgl.acln_annl_bal_amt \n");<a name="line.45"></a>
<FONT color="green">046</FONT>            sqlText.append("FROM LD_PND_BCNSTR_GL_T pbgl, LD_BCN_CTRL_LIST_T ctrl \n");<a name="line.46"></a>
<FONT color="green">047</FONT>            sqlText.append("WHERE ctrl.person_unvl_id = ? \n");<a name="line.47"></a>
<FONT color="green">048</FONT>            sqlText.append(" AND pbgl.fdoc_nbr = ctrl.fdoc_nbr \n");<a name="line.48"></a>
<FONT color="green">049</FONT>            sqlText.append(" AND pbgl.univ_fiscal_yr = ctrl.univ_fiscal_yr \n");<a name="line.49"></a>
<FONT color="green">050</FONT>            sqlText.append(" AND pbgl.fin_coa_cd = ctrl.fin_coa_cd \n");<a name="line.50"></a>
<FONT color="green">051</FONT>            sqlText.append(" AND pbgl.account_nbr = ctrl.account_nbr \n");<a name="line.51"></a>
<FONT color="green">052</FONT>            sqlText.append(" AND pbgl.sub_acct_nbr = ctrl.sub_acct_nbr \n");<a name="line.52"></a>
<FONT color="green">053</FONT>            sqlText.append(" AND pbgl.fin_object_cd = '");<a name="line.53"></a>
<FONT color="green">054</FONT>            // the 2PLG constant<a name="line.54"></a>
<FONT color="green">055</FONT>            insertionPoints.add(sqlText.length());<a name="line.55"></a>
<FONT color="green">056</FONT>            sqlText.append("'");<a name="line.56"></a>
<FONT color="green">057</FONT>    <a name="line.57"></a>
<FONT color="green">058</FONT>            updateReportsList2PLGTable.add(new SQLForStep(sqlText,insertionPoints));<a name="line.58"></a>
<FONT color="green">059</FONT>            insertionPoints.clear();<a name="line.59"></a>
<FONT color="green">060</FONT>            sqlText.delete(0, sqlText.length());<a name="line.60"></a>
<FONT color="green">061</FONT>    <a name="line.61"></a>
<FONT color="green">062</FONT>        }<a name="line.62"></a>
<FONT color="green">063</FONT>    <a name="line.63"></a>
<FONT color="green">064</FONT>        /**<a name="line.64"></a>
<FONT color="green">065</FONT>         *  remove from the table rows for any previous report requested by this user<a name="line.65"></a>
<FONT color="green">066</FONT>         */<a name="line.66"></a>
<FONT color="green">067</FONT>        protected void cleanReportsList2PLGTable(String principalName) {<a name="line.67"></a>
<FONT color="green">068</FONT>            clearTempTableByUnvlId("LD_BCN_2PLG_LIST_MT", "PERSON_UNVL_ID", principalName);<a name="line.68"></a>
<FONT color="green">069</FONT>        }<a name="line.69"></a>
<FONT color="green">070</FONT>    <a name="line.70"></a>
<FONT color="green">071</FONT>        /**<a name="line.71"></a>
<FONT color="green">072</FONT>         * <a name="line.72"></a>
<FONT color="green">073</FONT>         * @see org.kuali.kfs.module.bc.document.dataaccess.BudgetConstructionList2PLGReportDao#updateReportsList2PLGTable(java.lang.String)<a name="line.73"></a>
<FONT color="green">074</FONT>         */<a name="line.74"></a>
<FONT color="green">075</FONT>        public void updateList2PLGReportsTable(String principalName) {<a name="line.75"></a>
<FONT color="green">076</FONT>            // get rid of any rows from a previous report requested by this user<a name="line.76"></a>
<FONT color="green">077</FONT>            cleanReportsList2PLGTable(principalName);<a name="line.77"></a>
<FONT color="green">078</FONT>            // fetch the constant naming the 2PLG object class<a name="line.78"></a>
<FONT color="green">079</FONT>            ArrayList&lt;String&gt; stringToInsert = new ArrayList&lt;String&gt;(1); <a name="line.79"></a>
<FONT color="green">080</FONT>            stringToInsert.add(BudgetConstructionConstants.OBJECT_CODE_2PLG);<a name="line.80"></a>
<FONT color="green">081</FONT>            // fill the table<a name="line.81"></a>
<FONT color="green">082</FONT>            getSimpleJdbcTemplate().update(updateReportsList2PLGTable.get(0).getSQL(stringToInsert), principalName, principalName);<a name="line.82"></a>
<FONT color="green">083</FONT>            /**<a name="line.83"></a>
<FONT color="green">084</FONT>             * this is necessary to clear any rows for the tables we have just updated from the OJB cache.  otherwise, subsequent calls to OJB will fetch the old, unupdated cached rows.<a name="line.84"></a>
<FONT color="green">085</FONT>             */<a name="line.85"></a>
<FONT color="green">086</FONT>            persistenceService.clearCache();<a name="line.86"></a>
<FONT color="green">087</FONT>        }<a name="line.87"></a>
<FONT color="green">088</FONT>        <a name="line.88"></a>
<FONT color="green">089</FONT>        public void setPersistenceService(PersistenceService persistenceService)<a name="line.89"></a>
<FONT color="green">090</FONT>        {<a name="line.90"></a>
<FONT color="green">091</FONT>            this.persistenceService = persistenceService;<a name="line.91"></a>
<FONT color="green">092</FONT>        }<a name="line.92"></a>
<FONT color="green">093</FONT>    <a name="line.93"></a>
<FONT color="green">094</FONT>    }<a name="line.94"></a>
<FONT color="green">095</FONT>    <a name="line.95"></a>




























































</PRE>
</BODY>
</HTML>
